[{"title": "7 个使用 bcc/BPF 的性能分析神器", "url_object_id": "9ccbd4ca89f676b9c838a57a82c8d8ab", "create_date": "2017/12/14", "tags": "IT技术,Linux", "fav_nums": 0, "front_image_path": "full/1f020353984ba3d88d0e0349f7b5decd4ed6dd8a.jpg", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://opensource.com/article/17/11/bccbpf-performance\">Brendan Gregg</a>   译文出处：<a target=\"_blank\" href=\"https://linux.cn/article-9139-1.html\">Linux中国/张守永</a>   </div><blockquote><p>使用伯克利包过滤器 Berkeley Packet Filter（BPF）编译器集合Compiler Collection（BCC）工具深度探查你的 Linux 代码。</p></blockquote>\n<p>在 Linux 中出现的一种新技术能够为系统管理员和开发者提供大量用于性能分析和故障排除的新工具和仪表盘。它被称为增强的伯克利数据包过滤器 enhanced Berkeley Packet Filter（eBPF，或 BPF），虽然这些改进并不是由伯克利开发的，而且它们不仅仅是处理数据包，更多的是过滤。我将讨论在 Fedora 和 Red Hat Linux 发行版中使用 BPF 的一种方法，并在 Fedora 26 上演示。</p>\n<p>BPF 可以在内核中运行由用户定义的沙盒程序，可以立即添加新的自定义功能。这就像按需给 Linux 系统添加超能力一般。 你可以使用它的例子包括如下：</p>\n<ul>\n<li><strong>高级性能跟踪工具</strong>：对文件系统操作、TCP 事件、用户级事件等的可编程的低开销检测。</li>\n<li><strong>网络性能</strong>： 尽早丢弃数据包以提高对 DDoS 的恢复能力，或者在内核中重定向数据包以提高性能。</li>\n<li><strong>安全监控</strong>： 7×24 小时的自定义检测和记录内核空间与用户空间内的可疑事件。</li>\n</ul>\n<p>在可能的情况下，BPF 程序必须通过一个内核验证机制来保证它们的安全运行，这比写自定义的内核模块更安全。我在此假设大多数人并不编写自己的 BPF 程序，而是使用别人写好的。在 GitHub 上的 <a href=\"https://github.com/iovisor/bcc\">BPF Compiler Collection (bcc)</a> 项目中，我已发布许多开源代码。bcc 为 BPF 开发提供了不同的前端支持，包括 Python 和 Lua，并且是目前最活跃的 BPF 工具项目。</p>\n<h3 id=\"toc_1\">7 个有用的 bcc/BPF 新工具</h3>\n<p>为了了解 bcc/BPF 工具和它们的检测内容，我创建了下面的图表并添加到 bcc 项目中。</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/bb63b4b8c3e11401acd3a950aee8b737.png\" alt=\"Linux bcc/BPF 跟踪工具图\"></p>\n<p>这些是命令行界面工具，你可以通过 SSH 使用它们。目前大多数分析，包括我的老板，都是用 GUI 和仪表盘进行的。SSH 是最后的手段。但这些命令行工具仍然是预览 BPF 能力的好方法，即使你最终打算通过一个可用的 GUI 使用它。我已着手向一个开源 GUI 添加 BPF 功能，但那是另一篇文章的主题。现在我想向你分享今天就可以使用的 CLI 工具。</p>\n<h4 id=\"toc_2\">1、 execsnoop</h4>\n<p>从哪儿开始呢？如何查看新的进程。那些会消耗系统资源，但很短暂的进程，它们甚至不会出现在 <code>top(1)</code> 命令或其它工具中的显示之中。这些新进程可以使用 <a href=\"https://github.com/brendangregg/perf-tools/blob/master/execsnoop\">execsnoop</a> 进行检测（或使用行业术语说，可以被追踪traced）。 在追踪时，我将在另一个窗口中通过 SSH 登录：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3439b69efbb119326795\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n# /usr/share/bcc/tools/execsnoop\r\nPCOMM            PID    PPID   RET ARGS\r\nsshd             12234  727      0 /usr/sbin/sshd -D -R\r\nunix_chkpwd      12236  12234    0 /usr/sbin/unix_chkpwd root nonull\r\nunix_chkpwd      12237  12234    0 /usr/sbin/unix_chkpwd root chkexpiry\r\nbash             12239  12238    0 /bin/bash\r\nid               12241  12240    0 /usr/bin/id -un\r\nhostname         12243  12242    0 /usr/bin/hostname\r\npkg-config       12245  12244    0 /usr/bin/pkg-config --variable=completionsdir bash-completion\r\ngrepconf.sh      12246  12239    0 /usr/libexec/grepconf.sh -c\r\ngrep             12247  12246    0 /usr/bin/grep -qsi ^COLOR.*none /etc/GREP_COLORS\r\ntty              12249  12248    0 /usr/bin/tty -s\r\ntput             12250  12248    0 /usr/bin/tput colors\r\ndircolors        12252  12251    0 /usr/bin/dircolors --sh /etc/DIR_COLORS\r\ngrep             12253  12239    0 /usr/bin/grep -qi ^COLOR.*none /etc/DIR_COLORS\r\ngrepconf.sh      12254  12239    0 /usr/libexec/grepconf.sh -c\r\ngrep             12255  12254    0 /usr/bin/grep -qsi ^COLOR.*none /etc/GREP_COLORS\r\ngrepconf.sh      12256  12239    0 /usr/libexec/grepconf.sh -c\r\ngrep             12257  12256    0 /usr/bin/grep -qsi ^COLOR.*none /etc/GREP_COLORS\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efbb119326795-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efbb119326795-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efbb119326795-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efbb119326795-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efbb119326795-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efbb119326795-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efbb119326795-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efbb119326795-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efbb119326795-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efbb119326795-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efbb119326795-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efbb119326795-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efbb119326795-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efbb119326795-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efbb119326795-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efbb119326795-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efbb119326795-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efbb119326795-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efbb119326795-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efbb119326795-20\">20</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3439b69efbb119326795-1\"><span class=\"crayon-p\"># /usr/share/bcc/tools/execsnoop</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efbb119326795-2\"><span class=\"crayon-e\">PCOMM            </span><span class=\"crayon-e\">PID    </span><span class=\"crayon-e\">PPID   </span><span class=\"crayon-e\">RET </span><span class=\"crayon-e\">ARGS</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efbb119326795-3\"><span class=\"crayon-i\">sshd</span><span class=\"crayon-h\">             </span><span class=\"crayon-cn\">12234</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">727</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">sbin</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">sshd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">D</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">R</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efbb119326795-4\"><span class=\"crayon-v\">unix</span><span class=\"crayon-sy\">_</span>chkpwd<span class=\"crayon-h\">      </span><span class=\"crayon-cn\">12236</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12234</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">sbin</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">unix_chkpwd </span><span class=\"crayon-e\">root </span><span class=\"crayon-e\">nonull</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efbb119326795-5\"><span class=\"crayon-v\">unix</span><span class=\"crayon-sy\">_</span>chkpwd<span class=\"crayon-h\">      </span><span class=\"crayon-cn\">12237</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12234</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">sbin</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">unix_chkpwd </span><span class=\"crayon-e\">root </span><span class=\"crayon-e\">chkexpiry</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efbb119326795-6\"><span class=\"crayon-i\">bash</span><span class=\"crayon-h\">             </span><span class=\"crayon-cn\">12239</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12238</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bin</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">bash</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efbb119326795-7\"><span class=\"crayon-i\">id</span><span class=\"crayon-h\">               </span><span class=\"crayon-cn\">12241</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12240</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bin</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">un</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efbb119326795-8\"><span class=\"crayon-i\">hostname</span><span class=\"crayon-h\">         </span><span class=\"crayon-cn\">12243</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12242</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bin</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">hostname</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efbb119326795-9\"><span class=\"crayon-v\">pkg</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">config</span><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">12245</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12244</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bin</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">pkg</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">config</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">variable</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">completionsdir </span><span class=\"crayon-v\">bash</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">completion</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efbb119326795-10\"><span class=\"crayon-v\">grepconf</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">sh</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">12246</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12239</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">libexec</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">grepconf</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">sh</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">c</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efbb119326795-11\"><span class=\"crayon-i\">grep</span><span class=\"crayon-h\">             </span><span class=\"crayon-cn\">12247</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12246</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bin</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">grep</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">qsi</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">^</span><span class=\"crayon-v\">COLOR</span><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">none</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">etc</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">GREP_COLORS</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efbb119326795-12\"><span class=\"crayon-i\">tty</span><span class=\"crayon-h\">              </span><span class=\"crayon-cn\">12249</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12248</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bin</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">tty</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">s</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efbb119326795-13\"><span class=\"crayon-i\">tput</span><span class=\"crayon-h\">             </span><span class=\"crayon-cn\">12250</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12248</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bin</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">tput </span><span class=\"crayon-e\">colors</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efbb119326795-14\"><span class=\"crayon-i\">dircolors</span><span class=\"crayon-h\">        </span><span class=\"crayon-cn\">12252</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12251</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bin</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">dircolors</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">sh</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">etc</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">DIR_COLORS</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efbb119326795-15\"><span class=\"crayon-i\">grep</span><span class=\"crayon-h\">             </span><span class=\"crayon-cn\">12253</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12239</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bin</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">grep</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">qi</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">^</span><span class=\"crayon-v\">COLOR</span><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">none</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">etc</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">DIR_COLORS</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efbb119326795-16\"><span class=\"crayon-v\">grepconf</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">sh</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">12254</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12239</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">libexec</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">grepconf</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">sh</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">c</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efbb119326795-17\"><span class=\"crayon-i\">grep</span><span class=\"crayon-h\">             </span><span class=\"crayon-cn\">12255</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12254</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bin</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">grep</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">qsi</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">^</span><span class=\"crayon-v\">COLOR</span><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">none</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">etc</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">GREP_COLORS</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efbb119326795-18\"><span class=\"crayon-v\">grepconf</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">sh</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">12256</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12239</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">libexec</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">grepconf</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">sh</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">c</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efbb119326795-19\"><span class=\"crayon-i\">grep</span><span class=\"crayon-h\">             </span><span class=\"crayon-cn\">12257</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12256</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bin</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">grep</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">qsi</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">^</span><span class=\"crayon-v\">COLOR</span><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">*</span><span class=\"crayon-v\">none</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">etc</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">GREP</span><span class=\"crayon-sy\">_</span>COLORS</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efbb119326795-20\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0079 seconds] -->\r\n<p>哇哦。 那是什么？ 什么是 <code>grepconf.sh</code>？ 什么是 <code>/etc/GREP_COLORS</code>？ 是 <code>grep</code> 在读取它自己的配置文件……由 <code>grep</code> 运行的？ 这究竟是怎么工作的？</p>\n<p>欢迎来到有趣的系统追踪世界。 你可以学到很多关于系统是如何工作的（或者根本不工作，在有些情况下），并且发现一些简单的优化方法。 <code>execsnoop</code> 通过跟踪 <code>exec()</code> 系统调用来工作，<code>exec()</code> 通常用于在新进程中加载不同的程序代码。</p>\n<h4 id=\"toc_3\">2、 opensnoop</h4>\n<p>接着上面继续，所以，<code>grepconf.sh</code> 可能是一个 shell 脚本，对吧？ 我将运行 <code>file(1)</code> 来检查它，并使用<a href=\"https://github.com/brendangregg/perf-tools/blob/master/opensnoop\">opensnoop</a> bcc 工具来查看打开的文件：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3439b69efc5356180302\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n# /usr/share/bcc/tools/opensnoop\r\nPID    COMM               FD ERR PATH\r\n12420  file                3   0 /etc/ld.so.cache\r\n12420  file                3   0 /lib64/libmagic.so.1\r\n12420  file                3   0 /lib64/libz.so.1\r\n12420  file                3   0 /lib64/libc.so.6\r\n12420  file                3   0 /usr/lib/locale/locale-archive\r\n12420  file               -1   2 /etc/magic.mgc\r\n12420  file                3   0 /etc/magic\r\n12420  file                3   0 /usr/share/misc/magic.mgc\r\n12420  file                3   0 /usr/lib64/gconv/gconv-modules.cache\r\n12420  file                3   0 /usr/libexec/grepconf.sh\r\n1      systemd            16   0 /proc/565/cgroup\r\n1      systemd            16   0 /proc/536/cgroup\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efc5356180302-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efc5356180302-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efc5356180302-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efc5356180302-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efc5356180302-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efc5356180302-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efc5356180302-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efc5356180302-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efc5356180302-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efc5356180302-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efc5356180302-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efc5356180302-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efc5356180302-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efc5356180302-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efc5356180302-15\">15</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3439b69efc5356180302-1\"><span class=\"crayon-p\"># /usr/share/bcc/tools/opensnoop</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efc5356180302-2\"><span class=\"crayon-e\">PID    </span><span class=\"crayon-e\">COMM               </span><span class=\"crayon-e\">FD </span><span class=\"crayon-e\">ERR </span><span class=\"crayon-i\">PATH</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efc5356180302-3\"><span class=\"crayon-cn\">12420</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">file</span><span class=\"crayon-h\">                </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">etc</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ld</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">so</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">cache</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efc5356180302-4\"><span class=\"crayon-cn\">12420</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">file</span><span class=\"crayon-h\">                </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib64</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">libmagic</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">so</span><span class=\"crayon-sy\">.</span><span class=\"crayon-cn\">1</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efc5356180302-5\"><span class=\"crayon-cn\">12420</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">file</span><span class=\"crayon-h\">                </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib64</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">libz</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">so</span><span class=\"crayon-sy\">.</span><span class=\"crayon-cn\">1</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efc5356180302-6\"><span class=\"crayon-cn\">12420</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">file</span><span class=\"crayon-h\">                </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib64</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">libc</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">so</span><span class=\"crayon-sy\">.</span><span class=\"crayon-cn\">6</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efc5356180302-7\"><span class=\"crayon-cn\">12420</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">file</span><span class=\"crayon-h\">                </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">locale</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">locale</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">archive</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efc5356180302-8\"><span class=\"crayon-cn\">12420</span><span class=\"crayon-h\">  </span><span class=\"crayon-v\">file</span><span class=\"crayon-h\">               </span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">2</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">etc</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">magic</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">mgc</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efc5356180302-9\"><span class=\"crayon-cn\">12420</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">file</span><span class=\"crayon-h\">                </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">etc</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">magic</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efc5356180302-10\"><span class=\"crayon-cn\">12420</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">file</span><span class=\"crayon-h\">                </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">share</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">misc</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">magic</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">mgc</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efc5356180302-11\"><span class=\"crayon-cn\">12420</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">file</span><span class=\"crayon-h\">                </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib64</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">gconv</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">gconv</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">modules</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">cache</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efc5356180302-12\"><span class=\"crayon-cn\">12420</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">file</span><span class=\"crayon-h\">                </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">libexec</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">grepconf</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">sh</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efc5356180302-13\"><span class=\"crayon-cn\">1</span><span class=\"crayon-h\">      </span><span class=\"crayon-i\">systemd</span><span class=\"crayon-h\">            </span><span class=\"crayon-cn\">16</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">proc</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">565</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">cgroup</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efc5356180302-14\"><span class=\"crayon-cn\">1</span><span class=\"crayon-h\">      </span><span class=\"crayon-i\">systemd</span><span class=\"crayon-h\">            </span><span class=\"crayon-cn\">16</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">proc</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">536</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">cgroup</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efc5356180302-15\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0044 seconds] -->\r\n<p>像 <code>execsnoop</code> 和 <code>opensnoop</code> 这样的工具会将每个事件打印一行。上图显示 <code>file(1)</code> 命令当前打开（或尝试打开）的文件：返回的文件描述符（“FD” 列）对于 <code>/etc/magic.mgc</code> 是 -1，而 “ERR” 列指示它是“文件未找到”。我不知道该文件，也不知道 <code>file(1)</code> 正在读取的 <code>/usr/share/misc/magic.mgc</code> 文件是什么。我不应该感到惊讶，但是 <code>file(1)</code> 在识别文件类型时没有问题：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3439b69efca542496684\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n# file /usr/share/misc/magic.mgc /etc/magic\r\n/usr/share/misc/magic.mgc: magic binary file for file(1) cmd (version 14) (little endian)\r\n/etc/magic:                magic text file for file(1) cmd, ASCII text\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efca542496684-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efca542496684-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efca542496684-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efca542496684-4\">4</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3439b69efca542496684-1\"><span class=\"crayon-p\"># file /usr/share/misc/magic.mgc /etc/magic</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efca542496684-2\"><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">share</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">misc</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">magic</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">mgc</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">magic </span><span class=\"crayon-e\">binary </span><span class=\"crayon-e\">file </span><span class=\"crayon-st\">for</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">file</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">cmd</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">version</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">14</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">little </span><span class=\"crayon-v\">endian</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efca542496684-3\"><span class=\"crayon-o\">/</span><span class=\"crayon-v\">etc</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">magic</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">                </span><span class=\"crayon-e\">magic </span><span class=\"crayon-e\">text </span><span class=\"crayon-e\">file </span><span class=\"crayon-st\">for</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">file</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">cmd</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ASCII </span><span class=\"crayon-i\">text</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efca542496684-4\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0014 seconds] -->\r\n<p><code>opensnoop</code> 通过跟踪 <code>open()</code> 系统调用来工作。为什么不使用 <code>strace -feopen file</code> 命令呢？ 在这种情况下是可以的。然而，<code>opensnoop</code> 的一些优点在于它能在系统范围内工作，并且跟踪所有进程的 <code>open()</code> 系统调用。注意上例的输出中包括了从 systemd 打开的文件。<code>opensnoop</code> 应该系统开销更低：BPF 跟踪已经被优化过，而当前版本的 <code>strace(1)</code> 仍然使用较老和较慢的 <code>ptrace(2)</code> 接口。</p>\n<h4 id=\"toc_4\">3、 xfsslower</h4>\n<p>bcc/BPF 不仅仅可以分析系统调用。<a href=\"https://github.com/iovisor/bcc/blob/master/tools/xfsslower.py\">xfsslower</a> 工具可以跟踪大于 1 毫秒（参数）延迟的常见 XFS 文件系统操作。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3439b69efce008856327\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n# /usr/share/bcc/tools/xfsslower 1\r\nTracing XFS operations slower than 1 ms\r\nTIME     COMM           PID    T BYTES   OFF_KB   LAT(ms) FILENAME\r\n14:17:34 systemd-journa 530    S 0       0           1.69 system.journal\r\n14:17:35 auditd         651    S 0       0           2.43 audit.log\r\n14:17:42 cksum          4167   R 52976   0           1.04 at\r\n14:17:45 cksum          4168   R 53264   0           1.62 [\r\n14:17:45 cksum          4168   R 65536   0           1.01 certutil\r\n14:17:45 cksum          4168   R 65536   0           1.01 dir\r\n14:17:45 cksum          4168   R 65536   0           1.17 dirmngr-client\r\n14:17:46 cksum          4168   R 65536   0           1.06 grub2-file\r\n14:17:46 cksum          4168   R 65536   128         1.01 grub2-fstest\r\n[...]\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efce008856327-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efce008856327-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efce008856327-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efce008856327-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efce008856327-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efce008856327-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efce008856327-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efce008856327-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efce008856327-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efce008856327-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efce008856327-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efce008856327-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efce008856327-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efce008856327-14\">14</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3439b69efce008856327-1\"><span class=\"crayon-p\"># /usr/share/bcc/tools/xfsslower 1</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efce008856327-2\"><span class=\"crayon-e\">Tracing </span><span class=\"crayon-e\">XFS </span><span class=\"crayon-e\">operations </span><span class=\"crayon-e\">slower </span><span class=\"crayon-i\">than</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ms</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efce008856327-3\"><span class=\"crayon-e\">TIME     </span><span class=\"crayon-e\">COMM           </span><span class=\"crayon-i\">PID</span><span class=\"crayon-h\">    </span><span class=\"crayon-i\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">BYTES   </span><span class=\"crayon-e\">OFF_KB   </span><span class=\"crayon-e\">LAT</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">ms</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">FILENAME</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efce008856327-4\"><span class=\"crayon-cn\">14</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">17</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">34</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">systemd</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">journa</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">530</span><span class=\"crayon-h\">    </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">           </span><span class=\"crayon-cn\">1.69</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">system</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">journal</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efce008856327-5\"><span class=\"crayon-cn\">14</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">17</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">35</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">auditd</span><span class=\"crayon-h\">         </span><span class=\"crayon-cn\">651</span><span class=\"crayon-h\">    </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">           </span><span class=\"crayon-cn\">2.43</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">audit</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">log</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efce008856327-6\"><span class=\"crayon-cn\">14</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">17</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">42</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">cksum</span><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">4167</span><span class=\"crayon-h\">   </span><span class=\"crayon-i\">R</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">52976</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">           </span><span class=\"crayon-cn\">1.04</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">at</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efce008856327-7\"><span class=\"crayon-cn\">14</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">17</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">45</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">cksum</span><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">4168</span><span class=\"crayon-h\">   </span><span class=\"crayon-i\">R</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">53264</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">           </span><span class=\"crayon-cn\">1.62</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efce008856327-8\"><span class=\"crayon-cn\">14</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">17</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">45</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">cksum</span><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">4168</span><span class=\"crayon-h\">   </span><span class=\"crayon-i\">R</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">65536</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">           </span><span class=\"crayon-cn\">1.01</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">certutil</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efce008856327-9\"><span class=\"crayon-cn\">14</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">17</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">45</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">cksum</span><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">4168</span><span class=\"crayon-h\">   </span><span class=\"crayon-i\">R</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">65536</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">           </span><span class=\"crayon-cn\">1.01</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">dir</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efce008856327-10\"><span class=\"crayon-cn\">14</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">17</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">45</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">cksum</span><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">4168</span><span class=\"crayon-h\">   </span><span class=\"crayon-i\">R</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">65536</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">           </span><span class=\"crayon-cn\">1.17</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dirmngr</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">client</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efce008856327-11\"><span class=\"crayon-cn\">14</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">17</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">46</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">cksum</span><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">4168</span><span class=\"crayon-h\">   </span><span class=\"crayon-i\">R</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">65536</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">           </span><span class=\"crayon-cn\">1.06</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">grub2</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">file</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efce008856327-12\"><span class=\"crayon-cn\">14</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">17</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">46</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">cksum</span><span class=\"crayon-h\">          </span><span class=\"crayon-cn\">4168</span><span class=\"crayon-h\">   </span><span class=\"crayon-i\">R</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">65536</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">128</span><span class=\"crayon-h\">         </span><span class=\"crayon-cn\">1.01</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">grub2</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">fstest</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efce008856327-13\"><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efce008856327-14\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0049 seconds] -->\r\n<p>在上图输出中，我捕获到了多个延迟超过 1 毫秒 的 <code>cksum(1)</code> 读取操作（字段 “T” 等于 “R”）。这是在 <code>xfsslower</code> 工具运行的时候，通过在 XFS 中动态地检测内核函数实现的，并当它结束的时候解除该检测。这个 bcc 工具也有其它文件系统的版本：<code>ext4slower</code>、<code>btrfsslower</code>、<code>zfsslower</code> 和 <code>nfsslower</code>。</p>\n<p>这是个有用的工具，也是 BPF 追踪的重要例子。对文件系统性能的传统分析主要集中在块 I/O 统计信息 —— 通常你看到的是由 <code>iostat(1)</code> 工具输出，并由许多性能监视 GUI 绘制的图表。这些统计数据显示的是磁盘如何执行，而不是真正的文件系统如何执行。通常比起磁盘来说，你更关心的是文件系统的性能，因为应用程序是在文件系统中发起请求和等待。并且，文件系统的性能可能与磁盘的性能大为不同！文件系统可以完全从内存缓存中读取数据，也可以通过预读算法和回写缓存来填充缓存。<code>xfsslower</code> 显示了文件系统的性能 —— 这是应用程序直接体验到的性能。通常这对于排除整个存储子系统的问题是有用的；如果确实没有文件系统延迟，那么性能问题很可能是在别处。</p>\n<h4 id=\"toc_5\">4、 biolatency</h4>\n<p>虽然文件系统性能对于理解应用程序性能非常重要，但研究磁盘性能也是有好处的。当各种缓存技巧都无法挽救其延迟时，磁盘的低性能终会影响应用程序。 磁盘性能也是容量规划研究的目标。</p>\n<p><code>iostat(1)</code> 工具显示了平均磁盘 I/O 延迟，但平均值可能会引起误解。 以直方图的形式研究 I/O 延迟的分布是有用的，这可以通过使用 [biolatency] 来实现<a href=\"https://github.com/iovisor/bcc/blob/master/tools/biolatency.py\">18</a>：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3439b69efd4314076822\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n# /usr/share/bcc/tools/biolatency\r\nTracing block device I/O... Hit Ctrl-C to end.\r\n^C\r\n     usecs               : count     distribution\r\n         0 -&gt; 1          : 0        |                                        |\r\n         2 -&gt; 3          : 0        |                                        |\r\n         4 -&gt; 7          : 0        |                                        |\r\n         8 -&gt; 15         : 0        |                                        |\r\n        16 -&gt; 31         : 0        |                                        |\r\n        32 -&gt; 63         : 1        |                                        |\r\n        64 -&gt; 127        : 63       |****                                    |\r\n       128 -&gt; 255        : 121      |*********                               |\r\n       256 -&gt; 511        : 483      |************************************    |\r\n       512 -&gt; 1023       : 532      |****************************************|\r\n      1024 -&gt; 2047       : 117      |********                                |\r\n      2048 -&gt; 4095       : 8        |                                        |\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efd4314076822-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efd4314076822-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efd4314076822-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efd4314076822-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efd4314076822-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efd4314076822-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efd4314076822-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efd4314076822-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efd4314076822-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efd4314076822-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efd4314076822-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efd4314076822-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efd4314076822-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efd4314076822-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efd4314076822-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efd4314076822-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efd4314076822-17\">17</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3439b69efd4314076822-1\"><span class=\"crayon-p\"># /usr/share/bcc/tools/biolatency</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efd4314076822-2\"><span class=\"crayon-e\">Tracing </span><span class=\"crayon-e\">block </span><span class=\"crayon-i\">device</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">I</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">O</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Hit </span><span class=\"crayon-v\">Ctrl</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">C</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">to</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">end</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efd4314076822-3\"><span class=\"crayon-o\">^</span><span class=\"crayon-i\">C</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efd4314076822-4\"><span class=\"crayon-h\">     </span><span class=\"crayon-v\">usecs</span><span class=\"crayon-h\">               </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">count     </span><span class=\"crayon-i\">distribution</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efd4314076822-5\"><span class=\"crayon-h\">         </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\">          </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">        </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\">                                        </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efd4314076822-6\"><span class=\"crayon-h\">         </span><span class=\"crayon-cn\">2</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\">          </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">        </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\">                                        </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efd4314076822-7\"><span class=\"crayon-h\">         </span><span class=\"crayon-cn\">4</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">7</span><span class=\"crayon-h\">          </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">        </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\">                                        </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efd4314076822-8\"><span class=\"crayon-h\">         </span><span class=\"crayon-cn\">8</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">15</span><span class=\"crayon-h\">         </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">        </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\">                                        </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efd4314076822-9\"><span class=\"crayon-h\">        </span><span class=\"crayon-cn\">16</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">31</span><span class=\"crayon-h\">         </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">        </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\">                                        </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efd4314076822-10\"><span class=\"crayon-h\">        </span><span class=\"crayon-cn\">32</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">63</span><span class=\"crayon-h\">         </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\">        </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\">                                        </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efd4314076822-11\"><span class=\"crayon-h\">        </span><span class=\"crayon-cn\">64</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">127</span><span class=\"crayon-h\">        </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">63</span><span class=\"crayon-h\">       </span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\">                                    </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efd4314076822-12\"><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">128</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">255</span><span class=\"crayon-h\">        </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">121</span><span class=\"crayon-h\">      </span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\">                               </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efd4314076822-13\"><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">256</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">511</span><span class=\"crayon-h\">        </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">483</span><span class=\"crayon-h\">      </span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\">    </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efd4314076822-14\"><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">512</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1023</span><span class=\"crayon-h\">       </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">532</span><span class=\"crayon-h\">      </span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efd4314076822-15\"><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">1024</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">2047</span><span class=\"crayon-h\">       </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">117</span><span class=\"crayon-h\">      </span><span class=\"crayon-o\">|</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-o\">*</span><span class=\"crayon-h\">                                </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efd4314076822-16\"><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">2048</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">4095</span><span class=\"crayon-h\">       </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">8</span><span class=\"crayon-h\">        </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\">                                        </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efd4314076822-17\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0063 seconds] -->\r\n<p>这是另一个有用的工具和例子；它使用一个名为 maps 的 BPF 特性，它可以用来实现高效的内核摘要统计。从内核层到用户层的数据传输仅仅是“计数”列。 用户级程序生成其余的。</p>\n<p>值得注意的是，这种工具大多支持 CLI 选项和参数，如其使用信息所示：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3439b69efd8954904989\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n# /usr/share/bcc/tools/biolatency -h\r\nusage: biolatency [-h] [-T] [-Q] [-m] [-D] [interval] [count]\r\n\r\nSummarize block device I/O latency as a histogram\r\n\r\npositional arguments:\r\n  interval            output interval, in seconds\r\n  count               number of outputs\r\n\r\noptional arguments:\r\n  -h, --help          show this help message and exit\r\n  -T, --timestamp     include timestamp on output\r\n  -Q, --queued        include OS queued time in I/O time\r\n  -m, --milliseconds  millisecond histogram\r\n  -D, --disks         print a histogram per disk device\r\n\r\nexamples:\r\n    ./biolatency            # summarize block I/O latency as a histogram\r\n    ./biolatency 1 10       # print 1 second summaries, 10 times\r\n    ./biolatency -mT 1      # 1s summaries, milliseconds, and timestamps\r\n    ./biolatency -Q         # include OS queued time in I/O time\r\n    ./biolatency -D         # show each disk device separately\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efd8954904989-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efd8954904989-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efd8954904989-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efd8954904989-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efd8954904989-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efd8954904989-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efd8954904989-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efd8954904989-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efd8954904989-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efd8954904989-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efd8954904989-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efd8954904989-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efd8954904989-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efd8954904989-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efd8954904989-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efd8954904989-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efd8954904989-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efd8954904989-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efd8954904989-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efd8954904989-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efd8954904989-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efd8954904989-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efd8954904989-23\">23</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3439b69efd8954904989-1\"><span class=\"crayon-p\"># /usr/share/bcc/tools/biolatency -h</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efd8954904989-2\"><span class=\"crayon-v\">usage</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">biolatency</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">h</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">T</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">Q</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">m</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">D</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">interval</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">count</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efd8954904989-3\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efd8954904989-4\"><span class=\"crayon-e\">Summarize </span><span class=\"crayon-e\">block </span><span class=\"crayon-i\">device</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">I</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">O</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">latency </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">a</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">histogram</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efd8954904989-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efd8954904989-6\"><span class=\"crayon-e\">positional </span><span class=\"crayon-v\">arguments</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efd8954904989-7\"><span class=\"crayon-h\">  </span><span class=\"crayon-e\">interval            </span><span class=\"crayon-e\">output </span><span class=\"crayon-v\">interval</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">in</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">seconds</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efd8954904989-8\"><span class=\"crayon-e\">  </span><span class=\"crayon-e\">count               </span><span class=\"crayon-e\">number </span><span class=\"crayon-e\">of </span><span class=\"crayon-e\">outputs</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efd8954904989-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efd8954904989-10\"><span class=\"crayon-e\">optional </span><span class=\"crayon-v\">arguments</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efd8954904989-11\"><span class=\"crayon-h\">  </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">h</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-e\">help          </span><span class=\"crayon-e\">show </span><span class=\"crayon-r\">this</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">help </span><span class=\"crayon-e\">message </span><span class=\"crayon-st\">and</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">exit</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efd8954904989-12\"><span class=\"crayon-h\">  </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">T</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-e\">timestamp     </span><span class=\"crayon-e\">include </span><span class=\"crayon-e\">timestamp </span><span class=\"crayon-e\">on </span><span class=\"crayon-v\">output</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efd8954904989-13\"><span class=\"crayon-h\">  </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">Q</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-e\">queued        </span><span class=\"crayon-e\">include </span><span class=\"crayon-e\">OS </span><span class=\"crayon-e\">queued </span><span class=\"crayon-e\">time </span><span class=\"crayon-st\">in</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">I</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">O</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">time</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efd8954904989-14\"><span class=\"crayon-h\">  </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">m</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-e\">milliseconds  </span><span class=\"crayon-e\">millisecond </span><span class=\"crayon-v\">histogram</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efd8954904989-15\"><span class=\"crayon-h\">  </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">D</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-e\">disks         </span><span class=\"crayon-i\">print</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">a</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">histogram </span><span class=\"crayon-e\">per </span><span class=\"crayon-e\">disk </span><span class=\"crayon-e\">device</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efd8954904989-16\"> </div><div class=\"crayon-line\" id=\"crayon-5a3439b69efd8954904989-17\"><span class=\"crayon-v\">examples</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efd8954904989-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">biolatency</span><span class=\"crayon-h\">            </span><span class=\"crayon-p\"># summarize block I/O latency as a histogram</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efd8954904989-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">biolatency</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">10</span><span class=\"crayon-h\">       </span><span class=\"crayon-p\"># print 1 second summaries, 10 times</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efd8954904989-20\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">biolatency</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">mT</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\">      </span><span class=\"crayon-p\"># 1s summaries, milliseconds, and timestamps</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efd8954904989-21\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">biolatency</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">Q</span><span class=\"crayon-h\">         </span><span class=\"crayon-p\"># include OS queued time in I/O time</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efd8954904989-22\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">biolatency</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">D</span><span class=\"crayon-h\">         </span><span class=\"crayon-p\"># show each disk device separately</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efd8954904989-23\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0039 seconds] -->\r\n<p>它们的行为就像其它 Unix 工具一样，以利于采用而设计。</p>\n<h4 id=\"toc_6\">5、 tcplife</h4>\n<p>另一个有用的工具是 <a href=\"https://github.com/iovisor/bcc/blob/master/tools/tcplife.py\">tcplife</a> ，该例显示 TCP 会话的生命周期和吞吐量统计。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3439b69efdc099073512\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n# /usr/share/bcc/tools/tcplife\r\nPID   COMM       LADDR           LPORT RADDR           RPORT TX_KB RX_KB MS\r\n12759 sshd       192.168.56.101  22    192.168.56.1    60639     2     3 1863.82\r\n12783 sshd       192.168.56.101  22    192.168.56.1    60640     3     3 9174.53\r\n12844 wget       10.0.2.15       34250 54.204.39.132   443      11  1870 5712.26\r\n12851 curl       10.0.2.15       34252 54.204.39.132   443       0    74 505.90\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efdc099073512-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efdc099073512-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efdc099073512-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efdc099073512-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efdc099073512-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efdc099073512-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efdc099073512-7\">7</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3439b69efdc099073512-1\"><span class=\"crayon-p\"># /usr/share/bcc/tools/tcplife</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efdc099073512-2\"><span class=\"crayon-e\">PID   </span><span class=\"crayon-e\">COMM       </span><span class=\"crayon-e\">LADDR           </span><span class=\"crayon-e\">LPORT </span><span class=\"crayon-e\">RADDR           </span><span class=\"crayon-e\">RPORT </span><span class=\"crayon-e\">TX_KB </span><span class=\"crayon-e\">RX_KB </span><span class=\"crayon-i\">MS</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efdc099073512-3\"><span class=\"crayon-cn\">12759</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">sshd</span><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">192.168.56.101</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">22</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">192.168.56.1</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">60639</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">2</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1863.82</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efdc099073512-4\"><span class=\"crayon-cn\">12783</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">sshd</span><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">192.168.56.101</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">22</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">192.168.56.1</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">60640</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\">     </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">9174.53</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efdc099073512-5\"><span class=\"crayon-cn\">12844</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">wget</span><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">10.0.2.15</span><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">34250</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">54.204.39.132</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">443</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">11</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">1870</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">5712.26</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efdc099073512-6\"><span class=\"crayon-cn\">12851</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">curl</span><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">10.0.2.15</span><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">34252</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">54.204.39.132</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">443</span><span class=\"crayon-h\">       </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">74</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">505.90</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efdc099073512-7\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0019 seconds] -->\r\n<p>在你说 “我不是可以只通过 <code>tcpdump(8)</code> 就能输出这个？” 之前请注意，运行 <code>tcpdump(8)</code> 或任何数据包嗅探器，在高数据包速率的系统上的开销会很大，即使 <code>tcpdump(8)</code> 的用户层和内核层机制已经过多年优化（要不可能更差）。<code>tcplife</code> 不会测试每个数据包；它只会有效地监视 TCP 会话状态的变化，并由此得到该会话的持续时间。它还使用已经跟踪了吞吐量的内核计数器，以及进程和命令信息（“PID” 和 “COMM” 列），这些对于 <code>tcpdump(8)</code> 等线上嗅探工具是做不到的。</p>\n<h4 id=\"toc_7\">6、 gethostlatency</h4>\n<p>之前的每个例子都涉及到内核跟踪，所以我至少需要一个用户级跟踪的例子。 这就是 <a href=\"https://github.com/iovisor/bcc/blob/master/tools/gethostlatency.py\">gethostlatency</a>，它检测用于名称解析的 <code>gethostbyname(3)</code> 和相关的库调用：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3439b69efe0725366667\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n# /usr/share/bcc/tools/gethostlatency\r\nTIME      PID    COMM                  LATms HOST\r\n06:43:33  12903  curl                 188.98 opensource.com\r\n06:43:36  12905  curl                   8.45 opensource.com\r\n06:43:40  12907  curl                   6.55 opensource.com\r\n06:43:44  12911  curl                   9.67 opensource.com\r\n06:45:02  12948  curl                  19.66 opensource.cats\r\n06:45:06  12950  curl                  18.37 opensource.cats\r\n06:45:07  12952  curl                  13.64 opensource.cats\r\n06:45:19  13139  curl                  13.10 opensource.cats\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efe0725366667-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efe0725366667-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efe0725366667-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efe0725366667-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efe0725366667-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efe0725366667-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efe0725366667-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efe0725366667-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efe0725366667-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efe0725366667-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efe0725366667-11\">11</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3439b69efe0725366667-1\"><span class=\"crayon-p\"># /usr/share/bcc/tools/gethostlatency</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efe0725366667-2\"><span class=\"crayon-e\">TIME      </span><span class=\"crayon-e\">PID    </span><span class=\"crayon-e\">COMM                  </span><span class=\"crayon-e\">LATms </span><span class=\"crayon-i\">HOST</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efe0725366667-3\"><span class=\"crayon-cn\">06</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">43</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">33</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12903</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">curl</span><span class=\"crayon-h\">                 </span><span class=\"crayon-cn\">188.98</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">opensource</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">com</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efe0725366667-4\"><span class=\"crayon-cn\">06</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">43</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">36</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12905</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">curl</span><span class=\"crayon-h\">                   </span><span class=\"crayon-cn\">8.45</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">opensource</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">com</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efe0725366667-5\"><span class=\"crayon-cn\">06</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">43</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">40</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12907</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">curl</span><span class=\"crayon-h\">                   </span><span class=\"crayon-cn\">6.55</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">opensource</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">com</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efe0725366667-6\"><span class=\"crayon-cn\">06</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">43</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">44</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12911</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">curl</span><span class=\"crayon-h\">                   </span><span class=\"crayon-cn\">9.67</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">opensource</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">com</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efe0725366667-7\"><span class=\"crayon-cn\">06</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">45</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">02</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12948</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">curl</span><span class=\"crayon-h\">                  </span><span class=\"crayon-cn\">19.66</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">opensource</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">cats</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efe0725366667-8\"><span class=\"crayon-cn\">06</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">45</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">06</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12950</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">curl</span><span class=\"crayon-h\">                  </span><span class=\"crayon-cn\">18.37</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">opensource</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">cats</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efe0725366667-9\"><span class=\"crayon-cn\">06</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">45</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">07</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">12952</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">curl</span><span class=\"crayon-h\">                  </span><span class=\"crayon-cn\">13.64</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">opensource</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">cats</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efe0725366667-10\"><span class=\"crayon-cn\">06</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">45</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">19</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">13139</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">curl</span><span class=\"crayon-h\">                  </span><span class=\"crayon-cn\">13.10</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">opensource</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">cats</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efe0725366667-11\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0030 seconds] -->\r\n<p>是的，总是有 DNS 请求，所以有一个工具来监视系统范围内的 DNS 请求会很方便（这只有在应用程序使用标准系统库时才有效）。看看我如何跟踪多个对 “opensource.com” 的查找？ 第一个是 188.98 毫秒，然后更快，不到 10 毫秒，毫无疑问，这是缓存的作用。它还追踪多个对 “opensource.cats” 的查找，一个不存在的可怜主机名，但我们仍然可以检查第一个和后续查找的延迟。（第二次查找后是否有一些否定缓存的影响？）</p>\n<h4 id=\"toc_8\">7、 trace</h4>\n<p>好的，再举一个例子。 <a href=\"https://github.com/iovisor/bcc/blob/master/tools/trace.py\">trace</a> 工具由 Sasha Goldshtein 提供，并提供了一些基本的 <code>printf(1)</code> 功能和自定义探针。 例如：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3439b69efe4892113321\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n# /usr/share/bcc/tools/trace 'pam:pam_start \"%s: %s\", arg1, arg2'\r\nPID    TID    COMM         FUNC             -\r\n13266  13266  sshd         pam_start        sshd: root\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efe4892113321-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efe4892113321-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efe4892113321-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efe4892113321-4\">4</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3439b69efe4892113321-1\"><span class=\"crayon-p\"># /usr/share/bcc/tools/trace 'pam:pam_start \"%s: %s\", arg1, arg2'</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efe4892113321-2\"><span class=\"crayon-e\">PID    </span><span class=\"crayon-e\">TID    </span><span class=\"crayon-e\">COMM         </span><span class=\"crayon-v\">FUNC</span><span class=\"crayon-h\">             </span><span class=\"crayon-o\">-</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efe4892113321-3\"><span class=\"crayon-cn\">13266</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">13266</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">sshd         </span><span class=\"crayon-e\">pam_start        </span><span class=\"crayon-v\">sshd</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">root</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efe4892113321-4\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n<p>在这里，我正在跟踪 <code>libpam</code> 及其 <code>pam_start(3)</code> 函数，并将其两个参数都打印为字符串。 <code>libpam</code> 用于插入式身份验证模块系统，该输出显示 sshd 为 “root” 用户调用了 <code>pam_start()</code>（我登录了）。 其使用信息中有更多的例子（<code>trace -h</code>），而且所有这些工具在 bcc 版本库中都有手册页和示例文件。 例如 <code>trace_example.txt</code> 和 <code>trace.8</code>。</p>\n<h3 id=\"toc_9\">通过包安装 bcc</h3>\n<p>安装 bcc 最佳的方法是从 iovisor 仓储库中安装，按照 bcc 的 <a href=\"https://github.com/iovisor/bcc/blob/master/INSTALL.md#fedora---binary\">INSTALL.md</a> 进行即可。<a href=\"https://www.iovisor.org/\">IO Visor</a> 是包括了 bcc 的 Linux 基金会项目。4.x 系列 Linux 内核中增加了这些工具所使用的 BPF 增强功能，直到 4.9 添加了全部支持。这意味着拥有 4.8 内核的 Fedora 25 可以运行这些工具中的大部分。 使用 4.11 内核的 Fedora 26 可以全部运行它们（至少在目前是这样）。</p>\n<p>如果你使用的是 Fedora 25（或者 Fedora 26，而且这个帖子已经在很多个月前发布了 —— 你好，来自遥远的过去！），那么这个通过包安装的方式是可以工作的。 如果您使用的是 Fedora 26，那么请跳至“通过源代码安装”部分，它避免了一个<a href=\"https://reviews.llvm.org/rL302055\">已修复的</a>的<a href=\"https://github.com/iovisor/bcc/issues/1221\">已知</a>错误。 这个错误修复目前还没有进入 Fedora 26 软件包的依赖关系。 我使用的系统是：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3439b69efe8384779233\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n# uname -a\r\nLinux localhost.localdomain 4.11.8-300.fc26.x86_64 #1 SMP Thu Jun 29 20:09:48 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n# cat /etc/fedora-release\r\nFedora release 26 (Twenty Six)\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efe8384779233-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efe8384779233-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efe8384779233-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efe8384779233-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efe8384779233-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3439b69efe8384779233-1\"><span class=\"crayon-p\"># uname -a</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efe8384779233-2\"><span class=\"crayon-e\">Linux </span><span class=\"crayon-v\">localhost</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">localdomain</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">4.11.8</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">300.fc26.x86_64</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\">#1 SMP Thu Jun 29 20:09:48 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efe8384779233-3\"><span class=\"crayon-p\"># cat /etc/fedora-release</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efe8384779233-4\"><span class=\"crayon-e\">Fedora </span><span class=\"crayon-i\">release</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">26</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">Twenty </span><span class=\"crayon-v\">Six</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efe8384779233-5\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p>以下是我所遵循的安装步骤，但请参阅 INSTALL.md 获取更新的版本：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3439b69efeb264193624\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n# echo -e '[iovisor]\\nbaseurl=https://repo.iovisor.org/yum/nightly/f25/$basearch\\nenabled=1\\ngpgcheck=0' | sudo tee /etc/yum.repos.d/iovisor.repo\r\n# dnf install bcc-tools\r\n[...]\r\nTotal download size: 37 M\r\nInstalled size: 143 M\r\nIs this ok [y/N]: y\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efeb264193624-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efeb264193624-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efeb264193624-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efeb264193624-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efeb264193624-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efeb264193624-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efeb264193624-7\">7</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3439b69efeb264193624-1\"><span class=\"crayon-p\"># echo -e '[iovisor]\\nbaseurl=https://repo.iovisor.org/yum/nightly/f25/$basearch\\nenabled=1\\ngpgcheck=0' | sudo tee /etc/yum.repos.d/iovisor.repo</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efeb264193624-2\"><span class=\"crayon-p\"># dnf install bcc-tools</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efeb264193624-3\"><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efeb264193624-4\"><span class=\"crayon-e\">Total </span><span class=\"crayon-e\">download </span><span class=\"crayon-v\">size</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">37</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">M</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efeb264193624-5\"><span class=\"crayon-e\">Installed </span><span class=\"crayon-v\">size</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">143</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">M</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efeb264193624-6\"><span class=\"crayon-st\">Is</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">this</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">ok</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">y</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">N</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">y</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efeb264193624-7\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0011 seconds] -->\r\n<p>安装完成后，您可以在 <code>/usr/share</code> 中看到新的工具：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3439b69efef521182841\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n# ls /usr/share/bcc/tools/\r\nargdist       dcsnoop              killsnoop       softirqs    trace\r\nbashreadline  dcstat               llcstat         solisten    ttysnoop\r\n[...]\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efef521182841-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efef521182841-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efef521182841-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69efef521182841-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69efef521182841-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3439b69efef521182841-1\"><span class=\"crayon-p\"># ls /usr/share/bcc/tools/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efef521182841-2\"><span class=\"crayon-e\">argdist       </span><span class=\"crayon-e\">dcsnoop              </span><span class=\"crayon-e\">killsnoop       </span><span class=\"crayon-e\">softirqs    </span><span class=\"crayon-e\">trace</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efef521182841-3\"><span class=\"crayon-e\">bashreadline  </span><span class=\"crayon-e\">dcstat               </span><span class=\"crayon-e\">llcstat         </span><span class=\"crayon-e\">solisten    </span><span class=\"crayon-i\">ttysnoop</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69efef521182841-4\"><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69efef521182841-5\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p>试着运行其中一个：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3439b69eff2491647958\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n# /usr/share/bcc/tools/opensnoop\r\nchdir(/lib/modules/4.11.8-300.fc26.x86_64/build): No such file or directory\r\nTraceback (most recent call last):\r\n  File \"/usr/share/bcc/tools/opensnoop\", line 126, in \r\n    b = BPF(text=bpf_text)\r\n  File \"/usr/lib/python3.6/site-packages/bcc/__init__.py\", line 284, in __init__\r\n    raise Exception(\"Failed to compile BPF module %s\" % src_file)\r\nException: Failed to compile BPF module\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3439b69eff2491647958-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69eff2491647958-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69eff2491647958-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69eff2491647958-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69eff2491647958-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69eff2491647958-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69eff2491647958-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69eff2491647958-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69eff2491647958-9\">9</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3439b69eff2491647958-1\"><span class=\"crayon-p\"># /usr/share/bcc/tools/opensnoop</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69eff2491647958-2\"><span class=\"crayon-e\">chdir</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">modules</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">4.11.8</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">300.fc26.x86_64</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">build</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">No </span><span class=\"crayon-e\">such </span><span class=\"crayon-e\">file </span><span class=\"crayon-st\">or</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">directory</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69eff2491647958-3\"><span class=\"crayon-e\">Traceback</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">most </span><span class=\"crayon-e\">recent </span><span class=\"crayon-e\">call </span><span class=\"crayon-v\">last</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69eff2491647958-4\"><span class=\"crayon-h\">  </span><span class=\"crayon-i\">File</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"/usr/share/bcc/tools/opensnoop\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">line</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">126</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">in</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69eff2491647958-5\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">b</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">BPF</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">text</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">bpf_text</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69eff2491647958-6\"><span class=\"crayon-h\">  </span><span class=\"crayon-i\">File</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"/usr/lib/python3.6/site-packages/bcc/__init__.py\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">line</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">284</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">in</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__init__</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69eff2491647958-7\"><span class=\"crayon-e\">    </span><span class=\"crayon-e\">raise </span><span class=\"crayon-e\">Exception</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"Failed to compile BPF module %s\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">%</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">src_file</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69eff2491647958-8\"><span class=\"crayon-v\">Exception</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Failed </span><span class=\"crayon-st\">to</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">compile </span><span class=\"crayon-e\">BPF </span><span class=\"crayon-i\">module</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69eff2491647958-9\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0021 seconds] -->\r\n<p>运行失败，提示 <code>/lib/modules/4.11.8-300.fc26.x86_64/build</code> 丢失。 如果你也遇到这个问题，那只是因为系统缺少内核头文件。 如果你看看这个文件指向什么（这是一个符号链接），然后使用 <code>dnf whatprovides</code> 来搜索它，它会告诉你接下来需要安装的包。 对于这个系统，它是：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3439b69eff6265654236\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n# dnf install kernel-devel-4.11.8-300.fc26.x86_64\r\n[...]\r\nTotal download size: 20 M\r\nInstalled size: 63 M\r\nIs this ok [y/N]: y\r\n[...]\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3439b69eff6265654236-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69eff6265654236-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69eff6265654236-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69eff6265654236-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69eff6265654236-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69eff6265654236-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69eff6265654236-7\">7</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3439b69eff6265654236-1\"><span class=\"crayon-p\"># dnf install kernel-devel-4.11.8-300.fc26.x86_64</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69eff6265654236-2\"><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69eff6265654236-3\"><span class=\"crayon-e\">Total </span><span class=\"crayon-e\">download </span><span class=\"crayon-v\">size</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">20</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">M</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69eff6265654236-4\"><span class=\"crayon-e\">Installed </span><span class=\"crayon-v\">size</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">63</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">M</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69eff6265654236-5\"><span class=\"crayon-st\">Is</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">this</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">ok</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">y</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">N</span><span class=\"crayon-sy\">]</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">y</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69eff6265654236-6\"><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69eff6265654236-7\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0013 seconds] -->\r\n<p>现在：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3439b69eff9118558310\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n# /usr/share/bcc/tools/opensnoop\r\nPID    COMM               FD ERR PATH\r\n11792  ls                  3   0 /etc/ld.so.cache\r\n11792  ls                  3   0 /lib64/libselinux.so.1\r\n11792  ls                  3   0 /lib64/libcap.so.2\r\n11792  ls                  3   0 /lib64/libc.so.6\r\n[...]\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3439b69eff9118558310-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69eff9118558310-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69eff9118558310-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69eff9118558310-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69eff9118558310-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69eff9118558310-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69eff9118558310-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69eff9118558310-8\">8</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3439b69eff9118558310-1\"><span class=\"crayon-p\"># /usr/share/bcc/tools/opensnoop</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69eff9118558310-2\"><span class=\"crayon-e\">PID    </span><span class=\"crayon-e\">COMM               </span><span class=\"crayon-e\">FD </span><span class=\"crayon-e\">ERR </span><span class=\"crayon-i\">PATH</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69eff9118558310-3\"><span class=\"crayon-cn\">11792</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">ls</span><span class=\"crayon-h\">                  </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">etc</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ld</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">so</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">cache</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69eff9118558310-4\"><span class=\"crayon-cn\">11792</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">ls</span><span class=\"crayon-h\">                  </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib64</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">libselinux</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">so</span><span class=\"crayon-sy\">.</span><span class=\"crayon-cn\">1</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69eff9118558310-5\"><span class=\"crayon-cn\">11792</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">ls</span><span class=\"crayon-h\">                  </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib64</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">libcap</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">so</span><span class=\"crayon-sy\">.</span><span class=\"crayon-cn\">2</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69eff9118558310-6\"><span class=\"crayon-cn\">11792</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">ls</span><span class=\"crayon-h\">                  </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib64</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">libc</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">so</span><span class=\"crayon-sy\">.</span><span class=\"crayon-cn\">6</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69eff9118558310-7\"><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69eff9118558310-8\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0021 seconds] -->\r\n<p>运行起来了。 这是捕获自另一个窗口中的 ls 命令活动。 请参阅前面的部分以使用其它有用的命令。</p>\n<h3 id=\"toc_10\">通过源码安装</h3>\n<p>如果您需要从源代码安装，您还可以在 <a href=\"https://github.com/iovisor/bcc/blob/master/INSTALL.md#fedora---source\">INSTALL.md</a> 中找到文档和更新说明。 我在 Fedora 26 上做了如下的事情：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3439b69effd987651146\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsudo dnf install -y bison cmake ethtool flex git iperf libstdc++-static \\\r\n  python-netaddr python-pip gcc gcc-c++ make zlib-devel \\\r\n  elfutils-libelf-devel\r\nsudo dnf install -y luajit luajit-devel  # for Lua support\r\nsudo dnf install -y \\\r\n  http://pkgs.repoforge.org/netperf/netperf-2.6.0-1.el6.rf.x86_64.rpm\r\nsudo pip install pyroute2\r\nsudo dnf install -y clang clang-devel llvm llvm-devel llvm-static ncurses-devel\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3439b69effd987651146-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69effd987651146-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69effd987651146-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69effd987651146-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69effd987651146-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69effd987651146-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69effd987651146-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69effd987651146-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69effd987651146-9\">9</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3439b69effd987651146-1\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-e\">dnf </span><span class=\"crayon-v\">install</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">y</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">bison </span><span class=\"crayon-e\">cmake </span><span class=\"crayon-e\">ethtool </span><span class=\"crayon-e\">flex </span><span class=\"crayon-e\">git </span><span class=\"crayon-e\">iperf </span><span class=\"crayon-v\">libstdc</span><span class=\"crayon-o\">++</span><span class=\"crayon-o\">-</span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">\\</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69effd987651146-2\"><span class=\"crayon-h\">  </span><span class=\"crayon-v\">python</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">netaddr </span><span class=\"crayon-v\">python</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">pip </span><span class=\"crayon-e\">gcc </span><span class=\"crayon-v\">gcc</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">c</span><span class=\"crayon-o\">++</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">make </span><span class=\"crayon-v\">zlib</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">devel</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">\\</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69effd987651146-3\"><span class=\"crayon-h\">  </span><span class=\"crayon-v\">elfutils</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">libelf</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">devel</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69effd987651146-4\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-e\">dnf </span><span class=\"crayon-v\">install</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">y</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">luajit </span><span class=\"crayon-v\">luajit</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">devel</span><span class=\"crayon-h\">  </span><span class=\"crayon-p\"># for Lua support</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69effd987651146-5\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-e\">dnf </span><span class=\"crayon-v\">install</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">y</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">\\</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69effd987651146-6\"><span class=\"crayon-h\">  </span><span class=\"crayon-v\">http</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//pkgs.repoforge.org/netperf/netperf-2.6.0-1.el6.rf.x86_64.rpm</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69effd987651146-7\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-e\">pip </span><span class=\"crayon-e\">install </span><span class=\"crayon-e\">pyroute2</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69effd987651146-8\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-e\">dnf </span><span class=\"crayon-v\">install</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">y</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">clang </span><span class=\"crayon-v\">clang</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">devel </span><span class=\"crayon-e\">llvm </span><span class=\"crayon-v\">llvm</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">devel </span><span class=\"crayon-v\">llvm</span><span class=\"crayon-o\">-</span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ncurses</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">devel</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69effd987651146-9\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0026 seconds] -->\r\n<p>除 <code>netperf</code> 外一切妥当，其中有以下错误：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3439b69f000930919477\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nCurl error (28): Timeout was reached for http://pkgs.repoforge.org/netperf/netperf-2.6.0-1.el6.rf.x86_64.rpm [Connection timed out after 120002 milliseconds]\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3439b69f000930919477-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69f000930919477-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3439b69f000930919477-1\"><span class=\"crayon-e\">Curl </span><span class=\"crayon-e\">error</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">28</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Timeout </span><span class=\"crayon-e\">was </span><span class=\"crayon-e\">reached </span><span class=\"crayon-st\">for</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">http</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//pkgs.repoforge.org/netperf/netperf-2.6.0-1.el6.rf.x86_64.rpm [Connection timed out after 120002 milliseconds]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69f000930919477-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p>不必理会，<code>netperf</code> 是可选的，它只是用于测试，而 bcc 没有它也会编译成功。</p>\n<p>以下是余下的 bcc 编译和安装步骤：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3439b69f004145520837\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ngit clone https://github.com/iovisor/bcc.git\r\nmkdir bcc/build; cd bcc/build\r\ncmake .. -DCMAKE_INSTALL_PREFIX=/usr\r\nmake\r\nsudo make install\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3439b69f004145520837-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69f004145520837-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69f004145520837-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69f004145520837-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69f004145520837-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69f004145520837-6\">6</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3439b69f004145520837-1\"><span class=\"crayon-e\">git </span><span class=\"crayon-r\">clone</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">https</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//github.com/iovisor/bcc.git</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69f004145520837-2\"><span class=\"crayon-e\">mkdir </span><span class=\"crayon-v\">bcc</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">build</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">cd </span><span class=\"crayon-v\">bcc</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">build</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69f004145520837-3\"><span class=\"crayon-i\">cmake</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">DCMAKE_INSTALL_PREFIX</span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">usr</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69f004145520837-4\"><span class=\"crayon-e\">make</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69f004145520837-5\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-e\">make </span><span class=\"crayon-i\">install</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69f004145520837-6\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n<p>现在，命令应该可以工作了：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3439b69f007623657995\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n# /usr/share/bcc/tools/opensnoop\r\nPID    COMM               FD ERR PATH\r\n4131   date                3   0 /etc/ld.so.cache\r\n4131   date                3   0 /lib64/libc.so.6\r\n4131   date                3   0 /usr/lib/locale/locale-archive\r\n4131   date                3   0 /etc/localtime\r\n[...]\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3439b69f007623657995-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69f007623657995-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69f007623657995-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69f007623657995-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69f007623657995-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69f007623657995-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a3439b69f007623657995-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3439b69f007623657995-8\">8</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3439b69f007623657995-1\"><span class=\"crayon-p\"># /usr/share/bcc/tools/opensnoop</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69f007623657995-2\"><span class=\"crayon-e\">PID    </span><span class=\"crayon-e\">COMM               </span><span class=\"crayon-e\">FD </span><span class=\"crayon-e\">ERR </span><span class=\"crayon-i\">PATH</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69f007623657995-3\"><span class=\"crayon-cn\">4131</span><span class=\"crayon-h\">   </span><span class=\"crayon-i\">date</span><span class=\"crayon-h\">                </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">etc</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ld</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">so</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">cache</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69f007623657995-4\"><span class=\"crayon-cn\">4131</span><span class=\"crayon-h\">   </span><span class=\"crayon-i\">date</span><span class=\"crayon-h\">                </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib64</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">libc</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">so</span><span class=\"crayon-sy\">.</span><span class=\"crayon-cn\">6</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69f007623657995-5\"><span class=\"crayon-cn\">4131</span><span class=\"crayon-h\">   </span><span class=\"crayon-i\">date</span><span class=\"crayon-h\">                </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">usr</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">lib</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">locale</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">locale</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">archive</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69f007623657995-6\"><span class=\"crayon-cn\">4131</span><span class=\"crayon-h\">   </span><span class=\"crayon-i\">date</span><span class=\"crayon-h\">                </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\">   </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">etc</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">localtime</span></div><div class=\"crayon-line\" id=\"crayon-5a3439b69f007623657995-7\"><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3439b69f007623657995-8\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0020 seconds] -->\r\n<p></p>\n<h3 id=\"toc_11\">写在最后和其他的前端</h3>\n<p>这是一个可以在 Fedora 和 Red Hat 系列操作系统上使用的新 BPF 性能分析强大功能的快速浏览。我演示了 BPF 的流行前端 <a href=\"https://github.com/iovisor/bcc\">bcc</a> ，并包括了其在 Fedora 上的安装说明。bcc 附带了 60 多个用于性能分析的新工具，这将帮助您充分利用 Linux 系统。也许你会直接通过 SSH 使用这些工具，或者一旦 GUI 监控程序支持 BPF 的话，你也可以通过它们来使用相同的功能。</p>\n<p>此外，bcc 并不是正在开发的唯一前端。<a href=\"https://github.com/iovisor/ply\">ply</a> 和 <a href=\"https://github.com/ajor/bpftrace\">bpftrace</a>，旨在为快速编写自定义工具提供更高级的语言支持。此外，<a href=\"https://sourceware.org/systemtap/\">SystemTap</a> 刚刚发布<a href=\"https://sourceware.org/ml/systemtap/2017-q4/msg00096.html\">版本 3.2</a>，包括一个早期的实验性 eBPF 后端。 如果这个继续开发，它将为运行多年来开发的许多 SystemTap 脚本和 tapset（库）提供一个安全和高效的生产级引擎。（随同 eBPF 使用 SystemTap 将是另一篇文章的主题。）</p>\n<p>如果您需要开发自定义工具，那么也可以使用 bcc 来实现，尽管语言比 SystemTap、ply 或 bpftrace 要冗长得多。我的 bcc 工具可以作为代码示例，另外我还贡献了用 Python 开发 bcc 工具的<a href=\"https://github.com/iovisor/bcc/blob/master/docs/tutorial_bcc_python_developer.md\">教程</a>。 我建议先学习 bcc 的 multi-tools，因为在需要编写新工具之前，你可能会从里面获得很多经验。 您可以从它们的 bcc 存储库<a href=\"https://github.com/iovisor/bcc/blob/master/tools/funccount_example.txt\">funccount</a>，<a href=\"https://github.com/iovisor/bcc/blob/master/tools/funclatency_example.txt\">funclatency</a>，<a href=\"https://github.com/iovisor/bcc/blob/master/tools/funcslower_example.txt\">funcslower</a>，<a href=\"https://github.com/iovisor/bcc/blob/master/tools/stackcount_example.txt\">stackcount</a>，<a href=\"https://github.com/iovisor/bcc/blob/master/tools/trace_example.txt\">trace</a> ，<a href=\"https://github.com/iovisor/bcc/blob/master/tools/argdist_example.txt\">argdist</a> 的示例文件中研究 bcc。</p>\n<p>感谢 <a href=\"http://opensource.com/\">Opensource.com</a> 进行编辑。</p>\n<h3 id=\"toc_12\">关于作者</h3>\n<p>Brendan Gregg 是 Netflix 的一名高级性能架构师，在那里他进行大规模的计算机性能设计、分析和调优。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113328\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113328votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113328\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "url": "http://blog.jobbole.com/113328/", "comment_nums": 0, "praise_nums": 1, "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2015/10/478116e0d2ac0c766a25a7c5d7252167.jpg"]},{"title": "MySQL 引擎特性：InnoDB IO 子系统", "url_object_id": "c69bda76164398ee6c9c06ef369e13ed", "create_date": "2017/12/12", "tags": "IT技术,MySQL,数据库", "fav_nums": 0, "front_image_path": "full/35011d6168be00e949624c665041dc724e3ad786.jpg", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/coderyuhui/p/6498382.html\">水中的泪</a>   </div><h2 id=\"前言\">前言</h2>\n<p>InnoDB做为一款成熟的跨平台数据库引擎，其实现了一套高效易用的IO接口，包括同步异步IO，IO合并等。本文简单介绍一下其内部实现，主要的代码集中在os0file.cc这个文件中。本文的分析默认基于MySQL 5.6，CentOS 6，gcc 4.8，其他版本的信息会另行指出。</p>\n<h2 id=\"基础知识\">基础知识</h2>\n<p><strong><em>WAL技术 :</em></strong> 日志先行技术，基本所有的数据库，都使用了这个技术。简单的说，就是需要写数据块的时候，数据库前台线程把对应的日志先写（批量顺序写）到磁盘上，然后就告诉客户端操作成功，至于真正写数据块的操作（离散随机写）则放到后台IO线程中。使用了这个技术，虽然多了一个磁盘写入操作，但是由于日志是批量顺序写，效率很高，所以客户端很快就能得到相应。此外，如果在真正的数据块落盘之前，数据库奔溃，重启时候，数据库可以使用日志来做崩溃恢复，不会导致数据丢失。<br>\n<strong><em>数据预读 :</em></strong> 与数据块A“相邻”的数据块B和C在A被读取的时候，B和C也会有很大的概率被读取，所以可以在读取B的时候，提前把他们读到内存中，这就是数据预读技术。这里说的相邻有两种含义，一种是物理上的相邻，一种是逻辑上的相邻。底层数据文件中相邻，叫做物理上相邻。如果数据文件中不相邻，但是逻辑上相邻（id=1的数据和id=2的数据，逻辑上相邻，但是物理上不一定相邻，可能存在同一个文件中不同的位置），则叫逻辑相邻。<br>\n<strong><em>文件打开模式 :</em></strong> Open系统调用常见的模式主要三种：O_DIRECT，O_SYNC以及default模式。O_DIRECT模式表示后续对文件的操作不使用文件系统的缓存，用户态直接操作设备文件，绕过了内核的缓存和优化，从另外一个角度来说，使用O_DIRECT模式进行写文件，如果返回成功，数据就真的落盘了（不考虑磁盘自带的缓存），使用O_DIRECT模式进行读文件，每次读操作是真的从磁盘中读取，不会从文件系统的缓存中读取。O_SYNC表示使用操作系统缓存，对文件的读写都经过内核，但是这个模式还保证每次写数据后，数据一定落盘。default模式与O_SYNC模式类似，只是写数据后不保证数据一定落盘，数据有可能还在文件系统中，当主机宕机，数据有可能丢失。<br>\n此外，写操作不仅需要修改或者增加的数据落盘，而且还需要文件元信息落盘，只有两部分都落盘了，才能保证数据不丢。O_DIRECT模式不保证文件元信息落盘(但大部分文件系统都保证，Bug #45892)，因此如果不做其他操作，用O_DIRECT写文件后，也存在丢失的风险。O_SYNC则保证数据和元信息都落盘。default模式两种数据都不保证。<br>\n调用函数fsync后，能保证数据和日志都落盘，因此使用O_DIRECT和default模式打开的文件，写完数据，需要调用fsync函数。<br>\n<strong><em>同步IO :</em></strong> 我们常用的read/write函数（Linux上）就是这类IO，特点是，在函数执行的时候，调用者会等待函数执行完成，而且没有消息通知机制，因为函数返回了，就表示操作完成了，后续直接检查返回值就可知道操作是否成功。这类IO操作，编程比较简单，在同一个线程中就能完成所有操作，但是需要调用者等待，在数据库系统中，比较适合急需某些数据的时候调用，例如WAL中日志必须在返回客户端前落盘，则进行一次同步IO操作。<br>\n<strong><em>异步IO :</em></strong> 在数据库中，后台刷数据块的IO线程，基本都使用了异步IO。数据库前台线程只需要把刷块请求提交到异步IO的队列中即可返回做其他事情，而后台线程IO线程，则定期检查这些提交的请求是否已经完成，如果完成再做一些后续处理工作。同时异步IO由于常常是一批一批的请求提交，如果不同请求访问同一个文件且偏移量连续，则可以合并成一个IO请求。例如，第一个请求读取文件1，偏移量100开始的200字节数据，第二个请求读取文件1，偏移量300开始的100字节数据，则这两个请求可以合并为读取文件1，偏移量100开始的300字节数据。数据预读中的逻辑预读也常常使用异步IO技术。<br>\n目前Linux上的异步IO库，需要文件使用O_DIRECT模式打开，且数据块存放的内存地址、文件读写的偏移量和读写的数据量必须是文件系统逻辑块大小的整数倍，文件系统逻辑块大小可以使用类似<code>sudo blockdev --getss /dev/sda5</code>的语句查询。如果上述三者不是文件系统逻辑块大小的整数倍，则在调用读写函数时候会报错EINVAL，但是如果文件不使用O_DIRECT打开，则程序依然可以运行，只是退化成同步IO，阻塞在io_submit函数调用上。</p>\n<h2 id=\"innodb常规io操作以及同步io\">InnoDB常规IO操作以及同步IO</h2>\n<p>在InnoDB中，如果系统有pread/pwrite函数(<code>os_file_read_func</code>和<code>os_file_write_func</code>)，则使用它们进行读写，否则使用lseek+read/write方案。这个就是InnoDB同步IO。查看pread/pwrite文档可知，这两个函数不会改变文件句柄的偏移量且线程安全，所以多线程环境下推荐使用，而lseek+read/write方案则需要自己使用互斥锁保护，在高并发情况下，频繁的陷入内核态，对性能有一定影响。</p>\n<p>在InnoDB中，使用open系统调用打开文件(<code>os_file_create_func</code>)，模式方面除了O_RDONLY(只读)，O_RDWR(读写)，O_CREAT(创建文件)外，还使用了O_EXCL(保证是这个线程创建此文件)和O_TRUNC(清空文件)。默认情况下(数据库不设置为只读模式)，所有文件都以O_RDWR模式打开。innodb_flush_method这个参数比较重要，重点介绍一下：</p>\n<ul>\n<li>如果innodb_flush_method设置了O_DSYNC，日志文件(ib_logfileXXX)使用O_SYNC打开，因此写完数据不需要调用函数fsync刷盘，数据文件(ibd)使用default模式打开，因此写完数据需要调用fsync刷盘。</li>\n<li>如果innodb_flush_method设置了O_DIRECT，日志文件(ib_logfileXXX)使用default模式打开，写完数据需要调用fsync函数刷盘，数据文件(ibd)使用O_DIRECT模式打开，写完数据需要调用fsync函数刷盘。</li>\n<li>如果innodb_flush_method设置了fsync或者不设置，数据文件和日志文件都使用default模式打开，写完数据都需要使用fsync来刷盘。</li>\n<li>如果innodb_flush_method设置为O_DIRECT_NO_FSYNC，文件打开方式与O_DIRECT模式类似，区别是，数据文件写完后，不调用fsync函数来刷盘，主要针对O_DIRECT能保证文件的元数据也落盘的文件系统。<br>\nInnoDB目前还不支持使用O_DIRECT模式打开日志文件，也不支持使用O_SYNC模式打开数据文件。<br>\n注意，如果使用linux native aio（详见下一节），innodb_flush_method一定要配置成O_DIRECT，否则会退化成同步IO（错误日志中不会有任务提示）。</li>\n</ul>\n<p>InnoDB使用了文件系统的文件锁来保证只有一个进程对某个文件进行读写操作(<code>os_file_lock</code>)，使用了建议锁(Advisory locking)，而不是强制锁(Mandatory locking)，因为强制锁在不少系统上有bug，包括linux。在非只读模式下，所有文件打开后，都用文件锁锁住。</p>\n<p>InnoDB中目录的创建使用递归的方式(<code>os_file_create_subdirs_if_needed</code>和<code>os_file_create_directory</code>)。例如，需要创建/a/b/c/这个目录，先创建c，然后b，然后a，创建目录调用mkdir函数。此外，创建目录上层需要调用<code>os_file_create_simple_func</code>函数，而不是<code>os_file_create_func</code>，需要注意一下。</p>\n<p>InnoDB也需要临时文件，临时文件的创建逻辑比较简单(<code>os_file_create_tmpfile</code>)，就是在tmp目录下成功创建一个文件后直接使用unlink函数释放掉句柄，这样当进程结束后(不管是正常结束还是异常结束)，这个文件都会自动释放。InnoDB创建临时文件，首先复用了server层函数mysql_tmpfile的逻辑，后续由于需要调用server层的函数来释放资源，其又调用dup函数拷贝了一份句柄。</p>\n<p>如果需要获取某个文件的大小，InnoDB并不是去查文件的元数据(<code>stat</code>函数)，而是使用<code>lseek(file, 0, SEEK_END)</code>的方式获取文件大小，这样做的原因是防止元信息更新延迟导致获取的文件大小有误。</p>\n<p>InnoDB会预分配一个大小给所有新建的文件(包括数据和日志文件)，预分配的文件内容全部置为零(<code>os_file_set_size</code>)，当前文件被写满时，再进行扩展。此外，在日志文件创建时，即install_db阶段，会以100MB的间隔在错误日志中输出分配进度。</p>\n<p>总体来说，常规IO操作和同步IO相对比较简单，但是在InnoDB中，数据文件的写入基本都用了异步IO。</p>\n<h2 id=\"innodb异步io\">InnoDB异步IO</h2>\n<p>由于MySQL诞生在Linux native aio之前，所以在MySQL异步IO的代码中，有两种实现异步IO的方案。<br>\n第一种是原始的Simulated aio，InnoDB在Linux native air被import进来之前以及某些不支持air的系统上，自己模拟了一条aio的机制。异步读写请求提交时，仅仅把它放入一个队列中，然后就返回，程序可以去做其他事情。后台有若干异步io处理线程(innobase_read_io_threads和innobase_write_io_threads这两个参数控制)不断从这个队列中取出请求，然后使用同步IO的方式完成读写请求以及读写完成后的工作。<br>\n另外一种就是Native aio。目前在linux上使用io_submit，io_getevents等函数完成(不使用glibc aio，这个也是模拟的)。提交请求使用io_submit, 等待请求使用io_getevents。另外，window平台上也有自己对应的aio，这里就不介绍了，如果使用了window的技术栈，数据库应该会选用sqlserver。目前，其他平台(Linux和window之外)都只能使用Simulate aio。</p>\n<p>首先介绍一下一些通用的函数和结构，接下来分别详细介绍一下Simulate alo和Linux上的Native aio。<br>\n在os0file.cc中定义了全局数组，类型为<code>os_aio_array_t</code>，这些数组就是Simulate aio用来缓存读写请求的队列，数组的每一个元素是<code>os_aio_slot_t</code>类型，里面记录了每个IO请求的类型，文件的fd，偏移量，需要读取的数据量，IO请求发起的时间，IO请求是否已经完成等。另外，Linux native io中的struct iocb也在<code>os_aio_slot_t</code>中。数组结构<code>os_aio_slot_t</code>中，记录了一些统计信息，例如有多少数据元素(<code>os_aio_slot_t</code>)已经被使用了，是否为空，是否为满等。这样的全局数组一共有5个，分别用来保存数据文件读异步请求(<code>os_aio_read_array</code>)，数据文件写异步请求(<code>os_aio_write_array</code>)，日志文件写异步请求(<code>os_aio_log_array</code>)，insert buffer写异步请求(<code>os_aio_ibuf_array</code>)，数据文件同步读写请求(<code>os_aio_sync_array</code>)。日志文件的数据块写入是同步IO，但是这里为什么还要给日志写分配一个异步请求队列(<code>os_aio_log_array</code>)呢？原因是，InnoDB日志文件的日志头中，需要记录checkpoint的信息，目前checkpoint信息的读写还是用异步IO来实现的，因为不是很紧急。在window平台中，如果对特定文件使用了异步IO，就这个文件就不能使用同步IO了，所以引入了数据文件同步读写请求队列(<code>os_aio_sync_array</code>)。日志文件不需要读异步请求队列，因为只有在做奔溃恢复的时候日志才需要被读取，而做崩溃恢复的时候，数据库还不可用，因此完全没必要搞成异步读取模式。这里有一点需要注意，不管变量innobase_read_io_threads和innobase_write_io_threads两个参数是多少，<code>os_aio_read_array</code>和<code>os_aio_write_array</code>都只有一个，只不过数据中的<code>os_aio_slot_t</code>元素会相应增加，在linux中，变量加1，元素数量增加256。例如，innobase_read_io_threads=4，则os_aio_read_array数组被分成了四部分，每一个部分256个元素，每个部分都有自己独立的锁、信号量以及统计变量，用来模拟4个线程，innobase_write_io_threads类似。从这里我们也可以看出，每个异步read/write线程能缓存的读写请求是有上限的，即为256，如果超过这个数，后续的异步请求需要等待。256可以理解为InnoDB层对异步IO并发数的控制，而在文件系统层和磁盘层面也有长度限制，分别使用<code>cat /sys/block/sda/queue/nr_requests</code>和<code>cat /sys/block/sdb/queue/nr_requests</code>查询。<br>\n<code>os_aio_init</code>在InnoDB启动的时候调用，用来初始化各种结构，包括上述的全局数组，还有Simulate aio中用的锁和互斥量。<code>os_aio_free</code>则释放相应的结构。<code>os_aio_print_XXX</code>系列的函数用来输出aio子系统的状态，主要用在<code>show engine innodb status</code>语句中。</p>\n<h3 id=\"simulate-aio\">Simulate aio</h3>\n<p>Simulate aio相对Native aio来说，由于InnoDB自己实现了一套模拟机制，相对比较复杂。</p>\n<ul>\n<li>入口函数为<code>os_aio_func</code>，在debug模式下，会校验一下参数，例如数据块存放的内存地址、文件读写的偏移量和读写的数据量是否是OS_FILE_LOG_BLOCK_SIZE的整数倍，但是没有检验文件打开模式是否用了O_DIRECT，因为Simulate aio最终都是使用同步IO，没有必要一定要用O_DIRECT打开文件。</li>\n<li>校验通过后，就调用<code>os_aio_array_reserve_slot</code>，作用是把这个IO请求分配到某一个后台io处理线程(innobase_xxxx_io_threads分配的，但其实是在同一个全局数组中)中，并把io请求的相关信息记录下来，方便后台io线程处理。如果IO请求类型相同，请求同一个文件且偏移量比较接近(默认情况下，偏移量差别在1M内)，则InnoDB会把这两个请求分配到同一个io线程中，方便在后续步骤中IO合并。</li>\n<li>提交IO请求后，需要唤醒后台io处理线程，因为如果后台线程检测到没有IO请求，会进入等待状态(<code>os_event_wait</code>)。</li>\n<li>至此，函数返回，程序可以去干其他事情了，后续的IO处理交给后台线程了。<br>\n介绍一下后台IO线程怎么处理的。</li>\n<li>InnoDB启动时，后台IO线程会被启动(<code>io_handler_thread</code>)。其会调用<code>os_aio_simulated_handle</code>从全局数组中取出IO请求，然后用同步IO处理，结束后，需要做收尾工作，例如，如果是写请求的话，则需要在buffer pool中把对应的数据页从脏页列表中移除。</li>\n<li><code>os_aio_simulated_handle</code>首先需要从数组中挑选出某个IO请求来执行，挑选算法并不是简单的先进先出，其挑选所有请求中offset最小的请求先处理，这样做是为了后续的IO合并比较方便计算。但是这也容易导致某些offset特别大的孤立请求长时间没有被执行到，也就是饿死，为了解决这个问题，在挑选IO请求之前，InnoDB会先做一次遍历，如果发现有请求是2s前推送过来的(也就是等待了2s)，但是还没有被执行，就优先执行最老的请求，防止这些请求被饿死，如果有两个请求等待时间相同，则选择offset小的请求。</li>\n<li><code>os_aio_simulated_handle</code>接下来要做的工作就是进行IO合并，例如，读请求1请求的是file1，offset100开始的200字节，读请求2请求的是file1，offset300开始的100字节，则这两个请求可以合并为一个请求：file1，offset100开始的300字节，IO返回后，再把数据拷贝到原始请求的buffer中就可以了。写请求也类似，在写操作之前先把需要写的数据拷贝到一个临时空间，然后一次写完。注意，只有在offset连续的情况下IO才会合并，有间断或者重叠都不会合并，一模一样的IO请求也不会合并，所以这里可以算是一个可优化的点。</li>\n<li><code>os_aio_simulated_handle</code>如果发现现在没有IO请求，就会进入等待状态，等待被唤醒</li>\n</ul>\n<p>综上所述，可以看出IO请求是一个一个的push的对立面，每push进一个后台线程就拿去处理，如果后台线程优先级比较高的话，IO合并效果可能比较差，为了解决这个问题，Simulate aio提供类似组提交的功能，即一组IO请求提交后，才唤醒后台线程，让其统一进行处理，这样IO合并的效果会比较好。但这个依然有点小问题，如果后台线程比较繁忙的话，其就不会进入等待状态，也就是说只要请求进入了队列，就会被处理。这个问题在下面的Native aio中可以解决。<br>\n总体来说，InnoDB实现的这一套模拟机制还是比较安全可靠的，如果平台不支持Native aio则使用这套机制来读写数据文件。</p>\n<h3 id=\"linux-native-aio\">Linux native aio</h3>\n<p>如果系统安装了libaio库且在配置文件里面设置了innodb_use_native_aio=on则启动时候会使用Native aio。</p>\n<ul>\n<li>入口函数依然为<code>os_aio_func</code>，在debug模式下，依然会检查传入的参数，同样不会检查文件是否以O_DIRECT模式打开，这算是一个有点风险的点，如果用户不知道linux native aio需要使用O_DIRECT模式打开文件才能发挥出aio的优势，那么性能就不会达到预期。建议在此处做一下检查，有问题输出到错误日志。</li>\n<li>检查通过之后，与Simulated aio一样，调用<code>os_aio_array_reserve_slot</code>，把IO请求分配给后台线程，分配算法也考虑了后续的IO合并，与Simulated aio一样。不同之处，主要是需要用IO请求的参数初始化iocb这个结构。IO请求的相关信息除了需要初始化iocb外，也需要在全局数组的slot中记录一份，主要是为了在<code>os_aio_print_XXX</code>系列函数中统计方便。</li>\n<li>调用io_submit提交请求。</li>\n<li>至此，函数返回，程序可以去干其他事情了，后续的IO处理交给后台线程了。<br>\n接下来是后台IO线程。</li>\n<li>与Simulate aio类似，后台IO线程也是在InnoDB启动时候启动。如果是Linux native aio，后续会调用<code>os_aio_linux_handle</code>这个函数。这个函数的作用与<code>os_aio_simulated_handle</code>类似，但是底层实现相对比较简单，其仅仅调用io_getevents函数等待IO请求完成。超时时间为0.5s，也就是说如果即使0.5内没有IO请求完成，函数也会返回，继续调用io_getevents等待，当然在等待前会判断一下服务器是否处于关闭状态，如果是则退出。</li>\n</ul>\n<p>在分发IO线程时，尽量把相邻的IO放在一个线程内，这个与Simulate aio类似，但是后续的IO合并操作，Simulate aio是自己实现，Native aio则交给内核完成了，因此代码比较简单。<br>\n还要一个区别是，当没有IO请求的时候，Simulate aio会进入等待状态，而Native aio则会每0.5秒醒来一次，做一些检查工作，然后继续等待。因此，当有新的请求来时，Simulated aio需要用户线程唤醒，而Native aio不需要。此外，在服务器关闭时，Simulate aio也需要唤醒，Native aio则不需要。</p>\n<p>可以发现，Native aio与Simulate aio类似，请求也是一个一个提交，然后一个一个处理，这样会导致IO合并效果比较差。Facebook团队提交了一个Native aio的组提交优化：把IO请求首先缓存，等IO请求都到了之后，再调用io_submit函数，一口气提交先前的所有请求(io_submit可以一次提交多个请求)，这样内核就比较方便做IO优化。Simulate aio在IO线程压力大的情况下，组提交优化会失效，而Native aio则不会。注意，组提交优化，不能一口气提交太多，如果超过了aio等待队列长度，会强制发起一次io_submit。</p>\n<h2 id=\"总结\">总结</h2>\n<p>本文详细介绍了InnoDB中IO子系统的实现以及使用需要注意的点。InnoDB日志使用同步IO，数据使用异步IO，异步IO的写盘顺序也不是先进先出的模式，这些点都需要注意。Simulate aio虽然有比较大的学习价值，但是在现代操作系统中，推荐使用Native aio。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113310\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113310votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113310\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "url": "http://blog.jobbole.com/113310/", "comment_nums": 0, "praise_nums": 1, "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2015/11/e78e36715813f49e9e62fe0c6050075c.png"]},{"title": "MySQL 性能调优技巧", "url_object_id": "9d1a4f483de8dad0a4da4300eacbcc09", "create_date": "2017/12/06", "tags": "IT技术,MySQL,数据库", "fav_nums": 1, "front_image_path": "full/35011d6168be00e949624c665041dc724e3ad786.jpg", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://dzone.com/articles/mysql-performance-tuning-tips-for-the-shopping-sea\">Shree Nair</a>   译文出处：<a target=\"_blank\" href=\"http://www.iteye.com/news/32796\">ITeye/无阻我飞扬</a>   </div><blockquote><p><em>摘要：针对购物旺季网站流量会对数据库造成的压力，作者给出了MySQL性能调优的一些技巧，这些技巧极具参考价值，通过这些调优，可以有效避免因为流量过大造成服务器宕机，从而给企业造成经济损失。以下是译文</em></p></blockquote>\n<p>万圣节已经过去很久了，该是把注意力集中在即将到来的假日季节的时候了。首先是感恩节，接着就是黑色星期五和网络星期一，最终在圣诞节/节礼周（从12月26日的节礼日开始，到12月31日的除夕结束为期六天或更长时间。这个词是由零售业在2000年代中期左右发明的，试图延长他们的节礼日销售）达到购物高潮。对于企业主来说，一年的这个时候标志着人们期待已久的年底获利了结。对于一些DBA来说，它会带来恐惧，不安，甚至是不眠之夜，他们要努力使系统重新上线。</p>\n<p>值得庆幸是，情况并非如此。通过对MySQL性能变量做一些主动调整，可以使数据库服务器免受购物旺季带来的需求增加的冲击。</p>\n<h3>技巧#1：确定MySQL的最大连接数</h3>\n<p>对于MySQL的最大连接数，一次最好是发送5个请求到Web服务器。对Web服务器的5个请求中的一部分将用于CSS样式表，图像和脚本等资源。由于诸如浏览器缓存等原因，要获得准确的MySQL到Web服务器的请求比率可能很困难; 要想得到一个确切的数字，就需要分析Web服务器的日志文件。例如，可以手动访问Apache的“access_log”日志文件，也可以通过<a href=\"http://www.debianhelp.co.uk/analog.htm\" target=\"_blank\">Analog</a>或<a href=\"http://www.webalizer.org/\" target=\"_blank\">Webalizer</a>等实用程序访问日志文件。</p>\n<p>一旦有了对特定使用情况的准确估计，请将该比率乘以Web服务器的最大连接数。例如，如果Web服务器配置为最多为256个客户端提供服务，MySQL请求与Web请求的比率为1/8，则最好将最大数据库连接数设置为32。还要考虑留有安全余量，把这个数乘以2，得到最终的数量。只有在基础设施支持的情况下，才能尝试将数据库连接数的最大数量与Web服务器的客户端限制相匹配。在大多数情况下，最好保持接近32。</p>\n<p><strong>在Monyog中查看MySQL连接</strong></p>\n<p>在MySQL数据库中，MySQL的最大并发连接数是存储在全局变量max_connections中的。Monyog报告变量“max_connections”作为当前连接监控组中的“最大允许”指标。它还将该数字除以打开的连接数，以生成连接使用百分比：</p>\n<p>还有一个连接历史记录监控，可以帮助计算最佳的最大并发连接数。它包括尝试，拒绝和成功连接的数量。此外，允许达到的最大指标的百分比显示为一个进度条，可以让你快速评估服务器在过去达到的最大并发连接数：</p>\n<h3>技巧#2：为临时表分配足够的内存</h3>\n<p>在某些情况下，服务器在处理语句时会创建内部临时表。临时表用于内部操作如GROUP BY和distinct，还有一些ORDER BY查询以及UNION和FROM子句（派生表）中的子查询。这些都是在内存中创建的内存表。内存中临时表的最大大小由tmp_table_size和max_heap_table_size中较小的值确定。如果临时表的大小超过这个阈值，则将其转换为磁盘上的InnoDB或MyISAM表。此外，如果查询涉及BLOB或TEXT列，而这些列不能存储在内存表中，临时表总是直接指向磁盘。</p>\n<p>这种转换的代价很大，所以考虑增加max_heap_table_size和tmp_table_size变量的大小来帮助减少在磁盘上创建临时表的数量。请记住，这将需要大量内存，因为内存中临时表的大小是基于“最坏情况”的。例如，内存表总是使用固定长度的列，所以字符列使用VARCHAR（255）。这可以使内存中的临时表比想象的要大得多—事实上，这比查询表的总大小要大很多倍！当增加max_heap_table_size和tmp_table_sizevariables的大小时，一定要监视服务器的内存使用情况，因为内存中的临时表可能会增加达到服务器内存容量的风险。</p>\n<p>一般来说，32M到64M是建议值，从这两个变量开始并根据需要进行调优。</p>\n<p><strong>在Monyog中的临时表监测</strong></p>\n<p>临时表的监测是许多预定义的Monyog监测之一。它提供了一些临时表使用的指标，包括：</p>\n<ul>\n<li><strong>允许的最大值</strong>：显示tmp_table_size服务器变量的值，它定义了在内存中创建的临时表的最大大小。与max_heap_table_size一起，这个值定义了可以在内存中创建的临时表的最大大小。如果内存临时表大于此大小，则将其存储在磁盘上。</li>\n<li><strong>内存表的最大大小</strong>：显示max_heap_table_size服务器变量的值，该值定义了显式创建的MEMORY存储引擎表的最大大小。</li>\n<li><strong>创建的临时表总数</strong>：显示created_tmp_tables服务器变量的值，它定义了在内存中创建的临时表的数量。</li>\n<li><strong>在磁盘上创建的临时表</strong>：显示created_tmp_disk_tables服务器变量的值，该变量定义了在磁盘上创建的临时表的数量。如果这个值很高，则应该考虑增加tmp_table_size和max_heap_table_size的值，以便增加创建内存临时表的数量，从而减少在磁盘上创建临时表的数量。</li>\n<li><strong>磁盘：总比率</strong>：基于created_tmp_disk_tables除以created_tmp_tables的计算值。由于tmp_table_size或max_heap_table_size不足而在磁盘上创建的临时表的百分比。Monyog将这个数字显示为一个进度条和百分比，以便快速确定有多少磁盘用于临时表，而不是内存。</li>\n</ul>\n<p>趋势图可用于创建的总表，磁盘上创建的表和磁盘的总比值。这些让我们看到了它们随着时间的演变：</p>\n<h3>技巧#3：增加线程缓存大小</h3>\n<p>连接管理器线程处理服务器监听的网络接口上的客户端连接请求。连接管理器线程将每个客户端连接与专用于它的线程关联，该线程负责处理该连接的身份验证和所有请求处理。因此，线程和当前连接的客户端之间是一对一的比例。确保线程缓存足够大以容纳所有传入请求是非常重要的。</p>\n<p>MySQL提供了许多与连接线程相关的服务器变量：</p>\n<p>线程缓存大小由thread_cache_size系统变量决定。默认值为0（无缓存），这将导致为每个新连接设置一个线程，并在连接终止时需要处理该线程。如果希望服务器每秒接收数百个连接请求，那么应该将thread_cache_size设置的足够高，以便大多数新连接可以使用缓存线程。可以在服务器启动或运行时设置max_connections的值。</p>\n<p>还应该监视缓存中的线程数（Threads_cached）以及创建了多少个线程，因为无法从缓存中获取线程（Threads_created）。关于后者，如果Threads_created继续以每分钟多于几个线程的增加，请考虑增加thread_cache_size的值。</p>\n<p>使用MySQL show status命令显示MySQL的变量和状态信息。这里有几个例子：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a34465011984652233972\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nSHOW GLOBAL STATUS LIKE '%Threads_connected%';\r\n\r\n+-------------------+-------+\r\n\r\n| Variable_name     | Value |\r\n\r\n+-------------------+-------+\r\n\r\n| Threads_connected | 2     |\r\n\r\n+-------------------+-------+\r\nSHOW GLOBAL STATUS LIKE '%Threads_running%';\r\n\r\n+-----------------+-------+\r\n\r\n| Variable_name   | Value |\r\n\r\n+-----------------+-------+\r\n\r\n| Threads_running | 1     |\r\n\r\n+-----------------+-------+\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a34465011984652233972-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465011984652233972-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a34465011984652233972-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465011984652233972-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a34465011984652233972-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465011984652233972-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a34465011984652233972-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465011984652233972-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5a34465011984652233972-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465011984652233972-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5a34465011984652233972-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465011984652233972-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5a34465011984652233972-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465011984652233972-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5a34465011984652233972-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465011984652233972-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5a34465011984652233972-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465011984652233972-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5a34465011984652233972-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465011984652233972-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5a34465011984652233972-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465011984652233972-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5a34465011984652233972-23\">23</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a34465011984652233972-1\"><span class=\"crayon-e\">SHOW </span><span class=\"crayon-m\">GLOBAL</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">STATUS </span><span class=\"crayon-i\">LIKE</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'%Threads_connected%'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465011984652233972-2\"> </div><div class=\"crayon-line\" id=\"crayon-5a34465011984652233972-3\"><span class=\"crayon-o\">+</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">-</span><span class=\"crayon-o\">+</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">-</span><span class=\"crayon-o\">+</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465011984652233972-4\"> </div><div class=\"crayon-line\" id=\"crayon-5a34465011984652233972-5\"><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Variable_name</span><span class=\"crayon-h\">     </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465011984652233972-6\"> </div><div class=\"crayon-line\" id=\"crayon-5a34465011984652233972-7\"><span class=\"crayon-o\">+</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">-</span><span class=\"crayon-o\">+</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">-</span><span class=\"crayon-o\">+</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465011984652233972-8\"> </div><div class=\"crayon-line\" id=\"crayon-5a34465011984652233972-9\"><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Threads_connected</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">2</span><span class=\"crayon-h\">     </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465011984652233972-10\"> </div><div class=\"crayon-line\" id=\"crayon-5a34465011984652233972-11\"><span class=\"crayon-o\">+</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">-</span><span class=\"crayon-o\">+</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">-</span><span class=\"crayon-o\">+</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465011984652233972-12\"><span class=\"crayon-e\">SHOW </span><span class=\"crayon-m\">GLOBAL</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">STATUS </span><span class=\"crayon-i\">LIKE</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'%Threads_running%'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5a34465011984652233972-13\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465011984652233972-14\"><span class=\"crayon-o\">+</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">-</span><span class=\"crayon-o\">+</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">-</span><span class=\"crayon-o\">+</span></div><div class=\"crayon-line\" id=\"crayon-5a34465011984652233972-15\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465011984652233972-16\"><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Variable_name</span><span class=\"crayon-h\">   </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Value</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line\" id=\"crayon-5a34465011984652233972-17\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465011984652233972-18\"><span class=\"crayon-o\">+</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">-</span><span class=\"crayon-o\">+</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">-</span><span class=\"crayon-o\">+</span></div><div class=\"crayon-line\" id=\"crayon-5a34465011984652233972-19\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465011984652233972-20\"><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Threads_running</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\">     </span><span class=\"crayon-o\">|</span></div><div class=\"crayon-line\" id=\"crayon-5a34465011984652233972-21\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465011984652233972-22\"><span class=\"crayon-o\">+</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">-</span><span class=\"crayon-o\">+</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">-</span><span class=\"crayon-o\">+</span></div><div class=\"crayon-line\" id=\"crayon-5a34465011984652233972-23\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0030 seconds] -->\r\n<p><strong>Monyog线程缓存监测</strong></p>\n<p>Monyog提供了一个监控线程缓存的屏幕，名为“线程”。与MySQL线程相关的服务器变量映射到以下Monyog指标：</p>\n<ul>\n<li>thread_cache_size：可以缓存的线程数。</li>\n<li>Threads_cached：缓存中的线程数。</li>\n<li>Threads_created：创建用于处理连接的线程。</li>\n</ul>\n<p>Monyog线程屏幕还包括“线程缓存命中率”指标。这是一个提示线程缓存命中率的指标。如果值较低，则应该考虑增加线程缓存。在状态栏以百分比形式显示该值；它的值越接近100％越好。</p>\n<p>如果这些指标的值等于或超过指定值，则可以将每一个指标配置为发出警告和/或严重警报。</p>\n<h3>其他相关的服务器变量</h3>\n<p>除了上述指标以外，还应该监控以下内容：</p>\n<ol>\n<li><strong>InnoDB缓冲池大小</strong>： InnoDB缓冲池大小在使用InnoDB的MySQL数据库中起着至关重要的作用。缓冲池同时缓存数据和索引。它的值应该尽可能的大，以确保数据库使用内存而不是硬盘驱动器进行读取操作。</li>\n<li><strong>临时表大小</strong>： MySQL使用max_heap_table_size和tmp_table_size中较小的一个来限制内存中临时表的大小。拥有较大的值可以帮助减少在磁盘上创建临时表的数量，但也会增加服务器内存容量的风险，因为这个指标适用于每个客户端。一般来说，32M到64M是建议的值，从这两个变量开始并根据需要进行调优。</li>\n<li><strong>InnoDB日志缓冲区大小</strong>： MySQL每次写入日志文件时，它都会利用可用于处理销售数据的重要系统资源。因此，将InnoDB日志缓冲区大小设置为较大值才有意义。这样，服务器在大型事务中写入磁盘的次数就减少了，从而最大限度地减少了这些耗时的操作。64M是这个变量的一个很好的起点。</li>\n</ol>\n<h3>结论</h3>\n<p>虽然即便是最大的公司网站也会因宕机而遭受损失，但这种影响对于处理网上销售的中小型企业尤其关键。根据<a href=\"https://blog.100tb.com/the-real-cost-of-downtime-for-business\" target=\"_blank\">最近的一份调查报告</a>显示，一分钟的宕机导致企业平均损失约5000美元。不要让你的业务成为那种统计数据（因为宕机造成的损失）的一部分。在假日繁忙之前，主动调优MySQL数据库服务器（S）并收获回报吧！</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113197\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113197votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113197\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 2 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "url": "http://blog.jobbole.com/113197/", "comment_nums": 2, "praise_nums": 1, "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2015/11/e78e36715813f49e9e62fe0c6050075c.png"]},{"title": "MySQL 引擎特性：InnoDB崩溃恢复", "url_object_id": "7b2e7df15f26a1c4ddc1a2388108ab71", "create_date": "2017/12/13", "tags": "IT技术,MySQL,数据库", "fav_nums": 2, "front_image_path": "full/35011d6168be00e949624c665041dc724e3ad786.jpg", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/coderyuhui/p/7191413.html\">水中的泪</a>   </div><h2 id=\"前言\">前言</h2>\n<p>数据库系统与文件系统最大的区别在于数据库能保证操作的原子性，一个操作要么不做要么都做，即使在数据库宕机的情况下，也不会出现操作一半的情况，这个就需要数据库的日志和一套完善的崩溃恢复机制来保证。本文仔细剖析了InnoDB的崩溃恢复流程，代码基于5.6分支。</p>\n<h2 id=\"基础知识\">基础知识</h2>\n<p><strong><em>lsn: </em></strong> 可以理解为数据库从创建以来产生的redo日志量，这个值越大，说明数据库的更新越多，也可以理解为更新的时刻。此外，每个数据页上也有一个lsn，表示最后被修改时的lsn，值越大表示越晚被修改。比如，数据页A的lsn为100，数据页B的lsn为200，checkpoint lsn为150，系统lsn为300，表示当前系统已经更新到300，小于150的数据页已经被刷到磁盘上，因此数据页A的最新数据一定在磁盘上，而数据页B则不一定，有可能还在内存中。<br>\n<strong><em>redo日志: </em></strong> 现代数据库都需要写redo日志，例如修改一条数据，首先写redo日志，然后再写数据。在写完redo日志后，就直接给客户端返回成功。这样虽然看过去多写了一次盘，但是由于把对磁盘的随机写入(写数据)转换成了顺序的写入(写redo日志)，性能有很大幅度的提高。当数据库挂了之后，通过扫描redo日志，就能找出那些没有刷盘的数据页(在崩溃之前可能数据页仅仅在内存中修改了，但是还没来得及写盘)，保证数据不丢。<br>\n<strong><em>undo日志: </em></strong> 数据库还提供类似撤销的功能，当你发现修改错一些数据时，可以使用rollback指令回滚之前的操作。这个功能需要undo日志来支持。此外，现代的关系型数据库为了提高并发(同一条记录，不同线程的读取不冲突，读写和写读不冲突，只有同时写才冲突)，都实现了类似MVCC的机制，在InnoDB中，这个也依赖undo日志。为了实现统一的管理，与redo日志不同，undo日志在Buffer Pool中有对应的数据页，与普通的数据页一起管理，依据LRU规则也会被淘汰出内存，后续再从磁盘读取。与普通的数据页一样，对undo页的修改，也需要先写redo日志。<br>\n<strong><em>检查点: </em></strong> 英文名为checkpoint。数据库为了提高性能，数据页在内存修改后并不是每次都会刷到磁盘上。checkpoint之前的数据页保证一定落盘了，这样之前的日志就没有用了(由于InnoDB redolog日志循环使用，这时这部分日志就可以被覆盖)，checkpoint之后的数据页有可能落盘，也有可能没有落盘，所以checkpoint之后的日志在崩溃恢复的时候还是需要被使用的。InnoDB会依据脏页的刷新情况，定期推进checkpoint，从而减少数据库崩溃恢复的时间。检查点的信息在第一个日志文件的头部。<br>\n<strong><em>崩溃恢复: </em></strong> 用户修改了数据，并且收到了成功的消息，然而对数据库来说，可能这个时候修改后的数据还没有落盘，如果这时候数据库挂了，重启后，数据库需要从日志中把这些修改后的数据给捞出来，重新写入磁盘，保证用户的数据不丢。这个从日志中捞数据的过程就是崩溃恢复的主要任务，也可以成为数据库前滚。当然，在崩溃恢复中还需要回滚没有提交的事务，提交没有提交成功的事务。由于回滚操作需要undo日志的支持，undo日志的完整性和可靠性需要redo日志来保证，所以崩溃恢复先做redo前滚，然后做undo回滚。</p>\n<p>我们从源码角度仔细剖析一下数据库崩溃恢复过程。整个过程都在引擎初始化阶段完成(<code>innobase_init</code>)，其中最主要的函数是<code>innobase_start_or_create_for_mysql</code>，innodb通过这个函数完成创建和初始化，包括崩溃恢复。首先来介绍一下数据库的前滚。</p>\n<h2 id=\"redo日志前滚数据库\">redo日志前滚数据库</h2>\n<p>前滚数据库，主要分为两阶段，首先是日志扫描阶段，扫描阶段按照数据页的space_id和page_no分发redo日志到hash_table中，保证同一个数据页的日志被分发到同一个哈希桶中，且按照lsn大小从小到大排序。扫描完后，再遍历整个哈希表，依次应用每个数据页的日志，应用完后，在数据页的状态上至少恢复到了崩溃之前的状态。我们来详细分析一下代码。<br>\n首先，打开所有的ibdata文件(<code>open_or_create_data_files</code>)(ibdata可以有多个)，每个ibdata文件有个flush_lsn在头部，计算出这些文件中的max_flush_lsn和min_flush_lsn，因为ibdata也有可能有数据没写完整，需要恢复，后续(<code>recv_recovery_from_checkpoint_start_func</code>)通过比较checkpont_lsn和这两个值来确定是否需要对ibdata前滚。<br>\n接着，打开系统表空间和日志表空间的所有文件(<code>fil_open_log_and_system_tablespace_files</code>)，防止出现文件句柄不足，清空buffer pool(<code>buf_pool_invalidate</code>)。接下来就进入最最核心的函数:recv_recovery_from_checkpoint_start_func，注意，即使数据库是正常关闭的，也会进入。<br>\n虽然<code>recv_recovery_from_checkpoint_start_func</code>看过去很冗长，但是很多代码都是为了LOG_ARCHIVE特性而编写的，真正数据崩溃恢复的代码其实不多。<br>\n首先，初始化一些变量，查看<code>srv_force_recovery</code>这个变量，如果用户设置跳过前滚阶段，函数直接返回。<br>\n接着，初始化<code>recv_sys</code>结构，分配hash_table的大小，同时初始化flush list rbtree。<code>recv_sys</code>结构主要在崩溃恢复前滚阶段使用。hash_table就是之前说的用来存不同数据页日志的哈希表，哈希表的大小被初始化为buffer_size_in_bytes/512, 这个是哈希表最大的长度，超过就存不下了，幸运的是，需要恢复的数据页的个数不会超过这个值，因为buffer poll最多(数据库崩溃之前脏页的上线)只能存放buffer_size_in_bytes/16KB个数据页，即使考虑压缩页，最多也只有buffer_size_in_bytes/1KB个，此外关于这个哈希表内存分配的大小，可以参考bug#53122。flush list rbtree这个主要是为了加入插入脏页列表，InnoDB的flush list必须按照数据页的最老修改lsn(oldest_modifcation)从小到大排序，在数据库正常运行时，可以通过log_sys-&gt;mutex和log_sys-&gt;log_flush_order_mutex保证顺序，在崩溃恢复则没有这种保证，应用数据的时候，是从第一个元素开始遍历哈希表，不能保证数据页按照最老修改lsn(oldest_modifcation)从小到大排序，这样就需要线性遍历flush_list来寻找插入位置，效率太低，因此引入红黑树，加快查找插入的位置。<br>\n接着，从ib_logfile0的头中读取checkpoint信息，主要包括checkpoint_lsn和checkpoint_no。由于InnoDB日志是循环使用的，且最少要有2个，所以ib_logfile0一定存在，把checkpoint信息存在里面很安全，不用担心被删除。checkpoint信息其实会写在文件头的两个地方，两个checkpoint域轮流写。为什么要两个地方轮流写呢？假设只有一个checkpoint域，一直更新这个域，而checkpoint域有512字节(<code>OS_FILE_LOG_BLOCK_SIZE</code>)，如果刚好在写这个512字节的时候，数据库挂了，服务器也挂了(先不考虑硬件的原子写特性，早期的硬件没有这个特性)，这个512字节可能只写了一半，导致整个checkpoint域不可用。这样数据库将无法做崩溃恢复，从而无法启动。如果有两个checkpoint域，那么即使一个写坏了，还可以用另外一个尝试恢复，虽然有可能这个时候日志已经被覆盖，但是至少提高了恢复成功的概率。两个checkpoint域轮流写，也能减少磁盘扇区故障带来的影响。checkpoint_lsn之前的数据页都已经落盘，不需要前滚，之后的数据页可能还没落盘，需要重新恢复出来，即使已经落盘也没关系，因为redo日志时幂等的，应用一次和应用两次都一样(底层实现: 如果数据页上的lsn大于等于当前redo日志的lsn，就不应用，否则应用。checkpoint_no可以理解为checkpoint域写盘的次数，每次刷盘递增1，同时这个值取模2可以用来实现checkpoint_no域的轮流写。正常逻辑下，选取checkpoint_no值大的作为最终的checkpoint信息，用来做后续崩溃恢复扫描的起始点。<br>\n接着，使用checkpoint域的信息初始化recv_sys结构体的一些信息后，就进入日志解析的核心函数<code>recv_group_scan_log_recs</code>，这个函数后续我们再分析，主要作用就是解析redo日志，如果内存不够了，就直接调用应用(<code>recv_apply_hashed_log_recs</code>)日志，然后再接着解析。如果需要应用的日志很少，就仅仅解析分发日志，到<code>recv_recovery_from_checkpoint_finish</code>函数中在应用日志。<br>\n接着，依据当前刷盘的数据页状态做一次checkpoint，因为在<code>recv_group_scan_log_recs</code>里可能已经应用部分日志了。至此<code>recv_recovery_from_checkpoint_start_func</code>函数结束。<br>\n在<code>recv_recovery_from_checkpoint_finish</code>函数中，如果srv_force_recovery设置正确，就开始调用函数<code>recv_apply_hashed_log_recs</code>应用日志，然后等待刷脏的线程退出(线程是崩溃恢复时临时启动的)，最后释放recv_sys的相关资源以及hash_table占用的内存。<br>\n至此，数据库前滚结束。接下来，我们详细分析一下redo日志解析函数以及redo日志应用函数的实现细节。</p>\n<h2 id=\"redo日志解析函数\">redo日志解析函数</h2>\n<p>解析函数的最上层是<code>recv_group_scan_log_recs</code>，这个函数调用底层函数(<code>log_group_read_log_seg</code>)，按照RECV_SCAN_SIZE(64KB)大小分批读取。读取出来后，首先通过block_no和lsn之间的关系以及日志checksum判断是否读到了日志最后(所以可以看出，并没一个标记在日志头标记日志的有效位置，完全是按照上述两个条件判断是否到达了日志尾部)，如果读到最后则返回(之前说了，即使数据库是正常关闭的，也要走崩溃恢复逻辑，那么在这里就返回了，因为正常关闭的checkpoint值一定是指向日志最后)，否则则把日志去头掐尾放到一个recv_sys-&gt;buf中，日志头里面存了一些控制信息和checksum值，只是用来校验和定位，在真正的应用中没有用。在放到recv_sys-&gt;buf之前，需要检验一下recv_sys-&gt;buf有没有满(<code>RECV_PARSING_BUF_SIZE</code>，2M)，满了就报错(如果上一批解析有不完整的日志，日志解析函数不会分发，而是把这些不完整的日志留在recv_sys-&gt;buf中，直到解析到完整的日志)。接下的事情就是从recv_sys-&gt;buf中解析日志(<code>recv_parse_log_recs</code>)。日志分两种：single_rec和multi_rec，前者表示只对一个数据页进行一种操作，后者表示对一个或者多个数据页进行多种操作。日志中还包括对应数据页的space_id，page_no，操作的type以及操作的内容(<code>recv_parse_log_rec</code>)。解析出相应的日志后，按照space_id和page_no进行哈希(如果对应的表空间在内存中不存在，则表示表已经被删除了)，放到hash_table里面(日志真正存放的位置依然在buffer pool)即可，等待后续应用。这里有几个点值得注意：</p>\n<ul>\n<li>如果是multi_rec类型，则只有遇到MLOG_MULTI_REC_END这个标记，日志才算完整，才会被分发到hash_table中。查看代码，我们可以发现multi_rec类型的日志被解析了两次，一次用来校验完整性(寻找MLOG_MULTI_REC_END)，第二次才用来分发日志，感觉这是一个可以优化的点。</li>\n<li>目前日志的操作type有50多种，每种操作后面的内容都不一样，所以长度也不一样，目前日志的解析逻辑，需要依次解析出所有的内容，然后确定长度，从而定位下一条日志的开始位置。这种方法效率略低，其实可以在每种操作的头上加上一个字段，存储后面内容的长度，这样就不需要解析太多的内容，从而提高解析速度，进一步提高崩溃恢复速度，从结果看，可以提高一倍的速度(从38秒到14秒，详情可以参见bug#82937)。</li>\n<li>如果发现checkpoint之后还有日志，说明数据库之前没有正常关闭，需要做崩溃恢复，因此需要做一些额外的操作(<code>recv_init_crash_recovery</code>)，比如在错误日志中打印我们常见的“Database was not shutdown normally!”和“Starting crash recovery.”，还要从double write buffer中检查是否发生了数据页半写，如果有需要恢复(<code>buf_dblwr_process</code>)，还需要启动一个线程用来刷新应用日志产生的脏页(因为这个时候buf_flush_page_cleaner_thread还没有启动)。最后还需要打开所有的表空间。。注意是所有的表。。。我们在阿里云RDS MySQL的运维中，常常发现数据库hang在了崩溃恢复阶段，在错误日志中有类似“Reading tablespace information from the .ibd files…”字样，这就表示数据库正在打开所有的表，然后一看表的数量，发现有几十甚至上百万张表。。。数据库之所以要打开所有的表，是因为在分发日志的时候，需要确定space_id对应哪个ibd文件，通过打开所有的表，读取space_id信息来确定，另外一个原因是方便double write buffer检查半写数据页。针对这个表数量过多导致恢复过慢的问题，MySQL 5.7做了优化，WL#7142， 主要思想就是在每次checkpoint后，在第一次修改某个表时，先写一个新日志mlog_file_name(包括space_id和filename的映射)，来表示对这个表进行了操作，后续对这个表的操作就不用写这个新日志了，当需要崩溃恢复时候，多一次扫描，通过搜集mlog_file_name来确定哪些表被修改过，这样就不需要打开所有的表来确定space_id了。</li>\n<li>最后一个值得注意的地方是内存。之前说过，如果有太多的日志已经被分发，占用了太多的内存，日志解析函数会在适当的时候应用日志，而不是等到最后才一起应用。那么问题来了，使用了多大的内存就会出发应用日志逻辑。答案是：buffer_pool_size_in_bytes – 512 * buffer_pool_instance_num * 16KB。由于buffer_pool_instance_num一般不会太大，所以可以任务，buffer pool的大部分内存都被用来存放日志。剩下的那些主要留给应用日志时读取的数据页，因为目前来说日志应用是单线程的，读取一个日志，把所有日志应用完，然后就可以刷回磁盘了，不需要太多的内存。</li>\n</ul>\n<h2 id=\"redo日志应用函数\">redo日志应用函数</h2>\n<p>应用日志的上层函数为<code>recv_apply_hashed_log_recs</code>(应用日志也可能在io_helper函数中进行)，主要作用就是遍历hash_table，从磁盘读取对每个数据页，依次应用哈希桶中的日志。应用完所有的日志后，如果需要则把buffer_pool的页面都刷盘，毕竟空间有限。有以下几点值得注意：</p>\n<ul>\n<li>同一个数据页的日志必须按照lsn从小到大应用，否则数据会被覆盖。只应用redo日志lsn大于page_lsn的日志，只有这些日志需要重做，其余的忽略。应用完日志后，把脏页加入脏页列表，由于脏页列表是按照最老修改lsn(oldest_modification)来排序的，这里通过引入一颗红黑树来加速查找插入的位置，时间复杂度从之前的线性查找降为对数级别。</li>\n<li>当需要某个数据页的时候，如果发现其没有在Buffer Pool中，则会查看这个数据页周围32个数据页，是否也需要做恢复，如果需要则可以一起读取出来，相当于做了一次io合并，减少io操作(<code>recv_read_in_area</code>)。由于这个是异步读取，所以最终应用日志的活儿是由io_helper线程来做的(<code>buf_page_io_complete</code>)，此外，为了防止短时间发起太多的io，在代码中加了流量控制的逻辑(<code>buf_read_recv_pages</code>)。如果发现某个数据页在内存中，则直接调用<code>recv_recover_page</code>应用日志。由此我们可以看出，InnoDB应用日志其实并不是单线程的来应用日志的，除了崩溃恢复的主线程外，io_helper线程也会参与恢复。并发线程数取决于io_helper中读取线程的个数。</li>\n</ul>\n<p>执行完了redo前滚数据库，数据库的所有数据页已经处于一致的状态，undo回滚数据库就可以安全的执行了。数据库崩溃的时候可能有一些没有提交的事务或者已经提交的事务，这个时候就需要决定是否提交。主要分为三步，首先是扫描undo日志，重新建立起undo日志链表，接着是，依据上一步建立起的链表，重建崩溃前的事务，即恢复当时事务的状态。最后，就是依据事务的不同状态，进行回滚或者提交。</p>\n<h2 id=\"undo日志回滚数据库\">undo日志回滚数据库</h2>\n<p>在<code>recv_recovery_from_checkpoint_start_func</code>之后，<code>recv_recovery_from_checkpoint_finish</code>之前，调用了<code>trx_sys_init_at_db_start</code>，这个函数做了上述三步中的前两步。<br>\n第一步在函数<code>trx_rseg_array_init</code>中处理，遍历整个undo日志空间(最多TRX_SYS_N_RSEGS(128)个segment)，如果发现某个undo segment非空，就进行初始化(<code>trx_rseg_create_instance</code>)。整个每个undo segment，如果发现undo slot非空(最多TRX_RSEG_N_SLOTS(1024)个slot)，也就行初始化(<code>trx_undo_lists_init</code>)。在初始化undo slot后，就把不同类型的undo日志放到不同链表中(<code>trx_undo_mem_create_at_db_start</code>)。undo日志主要分为两种：TRX_UNDO_INSERT和TRX_UNDO_UPDATE。前者主要是提供给insert操作用的，后者是给update和delete操作使用。之前说过，undo日志有两种作用，事务回滚时候用和MVCC快照读取时候用。由于insert的数据不需要提供给其他线程用，所以只要事务提交，就可以删除TRX_UNDO_INSERT类型的undo日志。TRX_UNDO_UPDATE在事务提交后还不能删除，需要保证没有快照使用它的时候，才能通过后台的purge线程清理。<br>\n第二步在函数<code>trx_lists_init_at_db_start</code>中进行，由于第一步中，已经在内存中建立起了undo_insert_list和undo_update_list(链表每个undo segment独立)，所以这一步只需要遍历所有链表，重建起事务的状态(<code>trx_resurrect_insert</code>和<code>trx_resurrect_update</code>)。简单的说，如果undo日志的状态是TRX_UNDO_ACTIVE，则事务的状态为TRX_ACTIVE，如果undo日志的状态是TRX_UNDO_PREPARED，则事务的状态为TRX_PREPARED。这里还要考虑变量srv_force_recovery的设置，如果这个变量值为非0，所有的事务都会回滚(即事务被设置为TRX_ACTIVE)，即使事务的状态应该为TRX_STATE_PREPARED。重建起事务后，按照事务id加入到trx_sys-&gt;trx_list链表中。最后，在函数<code>trx_sys_init_at_db_start</code>中，会统计所有需要回滚的事务(事务状态为TRX_ACTIVE)一共需要回滚多少行数据，输出到错误日志中，类似：5 transaction(s) which must be rolled back or cleaned up。InnoDB: in total 342232 row operations to undo的字样。<br>\n第三步的操作在两个地方被调用。一个是在<code>recv_recovery_from_checkpoint_finish</code>的最后，另外一个是在<code>recv_recovery_rollback_active</code>中。前者主要是回滚对数据字典的操作，也就是回滚DDL语句的操作，后者是回滚DML语句。前者是在数据库可提供服务之前必须完成，后者则可以在数据库提供服务(也即是崩溃恢复结束)之后继续进行(通过新开一个后台线程<code>trx_rollback_or_clean_all_recovered</code>来处理)。因为InnoDB认为数据字典是最重要的，必须要回滚到一致的状态才行，而用户表的数据可以稍微慢一点，对外提供服务后，慢慢恢复即可。因此我们常常在会发现数据库已经启动起来了，然后错误日志中还在不断的打印回滚事务的信息。事务回滚的核心函数是<code>trx_rollback_or_clean_recovered</code>，逻辑很简单，只需要遍历trx_sys-&gt;trx_list，按照事务不同的状态回滚或者提交即可(<code>trx_rollback_resurrected</code>)。这里要注意的是，如果事务是TRX_STATE_PREPARED状态，那么在InnoDB层，不做处理，需要在Server层依据binlog的情况来决定是否回滚事务，如果binlog已经写了，事务就提交，因为binlog写了就可能被传到备库，如果主库回滚会导致主备数据不一致，如果binlog没有写，就回滚事务。</p>\n<h2 id=\"崩溃恢复相关参数解析\">崩溃恢复相关参数解析</h2>\n<p><strong><em>innodb_fast_shutdown: </em></strong><br>\ninnodb_fast_shutdown = 0。这个表示在MySQL关闭的时候，执行slow shutdown，不但包括日志的刷盘，数据页的刷盘，还包括数据的清理(purge)，ibuf的合并，buffer pool dump以及lazy table drop操作(如果表上有未完成的操作，即使执行了drop table且返回成功了，表也不一定立刻被删除)。<br>\ninnodb_fast_shutdown = 1。这个是默认值，表示在MySQL关闭的时候，仅仅把日志和数据刷盘。<br>\ninnodb_fast_shutdown = 2。这个表示关闭的时候，仅仅日志刷盘，其他什么都不做，就好像MySQL crash了一样。<br>\n这个参数值越大，MySQL关闭的速度越快，但是启动速度越慢，相当于把关闭时候需要做的工作挪到了崩溃恢复上。另外，如果MySQL要升级，建议使用第一种方式进行一次干净的shutdown。</p>\n<p><strong><em>innodb_force_recovery: </em></strong><br>\n这个参数主要用来控制InnoDB启动时候做哪些工作，数值越大，做的工作越少，启动也更加容易，但是数据不一致的风险也越大。当MySQL因为某些不可控的原因不能启动时，可以设置这个参数，从1开始逐步递增，知道MySQL启动，然后使用SELECT INTO OUTFILE把数据导出，尽最大的努力减少数据丢失。<br>\ninnodb_force_recovery = 0。这个是默认的参数，启动的时候会做所有的事情，包括redo日志应用，undo日志回滚，启动后台master和purge线程，ibuf合并。检测到了数据页损坏了，如果是系统表空间的，则会crash，用户表空间的，则打错误日志。<br>\ninnodb_force_recovery = 1。如果检测到数据页损坏了，不会crash也不会报错(<code>buf_page_io_complete</code>)，启动的时候也不会校验表空间第一个数据页的正确性(<code>fil_check_first_page</code>)，表空间无法访问也继续做崩溃恢复(<code>fil_open_single_table_tablespace</code>、<code>fil_load_single_table_tablespace</code>)，ddl操作不能进行(<code>check_if_supported_inplace_alter</code>)，同时数据库也被不能进行写入操作(<code>row_insert_for_mysql</code>、<code>row_update_for_mysql</code>等)，所有的prepare事务也会被回滚(<code>trx_resurrect_insert</code>、<code>trx_resurrect_update_in_prepared_state</code>)。这个选项还是很常用的，数据页可能是因为磁盘坏了而损坏了，设置为1，能保证数据库正常启动。<br>\ninnodb_force_recovery = 2。除了设置1之后的操作不会运行，后台的master和purge线程就不会启动了(<code>srv_master_thread</code>、<code>srv_purge_coordinator_thread</code>等)，当你发现数据库因为这两个线程的原因而无法启动时，可以设置。<br>\ninnodb_force_recovery = 3。除了设置2之后的操作不会运行，undo回滚数据库也不会进行，但是回滚段依然会被扫描，undo链表也依然会被创建(<code>trx_sys_init_at_db_start</code>)。srv_read_only_mode会被打开。<br>\ninnodb_force_recovery = 4。除了设置3之后的操作不会运行，ibuf的操作也不会运行(<code>ibuf_merge_or_delete_for_page</code>)，表信息统计的线程也不会运行(因为一个坏的索引页会导致数据库崩溃)(<code>info_low</code>、<code>dict_stats_update</code>等)。从这个选项开始，之后的所有选项，都会损坏数据，慎重使用。<br>\ninnodb_force_recovery = 5。除了设置4之后的操作不会运行，回滚段也不会被扫描(<code>recv_recovery_rollback_active</code>)，undo链表也不会被创建，这个主要用在undo日志被写坏的情况下。<br>\ninnodb_force_recovery = 6。除了设置5之后的操作不会运行，数据库前滚操作也不会进行，包括解析和应用(<code>recv_recovery_from_checkpoint_start_func</code>)。</p>\n<h2 id=\"总结\">总结</h2>\n<p>InnoDB实现了一套完善的崩溃恢复机制，保证在任何状态下(包括在崩溃恢复状态下)数据库挂了，都能正常恢复，这个是与文件系统最大的差别。此外，崩溃恢复通过redo日志这种物理日志来应用数据页的方法，给MySQL Replication带来了新的思路，备库是否可以通过类似应用redo日志的方式来同步数据呢？阿里云RDS MySQL团队在后续的产品中，给大家带来了类似的特性，敬请期待。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113312\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113312votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113312\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 2 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "url": "http://blog.jobbole.com/113312/", "comment_nums": 0, "praise_nums": 1, "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2015/11/e78e36715813f49e9e62fe0c6050075c.png"]},{"title": "Linux 中命令链接操作符的十个最佳实例", "url_object_id": "bccf70a0f17c9ad3021262b849ba61ac", "create_date": "2017/12/12", "tags": "IT技术,Linux", "fav_nums": 1, "front_image_path": "full/bbf5b2d33074c754cd78cbcc77e858e9cd022815.jpg", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://www.tecmint.com/chaining-operators-in-linux-with-practical-examples/\">Tecmint</a>   译文出处：<a target=\"_blank\" href=\"https://linux.cn/article-2469-1.html\">Linux中国/geekpi</a>   </div><p>Linux命令中的链接的意思是，通过操作符的行为将几个命令组合执行。Linux中的链接命令，有些像你在shell中写<a href=\"http://www.tecmint.com/category/bash-shell/\" target=\"_blank\" rel=\"external nofollow\">短小的shell脚本</a>，并直接在终端中执行。链接使得自动处理变得更方便。不仅如此，一个无人看管的机器在链接操作符的帮助下能够十分有条理地运行。</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/a358ba4f51dd7f1dac9b1dfc1fef5343.png\" alt=\"\" width=\"256\" height=\"256\"></p>\n<p style=\"text-align: center\"><em>Linux中的10个链接操作符</em></p>\n<p>本文旨在介绍一些常用的<strong>链接操作符</strong>，通过简短的描述和相关的例子帮助读者提高生产力、降低系统负载、写出更加简短有意义的代码。</p>\n<h3>1. 和号操作符 (&amp;)</h3>\n<p>‘<strong>&amp;</strong>’的作用是使命令在后台运行。只要在命令后面跟上一个空格和 ‘<strong>&amp;</strong>’。你可以一口气在后台运行多个命令。</p>\n<p>在后台运行一个命令:</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a348eb085681740396097\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ntecmint@localhost:~$ ping ­c5 www.tecmint.com &amp;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a348eb085681740396097-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a348eb085681740396097-1\"><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">localhost</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">~</span><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">ping</span><span class=\"crayon-h\"> </span>­<span class=\"crayon-e\">c5 </span><span class=\"crayon-v\">www</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">com</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p>同时在后台运行两个命令：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a348eb08568e221350706\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nroot@localhost:/home/tecmint# apt-get update &amp; mkdit test &amp;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a348eb08568e221350706-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a348eb08568e221350706-1\"><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">localhost</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">home</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-p\"># apt-get update &amp; mkdit test &amp;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p></p>\n<h3>2. 分号操作符 (;)</h3>\n<p>分号操作符使你可以一口气运行几个命令，命令顺序执行。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a348eb085692799463691\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nroot@localhost:/home/tecmint# apt-get update ; apt-get upgrade ; mkdir test</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a348eb085692799463691-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a348eb085692799463691-1\"><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">localhost</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">home</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-p\"># apt-get update ; apt-get upgrade ; mkdir test</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>上述命令先后执行了update和upgrade，最后在当前工作目录下创建了一个‘<strong>test</strong>’文件夹</p>\n<h3>3. 与操作符 (&amp;&amp;)</h3>\n<p>如果第一个命令执行成功，<strong>与操作符 (&amp;&amp;)</strong>才会执行第二个命令，也就是说，第一个命令退出状态是<strong>0</strong>。（译注：原文的这里明显写错了，我们进行了改译，有兴趣的读者可以参看原文以及原文下面的评论。在UNIX里面，0表示无错误，而所有非0返回值都是各种错误）。这个命令在检查最后一个命令的执行状态时很有用。</p>\n<p>比如，我想使用<strong><a href=\"http://www.tecmint.com/command-line-web-browsers/\" target=\"_blank\" rel=\"external nofollow\">links 命令</a></strong>在终端中访问网站<strong>tecmint.com</strong>，但在这之前我需要检查主机是否<strong>在线</strong>或<strong>不在线</strong>。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a348eb085696874929882\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nroot@localhost:/home/tecmint# ping -c3 www.tecmint.com &amp;&amp; links www.tecmint.com</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a348eb085696874929882-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a348eb085696874929882-1\"><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">localhost</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">home</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-p\"># ping -c3 www.tecmint.com &amp;&amp; links www.tecmint.com</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p></p>\n<h3>4. 或操作符 (||)</h3>\n<p><strong>或操作符 (||)</strong>很像编程中的<strong>else</strong>语句。上面的操作符允许你在第一个命令失败的情况下执行第二个命令，比如，第一个命令的退出状态是<strong>1</strong>。</p>\n<p>举例来说，我想要在非root帐户中执行‘<strong>apt-get update</strong>‘，如果第一个命令失败了，接着会执行第二个命令‘<strong>links <a href=\"http://www.tecmint.com\" target=\"_blank\" rel=\"external nofollow\">www.tecmint.com</a></strong>‘。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a348eb08569a913011929\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ntecmint@localhost:~$ apt-get update || links tecmint.com</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a348eb08569a913011929-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a348eb08569a913011929-1\"><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">localhost</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">~</span><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">apt</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">get </span><span class=\"crayon-v\">update</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">links </span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">com</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>上面的命令中，由于该<strong>用户</strong>不允许<strong>更新</strong>系统，这意味着第一个命令的退出状态是’<strong>1</strong>′,因此最后一个命令‘<strong>links tecmint.com</strong>‘会执行。</p>\n<p>如果第一个命令成功执行并且退出状态是‘<strong>0</strong>‘呢？很明显的，第二个命令不会执行。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a348eb08569d080376524\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ntecmint@localhost:~$ mkdir test || links tecmint.com</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a348eb08569d080376524-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a348eb08569d080376524-1\"><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">localhost</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">~</span><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">mkdir </span><span class=\"crayon-v\">test</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">links </span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">com</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>这里，用户在家目录创建了一个‘<strong>test</strong>‘文件夹，这是被允许的。命令成功的执行，退出状态是‘<strong>0</strong>‘,因此，最后的命令不会执行。</p>\n<h3>5. 非操作符 (!)</h3>\n<p><strong>非操作符 (!)</strong>很像<strong>except</strong>语句。这个命令会执行除了提供的条件外的所有的语句。要理解这点，在你的主目录创建一个目录‘<strong>tecmint</strong>’，并‘<strong>cd</strong>’到它这里。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a348eb0856a1431231032\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ntecmint@localhost:~$ mkdir tecmint \r\ntecmint@localhost:~$ cd tecmint</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856a1431231032-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a348eb0856a1431231032-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a348eb0856a1431231032-1\"><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">localhost</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">~</span><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">mkdir </span><span class=\"crayon-e\">tecmint </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a348eb0856a1431231032-2\"><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">localhost</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">~</span><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">cd </span><span class=\"crayon-v\">tecmint</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>接下来，在文件夹‘<strong>tecmint</strong>’下创建不同类型的文件。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a348eb0856a4704540365\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ntecmint@localhost:~/tecmint$ touch a.doc b.doc a.pdf b.pdf a.xml b.xml a.html b.html</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856a4704540365-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a348eb0856a4704540365-1\"><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">localhost</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">~</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">touch</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">doc</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">b</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">doc</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">pdf</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">b</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">pdf</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">xml</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">b</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">xml</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">html</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">b</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">html</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0011 seconds] -->\r\n<p>看一下我们在文件夹‘<strong>tecmint</strong>’创建的新文件。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a348eb0856a9494136727\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ntecmint@localhost:~/tecmint$ ls \r\n\r\na.doc  a.html  a.pdf  a.xml  b.doc  b.html  b.pdf  b.xml</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856a9494136727-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a348eb0856a9494136727-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856a9494136727-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a348eb0856a9494136727-1\"><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">localhost</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">~</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">ls</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a348eb0856a9494136727-2\"> </div><div class=\"crayon-line\" id=\"crayon-5a348eb0856a9494136727-3\"><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">doc</span><span class=\"crayon-h\">  </span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">html</span><span class=\"crayon-h\">  </span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">pdf</span><span class=\"crayon-h\">  </span><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">xml</span><span class=\"crayon-h\">  </span><span class=\"crayon-v\">b</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">doc</span><span class=\"crayon-h\">  </span><span class=\"crayon-v\">b</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">html</span><span class=\"crayon-h\">  </span><span class=\"crayon-v\">b</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">pdf</span><span class=\"crayon-h\">  </span><span class=\"crayon-v\">b</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">xml</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0010 seconds] -->\r\n<p>用一种聪明的办法马上删除除了 ‘<strong>html</strong>’之外的所有文件。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a348eb0856ac404386448\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ntecmint@localhost:~/tecmint$ rm -r !(*.html)</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856ac404386448-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a348eb0856ac404386448-1\"><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">localhost</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">~</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">rm</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">r</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">*</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">html</span><span class=\"crayon-sy\">)</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>验证一下上次的执行结果，使用<a href=\"http://www.tecmint.com/15-basic-ls-command-examples-in-linux/\" target=\"_blank\" rel=\"external nofollow\">ls 命令</a>列出可见所有文件。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a348eb0856af475916488\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ntecmint@localhost:~/tecmint$ ls \r\n\r\na.html  b.html</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856af475916488-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a348eb0856af475916488-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856af475916488-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a348eb0856af475916488-1\"><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">localhost</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">~</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">ls</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a348eb0856af475916488-2\"> </div><div class=\"crayon-line\" id=\"crayon-5a348eb0856af475916488-3\"><span class=\"crayon-v\">a</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">html</span><span class=\"crayon-h\">  </span><span class=\"crayon-v\">b</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">html</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p></p>\n<h3>6. 与或操作符 (&amp;&amp; – ||)</h3>\n<p>上面的操作符实际上是‘<strong>与</strong>’和‘<strong>或</strong>’操作符的组合。它很像‘<strong>if-else</strong>‘语句。</p>\n<p>比如，我们ping <strong>tecmint.com</strong>，如果成功打印‘<strong>已验证</strong>’，否则打印‘<strong>主机故障</strong>’。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a348eb0856b3886515844\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ntecmint@localhost:~/tecmint$ ping -c3 www.tecmint.com &amp;&amp; echo \"Verified\" || echo \"Host Down\"</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856b3886515844-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a348eb0856b3886515844-1\"><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">localhost</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">~</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ping</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">c3 </span><span class=\"crayon-v\">www</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">com</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Verified\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Host Down\"</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n<p></p>\n<h4>示例输出</h4>\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a348eb0856b6350105347\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nPING www.tecmint.com (212.71.234.61) 56(84) bytes of data. \r\n64 bytes from www.tecmint.com (212.71.234.61): icmp_req=1 ttl=55 time=216 ms \r\n64 bytes from www.tecmint.com (212.71.234.61): icmp_req=2 ttl=55 time=224 ms \r\n64 bytes from www.tecmint.com (212.71.234.61): icmp_req=3 ttl=55 time=226 ms \r\n\r\n--- www.tecmint.com ping statistics --- \r\n3 packets transmitted, 3 received, 0% packet loss, time 2001ms \r\nrtt min/avg/max/mdev = 216.960/222.789/226.423/4.199 ms \r\nVerified</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856b6350105347-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a348eb0856b6350105347-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856b6350105347-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a348eb0856b6350105347-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856b6350105347-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a348eb0856b6350105347-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856b6350105347-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a348eb0856b6350105347-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856b6350105347-9\">9</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a348eb0856b6350105347-1\"><span class=\"crayon-e\">PING </span><span class=\"crayon-v\">www</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">com</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">212.71.234.61</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">56</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">84</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">bytes </span><span class=\"crayon-e\">of </span><span class=\"crayon-v\">data</span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a348eb0856b6350105347-2\"><span class=\"crayon-cn\">64</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">bytes </span><span class=\"crayon-e\">from </span><span class=\"crayon-v\">www</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">com</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">212.71.234.61</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">icmp_req</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ttl</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">55</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">time</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">216</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">ms</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-5a348eb0856b6350105347-3\"><span class=\"crayon-cn\">64</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">bytes </span><span class=\"crayon-e\">from </span><span class=\"crayon-v\">www</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">com</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">212.71.234.61</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">icmp_req</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">2</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ttl</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">55</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">time</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">224</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">ms</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a348eb0856b6350105347-4\"><span class=\"crayon-cn\">64</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">bytes </span><span class=\"crayon-e\">from </span><span class=\"crayon-v\">www</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">com</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">212.71.234.61</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">icmp_req</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ttl</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">55</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">time</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">226</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ms</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-5a348eb0856b6350105347-5\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a348eb0856b6350105347-6\"><span class=\"crayon-o\">--</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">www</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">com </span><span class=\"crayon-e\">ping </span><span class=\"crayon-v\">statistics</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-5a348eb0856b6350105347-7\"><span class=\"crayon-cn\">3</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">packets </span><span class=\"crayon-v\">transmitted</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">received</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-o\">%</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">packet </span><span class=\"crayon-v\">loss</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">time</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">2001ms</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a348eb0856b6350105347-8\"><span class=\"crayon-e\">rtt </span><span class=\"crayon-v\">min</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">avg</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">max</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">mdev</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">216.960</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">222.789</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">226.423</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">4.199</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ms </span></div><div class=\"crayon-line\" id=\"crayon-5a348eb0856b6350105347-9\"><span class=\"crayon-v\">Verified</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0035 seconds] -->\r\n<p>现在，断开我们现在的网络连接诶，再试一下相同的命令。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a348eb0856b9995787021\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ntecmint@localhost:~/tecmint$ ping -c3 www.tecmint.com &amp;&amp; echo \"verified\" || echo \"Host Down\"</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856b9995787021-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a348eb0856b9995787021-1\"><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">localhost</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">~</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ping</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">c3 </span><span class=\"crayon-v\">www</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">com</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"verified\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Host Down\"</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n<p></p>\n<h4>实例输出</h4>\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a348eb0856bc629321657\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nping: unknown host www.tecmint.com \r\nHost Down</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856bc629321657-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a348eb0856bc629321657-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a348eb0856bc629321657-1\"><span class=\"crayon-v\">ping</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">unknown </span><span class=\"crayon-e\">host </span><span class=\"crayon-v\">www</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">com </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a348eb0856bc629321657-2\"><span class=\"crayon-e\">Host </span><span class=\"crayon-v\">Down</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p></p>\n<h3>7. 管道操作符 (|)</h3>\n<p><strong>PIPE</strong>在将第一个命令的输出作为第二个命令的输入时很有用。比如，‘<strong>ls -l</strong>’的输出通过管道到‘<strong>less</strong>’，并看一下输出。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a348eb0856c0495197563\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ntecmint@localhost:~$ ls -l | less</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856c0495197563-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a348eb0856c0495197563-1\"><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">localhost</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">~</span><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ls</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">l</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">|</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">less</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p></p>\n<h3>8. 命令合并操作符 {}</h3>\n<p>合并两个或多个命令，第二个命令依赖于第一个命令的执行。</p>\n<p>比如，检查一下文件‘<strong>xyz.txt</strong>’是否在<strong>Downloads</strong>目录下，如果不存在则创建之并输出提示信息。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a348eb0856c3574075729\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ntecmint@localhost:~$ [ -f /home/tecmint/Downloads/xyz.txt ] || touch /home/tecmint/Downloads/xyz.txt; echo \"The file does not exist\"</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856c3574075729-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a348eb0856c3574075729-1\"><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">localhost</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">~</span><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">f</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">home</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">Downloads</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">xyz</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">txt</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">touch</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">home</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">Downloads</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">xyz</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">txt</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"The file does not exist\"</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0012 seconds] -->\r\n<p>但是这样的命令的运行结果并不如我们预期的运行，会始终都输出提示信息。因此需要使用{}操作符来合并命令：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a348eb0856c6514554343\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ntecmint@localhost:~$ [ -f /home/tecmint/Downloads/xyz1.txt ] || {touch /home/tecmint/Downloads/xyz.txt; echo \"The file does not exist\"}\r\n\r\n“The file does not exist”</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856c6514554343-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a348eb0856c6514554343-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856c6514554343-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a348eb0856c6514554343-1\"><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">localhost</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">~</span><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">f</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">home</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">Downloads</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">xyz1</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">txt</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">touch</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">home</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">tecmint</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">Downloads</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">xyz</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">txt</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"The file does not exist\"</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a348eb0856c6514554343-2\"> </div><div class=\"crayon-line\" id=\"crayon-5a348eb0856c6514554343-3\">“<span class=\"crayon-e\">The </span><span class=\"crayon-e\">file </span><span class=\"crayon-e\">does </span><span class=\"crayon-st\">not</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">exist</span>”</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0014 seconds] -->\r\n<p>（译注：原文这里应该也是复制或书写的时候，出现了一些问题，例子中并没有出现小标题中的”{}”操作符，所以这里我们进行了修改）</p>\n<h3>9. 优先操作符 ()</h3>\n<p>这个操作符可以让命令以优先顺序执行。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a348eb0856c9772801590\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nCommand_x1 &amp;&amp;Command_x2 || Command_x3 &amp;&amp; Command_x4.</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856c9772801590-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a348eb0856c9772801590-1\"><span class=\"crayon-v\">Command_x1</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-v\">Command_x2</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Command_x3</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Command_x4</span><span class=\"crayon-sy\">.</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>在上面的伪代码中，如果<strong>Command_x1</strong>执行失败了会怎么样，<strong>Command_x2</strong>, <strong>Command_x3</strong>, <strong>Command_x4</strong>没有一个会执行，对于这种情况，我们使用<strong>优先操作符</strong>。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a348eb0856cf337030598\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n(Command_x1 &amp;&amp;Command_x2) || (Command_x3 &amp;&amp; Command_x4)</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856cf337030598-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a348eb0856cf337030598-1\"><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Command_x1</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-v\">Command_x2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Command_x3</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Command_x4</span><span class=\"crayon-sy\">)</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>在上面的伪代码中，如果<strong>Command_x1</strong>执行失败，<strong>Command_x2</strong>不会执行，但是<strong>Command_x3</strong>会继续执行， <strong>Command_x4</strong>会依赖于 <strong>Command_x3</strong>的退出状态。</p>\n<h3>10. 连接符 ($$</h3>\n<p><strong>连接符 ()</strong>如它名字所说，被用于连接shell中那些太长而需要分成多行的命令。可以在输入一个“\\”之后就回车，然后继续输入命令行，直到输入完成。比如，下面的命令会打开文本文件<strong>test(1).txt</strong>。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a348eb0856d3508369540\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ntecmint@localhost:~/Downloads$ nano test \\\r\n1.txt</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a348eb0856d3508369540-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a348eb0856d3508369540-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a348eb0856d3508369540-1\"><span class=\"crayon-v\">tecmint</span><span class=\"crayon-sy\">@</span><span class=\"crayon-v\">localhost</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">~</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">Downloads</span><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">nano </span><span class=\"crayon-i\">test</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">\\</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a348eb0856d3508369540-2\"><span class=\"crayon-cn\">1.txt</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p> </p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113305\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113305votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113305\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "url": "http://blog.jobbole.com/113305/", "comment_nums": 0, "praise_nums": 1, "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2017/12/a358ba4f51dd7f1dac9b1dfc1fef5343.png"]},{"title": "如何在 Linux 下统计高速网络中的流量", "url_object_id": "3d616518c51266775d612bb308e5855a", "create_date": "2017/12/09", "tags": "IT技术,Linux", "fav_nums": 0, "front_image_path": "full/662a63e34b6deebe6fc3d2666d88b8eafd6e2826.jpg", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"http://xmodulo.com/measure-packets-per-second-throughput-high-speed-network-interface.html\">Dan Nanni</a>   译文出处：<a target=\"_blank\" href=\"\">彭秦进</a>   </div><p><a title=\"如何在Linux下统计高速网络中的流量\" href=\"https://dn-linuxcn.qbox.me/data/attachment/album/201401/20/111509bcnzyb75c7v8e1ch.jpeg\" target=\"_blank\" rel=\"lightbox[5558]\"><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/93caf558382f0e23253d7b6a7cc1b012.jpeg\" alt=\"nethogs2\" width=\"594\" height=\"354\"></a></p>\n<p>在Linux中有很多的流量监控工具，它们可以监控、分类网络流量，以花哨的图形用户界面提供实时流量分析报告。大多数这些工具（例如：<a href=\"http://xmodulo.com/2013/10/set-web-based-network-traffic-monitoring-linux.html\" target=\"_blank\" rel=\"external nofollow\">ntopng </a>, <a href=\"http://xmodulo.com/2013/10/set-web-based-network-traffic-monitoring-linux.html\" target=\"_blank\" rel=\"external nofollow\"> </a><a href=\"http://xmodulo.com/2012/06/how-to-install-iftop-on-linux.html\" target=\"_blank\" rel=\"external nofollow\">iftop </a>）都是基于<a href=\"http://www.tcpdump.org/pcap3_man.html\" target=\"_blank\" rel=\"external nofollow\">libpcap</a> 库的 ，这个函数库是用来截取流经网卡的数据包的，可在用户空间用来监视分析网络流量。尽管这些工具功能齐全，然而基于libpcap库的流量监控工具无法处理高速（Gb以上）的网络接口，原因是由于在用户空间做数据包截取的系统开销过高所致。</p>\n<p>在本文中我们介绍一种简单的Shell 脚本，它可以监控网络流量而且不依赖于缓慢的libpcap库。这些脚本支持Gb以上规模的高速网络接口，如果你对“汇聚型”的网络流量感兴趣的话，它们可统计每个网络接口上的流量。</p>\n<p>脚本主要是基于<a href=\"http://lwn.net/Articles/31185/\" target=\"_blank\" rel=\"external nofollow\">sysfs</a>虚拟文件系统，这是由内核用来将设备或驱动相关的信息输出到用户空间的一种机制。网络接口的相关分析数据会通过“/sys/class/net//statistics”输出。</p>\n<p>举个例子，eth0的网口上分析报告会输出到这些文件中：</p>\n<ul>\n<li><strong>/sys/class/net/eth0/statistics/rx_packets:</strong> 收到的数据包数据</li>\n<li><strong>/sys/class/net/eth0/statistics/tx_packets:</strong> 传输的数据包数量</li>\n<li><strong>/sys/class/net/eth0/statistics/rx_bytes:</strong> 接收的字节数</li>\n<li><strong>/sys/class/net/eth0/statistics/tx_bytes:</strong> 传输的字节数</li>\n<li><strong>/sys/class/net/eth0/statistics/rx_dropped:</strong> 当收到包数据包下降的数据量</li>\n<li><strong>/sys/class/net/eth0/statistics/tx_dropped:</strong> 传输包数据包下降的数据量</li>\n</ul>\n<p>这些数据会根据内核数据发生变更的时候自动刷新。因此，你可以编写一系列的脚本进行分析并计算流量统计。下面就是这样的脚本（感谢 <a href=\"https://gist.github.com/joemiller/4069513\" target=\"_blank\" rel=\"external nofollow\">joemiller</a> 提供）。第一个脚本是统计每秒数据量，包含接收（RX）或发送（TX）。而后面的则是一个描述网络传输中的接收（RX）发送(TX)带宽。这些脚本中安装不需要任何的工具。</p>\n<p>测量网口每秒数据包：</p>\n<div id=\"crayon-52dc688d925f7354156767\">\n<div>\n<!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a34465e1da72891219409\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#!/bin/bash\r\n\r\nINTERVAL=\"1\"  # update interval in seconds\r\n\r\nif [ -z \"$1\" ]; then\r\n        echo\r\n        echo usage: $0 [network-interface]\r\n        echo\r\n        echo e.g. $0 eth0\r\n        echo\r\n        echo shows packets-per-second\r\n        exit\r\nfi\r\n\r\nIF=$1\r\n\r\nwhile true\r\ndo\r\n        R1=`cat /sys/class/net/$1/statistics/rx_packets`\r\n        T1=`cat /sys/class/net/$1/statistics/tx_packets`\r\n        sleep $INTERVAL\r\n        R2=`cat /sys/class/net/$1/statistics/rx_packets`\r\n        T2=`cat /sys/class/net/$1/statistics/tx_packets`\r\n        TXPPS=`expr $T2 - $T1`\r\n        RXPPS=`expr $R2 - $R1`\r\n        echo \"TX $1: $TXPPS pkts/s RX $1: $RXPPS pkts/s\"\r\ndone</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da72891219409-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da72891219409-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da72891219409-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da72891219409-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da72891219409-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da72891219409-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da72891219409-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da72891219409-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da72891219409-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da72891219409-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da72891219409-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da72891219409-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da72891219409-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da72891219409-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da72891219409-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da72891219409-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da72891219409-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da72891219409-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da72891219409-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da72891219409-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da72891219409-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da72891219409-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da72891219409-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da72891219409-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da72891219409-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da72891219409-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da72891219409-27\">27</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a34465e1da72891219409-1\"><span class=\"crayon-p\">#!/bin/bash</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da72891219409-2\"> </div><div class=\"crayon-line\" id=\"crayon-5a34465e1da72891219409-3\"><span class=\"crayon-v\">INTERVAL</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"1\"</span><span class=\"crayon-h\">  </span><span class=\"crayon-p\"># update interval in seconds</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da72891219409-4\"> </div><div class=\"crayon-line\" id=\"crayon-5a34465e1da72891219409-5\"><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">z</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"$1\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">then</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da72891219409-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">echo</span></div><div class=\"crayon-line\" id=\"crayon-5a34465e1da72891219409-7\"><span class=\"crayon-e\">        </span><span class=\"crayon-e\">echo </span><span class=\"crayon-v\">usage</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">network</span><span class=\"crayon-o\">-</span><span class=\"crayon-t\">interface</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da72891219409-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">echo</span></div><div class=\"crayon-line\" id=\"crayon-5a34465e1da72891219409-9\"><span class=\"crayon-e\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">g</span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">eth0</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da72891219409-10\"><span class=\"crayon-e\">        </span><span class=\"crayon-e\">echo</span></div><div class=\"crayon-line\" id=\"crayon-5a34465e1da72891219409-11\"><span class=\"crayon-e\">        </span><span class=\"crayon-e\">echo </span><span class=\"crayon-e\">shows </span><span class=\"crayon-v\">packets</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">per</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">second</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da72891219409-12\"><span class=\"crayon-e\">        </span><span class=\"crayon-e\">exit</span></div><div class=\"crayon-line\" id=\"crayon-5a34465e1da72891219409-13\"><span class=\"crayon-e\">fi</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da72891219409-14\"> </div><div class=\"crayon-line\" id=\"crayon-5a34465e1da72891219409-15\"><span class=\"crayon-st\">IF</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">$</span><span class=\"crayon-cn\">1</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da72891219409-16\"> </div><div class=\"crayon-line\" id=\"crayon-5a34465e1da72891219409-17\"><span class=\"crayon-st\">while</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da72891219409-18\"><span class=\"crayon-st\">do</span></div><div class=\"crayon-line\" id=\"crayon-5a34465e1da72891219409-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">R1</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">cat</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">sys</span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">class</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">net</span><span class=\"crayon-o\">/</span><span class=\"crayon-sy\">$</span><span class=\"crayon-cn\">1</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">statistics</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">rx_packets</span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da72891219409-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">T1</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">cat</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">sys</span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">class</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">net</span><span class=\"crayon-o\">/</span><span class=\"crayon-sy\">$</span><span class=\"crayon-cn\">1</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">statistics</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">tx_packets</span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line\" id=\"crayon-5a34465e1da72891219409-21\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">sleep</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-e\">INTERVAL</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da72891219409-22\"><span class=\"crayon-e\">        </span><span class=\"crayon-v\">R2</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">cat</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">sys</span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">class</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">net</span><span class=\"crayon-o\">/</span><span class=\"crayon-sy\">$</span><span class=\"crayon-cn\">1</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">statistics</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">rx_packets</span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line\" id=\"crayon-5a34465e1da72891219409-23\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">T2</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">cat</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">sys</span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">class</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">net</span><span class=\"crayon-o\">/</span><span class=\"crayon-sy\">$</span><span class=\"crayon-cn\">1</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">statistics</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">tx_packets</span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da72891219409-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">TXPPS</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">`</span><span class=\"crayon-i\">expr</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">T2</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">T1</span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line\" id=\"crayon-5a34465e1da72891219409-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">RXPPS</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">`</span><span class=\"crayon-i\">expr</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">R2</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">R1</span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da72891219409-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"TX $1: $TXPPS pkts/s RX $1: $RXPPS pkts/s\"</span></div><div class=\"crayon-line\" id=\"crayon-5a34465e1da72891219409-27\"><span class=\"crayon-v\">done</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0037 seconds] -->\r\n\n</div>\n</div>\n<p>网络带宽测量</p>\n<div id=\"crayon-52dc688d92610571820674\">\n<div>\n<!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a34465e1da80263420032\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n#!/bin/bash\r\n\r\nINTERVAL=\"1\"  # update interval in seconds\r\n\r\nif [ -z \"$1\" ]; then\r\n        echo\r\n        echo usage: $0 [network-interface]\r\n        echo\r\n        echo e.g. $0 eth0\r\n        echo\r\n        exit\r\nfi\r\n\r\nIF=$1\r\n\r\nwhile true\r\ndo\r\n        R1=`cat /sys/class/net/$1/statistics/rx_bytes`\r\n        T1=`cat /sys/class/net/$1/statistics/tx_bytes`\r\n        sleep $INTERVAL\r\n        R2=`cat /sys/class/net/$1/statistics/rx_bytes`\r\n        T2=`cat /sys/class/net/$1/statistics/tx_bytes`\r\n        TBPS=`expr $T2 - $T1`\r\n        RBPS=`expr $R2 - $R1`\r\n        TKBPS=`expr $TBPS / 1024`\r\n        RKBPS=`expr $RBPS / 1024`\r\n        echo \"TX $1: $TKBPS kb/s RX $1: $RKBPS kb/s\"\r\ndone</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da80263420032-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da80263420032-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da80263420032-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da80263420032-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da80263420032-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da80263420032-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da80263420032-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da80263420032-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da80263420032-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da80263420032-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da80263420032-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da80263420032-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da80263420032-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da80263420032-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da80263420032-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da80263420032-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da80263420032-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da80263420032-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da80263420032-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da80263420032-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da80263420032-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da80263420032-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da80263420032-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da80263420032-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da80263420032-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da80263420032-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5a34465e1da80263420032-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a34465e1da80263420032-28\">28</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a34465e1da80263420032-1\"><span class=\"crayon-p\">#!/bin/bash</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da80263420032-2\"> </div><div class=\"crayon-line\" id=\"crayon-5a34465e1da80263420032-3\"><span class=\"crayon-v\">INTERVAL</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"1\"</span><span class=\"crayon-h\">  </span><span class=\"crayon-p\"># update interval in seconds</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da80263420032-4\"> </div><div class=\"crayon-line\" id=\"crayon-5a34465e1da80263420032-5\"><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">z</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"$1\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">then</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da80263420032-6\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">echo</span></div><div class=\"crayon-line\" id=\"crayon-5a34465e1da80263420032-7\"><span class=\"crayon-e\">        </span><span class=\"crayon-e\">echo </span><span class=\"crayon-v\">usage</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">network</span><span class=\"crayon-o\">-</span><span class=\"crayon-t\">interface</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da80263420032-8\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">echo</span></div><div class=\"crayon-line\" id=\"crayon-5a34465e1da80263420032-9\"><span class=\"crayon-e\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">g</span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">eth0</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da80263420032-10\"><span class=\"crayon-e\">        </span><span class=\"crayon-e\">echo</span></div><div class=\"crayon-line\" id=\"crayon-5a34465e1da80263420032-11\"><span class=\"crayon-e\">        </span><span class=\"crayon-e\">exit</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da80263420032-12\"><span class=\"crayon-e\">fi</span></div><div class=\"crayon-line\" id=\"crayon-5a34465e1da80263420032-13\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da80263420032-14\"><span class=\"crayon-st\">IF</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">$</span><span class=\"crayon-cn\">1</span></div><div class=\"crayon-line\" id=\"crayon-5a34465e1da80263420032-15\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da80263420032-16\"><span class=\"crayon-st\">while</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span></div><div class=\"crayon-line\" id=\"crayon-5a34465e1da80263420032-17\"><span class=\"crayon-st\">do</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da80263420032-18\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">R1</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">cat</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">sys</span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">class</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">net</span><span class=\"crayon-o\">/</span><span class=\"crayon-sy\">$</span><span class=\"crayon-cn\">1</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">statistics</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">rx_bytes</span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line\" id=\"crayon-5a34465e1da80263420032-19\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">T1</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">cat</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">sys</span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">class</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">net</span><span class=\"crayon-o\">/</span><span class=\"crayon-sy\">$</span><span class=\"crayon-cn\">1</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">statistics</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">tx_bytes</span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da80263420032-20\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">sleep</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-e\">INTERVAL</span></div><div class=\"crayon-line\" id=\"crayon-5a34465e1da80263420032-21\"><span class=\"crayon-e\">        </span><span class=\"crayon-v\">R2</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">cat</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">sys</span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">class</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">net</span><span class=\"crayon-o\">/</span><span class=\"crayon-sy\">$</span><span class=\"crayon-cn\">1</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">statistics</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">rx_bytes</span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da80263420032-22\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">T2</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">cat</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">sys</span><span class=\"crayon-o\">/</span><span class=\"crayon-t\">class</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">net</span><span class=\"crayon-o\">/</span><span class=\"crayon-sy\">$</span><span class=\"crayon-cn\">1</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">statistics</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">tx_bytes</span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line\" id=\"crayon-5a34465e1da80263420032-23\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">TBPS</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">`</span><span class=\"crayon-i\">expr</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">T2</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">T1</span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da80263420032-24\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">RBPS</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">`</span><span class=\"crayon-i\">expr</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">R2</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">R1</span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line\" id=\"crayon-5a34465e1da80263420032-25\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">TKBPS</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">`</span><span class=\"crayon-i\">expr</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">TBPS</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1024</span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da80263420032-26\"><span class=\"crayon-h\">        </span><span class=\"crayon-v\">RKBPS</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">`</span><span class=\"crayon-i\">expr</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">RBPS</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1024</span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line\" id=\"crayon-5a34465e1da80263420032-27\"><span class=\"crayon-h\">        </span><span class=\"crayon-i\">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"TX $1: $TKBPS kb/s RX $1: $RKBPS kb/s\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a34465e1da80263420032-28\"><span class=\"crayon-v\">done</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0040 seconds] -->\r\n\n</div>\n</div>\n<p>下面的屏幕截图显示了上面的两个脚本的输出。</p>\n<p><a title=\"如何在Linux下统计高速网络中的流量\" href=\"https://dn-linuxcn.qbox.me/data/attachment/album/201401/20/111511ua1cdxnc8ncu1sdz.jpg\" target=\"_blank\" rel=\"lightbox[5558]\"><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/2f570edeab36f18c3bf5fc0f64a8feea.jpg\" alt=\"152940zdJ\" width=\"640\" height=\"386\"></a></p>\n<p> </p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113226\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113226votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113226\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "url": "http://blog.jobbole.com/113226/", "comment_nums": 0, "praise_nums": 1, "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2017/12/93caf558382f0e23253d7b6a7cc1b012.jpeg"]},{"title": "MySQL 引擎特性：InnoDB Buffer Pool", "url_object_id": "d85a15e01856b264ac4cedfbaff15491", "create_date": "2017/12/13", "tags": "IT技术,MySQL,数据库", "fav_nums": 1, "front_image_path": "full/75f6595b87bc254afe77bc1151f1aea91fb72f4b.jpg", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/coderyuhui/p/6861194.html\">水中的泪</a>   </div><h3 id=\"前言\">前言</h3>\n<p>用户对数据库的最基本要求就是能高效的读取和存储数据，但是读写数据都涉及到与低速的设备交互，为了弥补两者之间的速度差异，所有数据库都有缓存池，用来管理相应的数据页，提高数据库的效率，当然也因为引入了这一中间层，数据库对内存的管理变得相对比较复杂。本文主要分析MySQL Buffer Pool的相关技术以及实现原理，源码基于阿里云RDS MySQL 5.6分支，其中部分特性已经开源到AliSQL。Buffer Pool相关的源代码在buf目录下，主要包括LRU List，Flu List，Double write buffer, 预读预写，Buffer Pool预热，压缩页内存管理等模块，包括头文件和IC文件，一共两万行代码。</p>\n<h3 id=\"基础知识\">基础知识</h3>\n<p><strong><em>Buffer Pool Instance: </em></strong> 大小等于innodb_buffer_pool_size/innodb_buffer_pool_instances，每个instance都有自己的锁，信号量，物理块(Buffer chunks)以及逻辑链表(下面的各种List)，即各个instance之间没有竞争关系，可以并发读取与写入。所有instance的物理块(Buffer chunks)在数据库启动的时候被分配，直到数据库关闭内存才予以释放。当innodb_buffer_pool_size小于1GB时候，innodb_buffer_pool_instances被重置为1，主要是防止有太多小的instance从而导致性能问题。每个Buffer Pool Instance有一个page hash链表，通过它，使用space_id和page_no就能快速找到已经被读入内存的数据页，而不用线性遍历LRU List去查找。注意这个hash表不是InnoDB的自适应哈希，自适应哈希是为了减少Btree的扫描，而page hash是为了避免扫描LRU List。<br>\n<strong><em>数据页：</em></strong> InnoDB中，数据管理的最小单位为页，默认是16KB，页中除了存储用户数据，还可以存储控制信息的数据。InnoDB IO子系统的读写最小单位也是页。如果对表进行了压缩，则对应的数据页称为压缩页，如果需要从压缩页中读取数据，则压缩页需要先解压，形成解压页，解压页为16KB。压缩页的大小是在建表的时候指定，目前支持16K，8K，4K，2K，1K。即使压缩页大小设为16K，在blob/varchar/text的类型中也有一定好处。假设指定的压缩页大小为4K，如果有个数据页无法被压缩到4K以下，则需要做B-tree分裂操作，这是一个比较耗时的操作。正常情况下，Buffer Pool中会把压缩和解压页都缓存起来，当Free List不够时，按照系统当前的实际负载来决定淘汰策略。如果系统瓶颈在IO上，则只驱逐解压页，压缩页依然在Buffer Pool中，否则解压页和压缩页都被驱逐。<br>\n<strong><em>Buffer Chunks: </em></strong> 包括两部分：数据页和数据页对应的控制体，控制体中有指针指向数据页。Buffer Chunks是最低层的物理块，在启动阶段从操作系统申请，直到数据库关闭才释放。通过遍历chunks可以访问几乎所有的数据页，有两种状态的数据页除外：没有被解压的压缩页(BUF_BLOCK_ZIP_PAGE)以及被修改过且解压页已经被驱逐的压缩页(BUF_BLOCK_ZIP_DIRTY)。此外数据页里面不一定都存的是用户数据，开始是控制信息，比如行锁，自适应哈希等。<br>\n<strong><em>逻辑链表: </em></strong> 链表节点是数据页的控制体(控制体中有指针指向真正的数据页)，链表中的所有节点都有同一的属性，引入其的目的是方便管理。下面其中链表都是逻辑链表。<br>\n<strong><em>Free List: </em></strong> 其上的节点都是未被使用的节点，如果需要从数据库中分配新的数据页，直接从上获取即可。InnoDB需要保证Free List有足够的节点，提供给用户线程用，否则需要从FLU List或者LRU List淘汰一定的节点。InnoDB初始化后，Buffer Chunks中的所有数据页都被加入到Free List，表示所有节点都可用。<br>\n<strong><em>LRU List: </em></strong> 这个是InnoDB中最重要的链表。所有新读取进来的数据页都被放在上面。链表按照最近最少使用算法排序，最近最少使用的节点被放在链表末尾，如果Free List里面没有节点了，就会从中淘汰末尾的节点。LRU List还包含没有被解压的压缩页，这些压缩页刚从磁盘读取出来，还没来的及被解压。LRU List被分为两部分，默认前5/8为young list，存储经常被使用的热点page，后3/8为old list。新读入的page默认被加在old list头，只有满足一定条件后，才被移到young list上，主要是为了预读的数据页和全表扫描污染buffer pool。<br>\n<strong><em>FLU List: </em></strong> 这个链表中的所有节点都是脏页，也就是说这些数据页都被修改过，但是还没来得及被刷新到磁盘上。在FLU List上的页面一定在LRU List上，但是反之则不成立。一个数据页可能会在不同的时刻被修改多次，在数据页上记录了最老(也就是第一次)的一次修改的lsn，即oldest_modification。不同数据页有不同的oldest_modification，FLU List中的节点按照oldest_modification排序，链表尾是最小的，也就是最早被修改的数据页，当需要从FLU List中淘汰页面时候，从链表尾部开始淘汰。加入FLU List，需要使用flush_list_mutex保护，所以能保证FLU List中节点的顺序。<br>\n<strong><em>Quick List: </em></strong> 这个链表是阿里云RDS MySQL 5.6加入的，使用带Hint的SQL查询语句，可以把所有这个查询的用到的数据页加入到Quick List中，一旦这个语句结束，就把这个数据页淘汰，主要作用是避免LRU List被全表扫描污染。<br>\n<strong><em>Unzip LRU List: </em></strong> 这个链表中存储的数据页都是解压页，也就是说，这个数据页是从一个压缩页通过解压而来的。<br>\n<strong><em>Zip Clean List: </em></strong> 这个链表只在Debug模式下有，主要是存储没有被解压的压缩页。这些压缩页刚刚从磁盘读取出来，还没来的及被解压，一旦被解压后，就从此链表中删除，然后加入到Unzip LRU List中。<br>\n<strong><em>Zip Free: </em></strong> 压缩页有不同的大小，比如8K，4K，InnoDB使用了类似内存管理的伙伴系统来管理压缩页。Zip Free可以理解为由5个链表构成的一个二维数组，每个链表分别存储了对应大小的内存碎片，例如8K的链表里存储的都是8K的碎片，如果新读入一个8K的页面，首先从这个链表中查找，如果有则直接返回，如果没有则从16K的链表中分裂出两个8K的块，一个被使用，另外一个放入8K链表中。</p>\n<h3 id=\"核心数据结构\">核心数据结构</h3>\n<p>InnoDB Buffer Pool有三种核心的数据结构：buf_pool_t，buf_block_t，buf_page_t。<br>\n<strong><em>but_pool_t: </em></strong> 存储Buffer Pool Instance级别的控制信息，例如整个Buffer Pool Instance的mutex，instance_no, page_hash，old_list_pointer等。还存储了各种逻辑链表的链表根节点。Zip Free这个二维数组也在其中。<br>\n<strong><em>buf_block_t: </em></strong> 这个就是数据页的控制体，用来描述数据页部分的信息(大部分信息在buf_page_t中)。buf_block_t中第一字段就是buf_page_t，这个不是随意放的，是必须放在第一字段，因为只有这样buf_block_t和buf_page_t两种类型的指针可以相互转换。第二个字段是frame字段，指向真正存数据的数据页。buf_block_t还存储了Unzip LRU List链表的根节点。另外一个比较重要的字段就是block级别的mutex。<br>\n<strong><em>buf_page_t: </em></strong> 这个可以理解为另外一个数据页的控制体，大部分的数据页信息存在其中，例如space_id, page_no, page state, newest_modification，oldest_modification，access_time以及压缩页的所有信息等。压缩页的信息包括压缩页的大小，压缩页的数据指针(真正的压缩页数据是存储在由伙伴系统分配的数据页上)。这里需要注意一点，如果某个压缩页被解压了，解压页的数据指针是存储在buf_block_t的frame字段里。</p>\n<p>这里介绍一下buf_page_t中的state字段，这个字段主要用来表示当前页的状态。一共有八种状态。这八种状态对初学者可能比较难理解，尤其是前三种，如果看不懂可以先跳过。<br>\n<strong><em>BUF_BLOCK_POOL_WATCH: </em></strong> 这种类型的page是提供给purge线程用的。InnoDB为了实现多版本，需要把之前的数据记录在undo log中，如果没有读请求再需要它，就可以通过purge线程删除。换句话说，purge线程需要知道某些数据页是否被读取，现在解法就是首先查看page hash，看看这个数据页是否已经被读入，如果没有读入，则获取(启动时候通过malloc分配，不在Buffer Chunks中)一个BUF_BLOCK_POOL_WATCH类型的哨兵数据页控制体，同时加入page_hash但是没有真正的数据(buf_blokc_t::frame为空)并把其类型置为BUF_BLOCK_ZIP_PAGE(表示已经被使用了，其他purge线程就不会用到这个控制体了)，相关函数<code>buf_pool_watch_set</code>，如果查看page hash后发现有这个数据页，只需要判断控制体在内存中的地址是否属于Buffer Chunks即可，如果是表示对应数据页已经被其他线程读入了，相关函数<code>buf_pool_watch_occurred</code>。另一方面，如果用户线程需要这个数据页，先查看page hash看看是否是BUF_BLOCK_POOL_WATCH类型的数据页，如果是则回收这个BUF_BLOCK_POOL_WATCH类型的数据页，从Free List中(即在Buffer Chunks中)分配一个空闲的控制体，填入数据。这里的核心思想就是通过控制体在内存中的地址来确定数据页是否还在被使用。<br>\n<strong><em>BUF_BLOCK_ZIP_PAGE: </em></strong>当压缩页从磁盘读取出来的时候，先通过malloc分配一个临时的buf_page_t，然后从伙伴系统中分配出压缩页存储的空间，把磁盘中读取的压缩数据存入，然后把这个临时的buf_page_t标记为BUF_BLOCK_ZIP_PAGE状态(<code>buf_page_init_for_read</code>)，只有当这个压缩页被解压了，state字段才会被修改为BUF_BLOCK_FILE_PAGE，并加入LRU List和Unzip LRU List(<code>buf_page_get_gen</code>)。如果一个压缩页对应的解压页被驱逐了，但是需要保留这个压缩页且压缩页不是脏页，则这个压缩页被标记为BUF_BLOCK_ZIP_PAGE(<code>buf_LRU_free_page</code>)。所以正常情况下，处于BUF_BLOCK_ZIP_PAGE状态的不会很多。前述两种被标记为BUF_BLOCK_ZIP_PAGE的压缩页都在LRU List中。另外一个用法是，从BUF_BLOCK_POOL_WATCH类型节点中，如果被某个purge线程使用了，也会被标记为BUF_BLOCK_ZIP_PAGE。<br>\n<strong><em>BUF_BLOCK_ZIP_DIRTY: </em></strong> 如果一个压缩页对应的解压页被驱逐了，但是需要保留这个压缩页且压缩页是脏页，则被标记为BUF_BLOCK_ZIP_DIRTY(<code>buf_LRU_free_page</code>)，如果该压缩页又被解压了，则状态会变为BUF_BLOCK_FILE_PAGE。因此BUF_BLOCK_ZIP_DIRTY也是一个比较短暂的状态。这种类型的数据页都在Flush List中。<br>\n<strong><em>BUF_BLOCK_NOT_USED: </em></strong> 当链表处于Free List中，状态就为此状态。是一个能长期存在的状态。<br>\n<strong><em>BUF_BLOCK_READY_FOR_USE: </em></strong> 当从Free List中，获取一个空闲的数据页时，状态会从BUF_BLOCK_NOT_USED变为BUF_BLOCK_READY_FOR_USE(<code>buf_LRU_get_free_block</code>)，也是一个比较短暂的状态。处于这个状态的数据页不处于任何逻辑链表中。<br>\n<strong><em>BUF_BLOCK_FILE_PAGE: </em></strong> 正常被使用的数据页都是这种状态。LRU List中，大部分数据页都是这种状态。压缩页被解压后，状态也会变成BUF_BLOCK_FILE_PAGE。<br>\n<strong><em>BUF_BLOCK_MEMORY: </em></strong> Buffer Pool中的数据页不仅可以存储用户数据，也可以存储一些系统信息，例如InnoDB行锁，自适应哈希索引以及压缩页的数据等，这些数据页被标记为BUF_BLOCK_MEMORY。处于这个状态的数据页不处于任何逻辑链表中<br>\n<strong><em>BUF_BLOCK_REMOVE_HASH: </em></strong> 当加入Free List之前，需要先把page hash移除。因此这种状态就表示此页面page hash已经被移除，但是还没被加入到Free List中，是一个比较短暂的状态。<br>\n总体来说，大部分数据页都处于BUF_BLOCK_NOT_USED(全部在Free List中)和BUF_BLOCK_FILE_PAGE(大部分处于LRU List中，LRU List中还包含除被purge线程标记的BUF_BLOCK_ZIP_PAGE状态的数据页)状态，少部分处于BUF_BLOCK_MEMORY状态，极少处于其他状态。前三种状态的数据页都不在Buffer Chunks上，对应的控制体都是临时分配的，InnoDB把他们列为invalid state(<code>buf_block_state_valid</code>)。<br>\n如果理解了这八种状态以及其之间的转换关系，那么阅读Buffer pool的代码细节就会更加游刃有余。</p>\n<p>接下来，简单介绍一下buf_page_t中buf_fix_count和io_fix两个变量，这两个变量主要用来做并发控制，减少mutex加锁的范围。当从buffer pool读取一个数据页时候，会其加读锁，然后递增buf_page_t::buf_fix_count，同时设置buf_page_t::io_fix为BUF_IO_READ，然后即可以释放读锁。后续如果其他线程在驱逐数据页(或者刷脏)的时候，需要先检查一下这两个变量，如果buf_page_t::buf_fix_count不为零且buf_page_t::io_fix不为BUF_IO_NONE，则不允许驱逐(<code>buf_page_can_relocate</code>)。这里的技巧主要是为了减少数据页控制体上mutex的争抢，而对数据页的内容，读取的时候依然要加读锁，修改时加写锁。</p>\n<h3 id=\"buffer-pool内存初始化\">Buffer Pool内存初始化</h3>\n<p>Buffer Pool的内存初始化，主要是Buffer Chunks的内存初始化，buffer pool instance一个一个轮流初始化。核心函数为<code>buf_chunk_init</code>和<code>os_mem_alloc_large</code><br>\n。阅读代码可以发现，目前从操作系统分配内存有两种方式，一种是通过HugeTLB的方式来分配，另外一种使用传统的mmap来分配。<br>\n<strong><em>HugeTLB: </em></strong> 这是一种大内存块的分配管理技术。类似数据库对数据的管理，内存也按照页来管理，默认的页大小为4KB，HugeTLB就是把页大小提高到2M或者更加多。程序传送给cpu都是虚拟内存地址，cpu必须通过快表来映射到真正的物理内存地址。快表的全集放在内存中，部分热点内存页可以放在cpu cache中，从而提高内存访问效率。假设cpu cache为100KB，每条快表占用1KB，页大小为4KB，则热点内存页为100KB/1KB=100条，覆盖100<em>4KB=400KB的内存数据，但是如果也默认页大小为2M，则同样大小的cpu cache，可以覆盖100</em>2M=200MB的内存数据，也就是说，访问200MB的数据只需要一次读取内存即可(如果映射关系没有在cache中找到，则需要先把映射关系从内存中读到cache，然后查找，最后再去读内存中需要的数据，会造成两次访问物理内存)。也就是说，使用HugeTLB这种大内存技术，可以提高快表的命中率，从而提高访问内存的性能。当然这个技术也不是银弹，内存页变大了也必定会导致更多的页内的碎片。如果需要从swap分区中加载虚拟内存，也会变慢。当然最终要的理由是，4KB大小的内存页已经被业界稳定使用很多年了，如果没有特殊的需求不需要冒这个风险。在InnoDB中，如果需要用到这项技术可以使用super-large-pages参数启动MySQL。<br>\n<strong><em>mmap分配：</em></strong> 在Linux下，多个进程需要共享一片内存，可以使用mmap来分配和绑定，所以只提供给一个MySQL进程使用也是可以的。用mmap分配的内存都是虚存，在top命令中占用VIRT这一列，而不是RES这一列，只有相应的内存被真正使用到了，才会被统计到RES中，提高内存使用率。这样是为什么常常看到MySQL一启动就被分配了很多的VIRT，而RES却是慢慢涨上来的原因。这里大家可能有个疑问，为啥不用malloc。其实查阅malloc文档，可以发现，当请求的内存数量大于MMAP_THRESHOLD(默认为128KB)时候，malloc底层就是调用了mmap。在InnoDB中，默认使用mmap来分配。<br>\n分配完了内存，<code>buf_chunk_init</code>函数中，把这片内存划分为两个部分，前一部分是数据页控制体(buf_block_t)，在阿里云RDS MySQL 5.6 release版本中，每个buf_block_t是424字节，一共有innodb_buffer_pool_size/UNIV_PAGE_SIZE个。后一部分是真正的数据页，按照UNIV_PAGE_SIZE分隔。假设page大小为16KB，则数据页控制体占的内存:数据页约等于1:38.6，也就是说如果innodb_buffer_pool_size被配置为40G，则需要额外的1G多空间来存数据页的控制体。<br>\n划分完空间后，遍历数据页控制体，设置buf_block_t::frame指针，指向真正的数据页，然后把这些数据页加入到Free List中即可。初始化完Buffer Chunks的内存，还需要初始化BUF_BLOCK_POOL_WATCH类型的数据页控制块，page hash的结构体，zip hash的结构体(所有被压缩页的伙伴系统分配走的数据页面会加入到这个哈希表中)。注意这些内存是额外分配的，不包含在Buffer Chunks中。<br>\n除了<code>buf_pool_init</code>外，建议读者参考一下<code>but_pool_free</code>这个内存释放函数，加深对Buffer Pool相关内存的理解。</p>\n<h3 id=\"buf_page_get函数解析\">Buf_page_get函数解析</h3>\n<p>这个函数极其重要，是其他模块获取数据页的外部接口函数。如果请求的数据页已经在Buffer Pool中了，修改相应信息后，就直接返回对应数据页指针，如果Buffer Pool中没有相关数据页，则从磁盘中读取。<code>Buf_page_get</code>是一个宏定义，真正的函数为<code>buf_page_get_gen</code>，参数主要为space_id, page_no, lock_type, mode以及mtr。这里主要介绍一个mode这个参数，其表示读取的方式，目前支持六种，前三种用的比较多。<br>\n<strong><em>BUF_GET: </em></strong> 默认获取数据页的方式，如果数据页不在Buffer Pool中，则从磁盘读取，如果已经在Buffer Pool中，需要判断是否要把他加入到young list中以及判断是否需要进行线性预读。如果是读取则加读锁，修改则加写锁。<br>\n<strong><em>BUF_GET_IF_IN_POOL: </em></strong> 只在Buffer Pool中查找这个数据页，如果在则判断是否要把它加入到young list中以及判断是否需要进行线性预读。如果不在则直接返回空。加锁方式与BUF_GET类似。<br>\n<strong><em>BUF_PEEK_IF_IN_POOL: </em></strong> 与BUF_GET_IF_IN_POOL类似，只是即使条件满足也不把它加入到young list中也不进行线性预读。加锁方式与BUF_GET类似。<br>\n<strong><em>BUF_GET_NO_LATCH: </em></strong> 不管对数据页是读取还是修改，都不加锁。其他方面与BUF_GET类似。<br>\n<strong><em>BUF_GET_IF_IN_POOL_OR_WATCH: </em></strong> 只在Buffer Pool中查找这个数据页，如果在则判断是否要把它加入到young list中以及判断是否需要进行线性预读。如果不在则设置watch。加锁方式与BUF_GET类似。这个是要是给purge线程用。<br>\n<strong><em>BUF_GET_POSSIBLY_FREED: </em></strong> 这个mode与BUF_GET类似，只是允许相应的数据页在函数执行过程中被释放，主要用在估算Btree两个slot之前的数据行数。<br>\n接下来，我们简要分析一下这个函数的主要逻辑。</p>\n<ul>\n<li>首先通过<code>buf_pool_get</code>函数依据space_id和page_no查找指定的数据页在那个Buffer Pool Instance里面。算法很简单<code>instance_no = (space_id &lt;&lt; 20 + space_id + page_no &gt;&gt; 6) % instance_num</code>，也就是说先通过space_id和page_no算出一个fold value然后按照instance的个数取余数即可。这里有个小细节，page_no的第六位被砍掉，这是为了保证一个extent的数据能被缓存到同一个Buffer Pool Instance中，便于后面的预读操作。</li>\n<li>接着，调用<code>buf_page_hash_get_low</code>函数在page hash中查找这个数据页是否已经被加载到对应的Buffer Pool Instance中，如果没有找到这个数据页且mode为BUF_GET_IF_IN_POOL_OR_WATCH则设置watch数据页(<code>buf_pool_watch_set</code>)，接下来，如果没有找到数据页且mode为BUF_GET_IF_IN_POOL、BUF_PEEK_IF_IN_POOL或者BUF_GET_IF_IN_POOL_OR_WATCH函数直接返回空，表示没有找到数据页。如果没有找到数据但是mode为其他，就从磁盘中同步读取(<code>buf_read_page</code>)。在读取磁盘数据之前，我们如果发现需要读取的是非压缩页，则先从Free List中获取空闲的数据页，如果Free List中已经没有了，则需要通过刷脏来释放数据页，这里的一些细节我们后续在LRU模块再分析，获取到空闲的数据页后，加入到LRU List中(<code>buf_page_init_for_read</code>)。在读取磁盘数据之前，我们如果发现需要读取的是压缩页，则临时分配一个buf_page_t用来做控制体，通过伙伴系统分配到压缩页存数据的空间，最后同样加入到LRU List中(<code>buf_page_init_for_read</code>)。做完这些后，我们就调用IO子系统的接口同步读取页面数据，如果读取数据失败，我们重试100次(<code>BUF_PAGE_READ_MAX_RETRIES</code>)然后触发断言，如果成功则判断是否要进行随机预读(随机预读相关的细节我们也在预读预写模块分析)。</li>\n<li>接着，读取数据成功后，我们需要判断读取的数据页是不是压缩页，如果是的话，因为从磁盘中读取的压缩页的控制体是临时分配的，所以需要重新分配block(<code>buf_LRU_get_free_block</code>)，把临时分配的buf_page_t给释放掉，用<code>buf_relocate</code>函数替换掉，接着进行解压，解压成功后，设置state为BUF_BLOCK_FILE_PAGE，最后加入Unzip LRU List中。</li>\n<li>接着，我们判断这个页是否是第一次访问，如果是则设置buf_page_t::access_time，如果不是，我们则判断其是不是在Quick List中，如果在Quick List中且当前事务不是加过Hint语句的事务，则需要把这个数据页从Quick List删除，因为这个页面被其他的语句访问到了，不应该在Quick List中了。</li>\n<li>接着，如果mode不为BUF_PEEK_IF_IN_POOL，我们需要判断是否把这个数据页移到young list中，具体细节在后面LRU模块中分析。</li>\n<li>接着，如果mode不为BUF_GET_NO_LATCH，我们给数据页加上读写锁。</li>\n<li>最后，如果mode不为BUF_PEEK_IF_IN_POOL且这个数据页是第一次访问，则判断是否需要进行线性预读(线性预读相关的细节我们也在预读预写模块分析)。</li>\n</ul>\n<h3 id=\"lru-list中young-list和old-list的维护\">LRU List中young list和old list的维护</h3>\n<p>当LRU List链表大于512(<code>BUF_LRU_OLD_MIN_LEN</code>)时，在逻辑上被分为两部分，前面部分存储最热的数据页，这部分链表称作young list，后面部分则存储冷数据页，这部分称作old list，一旦Free List中没有页面了，就会从冷页面中驱逐。两部分的长度由参数innodb_old_blocks_pct控制。每次加入或者驱逐一个数据页后，都要调整young list和old list的长度(<code>buf_LRU_old_adjust_len</code>)，同时引入<code>BUF_LRU_OLD_TOLERANCE</code>来防止链表调整过频繁。当LRU List链表小于512，则只有old list。<br>\n新读取进来的页面默认被放在old list头，在经过innodb_old_blocks_time后，如果再次被访问了，就挪到young list头上。一个数据页被读入Buffer Pool后，在小于innodb_old_blocks_time的时间内被访问了很多次，之后就不再被访问了，这样的数据页也很快被驱逐。这个设计认为这种数据页是不健康的，应该被驱逐。<br>\n此外，如果一个数据页已经处于young list，当它再次被访问的时候，不会无条件的移动到young list头上，只有当其处于young list长度的1/4(大约值)之后，才会被移动到young list头部，这样做的目的是减少对LRU List的修改，否则每访问一个数据页就要修改链表一次，效率会很低，因为LRU List的根本目的是保证经常被访问的数据页不会被驱逐出去，因此只需要保证这些热点数据页在头部一个可控的范围内即可。相关逻辑可以参考函数<code>buf_page_peek_if_too_old</code>。</p>\n<h3 id=\"buf_lru_get_free_block函数解析\">buf_LRU_get_free_block函数解析</h3>\n<p>这个函数以及其调用的函数可以说是整个LRU模块最重要的函数，在整个Buffer Pool模块中也有举足轻重的作用。如果能把这几个函数吃透，相信其他函数很容易就能读懂。</p>\n<ul>\n<li>首先，如果是使用ENGINE_NO_CACHE发送过来的SQL需要读取数据，则优先从Quick List中获取(<code>buf_quick_lru_get_free</code>)。</li>\n<li>接着，统计Free List和LRU List的长度，如果发现他们再Buffer Chunks占用太少的空间，则表示太多的空间被行锁，自使用哈希等内部结构给占用了，一般这些都是大事务导致的。这时候会给出报警。</li>\n<li>接着，查看Free List中是否还有空闲的数据页(<code>buf_LRU_get_free_only</code>)，如果有则直接返回，否则进入下一步。大多数情况下，这一步都能找到空闲的数据页。</li>\n<li>如果Free List中已经没有空闲的数据页了，则会尝试驱逐LRU List末尾的数据页。如果系统有压缩页，情况就有点复杂，InnoDB会调用<code>buf_LRU_evict_from_unzip_LRU</code>来决定是否驱逐压缩页，如果Unzip LRU List大于LRU List的十分之一或者当前InnoDB IO压力比较大，则会优先从Unzip LRU List中把解压页给驱逐，否则会从LRU List中把解压页和压缩页同时驱逐。不管走哪条路径，最后都调用了函数<code>buf_LRU_free_page</code>来执行驱逐操作，这个函数由于要处理压缩页解压页各种情况，极其复杂。大致的流程：首先判断是否是脏页，如果是则不驱逐，否则从LRU List中把链表删除，必要的话还从Unzip LRU List移走这个数据页(<code>buf_LRU_block_remove_hashed</code>)，接着如果我们选择保留压缩页，则需要重新创建一个压缩页控制体，插入LRU List中，如果是脏的压缩页还要插入到Flush List中，最后才把删除的数据页插入到Free List中(<code>buf_LRU_block_free_hashed_page</code>)。</li>\n<li>如果在上一步中没有找到空闲的数据页，则需要刷脏了(<code>buf_flush_single_page_from_LRU</code>)，由于buf_LRU_get_free_block这个函数是在用户线程中调用的，所以即使要刷脏，这里也是刷一个脏页，防止刷过多的脏页阻塞用户线程。</li>\n<li>如果上一步的刷脏因为数据页被其他线程读取而不能刷脏，则重新跳转到上述第二步。进行第二轮迭代，与第一轮迭代的区别是，第一轮迭代在扫描LRU List时，最多只扫描innodb_lru_scan_depth个，而在第二轮迭代开始，扫描整个LRU List。如果很不幸，这一轮还是没有找到空闲的数据页，从三轮迭代开始，在刷脏前等待10ms。</li>\n<li>最终找到一个空闲页后，page的state为BUF_BLOCK_READY_FOR_USE。</li>\n</ul>\n<h3 id=\"控制全表扫描不增加cache数据到buffer-pool\">控制全表扫描不增加cache数据到Buffer Pool</h3>\n<p>全表扫描对Buffer Pool的影响比较大，即使有old list作用，但是old list默认也占Buffer Pool的3/8。因此，阿里云RDS引入新的语法ENGINE_NO_CACHE(例如：SELECT ENGINE_NO_CACHE count(*) FROM t1)。如果一个SQL语句中带了ENGINE_NO_CACHE这个关键字，则由它读入内存的数取据页都放入Quick List中，当这个语句结束时，会删除它独占的数据页。同时引入两个参数。innodb_rds_trx_own_block_max这个参数控制使用Hint的每个事物最多能拥有多少个数据页，如果超过这个数据就开始驱逐自己已有的数据页，防止大事务占用过多的数据页。innodb_rds_quick_lru_limit_per_instance这个参数控制每个Buffer Pool Instance中Quick List的长度，如果超过这个长度，后续的请求都从Quick List中驱逐数据页，进而获取空闲数据页。</p>\n<h3 id=\"删除指定表空间所有的数据页\">删除指定表空间所有的数据页</h3>\n<p>函数(<code>buf_LRU_remove_pages</code>)提供了三种模式，第一种(<code>BUF_REMOVE_ALL_NO_WRITE</code>)，删除Buffer Pool中所有这个类型的数据页(LRU List和Flush List)同时Flush List中的数据页也不写回数据文件，这种适合rename table和5.6表空间传输新特性，因为space_id可能会被复用，所以需要清除内存中的一切，防止后续读取到错误的数据。第二种(<code>BUF_REMOVE_FLUSH_NO_WRITE</code>)，仅仅删除Flush List中的数据页同时Flush List中的数据页也不写回数据文件，这种适合drop table，即使LRU List中还有数据页，但由于不会被访问到，所以会随着时间的推移而被驱逐出去。第三种(<code>BUF_REMOVE_FLUSH_WRITE</code>)，不删除任何链表中的数据仅仅把Flush List中的脏页都刷回磁盘，这种适合表空间关闭，例如数据库正常关闭的时候调用。这里还有一点值得一提的是，由于对逻辑链表的变动需要加锁且删除指定表空间数据页这个操作是一个大操作，容易造成其他请求被饿死，所以InnoDB做了一个小小的优化，每删除BUF_LRU_DROP_SEARCH_SIZE个数据页(默认为1024)就会释放一下Buffer Pool Instance的mutex，便于其他线程执行。</p>\n<h3 id=\"lru_manager_thread\">LRU_Manager_Thread</h3>\n<p>这是一个系统线程，随着InnoDB启动而启动，作用是定期清理出空闲的数据页(数量为innodb_LRU_scan_depth)并加入到Free List中，防止用户线程去做同步刷脏影响效率。线程每隔一定时间去做BUF_FLUSH_LRU，即首先尝试从LRU中驱逐部分数据页，如果不够则进行刷脏，从Flush List中驱逐(<code>buf_flush_LRU_tail</code>)。线程执行的频率通过以下策略计算：我们设定<code>max_free_len = innodb_LRU_scan_depth * innodb_buf_pool_instances</code>，如果Free List中的数量小于max_free_len的1%，则sleep time为零，表示这个时候空闲页太少了，需要一直执行buf_flush_LRU_tail从而腾出空闲的数据页。如果Free List中的数量介于max_free_len的1%-5%，则sleep time减少50ms(默认为1000ms)，如果Free List中的数量介于max_free_len的5%-20%，则sleep time不变，如果Free List中的数量大于max_free_len的20%，则sleep time增加50ms，但是最大值不超过<code>rds_cleaner_max_lru_time</code>。这是一个自适应的算法，保证在大压力下有足够用的空闲数据页(<code>lru_manager_adapt_sleep_time</code>)。</p>\n<h3 id=\"hazard-pointer\">Hazard Pointer</h3>\n<p>在学术上，Hazard Pointer是一个指针，如果这个指针被一个线程所占有，在它释放之前，其他线程不能对他进行修改，但是在InnoDB里面，概念刚好相反，一个线程可以随时访问Hazard Pointer，但是在访问后，他需要调整指针到一个有效的值，便于其他线程使用。我们用Hazard Pointer来加速逆向的逻辑链表遍历。<br>\n先来说一下这个问题的背景，我们知道InnoDB中可能有多个线程同时作用在Flush List上进行刷脏，例如LRU_Manager_Thread和Page_Cleaner_Thread。同时，为了减少锁占用的时间，InnoDB在进行写盘的时候都会把之前占用的锁给释放掉。这两个因素叠加在一起导致同一个刷脏线程刷完一个数据页A，就需要回到Flush List末尾(因为A之前的脏页可能被其他线程给刷走了，之前的脏页可能已经不在Flush list中了)，重新扫描新的可刷盘的脏页。另一方面，数据页刷盘是异步操作，在刷盘的过程中，我们会把对应的数据页IO_FIX住，防止其他线程对这个数据页进行操作。我们假设某台机器使用了非常缓慢的机械硬盘，当前Flush List中所有页面都可以被刷盘(<code>buf_flush_ready_for_replace</code>返回true)。我们的某一个刷脏线程拿到队尾最后一个数据页，IO fixed，发送给IO线程，最后再从队尾扫描寻找可刷盘的脏页。在这次扫描中，它发现最后一个数据页(也就是刚刚发送到IO线程中的数据页)状态为IO fixed(磁盘很慢，还没处理完)所以不能刷，跳过，开始刷倒数第二个数据页，同样IO fixed，发送给IO线程，然后再次重新扫描Flush List。它又发现尾部的两个数据页都不能刷新(因为磁盘很慢，可能还没刷完)，直到扫描到倒数第三个数据页。所以，存在一种极端的情况，如果磁盘比较缓慢，刷脏算法性能会从O(N)退化成O(N*N)。<br>\n要解决这个问题，最本质的方法就是当刷完一个脏页的时候不要每次都从队尾重新扫描。我们可以使用Hazard Pointer来解决，方法如下：遍历找到一个可刷盘的数据页，在锁释放之前，调整Hazard Pointer使之指向Flush List中下一个节点，注意一定要在持有锁的情况下修改。然后释放锁，进行刷盘，刷完盘后，重新获取锁，读取Hazard Pointer并设置下一个节点，然后释放锁，进行刷盘，如此重复。当这个线程在刷盘的时候，另外一个线程需要刷盘，也是通过Hazard Pointer来获取可靠的节点，并重置下一个有效的节点。通过这种机制，保证每次读到的Hazard Pointer是一个有效的Flush List节点，即使磁盘再慢，刷脏算法效率依然是O(N)。<br>\n这个解法同样可以用到LRU List驱逐算法上，提高驱逐的效率。相应的Patch是在MySQL 5.7上首次提出的，阿里云RDS把其Port到了我们5.6的版本上，保证在大并发情况下刷脏算法的效率。</p>\n<h3 id=\"page_cleaner_thread\">Page_Cleaner_Thread</h3>\n<p>这也是一个InnoDB的后台线程，主要负责Flush List的刷脏，避免用户线程同步刷脏页。与LRU_Manager_Thread线程相似，其也是每隔一定时间去刷一次脏页。其sleep time也是自适应的(<code>page_cleaner_adapt_sleep_time</code>)，主要由三个因素影响：当前的lsn，Flush list中的oldest_modification以及当前的同步刷脏点(<code>log_sys-&gt;max_modified_age_sync</code>，有redo log的大小和数量决定)。简单的来说，lsn – oldest_modification的差值与同步刷脏点差距越大，sleep time就越长，反之sleep time越短。此外，可以通过<code>rds_page_cleaner_adaptive_sleep</code>变量关闭自适应sleep time，这是sleep time固定为1秒。<br>\n与LRU_Manager_Thread每次固定执行清理innodb_LRU_scan_depth个数据页不同，Page_Cleaner_Thread每次执行刷的脏页数量也是自适应的，计算过程有点复杂(<code>page_cleaner_flush_pages_if_needed</code>)。其依赖当前系统中脏页的比率，日志产生的速度以及几个参数。innodb_io_capacity和innodb_max_io_capacity控制每秒刷脏页的数量，前者可以理解为一个soft limit，后者则为hard limit。innodb_max_dirty_pages_pct_lwm和innodb_max_dirty_pages_pct_lwm控制脏页比率，即InnoDB什么脏页到达多少才算多了，需要加快刷脏频率了。innodb_adaptive_flushing_lwm控制需要刷新到哪个lsn。innodb_flushing_avg_loops控制系统的反应效率，如果这个变量配置的比较大，则系统刷脏速度反应比较迟钝，表现为系统中来了很多脏页，但是刷脏依然很慢，如果这个变量配置很小，当系统中来了很多脏页后，刷脏速度在很短的时间内就可以提升上去。这个变量是为了让系统运行更加平稳，起到削峰填谷的作用。相关函数，<code>af_get_pct_for_dirty</code>和<code>af_get_pct_for_lsn</code>。</p>\n<h3 id=\"预读和预写\">预读和预写</h3>\n<p>如果一个数据页被读入Buffer Pool，其周围的数据页也有很大的概率被读入内存，与其分开多次读取，还不如一次都读入内存，从而减少磁盘寻道时间。在官方的InnoDB中，预读分两种，随机预读和线性预读。<br>\n<strong><em>随机预读: </em></strong> 这种预读发生在一个数据页成功读入Buffer Pool的时候(<code>buf_read_ahead_random</code>)。在一个Extent范围(1M，如果数据页大小为16KB，则为连续的64个数据页)内，如果热点数据页大于一定数量，就把整个Extend的其他所有数据页(依据page_no从低到高遍历读入)读入Buffer Pool。这里有两个问题，首先数量是多少，默认情况下，是13个数据页。接着，怎么样的页面算是热点数据页，阅读代码发现，只有在young list前1/4的数据页才算是热点数据页。读取数据时候，使用了异步IO，结合使用<code>OS_AIO_SIMULATED_WAKE_LATER</code>和<code>os_aio_simulated_wake_handler_threads</code>便于IO合并。随机预读可以通过参数innodb_random_read_ahead来控制开关。此外，<code>buf_page_get_gen</code>函数的mode参数不影响随机预读。<br>\n<strong><em>线性预读: </em></strong> 这中预读只发生在一个边界的数据页(Extend中第一个数据页或者最后一个数据页)上(<code>buf_read_ahead_linear</code>)。在一个Extend范围内，如果大于一定数量(通过参数innodb_read_ahead_threshold控制，默认为56)的数据页是被顺序访问(通过判断数据页access time是否为升序或者逆序来确定)的，则把下一个Extend的所有数据页都读入Buffer Pool。读取的时候依然采用异步IO和IO合并策略。线性预读触发的条件比较苛刻，触发操作的是边界数据页同时要求其他数据页严格按照顺序访问，主要是为了解决全表扫描时的性能问题。线性预读可以通过参数<code>innodb_read_ahead_threshold</code>来控制开关。此外，当<code>buf_page_get_gen</code>函数的mode为BUF_PEEK_IF_IN_POOL时，不触发线性预读。<br>\nInnoDB中除了有预读功能，在刷脏页的时候，也能进行预写(<code>buf_flush_try_neighbors</code>)。当一个数据页需要被写入磁盘的时候，查找其前面或者后面邻居数据页是否也是脏页且可以被刷盘(没有被IOFix且在old list中)，如果可以的话，一起刷入磁盘，减少磁盘寻道时间。预写功能可以通过<code>innodb_flush_neighbors</code>参数来控制。不过在现在的SSD磁盘下，这个功能可以关闭。</p>\n<h3 id=\"double-write-bufferdblwr\">Double Write Buffer(dblwr)</h3>\n<p>服务器突然断电，这个时候如果数据页被写坏了(例如数据页中的目录信息被损坏)，由于InnoDB的redolog日志不是完全的物理日志，有部分是逻辑日志，因此即使奔溃恢复也无法恢复到一致的状态，只能依靠Double Write Buffer先恢复完整的数据页。Double Write Buffer主要是解决数据页半写的问题，如果文件系统能保证写数据页是一个原子操作，那么可以把这个功能关闭，这个时候每个写请求直接写到对应的表空间中。<br>\nDouble Write Buffer大小默认为2M，即128个数据页。其中分为两部分，一部分留给batch write，另一部分是single page write。前者主要提供给批量刷脏的操作，后者留给用户线程发起的单页刷脏操作。batch write的大小可以由参数<code>innodb_doublewrite_batch_size</code>控制，例如假设innodb_doublewrite_batch_size配置为120，则剩下8个数据页留给single page write。<br>\n假设我们要进行批量刷脏操作，我们会首先写到内存中的Double Write Buffer(也是2M，在系统初始化中分配，不使用Buffer Chunks空间)，如果dblwr写满了，一次将其中的数据刷盘到系统表空间指定位置，注意这里是同步IO操作，在确保写入成功后，然后使用异步IO把各个数据页写回自己的表空间，由于是异步操作，所有请求下发后，函数就返回，表示写成功了(<code>buf_dblwr_add_to_batch</code>)。不过这个时候后续的写请求依然会阻塞，知道这些异步操作都成功，才清空系统表空间上的内容，后续请求才能被继续执行。这样做的目的就是，如果在异步写回数据页的时候，系统断电，发生了数据页半写，这个时候由于系统表空间中的数据页是完整的，只要从中拷贝过来就行(<code>buf_dblwr_init_or_load_pages</code>)。<br>\n异步IO请求完成后，会检查数据页的完整性以及完成change buffer相关操作，接着IO helper线程会调用<code>buf_flush_write_complete</code>函数，把数据页从Flush List删除，如果发现batch write中所有的数据页都写成了，则释放dblwr的空间。</p>\n<h3 id=\"buddy伙伴系统\">Buddy伙伴系统</h3>\n<p>与内存分配管理算法类似，InnoDB中的伙伴系统也是用来管理不规则大小内存分配的，主要用在压缩页的数据上。前文提到过，InnoDB中的压缩页可以有16K，8K，4K，2K，1K这五种大小，压缩页大小的单位是表，也就是说系统中可能存在很多压缩页大小不同的表。使用伙伴体统来分配和回收，能提高系统的效率。<br>\n申请空间的函数是<code>buf_buddy_alloc</code>，其首先在zip free链表中查看指定大小的块是否还存在，如果不存在则从更大的链表中分配，这回导致一些列的分裂操作。例如需要一块4K大小的内存，则先从4K链表中查找，如果有则直接返回，没有则从8K链表中查找，如果8K中还有空闲的，则把8K分成两部分，低地址的4K提供给用户，高地址的4K插入到4K的链表中，便与后续使用。如果8K中也没有空闲的了，就从16K中分配，16K首先分裂成2个8K，高地址的插入到8K链表中，低地址的8K继续分裂成2个4K，低地址的4K返回给用户，高地址的4K插入到4K的链表中。假设16K的链表中也没有空闲的了，则调用<code>buf_LRU_get_free_block</code>获取新的数据页，然后把这个数据页加入到zip hash中，同时设置state状态为BUF_BLOCK_MEMORY，表示这个数据页存储了压缩页的数据。<br>\n释放空间的函数是<code>buf_buddy_free</code>，相比于分配空间的函数，有点复杂。假设释放一个4K大小的数据块，其先把4K放回4K对应的链表，接着会查看其伙伴(释放块是低地址，则伙伴是高地址，释放块是高地址，则伙伴是低地址)是否也被释放了，如果也被释放了则合并成8K的数据块，然后继续寻找这个8K数据块的伙伴，试图合并成16K的数据块。如果发现伙伴没有被释放，函数并不会直接退出而是把这个伙伴给挪走(<code>buf_buddy_relocate</code>)，例如8K数据块的伙伴没有被释放，系统会查看8K的链表，如果有空闲的8K块，则把这个伙伴挪到这个空闲的8K上，这样就能合并成16K的数据块了，如果没有，函数才放弃合并并返回。通过这种relocate操作，内存碎片会比较少，但是涉及到内存拷贝，效率会比较低。</p>\n<h3 id=\"buffer-pool预热\">Buffer Pool预热</h3>\n<p>这个也是官方5.6提供的新功能，可以把当前Buffer Pool中的数据页按照space_id和page_no dump到外部文件，当数据库重启的时候，Buffer Pool就可以直接恢复到关闭前的状态。<br>\n<strong><em>Buffer Pool Dump: </em></strong> 遍历所有Buffer Pool Instance的LRU List，对于其中的每个数据页，按照space_id和page_no组成一个64位的数字，写到外部文件中即可(<code>buf_dump</code>)。<br>\n<strong><em>Buffer Pool Load: </em></strong> 读取指定的外部文件，把所有的数据读入内存后，使用归并排序对数据排序，以64个数据页为单位进行IO合并，然后发起一次真正的读取操作。排序的作用就是便于IO合并(<code>buf_load</code>)。</p>\n<h3 id=\"总结\">总结</h3>\n<p>InnoDB的Buffer Pool可以认为很简单，就是LRU List和Flush List，但是InnoDB对其做了很多性能上的优化，例如减少加锁范围，page hash加速查找等，导致具体的实现细节相对比较复杂，尤其是引入压缩页这个特性后，有些核心代码变得晦涩难懂，需要读者细细琢磨。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113298\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113298votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113298\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "url": "http://blog.jobbole.com/113298/", "comment_nums": 0, "praise_nums": 1, "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2015/11/dea4002e77dd3ecd398568bf746ea46c.png"]},{"title": "谈谈 MySQL 隐式类型转换", "url_object_id": "8044183d5be6bd3a67d777b3e5b0d219", "create_date": "2017/12/14", "tags": "IT技术,MySQL,数据库", "fav_nums": 0, "front_image_path": "full/75f6595b87bc254afe77bc1151f1aea91fb72f4b.jpg", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"https://my.oschina.net/u/1462914/blog/1572292\">andyqian</a>   </div><h4>前言</h4>\n<p>今天我们继续回到MySQL系列文章中,谈一谈MySQL中隐式类型转换。(其实我最早知道是在慢SQL优化中知道隐式类型转换概念的),在说隐式类型转换之前,首先我们通过一个实例来看看是怎么回事。</p>\n<h4>数据结构</h4>\n<p>本文中所有的操作,都是基于该数据结构(有兴趣的童鞋,可以实验):</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3448dfdcdd1132213800\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\ncreate table t_base_user(   \r\noid bigint(20) not null primary key auto_increment,  \r\nname varchar(30) null comment \"name\",  \r\nemail varchar(30) null comment \"email\",  \r\nage int null comment \"age\",  \r\ntelephone varchar(30) null comment \"telephone\",  \r\nstatus tinyint(4) null comment \"0 无效 1 有效\",  \r\ncreated_at datetime null default now() comment \"创建时间\",  \r\nupdated_at datetime null default now() comment \"修改时间\"  )\r\n\r\n### 新建索引alter table t_base_user add index idx_email(email);\r\nalter table t_base_user add index idx_name(name);\r\nalter table t_base_user add index idx_telephone(telephone);\r\n\r\n### 新增记录: \r\nINSERT INTO `andyqian`.`t_base_user` (`name`, `email`, `age`, `telephone`, `status`, `created_at`, `updated_at`) \r\nVALUES ('111111', 'andytohome@gmail.com', '111', '12345678901', '1', now(),now());</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3448dfdcdd1132213800-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448dfdcdd1132213800-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3448dfdcdd1132213800-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448dfdcdd1132213800-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a3448dfdcdd1132213800-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448dfdcdd1132213800-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a3448dfdcdd1132213800-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448dfdcdd1132213800-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5a3448dfdcdd1132213800-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448dfdcdd1132213800-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5a3448dfdcdd1132213800-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448dfdcdd1132213800-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5a3448dfdcdd1132213800-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448dfdcdd1132213800-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5a3448dfdcdd1132213800-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448dfdcdd1132213800-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5a3448dfdcdd1132213800-17\">17</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3448dfdcdd1132213800-1\"><span class=\"crayon-e\">create </span><span class=\"crayon-e\">table </span><span class=\"crayon-e\">t_base_user</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span> <span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448dfdcdd1132213800-2\"><span class=\"crayon-e\">oid </span><span class=\"crayon-e\">bigint</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">20</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">not</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">primary </span><span class=\"crayon-e\">key </span><span class=\"crayon-v\">auto_increment</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span> </div><div class=\"crayon-line\" id=\"crayon-5a3448dfdcdd1132213800-3\"><span class=\"crayon-e\">name </span><span class=\"crayon-e\">varchar</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">30</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">comment</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"name\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448dfdcdd1132213800-4\"><span class=\"crayon-e\">email </span><span class=\"crayon-e\">varchar</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">30</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">comment</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"email\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span> </div><div class=\"crayon-line\" id=\"crayon-5a3448dfdcdd1132213800-5\"><span class=\"crayon-e\">age </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">comment</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"age\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448dfdcdd1132213800-6\"><span class=\"crayon-e\">telephone </span><span class=\"crayon-e\">varchar</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">30</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">comment</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"telephone\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span> </div><div class=\"crayon-line\" id=\"crayon-5a3448dfdcdd1132213800-7\"><span class=\"crayon-e\">status </span><span class=\"crayon-e\">tinyint</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">4</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">comment</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"0 无效 1 有效\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448dfdcdd1132213800-8\"><span class=\"crayon-e\">created_at </span><span class=\"crayon-e\">datetime </span><span class=\"crayon-t\">null</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">default</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">now</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">comment</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"创建时间\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span> </div><div class=\"crayon-line\" id=\"crayon-5a3448dfdcdd1132213800-9\"><span class=\"crayon-e\">updated_at </span><span class=\"crayon-e\">datetime </span><span class=\"crayon-t\">null</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">default</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">now</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">comment</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"修改时间\"</span><span class=\"crayon-h\"> </span> <span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448dfdcdd1132213800-10\"> </div><div class=\"crayon-line\" id=\"crayon-5a3448dfdcdd1132213800-11\"><span class=\"crayon-p\">### 新建索引alter table t_base_user add index idx_email(email);</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448dfdcdd1132213800-12\"><span class=\"crayon-e\">alter </span><span class=\"crayon-e\">table </span><span class=\"crayon-e\">t_base_user </span><span class=\"crayon-e\">add </span><span class=\"crayon-e\">index </span><span class=\"crayon-e\">idx_name</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5a3448dfdcdd1132213800-13\"><span class=\"crayon-e\">alter </span><span class=\"crayon-e\">table </span><span class=\"crayon-e\">t_base_user </span><span class=\"crayon-e\">add </span><span class=\"crayon-e\">index </span><span class=\"crayon-e\">idx_telephone</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">telephone</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448dfdcdd1132213800-14\"> </div><div class=\"crayon-line\" id=\"crayon-5a3448dfdcdd1132213800-15\"><span class=\"crayon-p\">### 新增记录: </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448dfdcdd1132213800-16\"><span class=\"crayon-e\">INSERT </span><span class=\"crayon-i\">INTO</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">andyqian</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">t_base_user</span><span class=\"crayon-sy\">`</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">email</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">age</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">telephone</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">status</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">created_at</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span><span class=\"crayon-v\">updated_at</span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-5a3448dfdcdd1132213800-17\"><span class=\"crayon-e\">VALUES</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'111111'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'andytohome@gmail.com'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'111'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'12345678901'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'1'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">now</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-e\">now</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0042 seconds] -->\r\n<p></p>\n<h4>引子</h4>\n<p>首先我们基于上述数据结构中,我们来看看下面这个执行计划:</p>\n<blockquote><p>explain select * from t_base_user where telephone=12345678901;</p></blockquote>\n<p>执行计划结果:</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/12/05cc14303bda573f6977d4d18c48c42a.png\"><img class=\"alignnone size-full wp-image-113317\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/05cc14303bda573f6977d4d18c48c42a.png\" alt=\"QQ截图20171214105031\"></a></p>\n<p>细心的童鞋应该已经看出来了,为什么数据结构中已经在telephone字段上新建了idx_telephone索引，而上述语句并没有走索引,而是全表扫描。这是为什么呢？带着这疑问,我们来看看今天的主角——MySQL隐式类型转换</p>\n<h4>什么是隐式类型转换？</h4>\n<p>在MySQL中:</p>\n<blockquote><p>当操作符与不同类型的操作数一起使用时，会发生类型转换以使操作数兼容。则会发生转换隐式</p></blockquote>\n<p>也就是说,MySQL会根据需要自动将数字转换为字符串，将字符串转换数字。看到这个概念之后,是不是有一种茅塞顿开的感觉。哦… 原来在数据结构中telephone字段为字符串(varchar)类型,而我们传的手机号是数字类型。现在我们将SQL修改下:</p>\n<blockquote><p>select * from t_base_user where telephone=’12345678901′;</p></blockquote>\n<p>再看看上述语句的执行计划:</p>\n<blockquote><p>explain select * from t_base_user where telephone=’12345678901′;</p></blockquote>\n<p>结果:</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/12/70ee38005ac1816b149f228df6287fd2.png\"><img class=\"alignnone size-full wp-image-113318\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/70ee38005ac1816b149f228df6287fd2.png\" alt=\"QQ截图20171214105207\"></a></p>\n<p>从这里看,现在语句已经走索引了。为了加深我们对隐式类型转换的印象,我们再多看看几个隐式类型转换案例:</p>\n<p>案例一: 字符串转换为数字</p>\n<blockquote><p>mysql &gt; SELECT 1+’1′;</p></blockquote>\n<p>结果:</p>\n<blockquote><p>mysql &gt; 2</p></blockquote>\n<p>案例二: 数字转换为字符串</p>\n<blockquote><p>mysql -&gt; SELECT CONCAT(1024,’ andyqian’);</p></blockquote>\n<p>结果:</p>\n<blockquote><p>‘1024,’ andyqian’;</p></blockquote>\n<p>此时CONCAT(字符拼接)函数就将1024进行了隐式类型转换。</p>\n<h4>如何避免隐式类型转换?</h4>\n<p>只有当清楚的知道隐式类型转换的规则，才能从根本上避免产生隐式类型转换。MySQL也在官网描述了进行隐式类型转换的一些规则如下:</p>\n<p>1. 隐式类型转换规则:</p>\n<ul>\n<li>如果一个或两个参数都是NULL，比较的结果是NULL，除了NULL安全的&lt;=&gt;相等比较运算符。对于NULL &lt;=&gt; NULL，结果为true。不需要转换</li>\n<li>如果比较操作中的两个参数都是字符串，则将它们作为字符串进行比较。</li>\n<li>如果两个参数都是整数，则将它们作为整数进行比较。</li>\n<li>如果不与数字进行比较，则将十六进制值视为二进制字符串</li>\n<li>如果其中一个参数是十进制值，则比较取决于另一个参数。 如果另一个参数是十进制或整数值，则将参数与十进制值进行比较，如果另一个参数是浮点值，则将参数与浮点值进行比较</li>\n<li>如果其中一个参数是TIMESTAMP或DATETIME列，另一个参数是常量，则在执行比较之前将常量转换为时间戳。</li>\n<li>在所有其他情况下，参数都是作为浮点数（实数）比较的。</li>\n</ul>\n<p>2. 使用CAST函数显示转换<br>\n我们可以使用CAST显示的将类型进行转换,如下所示:</p>\n<blockquote><p>mysql&gt; SELECT 38.8, CAST(38.8 AS CHAR);</p></blockquote>\n<p>结果:</p>\n<blockquote><p>mysql &gt; 38.8, ‘38.8’</p></blockquote>\n<p>如上述中:</p>\n<blockquote><p>select * from t_base_user where telephone=cast(12345678901 as char);</p></blockquote>\n<p>查看执行计划,我们也可以看出</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/12/383bbad2ced38d0ca41ae862eaae9165.png\"><img class=\"alignnone size-full wp-image-113319\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/383bbad2ced38d0ca41ae862eaae9165.png\" alt=\"QQ截图20171214105349\"></a></p>\n<p>你看,这个时候也走索引了。</p>\n<p>3. 类型一致<br>\n这里说的类型一致,指的是在写SQL时,参数类型一定要与数据库中的类型一致,避免产生隐式类型转换,就如刚才在文首时,如果多检查,写的SQL的参数类型与数据库中字段类型一致，也就不会不走索引了，你说是不是？</p>\n<h4>小心隐式类型转换</h4>\n<p>这里再重申一次,写SQL时一定要检查参数类型与数据库字段类型一致,(如果参数不一致,也要使用CAST函数显示转换成一致)否则造成隐式类型转换,不走索引,后果简直不堪设想, 在前面<a href=\"http://mp.weixin.qq.com/s?__biz=MzI2NDU3OTg5Nw==&amp;mid=2247483736&amp;idx=1&amp;sn=e3fa0bf61b77c9ca12ee1d295c51313a&amp;scene=21#wechat_redirect\" rel=\"nofollow\">《写会MySQL索引》</a>这篇文章中提到过,不走索引,轻则造成慢查询，重则造成数据库服务器CPU100%。唉,说到这里,不瞒你说，我就吃过不少MySQL隐式类型转换的亏 ! (如慢查询) !</p>\n<h4>小结</h4>\n<p>看到这里,是不是有一种,数据表设计还真不是件容易的事情。需要考虑的因素太多太多了,需要考虑字段类型,索引设计,还有各种约束条件等等。也一定要谨慎谨慎再谨慎！其实换个角度就更容易理解了,大家都知道高楼大厦都是需要一个好的地基的,在数据库表设计中,前期的表结构设计就是这个地基，其重要性可想而知。</p>\n<p>从后续开始,每篇MySQL文章最后,都推荐一个常用且实用的MySQL命令:</p>\n<p>今天的命令是:</p>\n<blockquote><p>show full columns from table_name;</p></blockquote>\n<p>作用: 显示指定表所有列信息</p>\n<p>例如:</p>\n<blockquote><p>show full columns from t_base_user;</p></blockquote>\n<p>返回结果如下图所示:</p>\n<p><a href=\"http://jbcdn2.b0.upaiyun.com/2017/12/0ae91cc856d3e41ea81248f9f6d7d9af.png\"><img class=\"alignnone size-full wp-image-113320\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/0ae91cc856d3e41ea81248f9f6d7d9af.png\" alt=\"QQ截图20171214105501\"></a></p>\n<p>其中:<br>\nField: 字段名<br>\nType: 该字段类型<br>\nCollation: 描述了如何对查询出来的数据进行比较和排序<br>\nNull: 是否允许为空, NO: 不允许，YES 允许<br>\nKey: 键,例如: 主键(PRI), 唯一键(UNI) 等<br>\nDefault: 该字段默认值 Extra: 附加信息如自增主键上的(auto_increment)<br>\nPrivileges: 权限,有select,update等<br>\nComment: 字段注释</p>\n<p>注意: 通过该命令显示都是建表时的信息,这里着重强调一下,在数据库建表时,在每个字段上, 一定要加注释,加注释，加注释！</p>\n<p><strong>最后:  </strong>大家今天剁手了吗？ 祝大家晚安!</p>\n<p>相关阅读:</p>\n<p><a href=\"http://blog.jobbole.com/113142/\" target=\"_blank\" rel=\"nofollow\">写会MySQL索引</a></p>\n<p><a href=\"http://blog.jobbole.com/112877/\" target=\"_blank\" rel=\"nofollow\">读懂MySQL执行计划</a></p>\n<p> </p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113315\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113315votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113315\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "url": "http://blog.jobbole.com/113315/", "comment_nums": 0, "praise_nums": 1, "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2015/11/dea4002e77dd3ecd398568bf746ea46c.png"]},{"title": "MySQL 引擎特性：InnoDB 同步机制", "url_object_id": "3ab9c8467092797d5700883d37f29d0d", "create_date": "2017/12/12", "tags": "IT技术,MySQL,数据库", "fav_nums": 1, "front_image_path": "full/76dac52543eae84f3fd038af336bf45c1c4c1efe.jpg", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/coderyuhui/p/6498400.html\">水中的泪</a>   </div><h2>前言</h2>\n<p>现代操作系统以及硬件基本都支持并发程序，而在并发程序设计中，各个进程或者线程需要对公共变量的访问加以制约，此外，不同的进程或者线程需要协同工作以完成特征的任务，这就需要一套完善的同步机制，在Linux内核中有相应的技术实现，包括原子操作，信号量，互斥锁，自旋锁，读写锁等。InnoDB考虑到效率和监控两方面的原因，实现了一套独有的同步机制，提供给其他模块调用。本文的分析默认基于MySQL 5.6，CentOS 6，gcc 4.8，其他版本的信息会另行指出。</p>\n<h2 id=\"基础知识\">基础知识</h2>\n<p>同步机制对于其他数据库模块来说相对独立，但是需要比较多的操作系统以及硬件知识，这里简单介绍一下几个有用的概念，便于读者理解后续概念。<br>\n<strong><em>内存模型 :</em></strong>主要分为语言级别的内存模型和硬件级别的内存模型。语言级别的内存模型，C/C++属于weak memory model，简单的说就是编译器在进行编译优化的时候，可以对指令进行重排，只需要保证在单线程的环境下，优化前和优化后执行结果一致即可，执行中间过程不保证跟代码的语义顺序一致。所以在多线程的环境下，如果依赖代码中间过程的执行顺序，程序就会出现问题。硬件级别的内存模型，我们常用的cpu，也属于弱内存模型，即cpu在执行指令的时候，为了提升执行效率，也会对某些执行进行乱序执行（按照wiki提供的资料，在x86 64环境下，只会发生读写乱序，即读操作可能会被乱序到写操作之前），如果在编程的时候不做一些措施，同样容易造成错误。<br>\n<strong><em>内存屏障 :</em></strong>为了解决弱内存模型造成的问题，需要一种能控制指令重排或者乱序执行程序的手段，这种技术就叫做内存屏障，程序员只需要在代码中插入特定的函数，就能控制弱内存模型带来的负面影响，当然，由于影响了乱序和重排这类的优化，对代码的执行效率有一定的影响。具体实现上，内存屏障技术分三种，一种是full memory barrier，即barrier之前的操作不能乱序或重排到barrier之后，同时barrier之后的操作不能乱序或重排到barrier之前，当然这种full barrier对性能影响最大，为了提高效率才有了另外两种：acquire barrier和release barrier，前者只保证barrier后面的操作不能移到之前，后者只保证barrier前面的操作不移到之后。<br>\n<strong><em>互斥锁 :</em></strong>互斥锁有两层语义，除了大家都知道的排他性（即只允许一个线程同时访问）外，还有一层内存屏障（full memory barrier）的语义，即保证临界区的操作不会被乱序到临界区外。Pthread库里面常用的mutex，conditional variable等操作都自带内存屏障这层语义。此外，使用pthread库，每次调用都需要应用程序从用户态陷入到内核态中查看当前环境，在锁冲突不是很严重的情况下，效率相对比较低。<br>\n<strong><em>自旋锁 :</em></strong>传统的互斥锁，只要一检测到锁被其他线程所占用了，就立刻放弃cpu时间片，把cpu留给其他线程，这就会产生一次上下文切换。当系统压力大的时候，频繁的上下文切换会导致sys值过高。自旋锁，在检测到锁不可用的时候，首先cpu忙等一小会儿，如果还是发现不可用，再放弃cpu，进行切换。互斥锁消耗cpu sys值，自旋锁消耗cpu usr值。<br>\n<strong><em>递归锁 :</em></strong>如果在同一个线程中，对同一个互斥锁连续加锁两次，即第一次加锁后，没有释放，继续进行对这个锁进行加锁，那么如果这个互斥锁不是递归锁，将导致死锁。可以把递归锁理解为一种特殊的互斥锁。<br>\n<strong><em>死锁 :</em></strong>构成死锁有四大条件，其中有一个就是加锁顺序不一致，如果能保证不同类型的锁按照某个特定的顺序加锁，就能大大降低死锁发生的概率，之所以不能完全消除，是因为同一种类型的锁依然可能发生死锁。另外，对同一个锁连续加锁两次，如果是非递归锁，也将导致死锁。</p>\n<h2 id=\"原子操作\">原子操作</h2>\n<p>现代的cpu提供了对单一变量简单操作的原子指令，即这个变量的这些简单操作只需要一条cpu指令即可完成，这样就不用对这个操作加互斥锁了，在锁冲突不激烈的情况下，减少了用户态和内核态的切换，化悲观锁为乐观锁，从而提高了效率。此外，现在外面很火的所谓无锁编程（类似CAS操作），底层就是用了这些原子操作。gcc为了方便程序员使用这些cpu原子操作，提供了一系列__sync开头的函数，这些函数如果包含内存屏障语义，则同时禁止编译器指令重排和cpu乱序执行。<br>\nInnoDB针对不同的操作系统以及编译器环境，自己封装了一套原子操作，在头文件os0sync.h中。下面的操作基于Linux x86 64位环境， gcc 4.1以上的版本进行分析。<br>\n<code>os_compare_and_swap_xxx(ptr, old_val, new_val)</code>类型的操作底层都使用了gcc包装的<code>__sync_bool_compare_and_swap(ptr, old_val, new_val)</code>函数，语义为，交换成功则返回true，ptr是交换后的值，old_val是之前的值，new_val是交换后的预期值。这个原子操作是个内存屏障（full memory barrier）。<br>\n<code>os_atomic_increment_xxx</code>类型的操作底层使用了函数<code>__sync_add_and_fetch</code>，<code>os_atomic_decrement_xxx</code>类型的操作使用了函数<code>__sync_sub_and_fetch</code>，分别表示原子递增和原子递减。这个两个原子操作也都是内存屏障（full memory barrier）。<br>\n另外一个比较重要的原子操作是<code>os_atomic_test_and_set_byte(ptr, new_val)</code>，这个操作使用了<code>__sync_lock_test_and_set(ptr, new_val)</code>这个函数，语义为，把ptr设置为new_val，同时返回旧的值。这个操作提供了原子改变某个变量值的操作，InnoDB锁实现的同步机制中，大量的用了这个操作，因此比较重要。需要注意的是，参看gcc文档，这个操作不是full memory barrier，只是一个acquire barrier，简单的说就是，代码中<code>__sync_lock_test_and_set</code>之后操作不能被乱序或者重排到<code>__sync_lock_test_and_set</code>之前，但是<code>__sync_lock_test_and_set</code>之前的操作可能被重排到其之后。<br>\n关于内存屏障的专门指令，MySQL 5.7提供的比较完善。<code>os_rmb</code>表示acquire barrier，<code>os_wmb</code>表示release barrier。如果在编程时，需要在某个位置准确的读取一个变量的值时，记得在读取之前加上os_rmb，同理，如果需要在某个位置保证一个变量已经被写了，记得在写之后调用os_wmb。</p>\n<h2 id=\"条件通知机制\">条件通知机制</h2>\n<p>条件通知机制在多线程协作中非常有用，一个线程往往需要等待其他线程完成指定工作后，再进行工作，这个时候就需要有线程等待和线程通知机制。<code>Pthread_cond_XXX</code>类似的变量和函数来完成等待和通知的工作。InnoDB中，对Pthread库进行了简单的封装，并在此基础上，进一步抽象，提供了一套方便易用的接口函数给调用者使用。</p>\n<h3 id=\"系统条件变量\">系统条件变量</h3>\n<p>在文件os0sync.cc中，<code>os_cond_XXX</code>类似的函数就是InnoDB对Pthread库的封装。常用的几个函数如：<br>\n<code>os_cond_t</code>是核心的操作对象，其实就是pthread_cond_t的一层typedef而已，<code>os_cond_init</code>初始化函数，<code>os_cond_destroy</code>销毁函数，<code>os_cond_wait</code>条件等待，不会超时，<code>os_cond_wait_timed</code>条件等待，如果超时则返回，<code>os_cond_broadcast</code>唤醒所有等待线程，<code>os_cond_signal</code>只唤醒其中一个等待线程，但是在阅读源码的时候发现，似乎没有什么地方调用了<code>os_cond_signal</code>。。。<br>\n此外，还有一个<code>os_cond_module_init</code>函数，用来window下的初始化操作。<br>\n在InnoDB下，<code>os_cond_XXX</code>模块的函数主要是给InnoDB自己设计的条件变量使用。</p>\n<h3 id=\"innodb条件变量\">InnoDB条件变量</h3>\n<p>如果在InnoDB层直接使用系统条件变量的话，主要有四个弊端，首先，弊端1，系统条件变量的使用需要与一个系统互斥锁（详见下一节）相配合使用，使用完还要记得及时释放，使用者会比较麻烦。接着，弊端2，在条件等待的时候，需要在一个循环中等待，使用者还是比较麻烦。最后，弊端3，也是比较重要的，不方便系统监控。<br>\n基于以上几点，InnoDB基于系统的条件变量和系统互斥锁自己实现了一套条件通知机制。主要在文件os0sync.cc中实现，相关数据结构以及接口进一层的包装在头文件os0sync.h中。使用方法如下：<br>\nInnoDB条件变量核心数据结构为<code>os_event_t</code>，类似<code>pthread_cont_t</code>。如果需要创建和销毁则分别使用<code>os_event_create</code>和<code>os_event_free</code>函数。需要等待某个条件变量，先调用<code>os_event_reset</code>（原因见下一段），然后使用<code>os_event_wait</code>，如果需要超时等待，使用<code>os_event_wait_time</code>替换<code>os_event_wait</code>即可，<code>os_event_wait_XXX</code>这两个函数，解决了弊端1和弊端2，此外，建议把<code>os_event_reset</code>返回值传给他们，这样能防止多线程情况下的无限等待（详见下下段）。如果需要发出一个条件通知，使用<code>os_event_set</code>。这个几个函数，里面都插入了一些监控信息，方便InnoDB上层管理。怎么样，方便多了吧~</p>\n<h4 id=\"多线程环境下可能发生的问题\">多线程环境下可能发生的问题</h4>\n<p>首先来说说两个线程下会发生的问题。创建后，正常的使用顺序是这样的，线程A首先<code>os_event_reset</code>（步骤1），然后<code>os_event_wait</code>（步骤2），接着线程B做完该做的事情后，执行<code>os_event_set</code>（步骤3）发送信号，通知线程A停止等待，但是在多线程的环境中，会出现以下两种步骤顺序错乱的情况：乱序A： <code>步骤1--步骤3--步骤2</code>，乱序B: <code>步骤3--步骤1--步骤2</code>。对于乱序B，属于条件通知在条件等待之前发生，目前InnoDB条件变量的机制下，会发生无限等待，所以上层调用的时候一定要注意，例如在InnoDB在实现互斥锁和读写锁的时候为了防止发生条件通知在条件等待之前发生，在等待之前对lock_word再次进行了判断，详见InnoDB自旋互斥锁这一节。为了解决乱序A，InnoDB在核心数据结构os_event中引入布尔型变量is_set，is_set这个变量就表示是否已经发生过条件通知，在每次调用条件通知之前，会把这个变量设置为true（在<code>os_event_reset</code>时改为false，便于多次通知），在条件等待之前会检查一下这变量，如果这个变量为true，就不再等待了。所以，乱序A也能保证不会发生无限等待。<br>\n接着我们来说说大于两个线程下可能会发生的问题。线程A和C是等待线程，等待同一个条件变量，B是通知线程，通知A和C结束等待。考虑一个乱序C：线程A执行<code>os_event_reset</code>（步骤1），线程B马上就执行<code>os_event_set</code>（步骤2）了，接着线程C执行了<code>os_event_reset</code>（步骤3），最后线程A执行<code>os_event_wait</code>（步骤4），线程C执行<code>os_event_wait</code>（步骤5）。乍一眼看，好像看不出啥问题，但是实际上你会发现A和C线程在无限等待了。原因是，步骤2，把is_set这个变量设置为false，但是在步骤3，线程C通过reset又把它给重新设回false了。。然后线程A和C在<code>os_event_wait</code>中误以为还没有发生过条件通知，就开始无限等待了。为了解决这个问题，InnoDB在核心数据结构os_event中引入64位整形变量signal_count，用来记录已经发出条件信号的次数。每次发出一个条件通知，这个变量就递增1。<code>os_event_reset</code>的返回值就把当前的signal_count值取出来。<code>os_event_wait</code>如果发现有这个参数的传入，就会判断传入的参数与当前的signal_count值是否相同，如果不相同，表示这个已经通知过了，就不会进入等待了。举个例子，假设乱序C，一开始的signal_count为100，步骤1把这个参数传给了步骤4，在步骤4中，<code>os_event_wait</code>会发现传入值100与当前的值101（步骤2中递增了1）不同，所以线程A认为信号已经发生过了，就不会再等待了。。。然而。。线程C呢？步骤3返回的值应该是101，传给步骤5后，发生于当前值一样。。继续等待。。。仔细分析可以发现，线程C是属于条件变量通知发生在等待之前（步骤2，步骤3，步骤5），上一段已经说过了，针对这种通知提前发出的，目前InnoDB没有非常好的解法，只能调用者自己控制。<br>\n总结一下， InnoDB条件变量能方便InnoDB上层做监控，也简化了条件变量使用的方法，但是调用者上层逻辑必须保证条件通知不能过早的发出，否则就会有无限等待的可能。</p>\n<h2 id=\"互斥锁\">互斥锁</h2>\n<p>互斥锁保证一段程序同时只能一个线程访问，保证临界区得到正确的序列化访问。同条件变量一样，InnoDB对Pthread的mutex简单包装了一下，提供给其他模块用（主要是辅助其他自己实现的数据结构，不用InnoDB自己的互斥锁是为了防止递归引用，详见辅助结构这一节）。但与条件变量不同的是，InnoDB自己实现的一套互斥锁并没有依赖Pthread库，而是依赖上述的原子操作（如果平台不支持原子操作则使用Pthread库，但是这种情况不太会发生，因为gcc在4.1就支持原子操作了）和上述的InnoDB条件变量。</p>\n<h3 id=\"系统互斥锁\">系统互斥锁</h3>\n<p>相比与系统条件变量，系统互斥锁除了包装Pthread库外，还做了一层简单的监控统计，结构名为<code>os_mutex_t</code>。在文件os0sync.cc中，<code>os_mutex_create</code>创建mutex，并调用<code>os_fast_mutex_init_func</code>创建pthread的mutex，值得一提的是，创建pthread mutex的参数是<code>my_fast_mutexattr</code>的东西，其在MySQL server层函数<code>my_thread_global_init</code>初始化 ，只要pthread库支持，则默认成初始化为PTHREAD_MUTEX_ADAPTIVE_NP和PTHREAD_MUTEX_ERRORCHECK。前者表示，当锁释放，之前在等待的锁进行公平的竞争，而不是按照默认的优先级模式。后者表示，如果发生了递归的加锁，即同一个线程对同一个锁连续加锁两次，第二次加锁会报错。另外三个有用的函数为，销毁锁<code>os_mutex_free</code>，加锁<code>os_mutex_enter</code>，解锁<code>os_mutex_exit</code>。<br>\n一般来说，InnoDB上层模块不需要直接与系统互斥锁打交道，需要用锁的时候一般用InnoDB自己实现的一套互斥锁。系统互斥锁主要是用来辅助实现一些数据结构，例如最后一节提到的一些辅助结构，由于这些辅助结构可能本身就要提供给InnoDB自旋互斥锁用，为了防止递归引用，就暂时用系统互斥锁来代替。</p>\n<h3 id=\"innodb自旋互斥锁\">InnoDB自旋互斥锁</h3>\n<p>为什么InnoDB需要实现自己的一套互斥锁，不直接用上述的系统互斥锁呢？这个主要有以下几个原因，首先，系统互斥锁是基于pthread mutex的，Heikki Tuuri（同步模块的作者，也是Innobase的创始人）认为在当时的年代pthread mutex上下文切换造成的cpu开销太大，使用spin lock的方式在多处理器的机器上更加有效，尤其是在锁竞争不是很严重的时候，Heikki Tuuri还总结出，在spin lock大概自旋20微秒的时候在多处理的机器下效率最高。其次，不使用pthread spin lock的原因是，当时在1995年左右的时候，spin lock的类似实现，效率很低，而且当时的spin lock不支持自定义自旋时间，要知道自旋锁在单处理器的机器上没什么卵用。最后，也是为了更加完善的监控需求。总的来说，有历史原因，有监控需求也有自定义自旋时间的需求，然后就有了这一套InnoDB自旋互斥锁。<br>\nInnoDB自旋互斥锁的实现主要在文件sync0sync.cc和sync0sync.ic中，头文件sync0sync.h定义了核心数据结构ib_mutex_t。使用方法很简单，<code>mutex_create</code>创建锁，<code>mutex_free</code>释放锁，<code>mutex_enter</code>尝试获得锁，如果已经被占用了，则等待。<code>mutex_exit</code>释放锁，同时唤醒所有等待的线程，拿到锁的线程开始执行，其余线程继续等待。<code>mutex_enter_nowait</code>这个函数类似pthread的trylock，只要已检测到锁不用，就直接返回错误，不进行自旋等待。总体来说，InnoDB自旋互斥锁的用法和语义跟系统互斥锁一模一样，但是底层实现却大相径庭。<br>\n在ib_mutex_t这个核心数据结构中，最重要的是前面两个变量：event和lock_word。lock_word为0表示锁空闲，1表示锁被占用，InnoDB自旋互斥锁使用<code>__sync_lock_test_and_set</code>这个函数对lock_word进行原子操作，加锁的时候，尝试把其设置为1，函数返回值不指示是否成功，指示的是尝试设置之前的值，因此如果返回值是0，表示加锁成功，返回是1表示失败。如果加锁失败，则会自旋一段时间，然后等待在条件变量event（<code>os_event_wait</code>）上，当锁占用者释放锁的时候，会使用<code>os_event_set</code>来唤醒所有的等待者。简单的来说，byte类型的lock_word基于平台提供的原子操作来实现互斥访问，而event是InnoDB条件变量类型，用来实现锁释放后唤醒等待线程的操作。</p>\n<p>接下来，详细介绍一下，<code>mutex_enter</code>和<code>mutex_exit</code>的逻辑，InnoDB自旋互斥锁的精华都在这两个函数中。<br>\nmutex_enter的伪代码如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a349d334b528556923899\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nif (__sync_lock_test_and_set(mutex-&gt;lock_word, 1) == 0) {\r\n    get mutex successfully;\r\n    return;\r\n}\r\nloop1:\r\n    i = 0;\r\nloop2:\r\n    /*指示点1*/\r\n    while (mutex-&gt;lock_word ! = 0 &amp;&amp; i &lt; SPIN_ROUNDS) {\r\n             random spin using ut_delay, spin max time depend on SPIN_WAIT_DELAY;\r\n             i++;\r\n}\r\nif (i == SPIN_ROUNDS) {\r\n    yield_cpu;\r\n}\r\n/*指示点2*/\r\nif (__sync_lock_test_and_set(mutex-&gt;lock_word, 1) == 0) {\r\n    get mutex successfully;\r\n    return;\r\n}\r\nif (i &lt; SPIN_ROUNDS) {\r\n     goto loop2\r\n}\r\n/*指示点4*/\r\nget cell from sync array and call os_event_reset(mutex-&gt;event);\r\nmutex-&gt;waiter =1;\r\n/*指示点3*/\r\nfor (i = 0; i &lt; 4; i++) {\r\n    if (__sync_lock_test_and_set(mutex-&gt;lock_word, 1) == 0) {\r\n        get mutex successfully;\r\n        free cell;\r\n        return;\r\n    }\r\n}\r\nsync array wait and os_event_wait(mutex-&gt;event);\r\ngoto loop1;</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a349d334b528556923899-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b528556923899-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b528556923899-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b528556923899-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b528556923899-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b528556923899-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b528556923899-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b528556923899-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b528556923899-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b528556923899-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b528556923899-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b528556923899-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b528556923899-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b528556923899-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b528556923899-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b528556923899-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b528556923899-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b528556923899-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b528556923899-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b528556923899-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b528556923899-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b528556923899-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b528556923899-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b528556923899-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b528556923899-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b528556923899-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b528556923899-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b528556923899-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b528556923899-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b528556923899-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b528556923899-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b528556923899-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b528556923899-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b528556923899-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b528556923899-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b528556923899-36\">36</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a349d334b528556923899-1\"><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">__sync_lock_test_and_set</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">mutex</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lock_word</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b528556923899-2\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">get </span><span class=\"crayon-e\">mutex </span><span class=\"crayon-v\">successfully</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b528556923899-3\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b528556923899-4\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b528556923899-5\"><span class=\"crayon-v\">loop1</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b528556923899-6\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b528556923899-7\"><span class=\"crayon-v\">loop2</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b528556923899-8\"><span class=\"crayon-h\">    </span><span class=\"crayon-c\">/*指示点1*/</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b528556923899-9\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">while</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">mutex</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lock_word</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SPIN_ROUNDS</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b528556923899-10\"><span class=\"crayon-h\">             </span><span class=\"crayon-e\">random </span><span class=\"crayon-e\">spin </span><span class=\"crayon-e\">using </span><span class=\"crayon-v\">ut_delay</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">spin </span><span class=\"crayon-e\">max </span><span class=\"crayon-e\">time </span><span class=\"crayon-e\">depend </span><span class=\"crayon-e\">on </span><span class=\"crayon-v\">SPIN_WAIT_DELAY</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b528556923899-11\"><span class=\"crayon-h\">             </span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b528556923899-12\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b528556923899-13\"><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SPIN_ROUNDS</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b528556923899-14\"><span class=\"crayon-h\">    </span><span class=\"crayon-v\">yield_cpu</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b528556923899-15\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b528556923899-16\"><span class=\"crayon-c\">/*指示点2*/</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b528556923899-17\"><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">__sync_lock_test_and_set</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">mutex</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lock_word</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b528556923899-18\"><span class=\"crayon-h\">    </span><span class=\"crayon-e\">get </span><span class=\"crayon-e\">mutex </span><span class=\"crayon-v\">successfully</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b528556923899-19\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b528556923899-20\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b528556923899-21\"><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SPIN_ROUNDS</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b528556923899-22\"><span class=\"crayon-h\">     </span><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">loop2</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b528556923899-23\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b528556923899-24\"><span class=\"crayon-c\">/*指示点4*/</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b528556923899-25\"><span class=\"crayon-e\">get </span><span class=\"crayon-e\">cell </span><span class=\"crayon-e\">from </span><span class=\"crayon-e\">sync </span><span class=\"crayon-t\">array</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">and</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">call </span><span class=\"crayon-e\">os_event_reset</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">mutex</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">event</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b528556923899-26\"><span class=\"crayon-v\">mutex</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">waiter</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b528556923899-27\"><span class=\"crayon-c\">/*指示点3*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b528556923899-28\"><span class=\"crayon-st\">for</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">4</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b528556923899-29\"><span class=\"crayon-h\">    </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">__sync_lock_test_and_set</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">mutex</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lock_word</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b528556923899-30\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">get </span><span class=\"crayon-e\">mutex </span><span class=\"crayon-v\">successfully</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b528556923899-31\"><span class=\"crayon-h\">        </span><span class=\"crayon-e\">free </span><span class=\"crayon-v\">cell</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b528556923899-32\"><span class=\"crayon-h\">        </span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b528556923899-33\"><span class=\"crayon-h\">    </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b528556923899-34\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b528556923899-35\"><span class=\"crayon-e\">sync </span><span class=\"crayon-t\">array</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">wait </span><span class=\"crayon-st\">and</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">os_event_wait</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">mutex</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">event</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b528556923899-36\"><span class=\"crayon-st\">goto</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">loop1</span><span class=\"crayon-sy\">;</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0049 seconds] -->\r\n<p>代码还是有点小复杂的。这里分析几点如下：<br>\n1. SPIN_ROUNDS控制了在放弃cpu时间片（yield_cpu）之前，一共进行多少次忙等，这个参数就是对外可配置的innodb_sync_spin_loops，而SPIN_WAIT_DELAY控制了每次忙等的时间，这个参数也就是对外可配置的innodb_spin_wait_delay。这两个参数一起决定了自旋的时间。Heikki Tuuri建议在单处理器的机器上调小spin的时间，在对称多处理器的机器上，可以适当调大。比较有意思的是innodb_spin_wait_delay的单位，这个是100MHZ的奔腾处理器处理1毫秒的时间，默认innodb_spin_wait_delay配置成6，表示最多在100MHZ的奔腾处理器上自旋6毫秒。由于现在cpu都是按照GHZ来计算的，所以按照默认配置自旋时间往往很短。此外，自旋不真是cpu傻傻的在那边100%的跑，在现代的cpu上，给自旋专门提供了一条指令，在笔者的测试环境下，这条指令是pause，查看Intel的文档，其对pause的解释是：不会发生用户态和内核态的切换，cpu在用户态自旋，因此不会发生上下文切换，同时这条指令不会消耗太多的能耗。。。所以那些说spin lock太浪费电的不攻自破了。。。另外，编译器也不会把ut_delay给优化掉，因为其里面估计修改了一个全局变量。<br>\n2. yield_cpu 操作在笔者的环境中，就是调用了pthread_yield函数，这个函数把放弃当前cpu的时间片，然后把当前线程放到cpu可执行队列的末尾。<br>\n3. 在指示点1后面的循环，没有采用原子操作读取数据，是因为，Heikki Tuuri认为由于原子操作在内存和cpu cache之间会产生过的数据交换，如果只是读本地的cache，可以减少总线的争用。即使本地读到脏的数据，也没关系，因为在跳出循环的指示点2，依然会再一次使用原子操作进行校验。<br>\n4. get cell这个操作是从sync array执行的，sync array详见辅助数据结构这一节，简单的说就是提供给监控线程使用的。<br>\n5. 注意一下，<code>os_event_reset</code>和<code>os_event_wait</code>这两个函数的调用位置，另外，有一点必须清楚，就是<code>os_event_set</code>（锁持有者释放所后会调用这个函数通知所有等待者）可能在这整段代码执行到任意位置出现，有可能出现在指示点4的位置，这样就构成了条件变量通知在条件变量等待之前，会造成无限等待。为了解决这个问题，才有了指示点3下面的代码，需要重新再次检测一下lock_word，另外，即使<code>os_event_set</code>发生在<code>os_event_reset</code>之后，有了这些代码，也能让当前线程提前拿到锁，不用执行后续<code>os_event_wait</code>的代码，一定程度上提高了效率。</p>\n<p>mutex_exit的伪代码就简单多了，如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a349d334b541696145523\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n__sync_lock_test_and_set(mutex-&gt;lock_word, 0);\r\n\r\n/* A problem: we assume that mutex_reset_lock word                                                                     \r\n        is a memory barrier, that is when we read the waiters                                                                  \r\n        field next, the read must be serialized in memory                                                                      \r\n        after the reset. A speculative processor might                                                                         \r\n        perform the read first, which could leave a waiting                                                                    \r\n        thread hanging indefinitely.                                                                                                                                                                                                                        \r\nOur current solution call every second                                                                                 \r\n        sync_arr_wake_threads_if_sema_free()                                                                                   \r\n        to wake up possible hanging threads if                                                                                 \r\n        they are missed in mutex_signal_object. */ \r\n\r\nif (mutex-&gt;waiter != 0) {\r\n     mutex-&gt;waiter = 0;\r\n     os_event_set(mutex-&gt;event);\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a349d334b541696145523-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b541696145523-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b541696145523-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b541696145523-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b541696145523-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b541696145523-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b541696145523-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b541696145523-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b541696145523-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b541696145523-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b541696145523-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b541696145523-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b541696145523-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b541696145523-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b541696145523-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b541696145523-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b541696145523-17\">17</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a349d334b541696145523-1\"><span class=\"crayon-e\">__sync_lock_test_and_set</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">mutex</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">lock_word</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b541696145523-2\"> </div><div class=\"crayon-line\" id=\"crayon-5a349d334b541696145523-3\"><span class=\"crayon-c\">/* A problem: we assume that mutex_reset_lock word                                                                     </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b541696145523-4\"><span class=\"crayon-c\">        is a memory barrier, that is when we read the waiters                                                                  </span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b541696145523-5\"><span class=\"crayon-c\">        field next, the read must be serialized in memory                                                                      </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b541696145523-6\"><span class=\"crayon-c\">        after the reset. A speculative processor might                                                                         </span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b541696145523-7\"><span class=\"crayon-c\">        perform the read first, which could leave a waiting                                                                    </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b541696145523-8\"><span class=\"crayon-c\">        thread hanging indefinitely.                                                                                                                                                                                                                        </span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b541696145523-9\"><span class=\"crayon-c\">Our current solution call every second                                                                                 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b541696145523-10\"><span class=\"crayon-c\">        sync_arr_wake_threads_if_sema_free()                                                                                   </span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b541696145523-11\"><span class=\"crayon-c\">        to wake up possible hanging threads if                                                                                 </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b541696145523-12\"><span class=\"crayon-c\">        they are missed in mutex_signal_object. */</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b541696145523-13\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b541696145523-14\"><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">mutex</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">waiter</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b541696145523-15\"><span class=\"crayon-h\">     </span><span class=\"crayon-v\">mutex</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">waiter</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b541696145523-16\"><span class=\"crayon-h\">     </span><span class=\"crayon-e\">os_event_set</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">mutex</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">event</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b541696145523-17\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0016 seconds] -->\r\n<p>1. waiter是ib_mutex_t中的一个变量，用来表示当前是否有线程在等待这个锁。整个代码逻辑很简单，就是先把lock_word设置为0，然后如果发现有等待者，就把所有等待者给唤醒。facebook的mark callaghan在2014年测试过，相比现在已经比较完善的pthread库，InnoDB自旋互斥锁只在并发量相对较低（小于256线程）和锁等待时间比较短的情况下有优势，在高并发且较长的锁等待时间情况下，退化比较严重，其中一个很重要的原因就是InnoDB自旋互斥锁在锁释放的时候需要唤醒所有等待者。由于<code>os_event_ret</code>底层通过pthread_cond_boardcast来通知所有的等待者，一种改进是把pthread_cond_boardcast改成pthread_cond_signal，即只唤醒一个线程，但Inaam Rana Mark测试后发现，如果只唤醒一个线程的话，在高并发的情况下，这个线程可能不会立刻被cpu调度到。。由此看来，似乎唤醒一个特定数量的等待者是一个比较好的选择。<br>\n2. 伪代码中的这段注释笔者估计加上去的，大意是由于编译器或者cpu的指令重排乱序执行，mutex-&gt;waiter这个变量的读取可能在发生在原子操作之前，从而导致一些无线等待的问题。然后还专门开了一个叫做<code>sync_arr_wake_threads_if_sema_free</code>的函数来做清理。这个函数是在后台线程<code>srv_error_monitor_thread</code>中做的，每隔1秒钟执行一次。在现代的cpu和编译器上，完全可以用内存屏障的技术来防止指令重排和乱序执行，这个函数可以被去掉，官方的意见貌似是，不要这么激进，万一其他地方还需要这个函数呢。。详见BUG #79477。</p>\n<p>总体来说，InnoDB自旋互斥锁的底层实现还是比较有意思的，非常适合学习研究。这套锁机制在现在完善的Pthread库和高达4GMHZ的cpu下，已经有点力不从心了，mark callaghan研究发现，在高负载的压力下，使用这套锁机制的InnoDB，大部分cpu时间都给了sys和usr，基本没有空闲，而pthread mutex在相同情况下，却有平均80%的空闲。同时，由于ib_mutex_t这个结构体体积比较庞大，当buffer pool比较大的时候，会发现锁占用了很多的内存。最后，从代码风格上来说，有不少代码没有解耦，如果需要把锁模块单独打成一个函数库，比较困难。<br>\n基于上述几个缺陷，MySQL 5.7及后续的版本中，对互斥锁进行了大量的重新，包括以下几点(WL#6044)：<br>\n1. 使用了C++中的类继承关系，系统互斥锁和InnoDB自己实现的自旋互斥锁都是一个父类的子类。<br>\n2. 由于bool pool的锁对性能要求比较高，因此使用静态继承（也就是模板）的方式来减少继承中虚指针造成的开销。<br>\n3. 保留旧的InnoDB自旋互斥锁，并实现了一种基于futex的锁。简单的说，futex锁与上述的原子操作类似，能减少用户态和内核态切换的开销，但同时保留类似mutex的使用方法，大大降低了程序编写的难度。</p>\n<h2 id=\"innodb读写锁\">InnoDB读写锁</h2>\n<p>与条件变量、互斥锁不同，InnoDB里面没有Pthread库的读写锁的包装，其完全依赖依赖于原子操作和InnoDB的条件变量，甚至都不需要依赖InnoDB的自旋互斥锁。此外，读写锁还实现了写操作的递归锁，即同一个线程可以多次获得写锁，但是同一个线程依然不能同时获得读锁和写锁。InnoDB读写锁的核心数据结构rw_lock_t中，并没有等待队列的信息，因此不能保证先到的请求一定会先进入临界区。这与系统互斥量用PTHREAD_MUTEX_ADAPTIVE_NP来初始化有异曲同工之妙。<br>\nInnoDB读写锁的核心实现在源文件sync0rw.cc和sync0rw.ic中，核心数据结构rw_lock_t定义在sync0rw.h中。使用方法与InnoDB自旋互斥锁很类似，只不过读请求和写请求要调用不同的函数。加读锁调用<code>rw_lock_s_lock</code>, 加写锁调用<code>rw_lock_x_lock</code>，释放读锁调用<code>rw_lock_s_unlock</code>, 释放写锁调用<code>rw_lock_x_unlock</code>，创建读写锁调用<code>rw_lock_create</code>，释放读写锁调用<code>rw_lock_free</code>。函数<code>rw_lock_x_lock_nowait</code>和<code>rw_lock_s_lock_nowait</code>表示，当加读写锁失败的时候，直接返回，而不是自旋等待。</p>\n<h3 id=\"核心机制\">核心机制</h3>\n<p>rw_lock_t中，核心的成员有以下几个：lock_word, event, waiters, wait_ex_event，writer_thread, recursive。<br>\n与InnoDB自旋互斥锁的lock_word不同，rw_lock_t中的lock_word是int 型，注意不是unsigned的，其取值范围是(-2<em>X_LOCK_DECR, X_LOCK_DECR]，其中X_LOCK_DECR为0x00100000，差不多100多W的一个数。在InnoDB自旋互斥锁互斥锁中，lock_word的取值范围只有0，1，因为这两个状态就能把互斥锁的所有状态都表示出来了，也就是说，只需要查看一下这个lock_word就能确定当前的线程是否能获得锁。rw_lock_t中的lock_word也扮演了相同的角色，只需要查看一下当前的lock_word落在哪个取值范围中，就确定当前线程能否获得锁。至于rw_lock_t中的lock_word是如何做到这一点的，这其实是InnoDB读写锁乃至InnoDB同步机制中最神奇的地方，下文我们会详细分析。<br>\nevent是一个InnoDB条件变量，当当前的锁已经被一个线程以写锁方式独占时，后续的读锁和写锁都等待在这个event上，当这个线程释放写锁时，等待在这个event上的所有读锁和写锁同时竞争。waiters这变量，与event一起用，当有等待者在等待时，这个变量被设置为1，否则为0，锁被释放的时候，需要通过这个变量来判断有没有等待者从而执行<code>os_event_set</code>。<br>\n与InnoDB自旋互斥锁不同，InnoDB读写锁还有wait_ex_event和recursive两个变量。wait_ex_event也是一个InnoDB条件变量，但是它用来等待第一个写锁（因为写请求可能会被先前的读请求堵住），当先前到达的读请求都读完了，就会通过这个event来唤醒这个写锁的请求。<br>\n由于InnoDB读写锁实现了写锁的递归，因此需要保存当前写锁被哪个线程占用了，后续可以通过这个值来判断是否是这个线程的写锁请求，如果是则加锁成功，否则失败，需要等待。线程的id就保存在writer_thread这个变量中。<br>\nrecursive是个bool变量，用来表示当前的读写锁是否支持递归写模式，在某些情况下，例如需要另外一个线程来释放这个读写锁（insert buffer需要这个功能）的时候，就不要开启递归模式了。</em></p>\n<p>接下来，我们来详细介绍一下lock_word的变化规则：<br>\n1. 当有一个读请求加锁成功时，lock_word原子递减1。<br>\n2. 当有一个写请求加锁成功时，lock_word原子递减X_LOCK_DECR。<br>\n3. 如果读写锁支持递归写，那么第一个递归写锁加锁成功时，lock_word依然原子递减X_LOCK_DECR，而后续的递归写锁加锁成功是，lock_word只是原子递减1。<br>\n在上述的变化规则约束下，lock_word会形成以下几个区间：<br>\n<em>lock_word == X_LOCK_DECR: 表示锁空闲，即当前没有线程获得了这个锁。<br>\n0 &lt; lock_word &lt; X_LOCK_DECR: 表示当前有X_LOCK_DECR – lock_word个读锁<br>\nlock_word == 0: 表示当前有一个写锁<br>\n-X_LOCK_DECR &lt; lock_word &lt; 0: 表示当前有-lock_word个读锁，他们还没完成，同时后面还有一个写锁在等待<br>\nlock_word &lt;= -X_LOCK_DECR: 表示当前处于递归锁模式，同一个线程加了2 – (lock_word + X_LOCK_DECR)次写锁。</em><br>\n另外，还可以得出以下结论<br>\n1. 由于lock_word的范围被限制（rw_lock_validate）在(-2X_LOCK_DECR, X_LOCK_DECR]中，结合上述规则，可以推断出，一个读写锁最多能加X_LOCK_DECR个读锁。在开启递归写锁的模式下，一个线程最多同时加X_LOCK_DECR+1个写锁。<br>\n2. 在读锁释放之前，lock_word一定处于(-X_LOCK_DECR, 0)U(0, X_LOCK_DECR)这个范围内。<br>\n3. 在写锁释放之前，lock_word一定处于(-2*X_LOCK_DECR, -X_LOCK_DECR]或者等于0这个范围内。<br>\n4. 只有在lock_word大于0的情况下才可以对它递减。有一个例外，就是同一个线程需要加递归写锁的时候，lock_word可以在小于0的情况下递减。</p>\n<p>接下来，举个读写锁加锁的例子，方便读者理解读写锁底层加锁的原理。假设有读写加锁请求按照以下顺序依次到达：R1-&gt;R2-&gt;W1-&gt;R3-&gt;W2-&gt;W3-&gt;R4，其中W2和W3是属于同一个线程的写加锁请求，其他所有读写请求均来自不同线程。初始化后，lock_word的值为X_LOCK_DECR（十进制值为1048576）。R1读加锁请求首先到，其发现lock_word大于0，表示可以加读锁，同时lock_word递减1，结果为1048575，R2读加锁请求接着来到，发现lock_word依然大于0，继续加读锁并递减lock_word，最终结果为1048574。注意，如果R1和R2几乎是同时到达，即使时序上是R1先请求，但是并不保证R1首先递减，有可能是R2首先拿到原子操作的执行权限。如果在R1或者R2释放锁之前，写加锁请求W1到来，他发现lock_word依旧大于0，于是递减X_LOCK_DECR，并把自己的线程id记录在writer_thread这个变量里，再检查lock_word的值（此时为-2），由于结果小于0，表示前面有未完成的读加锁请求，于是其等待在wait_ex_event这个条件变量上。后续的R3, W2, W3, R4请求发现lock_word小于0，则都等待在条件变量event上，并且设置waiter为1，表示有等待者。假设R1先释放读锁(lock_word递增1)，R2后释放(lock_word再次递增1)。R2释放后，由于lock_word变为0了，其会在wait_ex_event上调用<code>os_event_set</code>，这样W3就被唤醒了，他可以执行临界区内的代码了。W3执行完后，lock_word被恢复为X_LOCK_DECR，然后其发现waiter为1，表示在其后面有新的读写加锁请求在等待，然后在event上调用<code>os_event_set</code>，这样R3, W2, W3, R4同时被唤醒，进行原子操作执行权限争抢(可以简单的理解为谁先得到cpu调度)。假设W2首先抢到了执行权限，其会把lock_word再次递减为0并自己的线程id记录在writer_thread这个变量里，当检查lock_word的时候，发现值为0，表示前面没有读请求了，于是其就进入临界区执行代码了。假设此时，W3得到了cpu的调度，由于lock_word只有在大于0的情况下才能递减，所以其递减lock_word失败，但是其通过对比writer_thread和自己的线程id，发现前面的写锁是自己加的，如果这个时候开启了递归写锁，即recursive值为true，他把lock_word再次递减X_LOCK_DECR（现在lock_word变为-X_LOCK_DECR了），然后进入临界区执行代码。这样就保证了同一个线程多次加写锁也不发生死锁，也就是递归锁的概念。后续的R3和R4发现lock_word小于等于0，就直接等待在event条件变量上，并设置waiter为1。直到W2和W3都释放写锁，lock_word又变为X_LOCK_DECR，最后一个释放的，检查waiter变量发现非0，就会唤醒event上的所有等待者，于是R3和R4就可以执行了。<br>\n读写锁的核心函数函数结构跟InnoDB自旋互斥锁的基本相同，主要的区别就是用<code>rw_lock_x_lock_low</code>和<code>rw_lock_s_lock_low</code>替换了<code>__sync_lock_test_and_set</code>原子操作。<code>rw_lock_x_lock_low</code>和<code>rw_lock_s_lock_low</code>就按照上述的lock_word的变化规则来原子的改变（依然使用了<code>__sync_lock_test_and_set</code>）lock_word这个变量。</p>\n<p>在MySQL 5.7中，读写锁除了可以加读锁(Share lock)请求和加写锁(exclusive lock)请求外，还可以加share exclusive锁请求，锁兼容性如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a349d334b550668263900\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n LOCK COMPATIBILITY MATRIX\r\n    S SX  X\r\n S  +  +  -\r\n SX +  -  -\r\n X  -  -  -</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a349d334b550668263900-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b550668263900-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b550668263900-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b550668263900-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b550668263900-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a349d334b550668263900-1\"><span class=\"crayon-h\"> </span><span class=\"crayon-e\">LOCK </span><span class=\"crayon-e\">COMPATIBILITY </span><span class=\"crayon-i\">MATRIX</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b550668263900-2\"><span class=\"crayon-h\">    </span><span class=\"crayon-i\">S</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">SX</span><span class=\"crayon-h\">  </span><span class=\"crayon-i\">X</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b550668263900-3\"><span class=\"crayon-h\"> </span><span class=\"crayon-v\">S</span><span class=\"crayon-h\">  </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\">  </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\">  </span><span class=\"crayon-o\">-</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b550668263900-4\"><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SX</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\">  </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\">  </span><span class=\"crayon-o\">-</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b550668263900-5\"><span class=\"crayon-h\"> </span><span class=\"crayon-v\">X</span><span class=\"crayon-h\">  </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\">  </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\">  </span><span class=\"crayon-o\">-</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n<p>按照WL#6363的说法，是为了修复index-&gt;lock这个锁的冲突。</p>\n<h2 id=\"辅助结构\">辅助结构</h2>\n<p>InnoDB同步机制中，还有很多使用的辅助结构，他们的作用主要是为了监控方便和死锁的预防和检测。这里主要介绍sync array, sync thread level array和srv_error_monitor_thread。<br>\nsync array主要的数据结构是sync_array_t，可以把他理解为一个数据，数组中的元素为sync_cell_t。当一个锁（InnoDB自旋互斥锁或者InnoDB读写锁，下同）需要发生<code>os_event_wait</code>等待时，就需要在sync array中申请一个sync_cell_t来保存当前的信息，这些信息包括等待锁的指针（便于死锁检测），在哪一个文件以及哪一行发生了等待（也就是mutex_enter, rw_lock_s_lock或者rw_lock_x_lock被调用的地方，只在debug模式下有效），发生等待的线程（便于死锁检测）以及等待开始的时间（便于统计等待的时间）。当锁释放的时候，就把相关联的sync_cell_t重置为空，方便复用。sync_cell_t在sync_array_t中的个数，是在初始化同步模块时候就指定的，其个数一般为OS_THREAD_MAX_N，而OS_THREAD_MAX_N是在InnoDB初始化的时候被计算，其包括了系统后台开启的所有线程，以及max_connection指定的个数，还预留了一些。由于一个线程在某一个时刻最多只能发生一个锁等待，所以不用担心sync_cell_t不够用。从上面也可以看出，在每个锁进行等待和释放的时候，都需要对sync array操作，因此在高并发的情况下，单一的sync array可能成为瓶颈，在MySQL 5.6中，引入了多sync array, 个数可以通过innodb_sync_array_size进行控制，这个值默认为1，在高并发的情况下，建议调高。</p>\n<p>InnoDB作为一个成熟的存储引擎，包含了完善的死锁预防机制和死锁检测机制。在每次需要锁等待时，即调用<code>os_event_wait</code>之前，需要启动死锁检测机制来保证不会出现死锁，从而造成无限等待。在每次加锁成功（lock_word递减后，函数返回之前）时，都会启动死锁预防机制，降低死锁出现的概率。当然，由于死锁预防机制和死锁检测机制需要扫描比较多的数据，算法上也有递归操作，所以只在debug模式下开启。<br>\n死锁检测机制主要依赖sync array中保存的信息以及死锁检测算法来实现。死锁检测机制通过sync_cell_t保存的等待锁指针和发生等待的线程以及教科书上的有向图环路检测算法来实现，具体实现在<code>sync_array_deadlock_step</code>和<code>sync_array_detect_deadlock</code>中实现，仔细研究后发现个小问题，由于<code>sync_array_find_thread</code>函数仅仅在当前的sync array中遍历，当有多个sync array时（innodb_sync_array_size &gt; 1）,如果死锁发生在不同的sync array上，现有的死锁检测算法将无法发现这个死锁。<br>\n死锁预防机制是由sync thread level array和全局锁优先级共同保证的。InnoDB为了降低死锁发生的概率，上层的每种类型的锁都有一个优先级。例如回滚段锁的优先级就比文件系统page页的优先级高，虽然两者底层都是InnoDB互斥锁或者InnoDB读写锁。有了这个优先级，InnoDB规定，每个锁创建是必须制定一个优先级，同一个线程的加锁顺序必须从优先级高到低，即如果一个线程目前已经加了一个低优先级的锁A，在释放锁A之前，不能再请求优先级比锁A高(或者相同)的锁。形成死锁需要四个必要条件，其中一个就是不同的加锁顺序，InnoDB通过锁优先级来降低死锁发生的概率，但是不能完全消除。原因是可以把锁设置为SYNC_NO_ORDER_CHECK这个优先级，这是最高的优先级，表示不进行死锁预防检查，如果上层的程序员把自己创建的锁都设置为这个优先级，那么InnoDB提供的这套机制将完全失效，所以要养成给锁设定优先级的好习惯。sync thread level array是一个数组，每个线程单独一个，在同步模块初始化时分配了OS_THREAD_MAX_N个，所以不用担心不够用。这个数组中记录了某个线程当前锁拥有的所有锁，当新加了一个锁B时，需要扫描一遍这个数组，从而确定目前线程所持有的锁的优先级都比锁B高。</p>\n<p>最后，我们来讲讲srv_error_monitor_thread这个线程。这是一个后台线程，在InnoDB启动的时候启动，每隔1秒钟执行一下指定的操作。跟同步模块相关的操作有两点，去除无限等待的锁和报告长时间等待的异常锁。<br>\n去除无线等待的锁，如上文所属，就是sync_arr_wake_threads_if_sema_free这个函数。这个函数通过遍历sync array，如果发现锁已经可用(<code>sync_arr_cell_can_wake_up</code>)，但是依然有等待者，则直接调用<code>os_event_set</code>把他们唤醒。这个函数是为了解决由于cpu乱序执行或者编译器指令重排导致锁无限等待的问题，但是可以通过内存屏障技术来避免，所以可以去掉。<br>\n报告长时间等待的异常锁，通过sync_cell_t里面记录的锁开始等待时间，我们可以很方便的统计锁等待发生的时间。在目前的实现中，当锁等待超过240秒的时候，就会在错误日志中看到信息。如果同一个锁被检测到等到超过600秒且连续10次被检测到，则InnoDB会通过assert来自杀。。。相信当做运维DBA的同学一定看到过如下的报错：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a349d334b55e194845195\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nInnoDB: Warning: a long semaphore wait:\r\n--Thread 139774244570880 has waited at log0read.h line 765 for 241.00 seconds the semaphore:\r\nMutex at 0x30c75ca0 created file log0read.h line 522, lock var 1 \r\nLast time reserved in file /home/yuhui.wyh/mysql/storage/innobase/include/log0read.h line 765, waiters flag 1\r\nInnoDB: ###### Starts InnoDB Monitor for 30 secs to print diagnostic info:\r\nInnoDB: Pending preads 0, pwrites 0</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a349d334b55e194845195-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b55e194845195-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b55e194845195-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b55e194845195-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a349d334b55e194845195-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a349d334b55e194845195-6\">6</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a349d334b55e194845195-1\"><span class=\"crayon-v\">InnoDB</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Warning</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">a</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">long</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">semaphore </span><span class=\"crayon-v\">wait</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b55e194845195-2\"><span class=\"crayon-o\">--</span><span class=\"crayon-i\">Thread</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">139774244570880</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">has </span><span class=\"crayon-e\">waited </span><span class=\"crayon-e\">at </span><span class=\"crayon-v\">log0read</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">h</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">line</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">765</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">for</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">241.00</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">seconds </span><span class=\"crayon-e\">the </span><span class=\"crayon-v\">semaphore</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b55e194845195-3\"><span class=\"crayon-e\">Mutex </span><span class=\"crayon-i\">at</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0x30c75ca0</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">created </span><span class=\"crayon-e\">file </span><span class=\"crayon-v\">log0read</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">h</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">line</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">522</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">lock </span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b55e194845195-4\"><span class=\"crayon-e\">Last </span><span class=\"crayon-e\">time </span><span class=\"crayon-e\">reserved </span><span class=\"crayon-st\">in</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">file</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">home</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">yuhui</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">wyh</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">mysql</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">storage</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">innobase</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">include</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">log0read</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">h</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">line</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">765</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">waiters </span><span class=\"crayon-i\">flag</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span></div><div class=\"crayon-line\" id=\"crayon-5a349d334b55e194845195-5\"><span class=\"crayon-v\">InnoDB</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\">###### Starts InnoDB Monitor for 30 secs to print diagnostic info:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a349d334b55e194845195-6\"><span class=\"crayon-v\">InnoDB</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Pending </span><span class=\"crayon-i\">preads</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">pwrites</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0023 seconds] -->\r\n<p>一般出现这种错误都是pread或者pwrite长时间不返回，导致锁超时。至于pread或者pwrite长时间不返回的root cause常常是有很多的读写请求在极短的时间内到达导致磁盘扛不住或者磁盘已经坏了。。。</p>\n<h2 id=\"总结\">总结</h2>\n<p>本文详细介绍了原子操作，条件变量，互斥锁以及读写锁在InnoDB引擎中的实现。原子操作由于其能减少不必要的用户态和内核态的切换以及更精简的cpu指令被广泛的应用到InnoDB自旋互斥锁和InnoDB读写锁中。InnoDB条件变量使用更加方便，但是一定要注意条件通知必须在条件等待之后，否则会有无限等待发生。InnoDB自旋互斥锁加锁和解锁过程虽然复杂但是都是必须的操作。InnoDB读写锁神奇的lock_word控制方法给我们留下了深刻影响。正因为InnoDB底层同步机制的稳定、高效，MySQL在我们的服务器上才能运行的如此稳定。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113301\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113301votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113301\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "url": "http://blog.jobbole.com/113301/", "comment_nums": 0, "praise_nums": 1, "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2016/04/582271a95a4505dff985ffc837868976.png"]},{"title": "漫画解读：通过造车来了解软件开发模式 ​​​​", "url_object_id": "adfa75d1779c8eafc10e8cabe3bff3e9", "create_date": "2017/12/14", "tags": "趣文小说,趣图", "fav_nums": 4, "front_image_path": "full/ddea7e492385a85fd588582693b753dfb4e75192.jpg", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文作者： <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/hanxiaomax\">艾凌风</a> 。未经作者许可，禁止转载！<br>欢迎加入伯乐在线 <a href=\"http://blog.jobbole.com/99322\" target=\"_blank\">专栏作者</a>。</div><p>1913 年，美利坚工业之神——亨利福特，发明了世界上第一条流水线，汽车工业从此进入了大规模生产的时代。丰田公司提出的丰田生产系统（Toyota Production System）又为汽车工业带来了很多先进的生产和管理理念。</p>\n<p>先进的生产和管理理念是一个行业从小作坊走向规模化的必经之路，软件工业虽然诞生较晚，但是发展却非常迅速，这也同样得益于软件工业开发和管理理念的发展。这其中就从汽车工业吸收了很多成熟的理念。</p>\n<p>下面，就让我们通过这张出自 Toggle 的漫画，来了解软件开发模式的变迁史。</p>\n<h2>总览</h2>\n<p><img id=\"pic\" class=\"M_cur_zoom_out\" src=\"http://wx3.sinaimg.cn/large/7cc829d3gy1fm603hue8aj20rs3duqn3.jpg\"></p>\n<p>这张图片从上向下，五个房间，分别是瀑布模型（waterfall），敏捷开发（agile），看板（KANBAN），SCRUM 和精益软件开发（lean）。</p>\n<p>除了瀑布模型这间小屋和其他小屋有着明显的界限之外，其他几种模型就像一个四合院，有着不可分割的关系，这也恰好表明，瀑布模式和敏捷开发模式是软件工业先后经历的两个阶段，而 KANBAN，SCRUM 和 LEAN 则是敏捷运动的产物。</p>\n<p>OK，客官里边请，让我们进第一个屋子看看。</p>\n<h2>Old Days——瀑布式软件开发</h2>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/12/fa38bde05d5560efbfc865afcc0aa5a0.jpg\" alt=\"15128081424398\"></p>\n<p>所谓瀑布模型，就是说，软件开发是按照一定顺序展开的（传统线性生产流程 : Traditional,linear production flow）。就像汽车生产的流水线一样，每个部门各司其责，工作按照顺序展开，交付件单通道线性流动。你看这幅图，总体上就分为：<strong>需求 → 设计<strong> → </strong>制造<strong> → </strong>测试</strong>，四个阶段。</p>\n<p><img class=\"alignnone\" src=\"http://wx2.sinaimg.cn/mw690/7cc829d3gy1fmg664g0ndj208d06dgoo.jpg\" width=\"301\" height=\"229\"></p>\n<p>在这个系统中，客户被排除在生产系统之外（围墙是密闭不透明的），它们只能从需求的接口人那里向系统输入需求（Client places order）。正因如此，客户无法理解生产所需的费用以及为什么交付总是会延期，因此，也难免会闹出下面这样的笑话：</p>\n<p><img class=\"alignnone\" src=\"http://wx1.sinaimg.cn/mw690/7cc829d3gy1fmg662v0xcj207e0gyte6.jpg\" width=\"266\" height=\"610\"></p>\n<p>客户希望你造一辆汽车，却只愿意支付一辆自行车的开发成本。</p>\n<p>需求接纳后进入到设计阶段：</p>\n<p><img class=\"alignnone\" src=\"http://wx2.sinaimg.cn/mw690/7cc829d3gy1fmg6652zs5j20c707tgqa.jpg\" width=\"439\" height=\"281\"></p>\n<p>设计定型后，进入制造阶段：</p>\n<p><img class=\"alignnone\" src=\"http://wx4.sinaimg.cn/mw690/7cc829d3gy1fmg665nbgij20dn08t45d.jpg\" width=\"491\" height=\"317\"></p>\n<p>在线性的生产系统中，或者说在瀑布开发模式中，需求和设计是不可以进行修改的。工人被安排在制造系统中一个个工位上，每个人仅负责一个部件的生产和装配，就像这位盘腿坐着的“I know HTML”大哥一样，HTML 开发者只需要负责 HTML 的开发而无需，也不应该关心软件的其他部分。</p>\n<p><img class=\"alignnone\" src=\"http://wx2.sinaimg.cn/mw690/7cc829d3gy1fmg66671jzj209d07r78i.jpg\" width=\"337\" height=\"279\"></p>\n<p>喂喂喂，这位老铁，不上班玩什么球啊？哎，您也别怪他，毕竟交付件（整车/软件）还没有完成开发，测试工作自然无法开展，当然得等着咯。这也是瀑布模型最大的弊端，下游工作的开展严格依赖于上游交付件的完成情况，这无疑是一种浪费，在争分夺秒的软件开发过程中，你能忍受这种浪费吗？</p>\n<p><img class=\"alignnone\" src=\"http://wx1.sinaimg.cn/mw690/7cc829d3gy1fmg666trlkj208506777b.jpg\" width=\"293\" height=\"223\"></p>\n<p>汽车完成生产和测试之后，一次性交付到客户手中，完成客户的全部需求。</p>\n<h2>走进新时代——敏捷开发模式</h2>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/12/d0d1ceb8da75fe97e9dff8706d6df0be.jpg\" alt=\"15128097291193\"></p>\n<blockquote><p>敏捷开发以用户的<strong>需求进化为</strong>核心，采用迭代、循序渐进的方法进行软件开发。在敏捷开发中，软件项目在构建初期被切分成多个子项目，各个子项目的成果都经过测试，具备可视、可集成和可运行使用的特征。换言之，就是把一个大项目分为多个相互联系，但也可独立运行的小项目，并分别完成，在此过程中软件一直处于可使用状态</p></blockquote>\n<p>有点书面是吧，其实很简单，敏捷开发的一个前提假设是：用户不可能在产品开发之前，设计之初就完整、明确的提出需求。期望用户在开发过程中不变更需求是不现实的。用户在开发前提出的需求，可能并不是它们最终希望得到的。</p>\n<p><img id=\"pic\" class=\"\" src=\"http://wx2.sinaimg.cn/large/7cc829d3gy1flk6c8yl83j20k008qglx.jpg\" width=\"523\" height=\"228\"></p>\n<p><img class=\"alignnone\" src=\"http://wx3.sinaimg.cn/mw690/7cc829d3gy1fmg667ckk9j20bt05zn1n.jpg\" width=\"425\" height=\"215\"></p>\n<p>在敏捷开发中，客户会参与到软件开发的整个流程中。整个开发过程不再是一堵不透风的墙，透明是关键（TRANSPARENCY IS KEY），但是，随着越来越多的用户参与进来，越来越多的问题也暴露出来了，越来越多不着调的需求也会被提出。</p>\n<p><img class=\"alignnone\" src=\"http://wx3.sinaimg.cn/mw690/7cc829d3gy1fmg667xsfij20dr08qn36.jpg\" width=\"495\" height=\"314\"></p>\n<p>敏捷开发的另一个重要概念就是<strong>迭代</strong>，所谓迭代，就是不断对产品进行细微的、渐进式的改进（Small incremental changes）。</p>\n<blockquote><p>“先给您上个小号的尾翼，用着好我再给您换个大的~”</p></blockquote>\n<p><img class=\"alignnone\" src=\"http://wx4.sinaimg.cn/mw690/7cc829d3gy1fmg668ixufj20aa06ltc7.jpg\" width=\"370\" height=\"237\"></p>\n<p>在敏捷开发中，生产不再是线性的，开发的同时还会进行测试工作，所有人都在同时工作。尴尬等待的日子一去不复返咯~</p>\n<p><img class=\"alignnone\" src=\"http://wx3.sinaimg.cn/mw690/7cc829d3gy1fmg6692mmwj20ig0bs4am.jpg\" width=\"664\" height=\"424\"></p>\n<p>利用敏捷模式开发出的产品，相较于传统的软件交付方式，一个显著的特点是能够及时响应客户需求的变更，不断适应新的趋势。</p>\n<p><img class=\"alignnone\" src=\"http://wx1.sinaimg.cn/mw690/7cc829d3gy1fmg669pb2lj20cc07a79q.jpg\" width=\"444\" height=\"262\"></p>\n<p>这不，隔壁老王喜当爹了，之前定的法拉利显得有点不稳重，宝宝也没地方坐。我们的产品经理和开发人员快速响应，轿跑变商务也不是什么大问题~~ 当然，为谁辛苦为谁忙，客户爸爸们一定要买单呀！</p>\n<p>什么？您问第一稿方案是什么样的？去翻垃圾桶吧！ <img class=\"alignnone\" src=\"http://wx2.sinaimg.cn/mw690/7cc829d3gy1fmg66aari0j208e04uq4v.jpg\" width=\"302\" height=\"174\"></p>\n<h2>一股来自东方的神秘力量——看板</h2>\n<p><img class=\"alignnone\" src=\"http://wx4.sinaimg.cn/mw690/7cc829d3gy1fmg66ayb9mj20fw0g9apk.jpg\" width=\"572\" height=\"585\"></p>\n<p>相信各位也注意到了，相对于瀑布模式的井井有条，敏捷开发在灵活的同时，也带来了一定程度的混乱。</p>\n<p>就在这个节骨眼上，还得请这位来自东方的神秘人物——丰田看板大师（KANBAN SENSEI）给你点拨点拨。</p>\n<p><img class=\"alignnone\" src=\"http://wx1.sinaimg.cn/mw690/7cc829d3gy1fmg66bk590j206k07gdim.jpg\" width=\"236\" height=\"268\"></p>\n<p>KANBAN，不是汉语拼音，更不是英文缩写，它来自日语“看板”，カンバン的罗马拼写：Kanban。它正是丰田生产系统的一个重要概念：</p>\n<blockquote><p>看板管理，常作“Kanban管理”，是丰田生产模式中的重要概念，指为了达到及时生产（JIT）方式控制现场生产流程的工具。及时生产方式中的拉式（Pull）生产系统可以使信息的流程缩短，并配合定量、固定装货容器等方式，而使生产过程中的物料流动顺畅。</p></blockquote>\n<p>KANBAN要求把开发中的任务，以 TODO List 的方式表现出来：</p>\n<p><img class=\"alignnone\" src=\"http://wx4.sinaimg.cn/mw690/7cc829d3gy1fmg66c3l9lj207c06itbl.jpg\" width=\"264\" height=\"234\"></p>\n<p>形式可以是即时贴，也可以是可视化软件等等。</p>\n<p><img class=\"alignnone\" src=\"http://wx1.sinaimg.cn/mw690/7cc829d3gy1fmg663dya7j20ds09h764.jpg\" width=\"496\" height=\"341\"></p>\n<p>在制造业中，看板也是非常重要的管理方法。也有将其称为目视化管理的。</p>\n<h2>SCRUM 又是什么？</h2>\n<p><img class=\"alignnone\" src=\"http://wx1.sinaimg.cn/mw690/7cc829d3gy1fmg66crh75j20m50fwx10.jpg\" width=\"690\" height=\"495\"></p>\n<blockquote><p>Scrum原始含义是指英式橄榄球次要犯规时在犯规地点对阵争球。争球双方各有8个队员参与，各方出3名前锋队员，并肩各站成一横排，面对面躬身互相顶肩，中间形成一条通道，其他队员分别站在后面，后排队员用肩顶住前锋队员的臀部，组成3、2、3或3、4、1阵形。然后，由犯规队的对方队员在对阵一侧1码外，用双手低手将球抛入通道，不得有利于本队。当球抛入通道时，前排的3对前锋队员互相抗挤，争相踢球给本方前卫或后卫队员，前卫和后卫队员必须等候前锋将球踢回后，方可移动</p></blockquote>\n<p><img class=\"\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/259a008f1edf1a34a14e98f4e10e65dc.jpg\" alt=\"15128143307299\" width=\"463\" height=\"261\"></p>\n<p>在敏捷开发领域，SCRUM是一种迭代式增量软件开发过程，它包括了一些预定义的角色：</p>\n<ul>\n<li><strong>产品负责人 Product Owner</strong></li>\n</ul>\n<p><img class=\"alignnone\" src=\"http://wx2.sinaimg.cn/mw690/7cc829d3gy1fmg66db5hvj207i05w76o.jpg\" width=\"270\" height=\"212\"></p>\n<p>产品负责人负责维护订单</p>\n<ul>\n<li><strong>Scrum主管 Scrum Master </strong></li>\n</ul>\n<p><img class=\"alignnone\" src=\"http://wx4.sinaimg.cn/mw690/7cc829d3gy1fmg66dufcfj207s05kgo6.jpg\" width=\"280\" height=\"200\"></p>\n<p>SCURM Master 对整个SCRUM 过程负责，不惜一切代价（<em>AT ANY COST</em>），保证团队的工作时间和计划。</p>\n<ul>\n<li><strong>开发团队 Team </strong></li>\n</ul>\n<p>在 SCRUM 过程中，开发团队通常会进行冲刺 （Sprint），一个冲刺周期的长度通常是2-4周。</p>\n<p><img class=\"alignnone\" src=\"http://wx2.sinaimg.cn/mw690/7cc829d3gy1fmg66e9phnj205x03qabg.jpg\" width=\"213\" height=\"134\"></p>\n<p>在这个冲刺过程中，开发小组专注于完成一组订单项的开发。比如：制造一个发动机 <img class=\"alignnone\" src=\"http://wx1.sinaimg.cn/mw690/7cc829d3gy1fmg66esfh8j209c05u77y.jpg\" width=\"336\" height=\"210\"></p>\n<p>对于KANBAN 和 SCRUM，有人说 KANBAN vs SCRUM，也有人说 KANBAN+SCRUM，究竟谁是谁非，我看只有适合自己团队的才是最好的，毕竟方法和流程是为业务服务的。就这篇漫画来看，SCRUM + KANBAN 是两个避免混乱的好方法。</p>\n<p><img class=\"alignnone\" src=\"http://wx2.sinaimg.cn/mw690/7cc829d3gy1fmg66f9q2mj205o08a40g.jpg\" width=\"204\" height=\"298\"></p>\n<p><em>来来来，兄弟们，我们来开一个关于减少站会的站会~~</em></p>\n<h2>精益软件开发</h2>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/12/6dd2911f0156068e997abd790e0f7493.jpg\" alt=\"15128322280368\"></p>\n<p>第二次世界大战结束后，丰田公司前社长丰田英二曾经去美国汽车城底特律对福特生产线进行了考察，尽管福特高效的大规模生产线给他造成了很大的冲击，丰田英二还是非常理智的认识到了当时日本制造业所面临的困难。经济萧条，资源短缺，小批量差异化的需求使他不能盲目的引进这种大规模的生产方式，随后丰田公司发明并实践了一系列的管理和生产方法，这些方法在后来被统称为精益生产和管理方式（lean）</p>\n<p>精益生产的思想， 简单来说就是Just In Time（JIT），也就是说，只在必要的时候，按照需求的量，仅生产必要的产品，杜绝浪费。</p>\n<p><img class=\"alignnone\" src=\"http://wx4.sinaimg.cn/mw690/7cc829d3gy1fmg66ftyjjj206b03r3zb.jpg\" width=\"227\" height=\"135\"></p>\n<blockquote><p>Eric Ries曾在《精益创业实战》中提出MVP（minimum viable product）概念，意即“最简可行产品”——用最快、最简明的方式建立一个可用的产品原型，这个原型要表达出你产品最终想要的效果，然后通过迭代来完善细节。</p></blockquote>\n<p>精益软件开发不再像传统的软件开发一样，耗时几年才向客户交付完整的软件。取而代之的是，优先建立一个最简可用的原型产品投放市场或交付到客户手中。</p>\n<p><img class=\"alignnone\" src=\"http://wx4.sinaimg.cn/mw690/7cc829d3gy1fmg66geocdj209h0biq8i.jpg\" width=\"341\" height=\"414\"></p>\n<p>一辆最简可用的汽车是什么样子的呢？不就是四个轮子、一个方向盘、一个座椅然后一起装在底盘上么。能开、能停、能转弯不就是汽车嘛。让客户先享受到产品带来的收益是最重要的。</p>\n<p><img src=\"https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1512898589423&amp;di=158b96821c3e271a06d229192b48d81f&amp;imgtype=0&amp;src=http%3A%2F%2Fa1.att.hudong.com%2F05%2F95%2F01300000432220148643955825350_s.jpg\" alt=\"\"></p>\n<p><strong>BUT!!!</strong></p>\n<p>你看，这里还有一位失落的大叔</p>\n<p><img class=\"alignnone\" src=\"http://wx2.sinaimg.cn/mw690/7cc829d3gy1fmg66h14y4j20b706877s.jpg\" width=\"403\" height=\"224\"></p>\n<p>尽管MPV 的概念听上去是如此的简单，可是实施起来却没有那么容易。</p>\n<blockquote><p>因为在设计产品原型的过程中，很多设计师是这么做的：把他们认为的产品应当具备的功能罗列出来，然后一一排除，排定优先级，决定哪个功能要在最初的版本中出现，而哪个可以靠后一些。但设计师们往往无法真的只把最必要的功能留在初级版本中——因为诱惑太多。设计师们总希望把很cool、很有惊喜的小细节带给用户来博取赞叹，但从全局来看，其实把某些功能刻意强加进产品，是会削弱产品整体流畅性的。Mr Jamie曾在其博客中把这种心理表现称作<strong>“艺术家心结”</strong>。</p></blockquote>\n<p>所有不必的东西（ALL NON-ESSENTIALS ARE THROWN OUT）都不能应用到当前的最小可用产品。你说，艺术家们得多伤心啊（愁的胡子都长一脸了）</p>\n<p>此外，尽早交付产品给客户或部署到生产环境，也促进了 DevOps，持续集成（CI），生产环境测试（testing in production）等实践的发展。尽早交付产品，尽早从用户获取反馈，不论是好的还是坏的，促使问题尽早暴露，尽早修复，持续集成，持续改进。</p>\n<p><img class=\"alignnone\" src=\"http://wx3.sinaimg.cn/mw690/7cc829d3gy1fmg68pf1nbj209208wgps.jpg\" width=\"326\" height=\"320\"></p>\n<p>眼尖的童鞋，估计早就看到了桌子上有一只程序员的好朋友 —— 小黄鸭。你还不知道小黄鸭？那你该看看这篇文章：《<a href=\"http://blog.jobbole.com/85719/\" target=\"_blank\">小黄鸭调试法，每个程序员都要知道的</a>》。</p>\n<p><img class=\"alignnone\" src=\"http://wx4.sinaimg.cn/mw690/7cc829d3gy1fmg663ygd2j206n047ta2.jpg\" width=\"239\" height=\"151\"></p>\n<h2>结束语</h2>\n<p>实际工作中的软件开发和管理模式，往往并不能纯粹的归类于以上某种类型。即使是相同的开发模型，在不同的团队中也往往会根据实际情况进行变化和改进，留言告诉我们你所在的公司是如何进行软件开发的吧~</p>\n<p>此外，如果你对我的解析有不同的看法，或者你在图中看出了新的内涵，也欢迎在评论中互动！</p>\n<h3>扩展阅读</h3>\n<ul>\n<li>[1] <a href=\"http://www.agileweboperations.com/scrum-vs-kanban\">kanban vs scrum vs agile</a></li>\n<li>[2] <a href=\"http://www.jianshu.com/p/e44b1038c9cf\">Scrum vs. 看板，还是Scrum + 看板？ </a></li>\n<li>[3] <a href=\"https://msdn.microsoft.com/zh-cn/library/hh533841(v=vs.110).aspx\">精益软件开发</a></li>\n<li>[4] <a href=\"https://www.ibm.com/developerworks/cn/rational/leaner-software-development-with-the-aid-of-collaborative-lifecycle-management/\">使用 DevOps 进行精益软件开发</a></li>\n<li>[5]<a href=\"https://baike.baidu.com/item/%E4%B8%B0%E7%94%B0%E5%BC%8F%E7%94%9F%E4%BA%A7%E7%AE%A1%E7%90%86/511862?fr=aladdin&amp;fromid=10166317&amp;fromtitle=%E4%B8%B0%E7%94%B0%E7%94%9F%E4%BA%A7%E7%B3%BB%E7%BB%9F\"> 丰田生产系统</a></li>\n</ul>\n\r\n        \r\n            <blockquote class=\"rewards\">\n        <p><strong>打赏支持我写出更多好文章，谢谢！</strong></p>\n        <a href=\"#rewardbox\" id=\"rewards-button\" class=\"fancybox\"><span class=\"btn-bluet-blue href-style\"><i class=\"fa fa-jpy\"></i> 打赏作者</span></a>\n    </blockquote>\n\n    <div id=\"rewardbox\">\n        <h4>打赏支持我写出更多好文章，谢谢！</h4>\n                <p>任选一种支付方式</p>\n                <p>\n                        <img src=\"http://jbcdn2.b0.upaiyun.com/2016/05/d3704dca07a3c6ce19c14a9762a0d776.jpg\">\n            \n                            <img src=\"http://www.jobbole.com/wp-content/uploads/2016/03/d8aa159efcd108a908cd3d6ab74b8f5f.jpg\">\n                    </p>\n    </div>\n\n    \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113230\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113230votetotal\">7</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113230\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 4 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 2 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/hanxiaomax\">艾凌风</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/hanxiaomax\">\r\n\t\t\t<img src=\"http://www.jobbole.com/wp-content/uploads/2015/10/bb74ca97c7e8b5a21a24f0b5bbc519c3.jpg\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            初入职场小码农;翻译组的勤务员;C/Python/在线教育/英文翻译        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/hanxiaomax\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/hanxiaomax/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/hanxiaomax/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 88</a> · <a title=\"我的网站\" target=\"_blank\" href=\"http://hanxiaomax.github.io\"><i class=\"fa fa-link\"></i></a> <a title=\"微博主页\" target=\"_blank\" href=\"http://www.weibo.com/smilingly1989\"><i class=\"fa fa-weibo\"></i></a> <a title=\"GitHub主页\" target=\"_blank\" href=\"https://github.com/hanxiaomax\"><i class=\"fa fa-github\"></i></a>         </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "url": "http://blog.jobbole.com/113230/", "comment_nums": 2, "praise_nums": 7, "front_image_url": ["http://wx3.sinaimg.cn/mw690/7cc829d3gy1fmg6692mmwj20ig0bs4am.jpg"]},{"title": "ls 命令的 20 个实用范例", "url_object_id": "bae67049a64d1e6081b8faffd0387ad3", "create_date": "2017/12/10", "tags": "IT技术,Linux", "fav_nums": 0, "front_image_path": "full/82d53cc686d85d92c9f78d84551efefe19f368cb.jpg", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://linoxide.com/linux-command/linux-ls-command/\">Pungki Arianto</a>   译文出处：<a target=\"_blank\" href=\"https://linux.cn/article-2535-1.html\">Linux中国/geekpi</a>   </div><p>Linux中一个基本命令是ls。没有这个命令，我们会在浏览目录条目时会遇到困难。这个命令必须被每个学习Linux的人知道。</p>\n<h3>ls是什么</h3>\n<p>ls命令用于列出文件和目录。默认上，他会列出当前目录的内容。带上参数后，我们可以用ls做更多的事情。这里是一些在日常操作中使用到的ls用法的示例。</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/84af875603b875a6afc4d722e5728a50.png\" alt=\"\" width=\"256\" height=\"256\"></p>\n<h4>1. 不带参数运行ls</h4>\n<p>不带参数运行ls会只列出文件或者目录。看不到其他信息输出（译注：有时候你发现无参数的ls命令和这里描述的不同，那有可能是你的ls命令实际上带参数的ls别名）。</p>\n<p>$ ls</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/044cd236033b33f2d14505af2e67e3cf.png\" alt=\"\"></p>\n<h4>2. 使用长清单模式</h4>\n<p>使用-l字符(小写L字符),会显示当前目录内容的长列表。在接下来的例子中，我们会结合-l参数(这个参数经常使用)来得到更好的结果。</p>\n<p>$ ls -l</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/edf00b08735d1fe0fda00f88125da855.png\" alt=\"\"></p>\n<p>这里是如何读取输出 :</p>\n<ul>\n<li><strong>第1列</strong>\n<ul>\n<li>第一个字母<strong>d</strong>意味着内容是目录或者文件。在上面的截图中，Desktop、 Documents、 Downloads 和 lynis-1.3.8是目录。如果是’-‘(<strong>减号</strong>)，这意味着它的内容是文件。当它是l(<strong>小写l字符</strong>)，意味这内容是链接文件。</li>\n<li>下面的9个字符是关于文件权限。<strong>前3个rwx</strong>字符是文件的拥有者的权限，<strong>第二组3rwx</strong>是文件的所有组的权限，<strong>最后的rwx</strong>是对其他人访问文件的权限。</li>\n</ul>\n</li>\n<li><strong>第2列</strong> 这行告诉我们有多少链接指向这个文件。</li>\n<li><strong>第3列</strong> 这行告诉我们谁是这个文件/文件夹的所有者。</li>\n<li><strong>第4列</strong> 这行告诉我们谁是这个文件/文件夹的所有组。</li>\n<li><strong>第5列</strong> 这行告诉我们这个文件/文件夹的以字节为单位的大小。 目录的大小总是4096字节。</li>\n<li><strong>第6列</strong> 这告诉我们文件最后的修改时间。</li>\n<li><strong>第7列</strong> 这告诉我们文件名或者目录名。</li>\n</ul>\n<h4>3. 显示文件大小</h4>\n<p>以字节为单位看大小可能会不方便。6.5M读起来比6727680字节更简单。要这么做，我们可以使用-h与<strong>-l</strong>结合的参数。<strong>-h参数意味着便于人识别</strong>。</p>\n<p>$ ls -lh</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/6298085aaf7eb7f85d3c93a1c6309beb.png\" alt=\"\"></p>\n<p>另外一个可以这么做的参数是<strong>–si</strong>。这个参数和-h参数类似，但是<strong>-si以1000为单位，而-h以1024为单位</strong>。</p>\n<p>$ ls -si</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/f7a3f1cbf0703a87fd954ace24965c1a.png\" alt=\"\"></p>\n<h4>4. 排序文件大小</h4>\n<p>在我们可以显示文件大小之后，我们希望以文件大小排序。我们可以使用-S参数来这么做。这列表会从大到校排序。</p>\n<p>$ ls -lhS</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/e1b5eb2704dd97fc314e67e4253d66c0.png\" alt=\"\"></p>\n<h4>5. 测量大小</h4>\n<p>ls可以通过使用<strong>-block-size=SIZE</strong>改单位大小。这里的SIZE是：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3448c25fc04642864125\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nK = Kilobyte\r\nM = Megabyte\r\nG = Gigabyte\r\nT = Terabyte\r\nP = Petabyte\r\nE = Exabyte\r\nZ = Zettabyte\r\nY = Yottabyte</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3448c25fc04642864125-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448c25fc04642864125-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3448c25fc04642864125-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448c25fc04642864125-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a3448c25fc04642864125-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448c25fc04642864125-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a3448c25fc04642864125-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448c25fc04642864125-8\">8</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3448c25fc04642864125-1\"><span class=\"crayon-v\">K</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Kilobyte</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448c25fc04642864125-2\"><span class=\"crayon-v\">M</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Megabyte</span></div><div class=\"crayon-line\" id=\"crayon-5a3448c25fc04642864125-3\"><span class=\"crayon-v\">G</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Gigabyte</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448c25fc04642864125-4\"><span class=\"crayon-v\">T</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Terabyte</span></div><div class=\"crayon-line\" id=\"crayon-5a3448c25fc04642864125-5\"><span class=\"crayon-v\">P</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Petabyte</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448c25fc04642864125-6\"><span class=\"crayon-v\">E</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Exabyte</span></div><div class=\"crayon-line\" id=\"crayon-5a3448c25fc04642864125-7\"><span class=\"crayon-v\">Z</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Zettabyte</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448c25fc04642864125-8\"><span class=\"crayon-v\">Y</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Yottabyte</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0011 seconds] -->\r\n<p>比如，我们希望使用MB作为单位大小。所以语法就会像这样:</p>\n<p>$ ls -l –block-size=M</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/ca5c2485695e0ff80466c1519c88c585.png\" alt=\"\"></p>\n<h4>6. 显示隐藏文件</h4>\n<p>在Linux中，以”.”(<strong>点号</strong>)开头的文件是隐藏文件。为了在ls命令中显示它，我们可以使用<strong>-a</strong>选项。</p>\n<p>$ ls -a</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/cfa7668f6caad7e44083bc934d667078.png\" alt=\"\"></p>\n<h4>7. 只列出目录条目</h4>\n<p>如果我们希望只列出目录，我们可以使用<strong>-d</strong>选项。</p>\n<p>$ ls -d */</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/88da387d50de04d574ae22943aa4d6d7.png\" alt=\"\"></p>\n<h4>8. 不打印所有者信息</h4>\n<p>要这么做，我们使用<strong>-g</strong>选项。</p>\n<p>$ ls -g</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/28da167a529bbe78d2aa9dc057887222.png\" alt=\"\"></p>\n<h4>9. 不打印组信息</h4>\n<p>-g隐藏了拥有者信息，<strong>—G</strong>会隐藏组信息。</p>\n<p>$ ls -lG</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/22d28b1330d26d2ce8f42d459fd4d97c.png\" alt=\"\"></p>\n<h4>10. 打印UID和GID</h4>\n<p>如果你想以数字方式列出项的所有者和所有组（即UID和GID），我们可以带<strong>-n</strong>选项使用ls命令。这里是个例子。</p>\n<p>$ ls -n</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/e23811f99ade6c4c4555f8092a4ecafa.png\" alt=\"\"></p>\n<p>从上面的例子中，我们知道<strong>用户pungki的UID</strong>是100，<strong>GID是1000</strong>，而<strong>root组的GID是0</strong>。</p>\n<h4>11. 不带颜色打印</h4>\n<p>一些Linux发行版已经对ls命令启用彩色。这会使ls以各种颜色打印列表。如果你不想要这样，你可以使用 <strong>–color=never</strong> 参数。</p>\n<p>$ ls –color=never</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/848f74362d015020fe7b695fb61e42c9.png\" alt=\"\"></p>\n<h4>12. 打印每个文件的索引号</h4>\n<p>为了打印索引或者大家俗称的inode号，我们可以使用-i选项。索引号会显示在第一列。</p>\n<p>$ ls -li</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/e0fecbc4db2799138efd4ef3c1742284.png\" alt=\"\"></p>\n<h4>13. 增加 / (斜线) 标记目录</h4>\n<p>要这么做，使用<strong>-p选项</strong>。</p>\n<p>$ ls -p</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/bdae6c864fb569e333c06a5c0d0b3f46.png\" alt=\"\"></p>\n<h4>14. 排序时反转顺序</h4>\n<p>你或许需要在列出条目时反转顺序。要这么做，你可以使用<strong>-r</strong>选项。</p>\n<p>$ ls -r</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/a63ce5ef9ed4d818faa1f2ebc3b5d13a.png\" alt=\"\"></p>\n<h4>15. 递归列出子目录</h4>\n<p>带<strong>-R</strong>参数后，你可以列出包含它子目录的目录。</p>\n<p>$ ls -R</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/3816d79aa013f2856ed1c49ee1627b17.png\" alt=\"\"></p>\n<h4>16. 扩展名排序</h4>\n<p>你可以使用-X参数或者–sort=extension来通过扩展名来排序（译注：这样对于筛选不同类型的文件很有用）。</p>\n<p>$ ls -lX</p>\n<p><strong>或</strong></p>\n<p>$ ls –sort=extension<strong><br>\n</strong></p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/4b1615d90fcb7e917808266d30980096.png\" alt=\"\"></p>\n<h4>17. 通过修改时间列出</h4>\n<p>使用-t选项会按修改时间排序，新的文件在前。</p>\n<p>$ ls -lt</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/7a10fe59414ec59d08d68322dc137f36.png\" alt=\"\"></p>\n<h4>18. 列出你的主目录</h4>\n<p>要列出你的主目录，你可以用”~”(<strong>波浪号</strong>)来代表它。这样你就不必输入完整的目录名。让我们假设家文件名为<strong>/home/pungki</strong>，那么<strong>波浪号</strong>就对/home/pungki有意义了。</p>\n<p>$ ls ~</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/5943c4c11a272abb12609d07dc2ae361.png\" alt=\"\"></p>\n<h4>19. 列出父目录</h4>\n<p>无论你在那个目录，你可以列出父目录而不必输入完整路径。这是个例子。</p>\n<p>$ ls ../</p>\n<p>这回列出<strong>1</strong>层之上的目录内容。</p>\n<p>$ ls ../../</p>\n<p>这回列出<strong>2</strong>层之上的目录内容（译注：可不支持“…”来代表2层之上）。</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/e0cedec01301971b3bdce2b4c4adc812.png\" alt=\"\"></p>\n<h4>20. 打印ls命令版本</h4>\n<p>使用–version参数打印它。</p>\n<p>$ ls –version</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/1c7dfc9fd3544b5825832d006d295ec4.png\" alt=\"\"></p>\n<h3>总结</h3>\n<p>这些是在日常操作中会使用到的参数。当然你总可以输入<strong>man ls</strong> 或者 <strong>ls –help</strong> 来查询ls的手册页</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113277\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113277votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113277\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "url": "http://blog.jobbole.com/113277/", "comment_nums": 0, "praise_nums": 1, "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2017/12/84af875603b875a6afc4d722e5728a50.png"]},{"title": "如何在 Linux 系统中通过用户组来管理用户", "url_object_id": "ecb07428446047245a1f32f8ff966176", "create_date": "2017/12/06", "tags": "IT技术,Linux", "fav_nums": 1, "front_image_path": "full/6085acc0af4696f5d49164561c6bc4f9b590fc26.jpg", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://www.linux.com/learn/intro-to-linux/2017/12/how-manage-users-groups-linux\">Jack Wallen</a>   译文出处：<a target=\"_blank\" href=\"https://linux.cn/article-9114-1.html\">Linux中国/imquanquan</a>   </div><blockquote><p>本教程可以了解如何通过用户组和访问控制表（ACL）来管理用户。</p></blockquote>\n<p>当你需要管理一台容纳多个用户的 Linux 机器时，比起一些基本的用户管理工具所提供的方法，有时候你需要对这些用户采取更多的用户权限管理方式。特别是当你要管理某些用户的权限时，这个想法尤为重要。比如说，你有一个目录，某个用户组中的用户可以通过读和写的权限访问这个目录，而其他用户组中的用户对这个目录只有读的权限。在 Linux 中，这是完全可以实现的。但前提是你必须先了解如何通过用户组和访问控制表（ACL）来管理用户。</p>\n<p>我们将从简单的用户开始，逐渐深入到复杂的访问控制表（ACL）。你可以在你所选择的 Linux 发行版完成你所需要做的一切。本文的重点是用户组，所以不会涉及到关于用户的基础知识。</p>\n<p>为了达到演示的目的，我将假设：</p>\n<p>你需要用下面两个用户名新建两个用户：</p>\n<ul>\n<li>olivia</li>\n<li>nathan</li>\n</ul>\n<p>你需要新建以下两个用户组：</p>\n<ul>\n<li>readers</li>\n<li>editors</li>\n</ul>\n<p>olivia 属于 editors 用户组，而 nathan 属于 readers 用户组。reader 用户组对 <code>/DATA</code> 目录只有读的权限，而 editors 用户组则对 <code>/DATA</code> 目录同时有读和写的权限。当然，这是个非常小的任务，但它会给你基本的信息，你可以扩展这个任务以适应你其他更大的需求。</p>\n<p>我将在 Ubuntu 16.04 Server 平台上进行演示。这些命令都是通用的，唯一不同的是，要是在你的发行版中不使用 <code>sudo</code> 命令，你必须切换到 root 用户来执行这些命令。</p>\n<h3 id=\"toc_1\">创建用户</h3>\n<p>我们需要做的第一件事是为我们的实验创建两个用户。可以用 <code>useradd</code> 命令来创建用户，我们不只是简单地创建一个用户，而需要同时创建用户和属于他们的家目录，然后给他们设置密码。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3448a35e710335994961\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsudo useradd -m olivia\r\nsudo useradd -m nathan\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3448a35e710335994961-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448a35e710335994961-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3448a35e710335994961-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3448a35e710335994961-1\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-v\">useradd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">m</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">olivia</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448a35e710335994961-2\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-v\">useradd</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">m</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">nathan</span></div><div class=\"crayon-line\" id=\"crayon-5a3448a35e710335994961-3\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>我们现在创建了两个用户，如果你看看 <code>/home</code> 目录，你可以发现他们的家目录（因为我们用了 <code>-m</code> 选项，可以在创建用户的同时创建他们的家目录。</p>\n<p>之后，我们可以用以下命令给他们设置密码：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3448a35e71a253948100\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsudo passwd olivia\r\nsudo passwd nathan\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3448a35e71a253948100-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448a35e71a253948100-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3448a35e71a253948100-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3448a35e71a253948100-1\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-e\">passwd </span><span class=\"crayon-e\">olivia</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448a35e71a253948100-2\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-e\">passwd </span><span class=\"crayon-i\">nathan</span></div><div class=\"crayon-line\" id=\"crayon-5a3448a35e71a253948100-3\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>就这样，我们创建了两个用户。</p>\n<h3 id=\"toc_2\">创建用户组并添加用户</h3>\n<p>现在我们将创建 readers 和 editors 用户组，然后给它们添加用户。创建用户组的命令是：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3448a35e71e541130108\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\naddgroup readers\r\naddgroup editors\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3448a35e71e541130108-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448a35e71e541130108-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3448a35e71e541130108-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3448a35e71e541130108-1\"><span class=\"crayon-e\">addgroup </span><span class=\"crayon-e\">readers</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448a35e71e541130108-2\"><span class=\"crayon-e\">addgroup </span><span class=\"crayon-i\">editors</span></div><div class=\"crayon-line\" id=\"crayon-5a3448a35e71e541130108-3\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>（LCTT 译注：当你使用 CentOS 等一些 Linux 发行版时，可能系统没有 <code>addgroup</code> 这个命令，推荐使用 <code>groupadd</code> 命令来替换 <code>addgroup</code> 命令以达到同样的效果）</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/12/a4aeb9d98d79d707090f46b85e6db25b.jpg\" alt=\"groups\"></p>\n<p><em>图一：我们可以使用刚创建的新用户组了。</em></p>\n<p>创建用户组后，我们需要添加我们的用户到这两个用户组。我们用以下命令来将 nathan 用户添加到 readers 用户组：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3448a35e722961231114\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsudo usermod -a -G readers nathan\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3448a35e722961231114-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448a35e722961231114-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3448a35e722961231114-1\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-v\">usermod</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">a</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">G</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">readers </span><span class=\"crayon-i\">nathan</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448a35e722961231114-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>用以下命令将 olivia 添加到 editors 用户组：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3448a35e725071273321\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsudo usermod -a -G editors olivia\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3448a35e725071273321-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448a35e725071273321-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3448a35e725071273321-1\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-v\">usermod</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">a</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">G</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">editors </span><span class=\"crayon-i\">olivia</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448a35e725071273321-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>现在我们可以通过用户组来管理用户了。</p>\n<h3 id=\"toc_3\">给用户组授予目录的权限</h3>\n<p>假设你有个目录 <code>/READERS</code> 且允许 readers 用户组的所有成员访问这个目录。首先，我们执行以下命令来更改目录所属用户组：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3448a35e729042232075\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsudo chown -R :readers /READERS \r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3448a35e729042232075-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448a35e729042232075-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3448a35e729042232075-1\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-v\">chown</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">R</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">readers</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">READERS</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448a35e729042232075-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>接下来，执行以下命令收回目录所属用户组的写入权限：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3448a35e72c417296445\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsudo chmod -R g-w /READERS\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3448a35e72c417296445-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448a35e72c417296445-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3448a35e72c417296445-1\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-v\">chmod</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">R</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">g</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">w</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">READERS</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448a35e72c417296445-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>然后我们执行下面的命令来收回其他用户对这个目录的访问权限（以防止任何不在 readers 组中的用户访问这个目录里的文件）：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3448a35e72f221530262\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsudo chmod -R o-x /READERS\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3448a35e72f221530262-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448a35e72f221530262-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3448a35e72f221530262-1\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-v\">chmod</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">R</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">o</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">READERS</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448a35e72f221530262-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>这时候，只有目录的所有者（root）和用户组 reader 中的用户可以访问 <code>/READES</code> 中的文件。</p>\n<p>假设你有个目录 <code>/EDITORS</code> ，你需要给用户组 editors 里的成员这个目录的读和写的权限。为了达到这个目的，执行下面的这些命令是必要的：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3448a35e733887940268\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsudo chown -R :editors /EDITORS\r\nsudo chmod -R g+w /EDITORS\r\nsudo chmod -R o-x /EDITORS\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3448a35e733887940268-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448a35e733887940268-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3448a35e733887940268-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448a35e733887940268-4\">4</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3448a35e733887940268-1\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-v\">chown</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">R</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">editors</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">EDITORS</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448a35e733887940268-2\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-v\">chmod</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">R</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">g</span><span class=\"crayon-o\">+</span><span class=\"crayon-v\">w</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">EDITORS</span></div><div class=\"crayon-line\" id=\"crayon-5a3448a35e733887940268-3\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-v\">chmod</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">R</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">o</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">x</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">EDITORS</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448a35e733887940268-4\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0009 seconds] -->\r\n<p>此时 editors 用户组的所有成员都可以访问和修改其中的文件。除此之外其他用户（除了 root 之外）无法访问 <code>/EDITORS</code> 中的任何文件。</p>\n<p>使用这个方法的问题在于，你一次只能操作一个组和一个目录而已。这时候访问控制表（ACL）就可以派得上用场了。</p>\n<h3 id=\"toc_4\">使用访问控制表（ACL）</h3>\n<p>现在，让我们把这个问题变得棘手一点。假设你有一个目录 <code>/DATA</code> 并且你想给 readers 用户组的成员读取权限，并同时给 editors 用户组的成员读和写的权限。为此，你必须要用到 <code>setfacl</code> 命令。<code>setfacl</code> 命令可以为文件或文件夹设置一个访问控制表（ACL）。</p>\n<p>这个命令的结构如下：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3448a35e736787183231\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsetfacl OPTION X:NAME:Y /DIRECTORY\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3448a35e736787183231-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448a35e736787183231-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3448a35e736787183231-1\"><span class=\"crayon-e\">setfacl </span><span class=\"crayon-i\">OPTION</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">X</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">NAME</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">Y</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">DIRECTORY</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448a35e736787183231-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>其中 OPTION 是可选选项，X 可以是 <code>u</code>（用户）或者是 <code>g</code> （用户组），NAME 是用户或者用户组的名字，/DIRECTORY 是要用到的目录。我们将使用 <code>-m</code> 选项进行修改。因此，我们给 readers 用户组添加读取权限的命令是：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3448a35e739385414290\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsudo setfacl -m g:readers:rx -R /DATA\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3448a35e739385414290-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448a35e739385414290-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3448a35e739385414290-1\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-v\">setfacl</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">m</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">g</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">readers</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">rx</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">R</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">DATA</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448a35e739385414290-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>现在 readers 用户组里面的每一个用户都可以读取 <code>/DATA</code> 目录里的文件了，但是他们不能修改里面的内容。</p>\n<p>为了给 editors 用户组里面的用户读写权限，我们执行了以下命令：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3448a35e73d409371498\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nsudo setfacl -m g:editors:rwx -R /DATA \r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3448a35e73d409371498-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3448a35e73d409371498-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3448a35e73d409371498-1\"><span class=\"crayon-e\">sudo </span><span class=\"crayon-v\">setfacl</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">m</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">g</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">editors</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">rwx</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">R</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">DATA</span><span class=\"crayon-h\"> </span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3448a35e73d409371498-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p>上述命令将赋予 editors 用户组中的任何成员读取权限，同时保留 readers 用户组的只读权限。</p>\n<h3 id=\"toc_5\">更多的权限控制</h3>\n<p>使用访问控制表（ACL），你可以实现你所需的权限控制。你可以添加用户到用户组，并且灵活地控制这些用户组对每个目录的权限以达到你的需求。如果想了解上述工具的更多信息，可以执行下列的命令：</p>\n<ul>\n<li><code>man usradd</code></li>\n<li><code>man addgroup</code></li>\n<li><code>man usermod</code></li>\n<li><code>man sefacl</code></li>\n<li><code>man chown</code></li>\n<li><code>man chmod</code></li>\n</ul>\n<p> </p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113200\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113200votetotal\">2</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113200\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "url": "http://blog.jobbole.com/113200/", "comment_nums": 0, "praise_nums": 2, "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2014/04/e260ae4f5d153b25be87819b25ff0577.jpg"]},{"title": "提升网站访问速度的 SQL 查询优化技巧", "url_object_id": "1d272b3f5e772e150256c80369d176bd", "create_date": "2017/12/09", "tags": "IT技术,数据库", "fav_nums": 1, "front_image_path": "full/30c9c89359420ef7de32e6e32e9620024a38972b.jpg", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://deliciousbrains.com/sql-query-optimization/\">Delicious Brains</a>   译文出处：<a target=\"_blank\" href=\"https://www.oschina.net/translate/sql-query-optimization\">开源中国</a>   </div><p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/d58689380279e0a450fddedcbc06ffc3.jpg\"></p>\n<p>你一定知道，一个快速访问的网站能让用户喜欢，可以帮助网站从Google 上提高排名，可以帮助网站增加转化率。如果你看过网站性能优化方面的文章，例如<a href=\"https://deliciousbrains.com/hosting-wordpress-setup-secure-virtual-server/\" rel=\"nofollow\">设置服务器的最佳实现</a>、到<a href=\"https://deliciousbrains.com/finding-bottlenecks-wordpress-code/\" rel=\"nofollow\">干掉慢速代码</a>以及 <a href=\"https://deliciousbrains.com/wp-offload-s3/doc/why-use-a-cdn/\" rel=\"nofollow\">使用CDN 加载图片</a>，就认为你的 WordPress 网站已经足够快了。但是事实果真如此吗？</p>\n<p>使用动态数据库驱动的网站，例如WordPress，你的网站可能依然有一个问题亟待解决：数据库查询拖慢了网站访问速度。</p>\n<p>在这篇文章中，我将介绍如何识别导致性能出现问题的查询，如何找出它们的问题所在，以及快速修复这些问题和其他加快查询速度的方法。我会把门户网站 deliciousbrains.com 出现的拖慢查询速度的情况作为实际的案例。</p>\n<p>定位</p>\n<p>处理慢SQL查询的第一步是找到慢查询。Ashley已经在之前的<a href=\"https://deliciousbrains.com/finding-bottlenecks-wordpress-code/#query-monitor\" target=\"_blank\" rel=\"nofollow\">博客</a>里面赞扬了调试插件<a href=\"https://wordpress.org/plugins/query-monitor/\" target=\"_blank\" rel=\"nofollow\">Query Monitor</a>，而且这个插件的数据库查询特性使其成为定位慢SQL查询的宝贵工具。该插件会报告所有页面请求过程中的数据库请求，并且可以通过调用这些查询代码或者原件(插件，主题，WordPress核)过滤这些查询，高亮重复查询和慢查询。</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/fca1e622eea8f23e013e4680c03d0df1.png\"></p>\n<p>要是不愿意在生产安环境装调试插件(性能开销原因)，也可以打开<a href=\"https://dev.mysql.com/doc/refman/5.7/en/slow-query-log.html\" target=\"_blank\" rel=\"nofollow\">MySQL Slow Query Log</a>，这样在特定时间执行的所有查询都会被记录下来。这种方法配置和设置存放查询位置相对简单。由于这是一个服务级别的调整，性能影响会小于使用调试插件，但当不用的时候也应该关闭。</p>\n<h1>理解</h1>\n<p>一旦你找到了一个你要花很大代价找到的查询，那么接下来就是尝试去理解它并找到是什么让查询变慢。最近，在我们开发我们网站的时候，我们找到了一个要执行8秒的查询。</p>\n<p>我们使用WooCommerce和定制版的WooCommerce软件插件来运行我们的插件商店。此查询的目的是获取那些我们知道客户号的客户的所有订阅。WooCommerce是一个稍微复杂的数据模型，即使订单以自定义的类型存储，用户的ID（商店为每一个用户创建的WordPress）也没有存储在post_author，而是作为后期数据的一部分。订阅软件插件给自义定表创建了一对链接。让我们深入了解查询的更多信息。</p>\n<h1>MySQL是你的朋友</h1>\n<p>MySQL有一个很方便的语句<a href=\"https://dev.mysql.com/doc/refman/5.7/en/describe.html\" target=\"_blank\" rel=\"nofollow\">DESCRIBE</a>，它可以输出表结构的信息，比如字段名，数据类型等等。所以，当你执行DESCRIBE wp_postmeta;你将会看到如下的结果：</p>\n<table>\n<tbody>\n<tr>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n<tbody>\n<tr>\n<th>Field</th>\n<th>Type</th>\n<th>Null</th>\n<th>Key</th>\n<th>Default</th>\n<th>Extra</th>\n</tr>\n</tbody>\n<tbody>\n<tr>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody>\n<tbody>\n<tr>\n<td>meta_id</td>\n<td>bigint(20) unsigned</td>\n<td>NO</td>\n<td>PRI</td>\n<td>NULL</td>\n<td>auto_increment</td>\n</tr>\n<tr>\n<td>post_id</td>\n<td>bigint(20) unsigned</td>\n<td>NO</td>\n<td>MUL</td>\n<td>0</td>\n<td></td>\n</tr>\n<tr>\n<td>meta_key</td>\n<td>varchar(255)</td>\n<td>YES</td>\n<td>MUL</td>\n<td>NULL</td>\n<td></td>\n</tr>\n<tr>\n<td>meta_value</td>\n<td>longtext</td>\n<td>YES</td>\n<td></td>\n<td>NULL</td>\n<td></td>\n</tr>\n</tbody>\n</table>\n<p>你可能已经知道了这个语句。但是你知道DESCRIBE语句可以放在SELECT, INSERT, UPDATE, REPLACE 和 DELETE语句前边使用吗？更为人们所熟知的是他的同义词 <a href=\"https://dev.mysql.com/doc/refman/5.7/en/explain.html\" target=\"_blank\" rel=\"nofollow\">EXPLAIN</a> ，并将提供有关该语句如何执行的详细信息。</p>\n<p>这是我们查询到的结果：</p>\n<table>\n<tbody>\n<tr>\n<th>id</th>\n<th>select_type</th>\n<th>table</th>\n<th>type</th>\n<th>possible_keys</th>\n<th>key</th>\n<th>key_len</th>\n<th>ref</th>\n<th>rows</th>\n<th>Extra</th>\n</tr>\n</tbody>\n<tbody>\n<tr>\n<td>1</td>\n<td>SIMPLE</td>\n<td>pm2</td>\n<td>ref</td>\n<td>meta_key</td>\n<td>meta_key</td>\n<td>576</td>\n<td>const</td>\n<td>28</td>\n<td>Using where; Using temporary; Using filesort</td>\n</tr>\n<tr>\n<td>1</td>\n<td>SIMPLE</td>\n<td>pm</td>\n<td>ref</td>\n<td>post_id,meta_key</td>\n<td>meta_key</td>\n<td>576</td>\n<td>const</td>\n<td>37456</td>\n<td>Using where</td>\n</tr>\n<tr>\n<td>1</td>\n<td>SIMPLE</td>\n<td>p</td>\n<td>eq_ref</td>\n<td>PRIMARY,type_status_date</td>\n<td>PRIMARY</td>\n<td>8</td>\n<td>deliciousbrainsdev.pm.post_id</td>\n<td>1</td>\n<td>Using where</td>\n</tr>\n<tr>\n<td>1</td>\n<td>SIMPLE</td>\n<td>l</td>\n<td>ref</td>\n<td>PRIMARY,order_id</td>\n<td>order_id</td>\n<td>8</td>\n<td>deliciousbrainsdev.pm.post_id</td>\n<td>1</td>\n<td>Using index condition; Using where</td>\n</tr>\n<tr>\n<td>1</td>\n<td>SIMPLE</td>\n<td>s</td>\n<td>eq_ref</td>\n<td>PRIMARY</td>\n<td>PRIMARY</td>\n<td>8</td>\n<td>deliciousbrainsdev.l.key_id</td>\n<td>1</td>\n<td>NULL</td>\n</tr>\n</tbody>\n</table>\n<p>乍一看，这很难解释。幸运的是，人们通过SitePoint总结了一个<a href=\"https://www.sitepoint.com/using-explain-to-write-better-mysql-queries/\" target=\"_blank\" rel=\"nofollow\">理解语句的全面指南</a>。</p>\n<p>最重要的字段是type，它描述了一张表是怎么构成的。如果你想看全部的内容，那就意味着MySQL要从内存读取整张表，增加I/O的速度并在CPU上加载。这种被称为“全表浏览”—稍后将对此进行详细介绍。</p>\n<p>rows字段也是一个好的标识，标识着MySQL将要不得不做的事情，它显示了结果中查找了多少行。</p>\n<p>Explain也给了我们很多可以优化的信息。例如，pm2表（(wp_postmeta），告诉我们是Using filesort，因为我们使用了 ORDER BY语句对结果进行了排序。如果我们要对查询结果进行分组，这将会给执行增加开销。</p>\n<h3>可视化研究</h3>\n<p>对于这种类型的研究，<a href=\"https://www.mysql.com/products/workbench/\" target=\"_blank\" rel=\"nofollow\">MySQL Workbench</a>是另外一个方便，免费的工具。将数据库用MySQL5.6及其以上的版本打开，EXPLAIN的结果可以用JSON格式输出，同时MySQL Workbench将JSON转换成可视化执行语句：</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/12/6775c1e9f8647de59507d737a09bb4b4.png\"></p>\n<p>它自动将查询的问题用颜色着重表示提醒用户去注意。我们可以马上看到，连接wp_woocommerce_software_licences（别名l）的表有严重的问题。</p>\n<h3>解决</h3>\n<p>你<a href=\"https://dev.mysql.com/doc/refman/5.7/en/table-scan-avoidance.html\" target=\"_blank\" rel=\"nofollow\">应该避免</a>这种全部表浏览的查询，因为他使用非索引字段order_id去连接wp_woocommerce_software_licences表和wp_posts表。这对于查询慢是常见的问题，而且也是比较容易解决的问题。</p>\n<h3>索引</h3>\n<p>order_id在表中是一个相当重要的标志性数据，如果想像这种方式查询，我们需要在列上建立一个<a href=\"https://dev.mysql.com/doc/refman/5.7/en/mysql-indexes.html\" target=\"_blank\" rel=\"nofollow\">索引</a>，除此之外，MySQL将逐字扫描表的每一行，直到找到我们想要的行为止。让我们添加一个索引并看看它是怎么样工作的：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3489db8dba0727806328\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nCREATE INDEX order_id ON wp_woocommerce_software_licences(order_id)</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3489db8dba0727806328-1\">1</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3489db8dba0727806328-1\"><span class=\"crayon-i\">CREATE</span> <span class=\"crayon-i\">INDEX</span> <span class=\"crayon-v\">order</span><span class=\"crayon-sy\">_</span>id <span class=\"crayon-i\">ON</span> <span class=\"crayon-e\">wp_woocommerce_software_licences</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">order_id</span><span class=\"crayon-sy\">)</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/12/1f0eaebba78bc7b76b03d765fdeed020.png\"></p>\n<p>哇，干的漂亮！我们成功的添加了索引并将查询的时间缩短了5s.</p>\n<h3>了解你的查询语句</h3>\n<p>检查下查询语句——看看每一个join，每一个子查询。它们做了它们不该做的事了吗？这里能做什么优化吗？</p>\n<p>这个例子中，我们把licenses 表和posts 表通过order_id 连接起来同时限制post type 为shop_order。这是为了通过保持数据的完整性来保证我们只使用正确的订单记录，但是事实上这在查询中是多余的。我们知道这是一个关于安全的赌注，在posts 表中software license 行是通过order_id 来跟 WooCommerce order 相关联的，这在PHP 插件代码中是强制的。让我们移除join 来看看有什么提升没有：</p>\n<p><img src=\"http://jbcdn2.b0.upaiyun.com/2017/12/447fc98220e9c37b85807de00e336cb6.png\"></p>\n<p>提升并不算很大但现在查询时间低于3 秒了。</p>\n<h3>缓存一切数据</h3>\n<p>如果你的服务器默认情况下没有使用MySQL查询缓存，那么你应该开启缓存。开启缓存意味着MySQL 会把所有的语句和语句执行的结果保存下来，如果随后有一条与缓存中完全相同的语句需要执行，那么MySQL 就会返回缓存的结果。缓存不会过时，因为MySQL 会在表数据更新后刷新缓存。</p>\n<p>查询监视器发现在加载一个页面时我们的查询语句执行了四次，尽管有MySQL查询缓存很好，但是在一个请求中重复读取数据库的数据是应该完全避免的。你的PHP 代码中的静态缓存很简单并且可以很高效的解决这个问题。基本上，首次请求时从数据库中获取查询结果，并将其存储在类的静态属性中，然后后续的查询语句调用将从静态属性中返回结果：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3489db8dbab835074040\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nclass WC_Software_Subscription {\r\n\r\n    protected static $subscriptions = array();\r\n\r\n    public static function get_user_subscriptions( $user_id ) {\r\n        if ( isset( static::$subscriptions[ $user_id ] ) ) {\r\n            return static::$subscriptions[ $user_id ];\r\n        }\r\n\r\n        global $wpdb;\r\n\r\n        $sql = '...';\r\n\r\n        $results = $wpdb-&gt;get_results( $sql, ARRAY_A );\r\n\r\n        static::$subscriptions[ $user_id ] = $results;\r\n\r\n        return $results;\r\n    }\r\n}</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3489db8dbab835074040-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3489db8dbab835074040-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3489db8dbab835074040-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3489db8dbab835074040-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a3489db8dbab835074040-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3489db8dbab835074040-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5a3489db8dbab835074040-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3489db8dbab835074040-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5a3489db8dbab835074040-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3489db8dbab835074040-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5a3489db8dbab835074040-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3489db8dbab835074040-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5a3489db8dbab835074040-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3489db8dbab835074040-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5a3489db8dbab835074040-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3489db8dbab835074040-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5a3489db8dbab835074040-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3489db8dbab835074040-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5a3489db8dbab835074040-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3489db8dbab835074040-20\">20</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3489db8dbab835074040-1\"><span class=\"crayon-t\">class</span> <span class=\"crayon-e\">WC_Software_Subscription</span> <span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3489db8dbab835074040-2\"> </div><div class=\"crayon-line\" id=\"crayon-5a3489db8dbab835074040-3\">    <span class=\"crayon-m\">protected</span> <span class=\"crayon-m\">static</span> <span class=\"crayon-sy\">$</span><span class=\"crayon-i\">subscriptions</span> <span class=\"crayon-o\">=</span> <span class=\"crayon-t\">array</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3489db8dbab835074040-4\"> </div><div class=\"crayon-line\" id=\"crayon-5a3489db8dbab835074040-5\">    <span class=\"crayon-m\">public</span> <span class=\"crayon-m\">static</span> <span class=\"crayon-t\">function</span> <span class=\"crayon-e\">get_user_subscriptions</span><span class=\"crayon-sy\">(</span> <span class=\"crayon-sy\">$</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">_</span>id <span class=\"crayon-sy\">)</span> <span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3489db8dbab835074040-6\">        <span class=\"crayon-st\">if</span> <span class=\"crayon-sy\">(</span> <span class=\"crayon-e\">isset</span><span class=\"crayon-sy\">(</span> <span class=\"crayon-m\">static</span><span class=\"crayon-o\">::</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">subscriptions</span><span class=\"crayon-sy\">[</span> <span class=\"crayon-sy\">$</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">_</span>id <span class=\"crayon-sy\">]</span> <span class=\"crayon-sy\">)</span> <span class=\"crayon-sy\">)</span> <span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5a3489db8dbab835074040-7\">            <span class=\"crayon-st\">return</span> <span class=\"crayon-m\">static</span><span class=\"crayon-o\">::</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">subscriptions</span><span class=\"crayon-sy\">[</span> <span class=\"crayon-sy\">$</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">_</span>id <span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3489db8dbab835074040-8\">        <span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5a3489db8dbab835074040-9\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3489db8dbab835074040-10\">        <span class=\"crayon-m\">global</span> <span class=\"crayon-sy\">$</span><span class=\"crayon-v\">wpdb</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5a3489db8dbab835074040-11\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3489db8dbab835074040-12\">        <span class=\"crayon-sy\">$</span><span class=\"crayon-i\">sql</span> <span class=\"crayon-o\">=</span> <span class=\"crayon-s\">'...'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5a3489db8dbab835074040-13\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3489db8dbab835074040-14\">        <span class=\"crayon-sy\">$</span><span class=\"crayon-i\">results</span> <span class=\"crayon-o\">=</span> <span class=\"crayon-sy\">$</span><span class=\"crayon-v\">wpdb</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">get_results</span><span class=\"crayon-sy\">(</span> <span class=\"crayon-sy\">$</span><span class=\"crayon-v\">sql</span><span class=\"crayon-sy\">,</span> <span class=\"crayon-v\">ARRAY</span><span class=\"crayon-sy\">_</span>A <span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5a3489db8dbab835074040-15\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3489db8dbab835074040-16\">        <span class=\"crayon-m\">static</span><span class=\"crayon-o\">::</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">subscriptions</span><span class=\"crayon-sy\">[</span> <span class=\"crayon-sy\">$</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">_</span>id <span class=\"crayon-sy\">]</span> <span class=\"crayon-o\">=</span> <span class=\"crayon-sy\">$</span><span class=\"crayon-v\">results</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5a3489db8dbab835074040-17\"> </div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3489db8dbab835074040-18\">        <span class=\"crayon-st\">return</span> <span class=\"crayon-sy\">$</span><span class=\"crayon-v\">results</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5a3489db8dbab835074040-19\">    <span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3489db8dbab835074040-20\"><span class=\"crayon-sy\">}</span></div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0026 seconds] -->\r\n<p>缓存有一个生命周期，具体地说是实例化对象有一个生命周期。如果你正在查看跨请求的查询结果，那么你需要实现一个持久对象缓存。然而不管怎样，你的代码应该负责设置缓存，并且当基础数据变更时让缓存失效。</p>\n<h3>跳出箱子外思考</h3>\n<p>不仅仅是调整查询或添加索引，还有其他方法可以加快查询的执行速度。 我们查询的最慢的部分是从客户ID到产品ID再到加入表格所做的工作，我们必须为每个客户做到。我们是不是可以在需要的时候抓取客户的数据？如果是那样，那我们就只需要加入一次。</p>\n<p>您可以通过创建数据表来存储许可数据，以及所有许可用户标识和产品标识符来对数据进行非规范化（反规范化）处理，并针对特定客户进行查询。 您需要使用INSERT / UPDATE / DELETE上的<a href=\"https://dev.mysql.com/doc/refman/5.7/en/create-trigger.html\" target=\"_blank\" rel=\"nofollow\">MySQL触发器</a>来重建表格（不过这要取决于数据来更改的表格），这会显着提高查询数据的性能。</p>\n<p>类似地，如果一些连接在MySQL中减慢了查询速度，那么将查询分解为两个或更多语句并在PHP中单独执行它们可能会更快，然后可以在代码中收集和过滤结果。 Laravel 通过<a href=\"https://laravel.com/docs/5.5/eloquent-relationships#eager-loading\" target=\"_blank\" rel=\"nofollow\">预加载</a>在 Eloquent 中就做了类似的事情。</p>\n<p>如果您有大量数据和许多不同的自定义帖子类型，WordPress可能会在wp_posts表上减慢查询速度。 如果您发现查询的帖子类型较慢，那么可以考虑从自定义帖子类型的存储模型移动到<a href=\"https://deliciousbrains.com/creating-custom-table-php-wordpress/\" target=\"_blank\" rel=\"nofollow\">自定义表格</a>中 – 更多内容将在后面的文章中介绍。</p>\n<h3>结论</h3>\n<p>通过这些查询优化方法，我们设法将查询从8秒降低到2秒，并且将查询次数从4次减少到1次。需要说明的是，这些查询时间是在我们开发环境运行时记录的 ，生产环境速度会更快。</p>\n<p>这对追踪查询缓慢及其修复等问题是一个有用的指南。 优化查询看起来可能像一个可怕的任务，但只要你尝试一下，并取得一些初步的胜利，你就会开始找到错误，并希望做出进一步改善。</p>\n<p>如果你有任何优化查询的建议或你喜欢使用的工具？ 可以在评论中留言，让我们知道。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113222\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113222votetotal\">2</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113222\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 1 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "url": "http://blog.jobbole.com/113222/", "comment_nums": 0, "praise_nums": 2, "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2017/12/d58689380279e0a450fddedcbc06ffc3.jpg"]},{"title": "技术面试中的精英主义", "url_object_id": "37c15e1679dcae4dfdeabd16f1e6f975", "create_date": "2017/12/11", "tags": "职场,技术面试,面试", "fav_nums": 0, "front_image_path": "full/536b64ffdc363d8fbb2e76690b23066591ee2e91.jpg", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/duydls\">duydls</a> 翻译，<a href=\"http://www.jobbole.com/members/buntamarui\">小米云豆粥</a> 校稿。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"http://www.designlimbo.com/elitism-in-technology-interviews/\">Shawn Jackson</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p class=\"p1\" data-incom=\"P3\">【导读】：技术面试有很多比较深入的 CS 问题，对每个面试官来说，他们也都有自己最喜欢提的问题。但是对于招聘及面试，相比于以上那些问题，更重要的是要针对这个岗位需要什么样的人，而不是一味为难求职者，就算想问一些比较难的 CS 问题，也要有提出的理由。</p>\n<p class=\"p1\" data-incom=\"P3\"><img class=\"alignnone\" src=\"http://ww1.sinaimg.cn/mw690/7cc829d3gw1esx16njnxrj21hc140gw4.jpg\" width=\"563\" height=\"423\"></p>\n<p class=\"p1\" data-incom=\"P3\">我已经在 IT 领域工作了相当长时间，有 12 年了。作为一个曾经的求职者和面试官，我对面试有一个客观公平的看法。这种看法来自于个人面试经验，在这些面试中，面试官都高高在上，而且他们都有自己喜欢问的问题。其中我最喜欢的面试题包括：①二叉树排序算法，②编写代码求解一个多项式方程 ③以及编写一个编译器。到目前为止，我所经历的最糟糕的面试来自亚马逊和 Intuit，他们分别问到了二叉树和多项式。</p>\n<p class=\"p2\" data-incom=\"P6\">除此以外，我还喜欢问求职者，你们每天花多长时间在那些事情？90% 的回答都会是‘从不’，或者绝大多数时间。尽管绝大多数公司都不愿意承认，计算机水平面试题是有年龄歧视的。当你离开 CS 项目一段时间却又没有每天温习（就像绝大多数高级业务程序员），你就和这些知识生疏了。计算机面试题可以帮助你找到这样的人：a）在面试前学习过一本算法书 b）刚从大学毕业。也有些人在经历过多年的职业生涯以后还可以完美回答这些问题，但是就我的经验而言，这些人多半是业务一线的开发者。</p>\n<p class=\"p1\" data-incom=\"P8\">这也是我为现在公司的面试流程感到骄傲的原因。我们会给你一个能反映出公司日常工作内容的编程问题”。你可以向我们展示你的能力。然后我们会花大概 45 分钟的时间和你一起预演一遍项目并且提问，这样有助于我们了解你的想法和展示你的思路。</p>\n<p class=\"p1\" data-incom=\"P8\"><img class=\"alignnone\" src=\"http://wx1.sinaimg.cn/mw690/7cc829d3gy1fmcx90uqskj20gr0d475b.jpg\" width=\"551\" height=\"431\"></p>\n<p class=\"p1\" data-incom=\"P10\">如果你恰好没有向我们展示你在编程项目上的技巧，我们会问一些其它正常的技术问题。我们试图保持一个轻松的氛围，我们会问你在某个问题上的技术水平（1 代表新手，10 代表专家），这样一来你就不会被某些你可能不知道答案的问题所打击到。我们的面试流程是完美的么？绝不，我们每周都在试图改善和提高这个流程。</p>\n<p class=\"p1\" data-incom=\"P12\">这就是为什么当我看到这个 <a href=\"https://www.glassdoor.com/Interview/Paylocity-Interview-Questions-E29987.htm?filter.jobTitleExact=Software+Engineer+.NET#InterviewReview_929569\">Glassdoor 上的评论</a>后彻底震惊了。这里面有些抱怨是有效的，比如面试官没有及时告诉应聘者结果和不理睬应聘者是不可以被接受的。我从来没有在任何技术面试后立刻收到面试结果，往往都会有一些延迟，但没有任何人联系求职者并给出反馈意见，这样就不好了。（伯乐在线注：Glassdoor 是国外一家点评雇主的网站）</p>\n<p class=\"p1\" data-incom=\"P14\">但是这个评论启发我意识到精英观念是相对的。作为那个求职者，要回答 JavaScript 的问题看上去有点不合理，他或许是一个后端开发者。作为新一代的只使用 ORM’ 的开发者，他们或许没有任何 SQL 的经验。某些对我们而言简单和无害的问题，对其它人而言也许会很古怪。</p>\n<p class=\"p1\" data-incom=\"P16\">面试题应该是经过仔细思考、有意义并且能体现求职者所申请工作岗位的职能。你不一定非得通过一个很难的计算机问题来考察求职者是如何解决问题的。如果你觉得陷应试者于窘境是一种享受，那你应该把自己从面试工作中解放出来。这并不是说我们不能问我们最喜欢的问题，但是我们要有一个合理的理由问，而不是在求职者离开以后贬损他。</p>\n<p class=\"p1\" data-incom=\"P18\">在你的机构/公司里，每一个部分都需要技术天才么？如果你的答案是 Yes，那你就是在寻找独角兽，也许你应该重新审查你的需求。在我的职业生涯中，曾经与我共事并且真正令我惊喜的开发者们寥寥可数。但他们也不是对公司里所用到的所有技术/系统/语言都超级擅长。因为这个，我喜欢准备不同水平的面试问题，并且我感觉这样做很有效。如果你告诉我你在某一个方面是专家，你最好可以证明这一点。</p>\n<p class=\"p1\" data-incom=\"P20\">个人来讲，我把求职者与公司文化的匹配度和求职者的个性放在首要位置。在那之后是他们学习和适应新事物的能力，再之后是对待工作的激情。面试是一个困难和非完美的过程，没有人会有一个 100% 无懈可击的面试，当我们尝试帮助他们提高的时候，要试着去除精英主义。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113217\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113217votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113217\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i>  收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 3 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/duydls\">duydls</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/duydls\">\r\n\t\t\t<img src=\"http://jbcdn2.b0.upaiyun.com/2015/04/8fbdaaa5ea6d3b49c8c1c825aafeb5d9.png\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            简介还没来得及写 :）        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/duydls\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/duydls/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/duydls/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 10</a>        </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "url": "http://blog.jobbole.com/113217/", "comment_nums": 3, "praise_nums": 1, "front_image_url": ["http://ww1.sinaimg.cn/mw690/7cc829d3gw1esx16njnxrj21hc140gw4.jpg"]},{"title": "分布式、服务化的 ERP 系统架构设计", "url_object_id": "fa24eafc29a7a991a5f4b675e3fe9aab", "create_date": "2017/12/07", "tags": "IT技术,分布式,架构", "fav_nums": 4, "front_image_path": "full/900573f30c0b83190d0af33044be8518edaae066.jpg", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/liuche/p/7955462.html\">刘彻</a>   </div><p><strong>ERP</strong><strong>之痛</strong></p>\n<p>曾几何时，我混迹于电商、珠宝行业4年多，为这两个行业开发过两套大型业务系统（ERP）。作为一个ERP系统，系统主要功能模块无非是订单管理、商品管理、生产采购、仓库管理、物流管理、财务管理等等。作为一个管理系统，大家的一般开发习惯就是使用.Net或Java技术，建立一个单块（单进程）架构的应用，只有一个SQLServer或MySql数据库。然后在项目文件中分一下各个模块，三层结构方式组织代码编写开发。最后测试，交付上线。</p>\n<p>起初，因为数据量不大，系统性能还不错，各种列表查询，报表查询，Excel数据导出功能等用的都很流畅。但是随着公司业务发展，订单量日积月累，后期各种业务部门的报表查询、数据导出需求不断增多，我们渐渐就感觉系统运行越来越慢。于是我们可能最先想到的解决方案就是，优化系统瓶颈数据库这个大头。我们可能的一种尝试就是将数据库单独放置到一个服务器，实现数据库和应用程序分离，或者是建立各种数据库表索引，优化程序代码等方法。经过这样一番研究优化，系统某些功能可能性能的确大大提高，但是我们还是发现某些功能列表的数据查询导出依然很慢，或者随着数据量继续积累，原来较快的列表导出功能，也愈来愈变得缓慢了。我们用尽各种办法，最后也达不到理想的系统性能速度。</p>\n<p>为了提高系统性能，我们也许会主动学习一些互联网公司的技术经验，什么高并发、高性能、大数据、读写分离等方案，发现自己根本无从下手。我们会觉得因为系统业务特点不一样。ERP系统并发量不高，主要是业务复杂，各种业务耦合度远高于那些互联网应用，不好做拆分，数据查询逻辑要远比互联网系统复杂，一个列表页查询出来的数据，往往需要关联4、5张表才能得到结果。有些报表类的甚至更多。加上各种业务操作事务性、数据一致性要求很高，很多时候导致我们措不及手，无法进一步优化系统。</p>\n<p>曾几何时，我也被这样或那样的理由所挫败，认为ERP系统非常特殊，无药可救，可是后来。。。</p>\n<p>我现在已经不这么认为了，似乎有了新的解决方案O(∩_∩)O哈哈~</p>\n<p><strong>曙光乍现</strong></p>\n<p>在叙述具体方案前，先说下自己的想法。我首先觉得我们做ERP系统前，就得有当今互联网思维。我们不要再去做一个大一统的系统了。我们要分拆一个大系统，做成一个个小系统。然后通过系统接口让这些小系统相互通信。这样来组成一个大系统，具体来说就是“分布式”、“服务化”的互联网思维。让系统在架构设计上就是一个先天支持高度可扩展的系统。</p>\n<p>怎么做呢？具体来说就是要将订单管理、商品管理、生产采购、仓库管理、物流管理、财务管理拆分成一个个子系统。这些子系统可以单独设计开发，对外暴露出各种其他子系统需求的数据接口即可。每个子系统都有单独的数据库。甚至这些子系统可以交由不同的团队去开发和维护，使用不同的技术体系，使用不同的数据库。而不是再像以前那样，都集成在同一个大而全的系统中，一个大而全的数据库。</p>\n<p>对于新架构的系统他有什么优点呢？</p>\n<p>首先，也是最重要的就是解决系统的性能问题。以往数据库实例只有一个，没法扩展出多个实例，以便在性能受限的情况下依靠增加数据库实例来达到负载均衡。也许有人会说可以使用读写分离方案，但是因为ERP系统的特点，这个方案很多时候不现实。比如说操作库存的时候，你不能从读库里读库存，然后在写库里写入库存。因为主从复制会有时效性，写入的库存并不能马上写入从库。这样的场景在ERP中也有多处。何况写库不能扩展，只能有一个。而新设计方案是写库是分离的，每个子系统有自己的数据库。</p>\n<p>其次，就是更新非常方便，各个子系统以后台微服务的方式存在。前台一个单独的web项目，这个web项目调用后台这些子系统的服务接口。这样的设计，在某个业务子系统需要更新的时候，可以单独更新。不用像以前那种单进程架构时，一个小更新需要整个系统重启，导致用户会话也丢失，用户需要新登录。而现在的这种设计就不会有这个问题。</p>\n<p><strong>系统整体设计</strong></p>\n<p>系统物理部署视图</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/92662fec4eb3e86e81fbd23e062cef51.png\" alt=\"\" width=\"659\" height=\"534\"></p>\n<p><strong>详细设计</strong></p>\n<p><strong>   拆分应用层</strong></p>\n<p>拆分应用层，是践行“微服务”架构的理念。将原来大而全的单进程架构按照业务模块拆分成可独立部署的应用程序，以此来达到平滑系统更新、升级、方便负载扩展的目的。具体来说，技术上可以使用restfull风格的接口，也可以使用像java中dubbo框架方式来简化开发复杂度。ERPWeb端或其他移动端也是一个单独的应用充当表现层。非常薄，只是简单的接受参数，调取后台其他各种微服务程序的接口获取所需展示的数据。微服务充当业务逻辑层，每个微服务都是可独立部署上线的程序，对外提供数据访问接口。</p>\n<p>微服务可以使用流行的各种RPC框架，比如dubbo，可以支持多种调用协议Http、TCP等，这些框架使得编码比较容易，框架封装底层数据通信细节，使得客户端执行远程方法如同执行本地方法一样简单。</p>\n<p>dubbo微服务架构，还支持服务治理，负载均衡等功能。这样不仅可以提高系统的可用性，还能动态提升系统应用层的性能。比如仓库管理中入库业务非常繁忙，占用非常多的CPU和内存资源，我们可以另外加一台机器，单独再部署一个仓库管理服务上去。这样使得整个系统，有两个仓库管理服务在同时工作，平衡负载。而这一切都是在服务注册中心，比如Zookeeper下自动完成的。</p>\n<p>微服务结构，天生很好的支持系统更新升级操作。比如财务模块有个新需求需要上线，我们只需要替换财务模块的服务重启即可。这对已经登录系统的用户来说，没有多少影响，不用重新登陆系统，其他模块服务使用也不受影响。</p>\n<p><strong>    拆分数据层</strong></p>\n<p>数据库瓶颈是ERP系统的永久之伤。大量复杂的数据查询表连接逻辑充斥着整个系统。数据库垂直拆分成功的关键就是如何重新设计系统数据层各个模块相互耦合的问题。能解决这个问题，永久之伤便可以解决了。</p>\n<p>我们先来看一个典型数据层模块耦合问题。需求是展示物料库存，列表字段：物料编号、物料名称、品类、仓库、数量</p>\n<p>物料表：</p>\n<table cellspacing=\"0\" cellpadding=\"0\">\n<tbody>\n<tr>\n<td>物料ID</td>\n<td>名称</td>\n<td>品类ID</td>\n</tr>\n<tr>\n<td>Z0001</td>\n<td>Iphone6红色手机壳</td>\n<td>Z</td>\n</tr>\n<tr>\n<td>Z0002</td>\n<td>iPhone6黑色手机壳</td>\n<td>Z</td>\n</tr>\n</tbody>\n</table>\n<p>库存表：</p>\n<table cellspacing=\"0\" cellpadding=\"0\">\n<tbody>\n<tr>\n<td>物料ID</td>\n<td>仓库ID</td>\n<td>数量</td>\n</tr>\n<tr>\n<td>Z0001</td>\n<td>W1</td>\n<td>10</td>\n</tr>\n<tr>\n<td>Z0002</td>\n<td>W1</td>\n<td>20</td>\n</tr>\n</tbody>\n</table>\n<p>品类和仓库表省略。。。</p>\n<p>很显然，传统一个数据库中，我们只需要简单的join操作，即可关联这两张表，外加关联品类和仓库表即可查询出我们所要的数据。但是现在我们的架构中，物料表和商品表不在同一个数据库实例中，我们不能使用join操作了，那我们该怎么实现需求呢？</p>\n<p>新的架构，只允许我们通过对方的服务接口来获取数据，不能直接关联对方服务的私有数据库。至少从架构上，服务化角度来说不能直接访问对方服务的数据库。这种情况下，假设web模块子系统调用仓库子系统来获取数据，则我们需要在仓库模块中创建一个service方法来装配这些数据。然后返回给web子系统。如下图所示，仓库管理方法首先获取本地库存表的物料编码、和仓库表的仓库名称字段信息，并且分页完后最终准备返回20条数据到Web模块前，将这20条数据中的物料ID作为参数请求商品模块子系统，商品子系统返回这20个物料ID相关的商品信息给到仓库管理模块，然后仓库管理模块重新组装上列表所需的物料名称和品类两个字段数据，实现最终要返回给Web子系统的数据。</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/5844da7dc1a895e04903b2e7e9a80583.png\" alt=\"\" width=\"492\" height=\"484\"></p>\n<p>也许你会说，这太麻烦了，这种方法的性能肯定没有直接join来的高，解决不了性能问题。咋看起来好像是这么回事，但是仔细考虑看看，在系统并发量低、数据量小、业务不算繁忙的环境下，的确性能还不如传统一个数据中join方式来的快速。但我们想想以后吧！我们现在的架构设计是将一个数据库拆成多个数据库，每个数据库可以运行在单独的服务器上去，这样以后就能负载数据库的压力了。整体来说这样才能不会让数据库成为未来业务繁忙时候的性能瓶颈了。想想都觉得让人兴奋不已，是不是？</p>\n<p>这时候有人又会问，那以后系统数据量、业务更大了，连你这个拆分成几个数据库还不够用怎么办呢？我的方法是，可以基于拆分的数据库，单独每个库可以做读写分离、使用缓存等。甚至可以继续拆分下去，将子系统再次拆分成多个孙子系统。视业务模块繁忙程度而定。</p>\n<p><strong>报表系统</strong></p>\n<p>有人又会问，有些列表查询逻辑非常复杂，关联十多张表，如果按上述方法拆分数据，那简直是灾难啊！是的，你说的没有错。这种情况下我的方案是将这种更加复杂的报表级别的数据查询展示需求，可以单独做个报表系统。报表数据库设计采用数据仓库方式。为了更高的读取性能，我们可以将数据库表设计成很多冗余字段方式也就是反范式设计，以及建立非常多的组合索引。</p>\n<p>这种系统成功的关键就是数据和主ERP系统业务库的同步问题了。一般可以写一个定时同步程序，将ERP主业务系统的数据经过帅选、转化等方式直接生成报表视图所需的最终或中间数据，简化关联查询。报表系统也可以采用微服务架构设计。如下图所示：</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/522a3600daf64a8e983f09ed54353a98.png\" alt=\"\" width=\"651\" height=\"294\"></p>\n<p>如果报表所需的数据要求实时的，我们可以让ERP系统业务操作时，触发同步数据的请求，实时同步至报表库。</p>\n<p><strong>分布式事务</strong></p>\n<p>也许有人又又问了，ERP系统很多操作都要求事务性，你拆分系统后怎么实现事务性，保障数据一致性呢？</p>\n<p>这个问题很好，也是我决定写这篇文章前思考的最后一个问题。在微服务架构中，实现夸服务的事务并不容易，至少不像本地应用使用本地数据库事务那样方便，性能高效，数据一致性好。</p>\n<p>也许你听过分布式事务这个概念。有两种情景，一种是一个应用中使用多个数据库，为保障数据一致性，需要使用分布式事务。还有一种情况就是针对我们这个架构而言的。微服务环境下的分布式事务，具体来说打个比方。采购入库这个操作设计在仓库管理服务中。入库后，需要更新采购子系统中的采购单中的入库数量。这个过程要求数据一致性，也就是采购单入库成功后写入了库存表中的数量，同时要更新采购单表中的入库数量。我们不能直接在仓库服务中去访问采购服务中的数据库，必须通过采购服务提供的服务接口才行。如果这样，我们怎么能保证数据一致性呢？因为很有可能库存表写入成功，但调取采购服务写入采购单数据时失败了。可能是网络问题原因导致的，这样数据就不一致了。</p>\n<p>在分布式事务技术中，有实现最终一致性这么一说，意思就是只要我能保证两边数据最终实现了一致性就行，不一定要使用事务。这样说来就有方案了。如仓库子系统在处理采购入库时需要增加入库单数据和更新库存数据等多个表。这多个表都在仓库子系统中，我们可以使用一个本地事务来保证仓库子系统中的表数据一致性。然后调用采购子系统更新采购单里的入库数量。为了防止这个过程突然中断导致调用失败，我们考虑增加一个消息队列中间件如ActiveMQ。如果接口返回失败我们就往MQ里写入这个处理请求，等到采购子系统恢复正常后，MQ通知采购子系统处理这个更新操作。由于消息消费掉以后不会再有通知了，采购子系统处理过程中发生异常导致更新失败，需要将问题写入本地的日志库，以便通知管理员做后续补偿处理。就这样通过各种办法来达到数据的最终一致性即可。虽然听上去有点坑，但这就是解决方案。没有其他更好的了。或者更新失败后重新调用仓库子系统回滚入库单和库存数据，达到最终一致性！如图所示：</p>\n<p><img class=\"aligncenter\" src=\"http://jbcdn2.b0.upaiyun.com/2017/12/a5b2c925209ba4a005c3b909e598de99.png\" alt=\"\" width=\"651\" height=\"312\"></p>\n<p>非常有幸能和大家一起分享知识和经验，正是由于大家的无私分享，才让我们得以成长和进步，我最近几年来都很少分享东西，有时候是因为工作很忙没有时间写点东西，有时候也是因为自己懒或是没有什么新东西可以分享给大家的。最后也希望大家对我的分享不足之处给予批评指正，一起进步！</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113174\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113174votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113174\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 4 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 3 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "url": "http://blog.jobbole.com/113174/", "comment_nums": 3, "praise_nums": 1, "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2013/03/architecture.jpg"]},{"title": "越做越复杂的软件工程项目", "url_object_id": "62dfe5b002b87b6d827600206c0ab7de", "create_date": "2017/12/11", "tags": "IT技术,软件开发", "fav_nums": 2, "front_image_path": "full/5f3168649ca6499ecc58fe19364504eed675d2f2.jpg", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/dimple11\">dimple11</a> 翻译，<a href=\"http://www.jobbole.com/members/young605867996\">Lada</a> 校稿。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://medium.com/swlh/your-app-is-an-onion-why-software-projects-spiral-out-of-control-bb9247d9bdbd\">Kannan Chandrasegaran</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><h4>你的APP就像个洋葱：为什么软件开发项目一路失控</h4>\n<p>你最开始想得很好。雇佣开发人员来构建出你的创业想法。但是几乎每一周，都感觉似乎项目需要做做调整，于是各种功能开始混进来，范围逐渐蔓延。</p>\n<p>仿佛这项目拥有了自己的生命，而且还试图毁掉你的生活。</p>\n<p><img class=\"alignnone\" src=\"http://wx2.sinaimg.cn/mw690/63918611gy1fmd055iz98j21jk18814r.jpg\" width=\"690\" height=\"549\"></p>\n<p>怎么会这样呢？你雇佣的开发人员很差劲吗？你对项目管理也只是摸着石头过河吗？还是这个想法从头到尾就是糟糕的？</p>\n<p>有可能。但一个核心误区通常会在一开始注定项目的失败。</p>\n<p>我们的假设是，给产品定义一系列的功能并记在纸上后，虽然偶然有时候要新增功能，有时候要去除功能，但是你一眼就能看出项目的范围大小。</p>\n<p>这个假设是错误的。</p>\n<p>你的项目不像一张纸一样是二维的，它还有深度。</p>\n<p>软件的每个功能都可以被一层一层剥开。事实上，如果我想当标题党的话，我会说你的app就是个洋葱。我来讲一下我的意思，来告诉你为什么当你把自己的 app 一层层剥开时，它会让你泪流满面。</p>\n<h4>终结所有图书馆的图书馆。</h4>\n<p>咱们通过具体的实例来看吧，给你推荐一个我的想法。</p>\n<blockquote><p>人们经常会想要附近图书馆没有的书，而在这附件其它的人可能会有。因此，这款 app 可以让人们发送用书请求，然后有这本书的人会响应。我们从每一次这样的交易中获利。</p></blockquote>\n<p>太有才了。</p>\n<blockquote><p>这我知道，好吧？软件的功能直截了当 ：</p></blockquote>\n<p><img class=\"alignnone\" src=\"http://wx4.sinaimg.cn/mw690/63918611gy1fmd0588aa5j21hc0zknjn.jpg\" width=\"690\" height=\"460\"></p>\n<blockquote><p>现在该把规格说明书交给开发人员，并且给软件想个精彩的名字了。叫 kaBooki？lib.rari.ly？reddit？</p></blockquote>\n<p>好吧，稍等一下，我们仔细来看看。而且已经有软件叫reddit了。</p>\n<p>我们带着问题探究一下你的想法，看看会发现什么。</p>\n<p>用户彼此之间如何付款呢？见面的时候付现金还是在 app 上付款呢？</p>\n<blockquote><p>哦，他们应该在app上用信用卡支付，这样我们能够获得提成。</p></blockquote>\n<p>他们实际上怎么发送用书请求呢？我的意思是，他们到底在 app 上要怎么操作呢？要填写一个包含了书名和作者的开放式表格吗？</p>\n<blockquote><p>噢，嗯。他们应该对书进行检索并且选择一本想要的。</p></blockquote>\n<p>好，所以我们需要建个书的数据库。</p>\n<blockquote><p>我猜是要这样。</p></blockquote>\n<p>实际上，什么是用书请求呢？拿着书并且准备把书卖出去的人能看到请求的书单吗？还是说我们要向这些要卖书的人发送通知，像 Uber 或 Thumbtack 那样？</p>\n<blockquote><p>是那样，我们将用书请求发给持有书的人。</p></blockquote>\n<p>所以，卖书者需要往 app 中填充所有在售书籍的信息吗？</p>\n<blockquote><p>呃，是的。</p></blockquote>\n<p>怎么进行书的交接呢？用户自己送书，还是我们处理配送问题？</p>\n<blockquote><p>我们处理配送问题。</p></blockquote>\n<p>所以你需要一个系统来告诉你要拿什么书，以及书应送往的地方。我猜你的司机想知道最短的送书路线，对吧？</p>\n<blockquote><p>好吧，这样不可行。那让用户彼此之间寄书怎么样呢？</p></blockquote>\n<p>所以我们要将收书人的地址给发书的人？怎么处理运费问题呢？</p>\n<blockquote><p>实际上，你知道的，这些用户需要挨得比较近，这样他们就可以直接过去拿书了，还能交个新朋友，对吧？</p></blockquote>\n<p>所以我们需要把挨得近的用户匹配起来。他们怎么找对方呢？App 有没有实时地图好让他们安排见面呢？</p>\n<blockquote><p>好，行，就这样吧。</p></blockquote>\n<p>我们要给书定价吗？还是他们自己商量价格？</p>\n<blockquote><p>他们自己谈个明白，给书定好一个价格。</p></blockquote>\n<p>他们怎么做决定？我们是不是需要在 app 里建个交流平台呢？</p>\n<blockquote><p>他们彼此只需要用电话谈就行了。</p></blockquote>\n<p>好吧，所以我们是不是要用 SMS （Short Messaging Service 短信服务）短信来确认号码呢？还是……你懂我的意思了，我们真的可以永远无休无止地进行下去。</p>\n<blockquote><p>请别这样。</p></blockquote>\n<p>我们来看一下现在功能清单是什么样的：</p>\n<p><img class=\"alignnone\" src=\"http://wx1.sinaimg.cn/mw690/63918611gy1fmd059alfrj21hc0zk4p6.jpg\" width=\"690\" height=\"460\"></p>\n<p>每一条项目的功能都可以进行多次扩展，我们只把洋葱拨开了一层，就已经成这样了。</p>\n<p><img class=\"alignnone\" src=\"http://wx1.sinaimg.cn/large/63918611gy1fmd05aus1gg209q05iqgi.gif\" width=\"350\" height=\"198\"></p>\n<p>现在啊，现在可别哭。</p>\n<h4>发生了什么呢？</h4>\n<p>我们要清楚哪些东西不是导致功能激增的原因。</p>\n<h5>这不是我们通常所知的功能蔓延。</h5>\n<p>功能蔓延是指产品中不断增添新的功能，而如果你看一眼我们最终列的功能清单，里面每一条都支持最初的功能设定。</p>\n<h5>这无关乎科技因素。</h5>\n<p>比如说，聊天系统最适宜的结构是怎样的呢？什么支付平台是最容易整合的呢？</p>\n<p>我们在这儿不讨论那些。一个好的开发人员可以通过各式各样的技术手段与你沟通，但是不能替你决定软件需要具备什么功能。</p>\n<h5>这也无关乎技术考量。</h5>\n<p>人们想使用这样的产品吗？当其他用户还很少时，有什么因素会诱使早期的用户来登陆软件呢？用户愿意为这项服务付费吗？</p>\n<p>这些问题与想法的落实、产品市场匹配度的确认、定价的策略等息息相关。再重申一次，这些项都是非常重要的，但却不是软件功能清单中内容多到炸的原因。</p>\n<blockquote><p>当然这也与全球变暖或者牙仙没有丝毫关系，你要告诉我变成项目变成洋葱的原因吗？或者说看完觉得每个其实都并没什么理由？</p></blockquote>\n<p>噢，你这样很无聊，事实是这样：</p>\n<blockquote><p><strong>我们基本上对复杂性是怎么凸显的存在误解。</strong></p></blockquote>\n<p>我们以为每个功能的复杂程度就像我们开始描述的那样。嘿，也许程序员写代码要花费时间，或者随便程序员做什么，但是商业用语区区几个词就可以完全描述软件的功能，像“用户通过 y 使用 x”，对吧？</p>\n<p>这种观点是错的。</p>\n<h4>软件功能更像是分形。</h4>\n<p>你离得越近去看，细节就会展现得越明显。</p>\n<p><img class=\"alignnone\" src=\"http://wx1.sinaimg.cn/large/63918611gy1fmd05c4r90g206y058wxs.gif\" width=\"250\" height=\"188\"></p>\n<blockquote><p>洋葱是分形？</p></blockquote>\n<p>不是，我已经换了比喻。咱们继续。</p>\n<p>我们从全局视角来开始描述软件的功能。但是，当构建好 app，或是使用 app 时，是处在一个较小规模下的。它的完成一步一步进行的，每一个步骤都有可能遇到问题。为了解决问题，你可能需要重新设计这一步、添加新步骤、或是增添全新功能。</p>\n<p>这就像是规划一条从你家到单位的行程。看地图的话，行程好像是直的。</p>\n<p><img class=\"alignnone\" src=\"http://wx2.sinaimg.cn/mw690/63918611gy1fmd05d11p1j21f50s7k08.jpg\" width=\"690\" height=\"380\"></p>\n<p>当你开始从更小的视角来看，你会发现直的路线并不会城市道路网相契合。你会遇到交通站、高坡和道路阻塞。根据步行、骑行或者开车的不同，你的行程路线也会不同。</p>\n<p>建立软件很大程度上是一样的，你离得越近去看，对解决方案就能有越细致的认识。</p>\n<blockquote><p>这下好了，一路到处都充斥着细节，还都是我需要考虑的。这是否意味着我的产品永远也不可能做完呢？</p></blockquote>\n<p>这么想也对也不对，之所以复杂性凸显，是因为我们一开始就宏观描述了软件功能，也通常就是要实现的目标。然后我们将细节放大，为实现这一目标而一步步建立解决方案。细节放得越大，就会发现越多复杂的问题。</p>\n<p>但复杂性并不是问题所在，问题是我们如何来发现复杂性的。我们把软件功能规格书叫个开发人员，几周过后，我们拿到了第一版的 app 并开始测试。这是我们第一次一步一步操作软件，会从中发现大量漏洞。然后我们做好修订说明，把它交给开发者，让他们再开发第二版 app。</p>\n<p><img class=\"alignnone\" src=\"http://wx3.sinaimg.cn/mw690/63918611gy1fmd05duyq3j20af0dwq4w.jpg\" width=\"375\" height=\"500\"></p>\n<p>在整个流程的最后一步，我们在多次进行之后，得到了很好的解决方案。</p>\n<p>问题是开发周期真的太长了，每一环节都要耗费好几周或好几个月。</p>\n<p>但是发现 app 的潜在复杂性又是必要之举。</p>\n<blockquote><p>通过来回反复和开发人员交涉来发现这种复杂性，既耗时又烧钱。</p></blockquote>\n<p>我们想这样做：</p>\n<p><img class=\"alignnone\" src=\"http://wx3.sinaimg.cn/mw690/63918611gy1fmd05eim30j20af0dwmz4.jpg\" width=\"375\" height=\"500\"></p>\n<p>我们想在开始写代码之前就尽可能多得发现它的复杂性，将软件层层剥开来，看到一个更加健壮的功能清单，而且想做得又快又省钱。</p>\n<p>我们想在软件规格书上来回修改，而不是在app上反复折腾。</p>\n<p>我们想从这个过程：</p>\n<p><img class=\"alignnone\" src=\"http://wx2.sinaimg.cn/mw690/63918611gy1fmd05f955oj21jk0feaeq.jpg\" width=\"690\" height=\"191\"></p>\n<p> </p>\n<p>走到这个过程：</p>\n<p><img class=\"alignnone\" src=\"http://wx4.sinaimg.cn/mw690/63918611gy1fmd05g65vbj21jk0g4443.jpg\" width=\"690\" height=\"200\"></p>\n<p>我们需要两个东西来行之有效地实现这个过程：第一，我们需要一种方式来展示功能清单，以便反复修改；第二，我们需要一种方式来高效地就功能清单进行审核协商。</p>\n<p>我们来看看怎么做。</p>\n<h4>规划功能</h4>\n<p>我们不想以商业用语来谈，而是像用户一样的身份来考虑软件功能。在这个层面就需要处理软件的复杂性问题了。</p>\n<p>首先，列一张用户目标表。你想让用户通过你的 app 获得什么呢？</p>\n<p>接下来，你需要规划用户流程，以用户的身份走每一步，来实现用户目标，并记录这些步骤。</p>\n<p>我们建立一张用户使用 app 的流程图。</p>\n<p>有很多种做的方式，你仅需为每一步勾勒一个简单的略图即可。你可以为用户走过的每一个界面绘制模型，也可以在纸上或软件上画流程图。</p>\n<p><img class=\"alignnone\" src=\"http://wx2.sinaimg.cn/mw690/63918611gy1fmd05hhi1nj218g0wbtwq.jpg\" width=\"690\" height=\"502\"></p>\n<p>无论你选择哪种方式，确保优先考虑速度问题。除非你是 Photoshop 专家，否则把软件收起来，拿纸和笔画吧。</p>\n<p>确保每个界面在你的软件略图中都能够得以体现。比如说，如果一个特定的步骤会经过 app 的好几个界面，那么把该步骤切分开。我们想要梳理出更多的细节，而不是更少的。</p>\n<p>这个单独的过程应该将 app 中一些复杂的问题平面化。现在，我们要往更深处挖。</p>\n<h4>对一切保持疑问</h4>\n<p>我们要是像之前那样提问的话，范围太宽泛了，无从下手。</p>\n<p>首先我们将适用于大部分软件的一些常见问题列到一起，这些问题可以归为四个大类，你可以把它当做框架来组织软件略图。</p>\n<p>看着软件略图的每一步，问你自己清单上写的每一个问题。如果答案会展现出一个新的步骤，那就把它添加进软件略图。</p>\n<p>清单在这儿：</p>\n<h5>用户输入</h5>\n<p>这些问题与用户提交到产品的信息有关</p>\n<ul>\n<li>用户会输入什么信息？</li>\n<li>输入的是信息是开放式的还是交互式的？</li>\n<li>开放式信息范例：输入自由格式文本，上传图片，录制视频。</li>\n<li>交互举例：往搜索框输入文本来显示可选结果、在地图上选取地址、选择那些预定义选项。</li>\n<li>是否有些输入应该被当做无效呢？App 又该如何处理呢？</li>\n<li>是否有无源输入呢？最常见的例子：通过 GPS 进行用户定位。</li>\n<li>产品需要获取新用户 (<a href=\"https://www.useronboard.com/\">https://www.useronboard.com/</a><u>)</u>的什么信息？用户之后可以对信息进行修改吗？</li>\n</ul>\n<h5>呈现给用户的信息</h5>\n<p>如果之前的部分是输入，你可以把这个当成输出。</p>\n<ul>\n<li>屏幕上哪些信息是呈现给用户的？</li>\n<li>这些信息是以怎样的形式呈现的？比如：文本、图片、地图、清单、图表。</li>\n<li>这些信息需要以某种方式进行分类吗？比如：最近使用频率、距上次使用时间、关联性。</li>\n<li>产品是不是可以主动对外通信？比如：邮件、推送通知、SMS 消息。</li>\n</ul>\n<h5>各部分之间的交互</h5>\n<p>这些问题有关软件体验的不同部分（用户、产品、其他服务）之前是如何交互的。</p>\n<ul>\n<li>用户彼此之间有交互吗？比如：收发邮件、加好友、 “喜欢”、或者给其它用户的内容打标签</li>\n<li>用户与外部服务有交互吗？比如：付费服务、物流跟踪、社交登陆。</li>\n<li>产品与外部服务有交互吗？比如：位置查询服务、天气 API、社交网络（“你的朋友X刚加入了！看看他们的简介！”）</li>\n</ul>\n<h5>企业家功能</h5>\n<p>有关你——企业家，需要从产品中获得什么。</p>\n<ul>\n<li>你需要通过邮件或其他媒介接收提醒或摘要吗？</li>\n<li>需要为你自己或员工提供专门的系统吗？比如：为配送人员提供导航软件，为厨房员工提供实时点餐管理接口。</li>\n<li>你需要手动批准用户/内容的接口吗？</li>\n<li>你需要一个内容审核系统吗？它可以让管理员轻松地进行用户内容移除和用户账户失效的操作。</li>\n</ul>\n<blockquote><p>简直有……数不清的问题。</p></blockquote>\n<p>这就对了！这也真的就是人们在早期开发过程常常忘记的东西。你的产品还有很多特定的问题，随着时间你就会慢慢发现。</p>\n<h4>把它整合到一起</h4>\n<p>建立软件略图和进行软件审核的过程可以让你知道少了什么东西，这个过程重复几次之后，你就能更自信得拿出一个 非常可靠的功能表 了。</p>\n<blockquote><p>你知道，我真的很希望通过这种好像挺奇怪的诀窍，可以使项目得到修缮。听上去工作量还蛮大的。</p></blockquote>\n<p>的确。但这是你在过程中的某些点上，无论如何都必须要做的工作。</p>\n<p>记住我们为什么要这样做。你无论如何都要找到软件功能所潜藏的复杂性因素，你要做的就是选择何时来将洋葱层层剥开。</p>\n<p>基本上来说，有两种选择：</p>\n<ol>\n<li>根据用户找准开发目标，对此建立模型或者流程图，对自己的假想保持疑问态度，并且像我们上面所做的那样将软件层层剥开。或者，</li>\n<li>让开发人员直接开始开发软件，然后根据每一版暴露的问题一次次改版，每改版一次就要花一周时间。几个月后，你通过改版会发现很多问题，而这些问题和你本在一周内用纸笔就可以搞定的问题一模一样。</li>\n</ol>\n<p>所以这让软件项目变得复杂到爆，恨不得能一下子将你生吞活剥。</p>\n<p>所以，去发掘功能吧，建立软件略图，对自己的假想保持疑问态度，以既迅速又省钱的方式发现软件存在的主要问题。</p>\n<p>让自己从压力和痛苦中解脱出来，放手让产品走向外面的世界，让它恣意绽放。</p>\n<blockquote><p>难道洋葱也会开花绽放吗？你的隐喻太蠢了。</p></blockquote>\n<p><img class=\"alignnone\" src=\"http://wx1.sinaimg.cn/mw690/63918611gy1fmd05ib9yrj20jw0jw40y.jpg\" width=\"690\" height=\"690\"></p>\n<blockquote><p>噢说得好。</p></blockquote>\n<p>如果你觉得这篇文章挺有用，可以帮我分享它！也可以订阅我的邮件，确保不错过我的下一篇文章。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113146\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113146votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113146\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 2 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i>  评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/dimple11\">dimple11</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/dimple11\">\r\n\t\t\t<img src=\"http://jbcdn2.b0.upaiyun.com/2017/09/28db3e36f17643a752be4b798d5ceabc.jpg\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            简介还没来得及写 :）        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/dimple11\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/dimple11/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/dimple11/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 14</a>        </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "url": "http://blog.jobbole.com/113146/", "comment_nums": 0, "praise_nums": 1, "front_image_url": ["http://wx2.sinaimg.cn/mw690/63918611gy1fmd055iz98j21jk18814r.jpg"]},{"title": "谈谈程序员的离职和跳槽", "url_object_id": "eb6cc8fd6536dae6eac7ae49fc72211b", "create_date": "2017/12/09", "tags": "职场,职场,跳槽", "fav_nums": 5, "front_image_path": "full/3dec15374f3b9e62441c4d320c8998dd12c43dc8.jpg", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a target=\"_blank\" href=\"http://www.cnblogs.com/JimmyZhang/archive/2012/11/21/2781035.html\">张子阳</a>   </div><p>// 伯乐在线转注：原文写于 2012 年</p>\n<p>这篇文章是我在部门会议上一次发言的总结。之所以会有这次会议，是因为我的一名员工向我提出了辞职，在思索了几天后，我整理了一下自己的思路，于是便有了这次的会议和现在的这篇文章。</p>\n<p><img class=\"alignnone aligncenter\" src=\"http://ww1.sinaimg.cn/mw690/7cc829d3gw1eizj4ql2huj20eq0b0wfx.jpg\" width=\"530\" height=\"396\"></p>\n<p style=\"text-align: center;\">（转载配图）</p>\n<h3>收入是由什么决定的？</h3>\n<p>这位员工辞职的原因主要有两个：</p>\n<ol>\n<li>公司的薪水无法达到他的预期，未来一年在公司的收入前景也不是很明确。</li>\n<li>想要去做更底层的开发，方向是使用C/C++开发3D图形图像。而我们公司主要是.NET开发。</li>\n</ol>\n<p>既然其中的一个原因是薪水无法符合预期，那么首先要搞清楚的就是收入是由什么决定的。</p>\n<h3>1.积累</h3>\n<p>首先要说的一点就是：积累。积累就是你在这家公司所创造的价值的积累。</p>\n<p>你今天所领的薪水，并不是由你现在所创造的价值所决定的，而是包含了以前一段时期内其他同事所创造的价值。举个例子来说，公司目前排名前三的大客户：客户A、客户B、客户C。</p>\n<ol>\n<li>客户A是2008年接下来的，现在每年为公司贡献600万。</li>\n<li>客户B是2009年接下来的，现在每年为公司贡献500万。</li>\n<li>客户C是2010年接下来的，现在每年为公司贡献350万。</li>\n</ol>\n<p>我的年薪是你的两倍还多。可我也承认，我现在所能创造的价值，和我的能力绝对不可能是你的两倍。可问题是：2008年、2009年、2010年这些年份我都在公司，上面的每一个大客户，都有我的贡献。而你2012年才新进公司，你并没有之前的积累。所以，新员工入职后，工资相较老员工会低一些是正常的。很多新员工总是认为自己的收入低了，吃亏了，实际上，很多情况下，新员工在加入公司的头一年，公司仅能维持平衡，即新员工创造的价值全当工资发给他了。直到第二年，有了上一年的积累之后，公司才有所盈余。而加入半年就离职的员工，对公司来说基本上是亏本的。这也就解释了为什么人员流动特别快的公司活不长，因为人力成本太高。</p>\n<p>关于积累，我可以再举几个例子说明一下：</p>\n<blockquote><p>洪小莲，李嘉诚的秘书，几十年来一直追随李嘉诚，她从几千元的工薪族，做到身家上亿的工薪族，享受的是公司成长的回报。这种回报并非是她个人的学识和能力有了大幅的提高而得到的等价交换，很大程度上仅仅是因为她忠诚地待在这趟车上。</p>\n<p>杨元庆，联想现在的CEO，研究生毕业后就一直追随柳传志，尽管一开始从事的是他并不很乐意的销售工作，但最终还是坚持了下来。上一次注意到他，是看到一则新闻，标题是“杨元庆自掏2000万奖励一线员工”。</p></blockquote>\n<p>上面只是正面的例子，也有反面的例子：</p>\n<blockquote><p>吴士宏，曾写了一本书叫做《逆风飞扬》，可谓是红极一时。1986年进入IBM，1998年离开IBM，进入微软，担任微软中国公司总经理，1999年进入TCL，2002年离开TCL。之后就离开了公众的视线。我特意去百度搜索“吴士宏现在在哪里”，没有任何的消息。我想如果她很成功的话，一定还属于“公众人物”，不至于连度娘都不知去向。</p></blockquote>\n<p>跳槽的话显然就要放弃先前的积累。比方说，当你跳槽到另一家公司以后，你曾经做过的系统、曾经服务过的客户仍然在为先前的公司创造着利润，可是跟你已经一毛钱关系都没有了（极少数公司有股票，另当别论）。所以跳槽之前要慎重考虑，跳得不好，有可能越跳越低。</p>\n<p>既然新员工相对于老员工来说，收入低一些是正常的，那么老员工工资高也是合情合理的。但是有一些公司，我将其归为“无良公司”，它们会在老员工的收入高到一定程度的时候，将老员工砍掉，然后再招募低廉的新人来承担之前老员工的工作，以赚取更高的利润。我觉得这些都是小聪明，最后的结果就是，聪明能干一些的人，在看出公司的这些伎俩之后果断离职；能力一般的员工，也会把你这里当成培训基地，翅膀硬了就飞了，受损的最后还是公司，实在是得不偿失。还不如厚待老员工，也让新进的员工对未来有一个更好的预期。也有一些人向我抱怨说：“老员工待得久了，干劲都被磨光了，每天都是混日子，还不如新员工，不开他开谁？”。然后我反问他：“激励员工难道不正是你工作的一部分吗？”。这种情况的出现，更多时候，是管理者的责任，而非员工。</p>\n<p>最后补充一点：我并不认为老员工工资比新员工高就一定是合理的。当公司对一个新员工开出很高的工资时，其实是出于这样一种期望：他能推动公司进步的更快。而如果他真的这样做到了，公司进步的更快了、收益更高了，可以反哺老员工，从而公司的整体待遇水平都提高了，不是皆大欢喜吗？可能一些老员工并不能明白这些，所以，当招一个新员工工资水平远高于现有的老员工时，为什么要这样做，最好能让老员工知晓。</p>\n<h3>2.老板</h3>\n<p>这个“老板”是宽泛的老板，不一定是公司最大的老板。有的时候，公司比较大，你的职位又比较低，大老板连有没有你这个人都不知道，此时的老板就是你的顶头上司。很多时候，你的收入与他也有着莫大的关系。</p>\n<p>对于我来说，我的原则是：在我的能力范围内，我会为我的员工争取更好的待遇。表面上看，这样做很蠢，花6000块就能雇到一个人，为什么要花8000块？我不是这样认为的，我期望能和我的员工形成这样一种互动：我尽我的能力为你争取好的待遇，你也尽你的努力做好工作。</p>\n<p>我不能要求员工“你先把工作做好，我自然会给你好的待遇”。总是要有人先迈出一步，总是要有一方先信任另一方，所以在你什么还没有做的时候，我就先信任你，并且给你尽可能好的待遇，那么我该做的事情都做了，我问心无愧，剩下的，就看你的表现了。</p>\n<p>可能有人会想，都这样了怎么还会有人提出辞职？实际上，提出辞职的是一个毕业刚一年的小伙子，1989年生，毕业1年多，我给他的待遇是试用期9000，转正后9500。在给他这个待遇之前，我是进行过一些调研的，我打电话给我的一个表妹，她是西安电子科技大学的研究生（陕西省排名第三的学校，211院校），她和她的同学在今年毕业找工作的时候，多得是6000到8000的工资。所以从这方面来说，我并没有亏待你，而你要求12K的工资，我并不是不愿意给这么多，你的表现也说明了你是个很有潜力的人才。只是受经济环境的影响，今年公司的效益不及往年，要在一定程度上节省开支。其次，你让其他的老员工情何以堪？所以，综合起来，你的要求超出了我的能力范围之外，我无法开口向公司申请提高你的薪水。</p>\n<h3>3.门槛</h3>\n<p>除了积累和顶头上司两个决定因素以外，第三个决定因素就是你从事工作的门槛。为什么餐厅服务员的收入很低？为什么坐在前台收发快递的文员收入很低？因为这些工作的门槛很低，门槛低就意味着你不做有的是人能做，你不做有大批的“后备队伍”在等着做。由于庞大的后备队伍的竞争，你就无法提高自己的要价。而提升自己所从事工作的门槛，实际上就缩减了竞争者的规模。</p>\n<p>程序开发也是一样。如果你想收入高，你就做一些别人做不了，又有市场的。</p>\n<p>.NET在程序开发中就属于门槛比较低的一类。个中原因我想大家都懂的，就不在这里赘述了。做.NET不需要你科班出身，或许一点兴趣再加上一点时间，或许一个类似北大青鸟的培训，都可以让你开始从事.NET开发了。你可以不懂指针、不懂数据结构、不懂算法、不懂汇编、不懂很多东西，但照样可以做出一个.NET程序来。而这些人往往又是对薪资的要求没那么高的，这样无形中就拉低了.NET程序员的“身价”。.NET的易学易会，很大程度上是由于它的封装性比较好。底层的东西都屏蔽掉了，你只要知道学习一下命名空间，然后寻找相关的API去调用就好了。记得我们公司曾经开发过一个基于C语言的手持设备程序，没有任何的类库支持，连排序、链表这样.NET中的基本功能，都要自己来实现，更别提内存管理和程序逻辑了，和.NET比起来，门槛就相对高一些了。</p>\n<p>所以，如果想收入高一些，那么就去做更高难度的技术工作，这里随便想了几个例子：</p>\n<ul>\n<li>百度、谷歌的搜索引擎算法。</li>\n<li>微软、谷歌、苹果的操作系统。</li>\n<li>网络游戏，例如《征途》的游戏引擎。</li>\n<li>大型企业的ERP，比方说SAP。</li>\n<li>软硬结合，比如单片机，电气自动化。</li>\n<li>以及我这位即将离职的同事说的，3D图形图像。</li>\n</ul>\n<p>所以，从这个角度来看，这位同事的辞职是明智的，他很年轻，有的是机会重新选择自己的道路，所以我也祝愿他能有更好的发展。而这些好赚的钱，就留给我们来做了:-)。</p>\n<h3>4.平台</h3>\n<p>接下来要说的一个决定因素是平台。很多程序员觉得30岁就瓶颈了，30岁写程序就到头了，实际上，这只是你的平台比较小罢了。就拿我自己的公司来说，平台就不大，只要是踏踏实实工作过5年的程序员，基本上就能够胜任公司90%的技术工作了，剩下的10%，请教一下其他同事，进行一下技术交流，也完全能够解决。这样就存在一个问题：随着你年龄的增长，你的生活压力越来越大，要求越来越高，可是公司只要5年经验的程序员就够用了。假设市场上5年经验的程序员的平均要求是10K，凭什么要给你15K？你的优势在哪里？如果你没有突破，就会有“30岁写程序就到头了”的感觉。</p>\n<p>而如果平台大一些情况就会不一样，比方说，你去了IBM，可能5年的经验不过刚刚入门而已。IBM有一个工程院，其中有5位院士（IBM Fellow）获得过诺贝尔奖，很多人钻研技术都超过20年或者更久。如果你对技术感兴趣，并执着去钻研的话，你可以不断地去挑战和攀登。</p>\n<p>当然，你可能没那么好的运气和实力进入IBM，那么其他一些中型的平台也是不错的，比方说阿里巴巴、金蝶、百度、腾讯等等。在这里，至少你有足够的理由和需要再去进行深入学习。因为在这些地方，5年的经验是远远不够的，还需要进一步地学习和努力。</p>\n<p>如果你和我一样，不巧没有那么大的平台，此时的选择大概有这么几种：</p>\n<p>1. 你可以凭借你在公司的积累（第一节讲过的），过比较安逸的日子。如果比较幸运，押对了宝，公司发展得比较好，收入一样会变得非常可观；如果比较不幸，公司经营的状况不好，那就要承担比较大的风险了。说得难听一点，公司倒闭了你去哪里？你过去的积累已经一文不值，而你的年龄已经35，水平却相当于只有5年经验。你的竞争力在哪里？</p>\n<p>2. 你可以凭自己的努力将现在所在的平台做大，换言之，把自己的小公司做大。这当然是比较积极的做法，也是我一直努力的方向。现在你看到的大公司，不也是从小公司一步一步做起的吗？不过这里还有两个问题：1、有的时候，你的力量在公司中的占比没那么大，你再怎么努力推进的速度也还是有限；2、你缺乏慧眼，选中的公司本身就缺乏长大的资质。我们往往只看到成功了的公司，却忽视了更多在竞争中倒下的公司。</p>\n<p>3. 主动选择更大的平台，也就是跳槽了。但是跳槽也是有风险的，尤其是过了30岁的程序员。你在这家公司的收入高，是因为有之前的积累，换一家就没有积累了，等于从新人开始，而大多数的公司，5年经验的程序员就够用了。如果跳得不好，收入还可能越跳越低，如果还有老婆、孩子、房贷，那将面临更大的压力。所以当你想要从一个低的平台向更高的平台跳跃的时候，平时就要做足功夫，认真积累自己的实力。对于我来说，我缺乏大型项目的管理经验，但是没关系，我努力学习考一个PMP没什么问题吧？我缺乏大型软件的架构经验，但是没关系，我把.NET的基础知识和各种设计模式掰开了揉碎了没什么问题吧？我缺乏大型团队的管理经验，但是没关系，每次遇到管理方面的问题我都认真思考仔细总结没什么问题吧？有些人总是抱怨没有机会，运气不好，我想机会总是有的，但只属于有准备的人。</p>\n<h3>5.行业</h3>\n<p>我想说的最后一点就是行业。有时候你觉得已经万事俱备了，可是你所处的这个行业本身就属于极低利润率的，你再怎么努力也很难有很高的收入。很多情况下，可能公司也想提高你的待遇，但是由于缺乏利润的支撑，公司也是有心无力。所以，在选择公司，尤其是小公司的时候，要重点考察一下公司所处的行业如何？是不是前景比较好、利润比较高的行业？如果是大公司的话，这方面的问题就会少一些，因为如果方向有问题，它就无法做成大公司。</p>\n<p>行业是有周期性的，可能在一段时期内这个行业好，下一段时期这个行业就不行了。最典型的一个例子就是软盘，我现在的老板在成立这家公司之前是做销售的，他有一个客户，做索尼软盘的，这种软盘我想很多80后都见过。当时生意做得很大，可是当光盘出来以后，软盘的市场是会急剧萎缩的，可是这家公司的领导层居然没有看到，或者是看到了但不愿意转变，像鸵鸟一样在危机来临时把头埋在土里，继续做它的软盘。几年以后，这家公司就倒掉了。</p>\n<p>选择行业也不是选择暴利行业就一定好，比方说房地产。资本都是逐利的，当一个行业属于暴利，同时所有人都知道它是暴利的时候，危机就来了。这个危机就是会有大量的社会资源、人力物力投入到这个行业中企图分一杯羹。而全局上又没有一个统一的把控，这个行业究竟需要多少公司才是合适的？最后的结果就是过剩。就好像股票在崩盘时，也许跌到3000点是比较合理也比较正常的位置，但是由于人们的恐慌，它就跌到1600点了。</p>\n<p>感谢阅读，希望这篇文章能给你带来收获。</p>\n<p>不是所有一年工作经验的毕业生都有这样的待遇，我主要是看能力，而不是年龄、学历等。特别说明一下，以免误导。</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"112809\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"112809votetotal\">1</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"112809\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 5 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 6 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "url": "http://blog.jobbole.com/112809/", "comment_nums": 6, "praise_nums": 1, "front_image_url": ["http://ww1.sinaimg.cn/mw690/7cc829d3gw1eizj4ql2huj20eq0b0wfx.jpg"]},{"title": "如何判断 Linux 服务器是否被入侵？", "url_object_id": "876ee85ca3eab93b154bc72080cb1d99", "create_date": "2017/12/06", "tags": "IT技术,Linux", "fav_nums": 11, "front_image_path": "full/0d4192df99abd0f294a9eade3688a9b7ce6caa0e.jpg", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">原文出处： <a ref=\"nofollow\" target=\"_blank\" href=\"https://bash-prompt.net/guides/server-hacked/\">Elliot Cooper</a>   译文出处：<a target=\"_blank\" href=\"https://linux.cn/article-9116-1.html\">Linux中国/DarkSun</a>   </div><p>本指南中所谓的服务器被入侵或者说被黑了的意思，是指未经授权的人或程序为了自己的目的登录到服务器上去并使用其计算资源，通常会产生不好的影响。</p>\n<p>免责声明：若你的服务器被类似 NSA 这样的国家机关或者某个犯罪集团入侵，那么你并不会注意到有任何问题，这些技术也无法发觉他们的存在。</p>\n<p>然而，大多数被攻破的服务器都是被类似自动攻击程序这样的程序或者类似“脚本小子”这样的廉价攻击者，以及蠢蛋罪犯所入侵的。</p>\n<p>这类攻击者会在访问服务器的同时滥用服务器资源，并且不怎么会采取措施来隐藏他们正在做的事情。</p>\n<h3 id=\"toc_1\">被入侵服务器的症状</h3>\n<p>当服务器被没有经验攻击者或者自动攻击程序入侵了的话，他们往往会消耗 100% 的资源。他们可能消耗 CPU 资源来进行数字货币的采矿或者发送垃圾邮件，也可能消耗带宽来发动 DoS 攻击。</p>\n<p>因此出现问题的第一个表现就是服务器 “变慢了”。这可能表现在网站的页面打开的很慢，或者电子邮件要花很长时间才能发送出去。</p>\n<p>那么你应该查看那些东西呢?</p>\n<h4 id=\"toc_2\">检查 1 – 当前都有谁在登录?</h4>\n<p>你首先要查看当前都有谁登录在服务器上。发现攻击者登录到服务器上进行操作并不复杂。</p>\n<p>其对应的命令是 <code>w</code>。运行 <code>w</code> 会输出如下结果：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3464cc6ff55396349640\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\n 08:32:55 up 98 days,  5:43,  2 users,  load average: 0.05, 0.03, 0.00\r\nUSER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT\r\nroot     pts/0    113.174.161.1    08:26    0.00s  0.03s  0.02s ssh root@coopeaa12\r\nroot     pts/1    78.31.109.1      08:26    0.00s  0.01s  0.00s w\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3464cc6ff55396349640-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3464cc6ff55396349640-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3464cc6ff55396349640-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3464cc6ff55396349640-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a3464cc6ff55396349640-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3464cc6ff55396349640-1\"><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">08</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">32</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">55</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">up</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">98</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">days</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">5</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">43</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">2</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">users</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\">  </span><span class=\"crayon-e\">load </span><span class=\"crayon-v\">average</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0.05</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0.03</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0.00</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3464cc6ff55396349640-2\"><span class=\"crayon-e\">USER     </span><span class=\"crayon-e\">TTY      </span><span class=\"crayon-e\">FROM             </span><span class=\"crayon-v\">LOGIN</span><span class=\"crayon-sy\">@</span><span class=\"crayon-h\">   </span><span class=\"crayon-e\">IDLE   </span><span class=\"crayon-e\">JCPU   </span><span class=\"crayon-e\">PCPU </span><span class=\"crayon-e\">WHAT</span></div><div class=\"crayon-line\" id=\"crayon-5a3464cc6ff55396349640-3\"><span class=\"crayon-e\">root     </span><span class=\"crayon-v\">pts</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">113.174.161.1</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">08</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">26</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">0.00s</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">0.03s</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">0.02s</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ssh </span><span class=\"crayon-v\">root</span><span class=\"crayon-sy\">@</span><span class=\"crayon-e\">coopeaa12</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3464cc6ff55396349640-4\"><span class=\"crayon-e\">root     </span><span class=\"crayon-v\">pts</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">78.31.109.1</span><span class=\"crayon-h\">      </span><span class=\"crayon-cn\">08</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">26</span><span class=\"crayon-h\">    </span><span class=\"crayon-cn\">0.00s</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">0.01s</span><span class=\"crayon-h\">  </span><span class=\"crayon-cn\">0.00s</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">w</span></div><div class=\"crayon-line\" id=\"crayon-5a3464cc6ff55396349640-5\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0019 seconds] -->\r\n<p>第一个 IP 是英国 IP，而第二个 IP 是越南 IP。这个不是个好兆头。</p>\n<p>停下来做个深呼吸, 不要恐慌之下只是干掉他们的 SSH 连接。除非你能够防止他们再次进入服务器，否则他们会很快进来并踢掉你，以防你再次回去。</p>\n<p>请参阅本文最后的“被入侵之后怎么办”这一章节来看找到了被入侵的证据后应该怎么办。</p>\n<p><code>whois</code> 命令可以接一个 IP 地址然后告诉你该 IP 所注册的组织的所有信息，当然就包括所在国家的信息。</p>\n<h4 id=\"toc_3\">检查 2 – 谁曾经登录过?</h4>\n<p>Linux 服务器会记录下哪些用户，从哪个 IP，在什么时候登录的以及登录了多长时间这些信息。使用 <code>last</code> 命令可以查看这些信息。</p>\n<p>输出类似这样：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3464cc6ff5f475589086\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nroot     pts/1        78.31.109.1      Thu Nov 30 08:26   still logged in\r\nroot     pts/0        113.174.161.1    Thu Nov 30 08:26   still logged in\r\nroot     pts/1        78.31.109.1      Thu Nov 30 08:24 - 08:26  (00:01)\r\nroot     pts/0        113.174.161.1    Wed Nov 29 12:34 - 12:52  (00:18)\r\nroot     pts/0        14.176.196.1     Mon Nov 27 13:32 - 13:53  (00:21)\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3464cc6ff5f475589086-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3464cc6ff5f475589086-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5a3464cc6ff5f475589086-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3464cc6ff5f475589086-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5a3464cc6ff5f475589086-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3464cc6ff5f475589086-6\">6</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3464cc6ff5f475589086-1\"><span class=\"crayon-e\">root     </span><span class=\"crayon-v\">pts</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\">        </span><span class=\"crayon-cn\">78.31.109.1</span><span class=\"crayon-h\">      </span><span class=\"crayon-e\">Thu </span><span class=\"crayon-i\">Nov</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">30</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">08</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">26</span><span class=\"crayon-h\">   </span><span class=\"crayon-e\">still </span><span class=\"crayon-e\">logged </span><span class=\"crayon-st\">in</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3464cc6ff5f475589086-2\"><span class=\"crayon-e\">root     </span><span class=\"crayon-v\">pts</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">        </span><span class=\"crayon-cn\">113.174.161.1</span><span class=\"crayon-h\">    </span><span class=\"crayon-e\">Thu </span><span class=\"crayon-i\">Nov</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">30</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">08</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">26</span><span class=\"crayon-h\">   </span><span class=\"crayon-e\">still </span><span class=\"crayon-e\">logged </span><span class=\"crayon-st\">in</span></div><div class=\"crayon-line\" id=\"crayon-5a3464cc6ff5f475589086-3\"><span class=\"crayon-e\">root     </span><span class=\"crayon-v\">pts</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">1</span><span class=\"crayon-h\">        </span><span class=\"crayon-cn\">78.31.109.1</span><span class=\"crayon-h\">      </span><span class=\"crayon-e\">Thu </span><span class=\"crayon-i\">Nov</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">30</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">08</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">24</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">08</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">26</span><span class=\"crayon-h\">  </span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">00</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">01</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3464cc6ff5f475589086-4\"><span class=\"crayon-e\">root     </span><span class=\"crayon-v\">pts</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">        </span><span class=\"crayon-cn\">113.174.161.1</span><span class=\"crayon-h\">    </span><span class=\"crayon-e\">Wed </span><span class=\"crayon-i\">Nov</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">29</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">12</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">34</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">12</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">52</span><span class=\"crayon-h\">  </span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">00</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">18</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5a3464cc6ff5f475589086-5\"><span class=\"crayon-e\">root     </span><span class=\"crayon-v\">pts</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">0</span><span class=\"crayon-h\">        </span><span class=\"crayon-cn\">14.176.196.1</span><span class=\"crayon-h\">     </span><span class=\"crayon-e\">Mon </span><span class=\"crayon-i\">Nov</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">27</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">13</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">32</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">13</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">53</span><span class=\"crayon-h\">  </span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">00</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">21</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3464cc6ff5f475589086-6\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0041 seconds] -->\r\n<p>这里可以看到英国 IP 和越南 IP 交替出现，而且最上面两个 IP 现在还处于登录状态。如果你看到任何未经授权的 IP，那么请参阅最后章节。</p>\n<p>登录后的历史记录会记录到二进制的 <code>/var/log/wtmp</code> 文件中（LCTT 译注：这里作者应该写错了，根据实际情况修改），因此很容易被删除。通常攻击者会直接把这个文件删掉，以掩盖他们的攻击行为。 因此, 若你运行了 <code>last</code> 命令却只看得见你的当前登录，那么这就是个不妙的信号。</p>\n<p>如果没有登录历史的话，请一定小心，继续留意入侵的其他线索。</p>\n<h4 id=\"toc_4\">检查 3 – 回顾命令历史</h4>\n<p>这个层次的攻击者通常不会注意掩盖命令的历史记录，因此运行 <code>history</code> 命令会显示出他们曾经做过的所有事情。 一定留意有没有用 <code>wget</code> 或 <code>curl</code> 命令来下载类似垃圾邮件机器人或者挖矿程序之类的非常规软件。</p>\n<p>命令历史存储在 <code>~/.bash_history</code> 文件中，因此有些攻击者会删除该文件以掩盖他们的所作所为。跟登录历史一样，若你运行 <code>history</code> 命令却没有输出任何东西那就表示历史文件被删掉了。这也是个不妙的信号，你需要很小心地检查一下服务器了。（LCTT 译注，如果没有命令历史，也有可能是你的配置错误。）</p>\n<h4 id=\"toc_5\">检查 4 – 哪些进程在消耗 CPU？</h4>\n<p>你常遇到的这类攻击者通常不怎么会去掩盖他们做的事情。他们会运行一些特别消耗 CPU 的进程。这就很容易发现这些进程了。只需要运行 <code>top</code> 然后看最前的那几个进程就行了。</p>\n<p>这也能显示出那些未登录进来的攻击者。比如，可能有人在用未受保护的邮件脚本来发送垃圾邮件。</p>\n<p>如果你最上面的进程对不了解，那么你可以 Google 一下进程名称，或者通过 <code>losf</code> 和 <code>strace</code> 来看看它做的事情是什么。</p>\n<p>使用这些工具，第一步从 <code>top</code> 中拷贝出进程的 PID，然后运行：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3464cc6ff65625526684\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nstrace -p PID\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3464cc6ff65625526684-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3464cc6ff65625526684-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3464cc6ff65625526684-1\"><span class=\"crayon-v\">strace</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">PID</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3464cc6ff65625526684-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p>这会显示出该进程调用的所有系统调用。它产生的内容会很多，但这些信息能告诉你这个进程在做什么。</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3464cc6ff6b790080333\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nlsof  -p PID\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3464cc6ff6b790080333-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3464cc6ff6b790080333-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3464cc6ff6b790080333-1\"><span class=\"crayon-v\">lsof</span><span class=\"crayon-h\">  </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">PID</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3464cc6ff6b790080333-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>这个程序会列出该进程打开的文件。通过查看它访问的文件可以很好的理解它在做的事情。</p>\n<h4 id=\"toc_6\">检查 5 – 检查所有的系统进程</h4>\n<p>消耗 CPU 不严重的未授权进程可能不会在 <code>top</code> 中显露出来，不过它依然可以通过 <code>ps</code> 列出来。命令 <code>ps auxf</code> 就能显示足够清晰的信息了。</p>\n<p>你需要检查一下每个不认识的进程。经常运行 <code>ps</code> （这是个好习惯）能帮助你发现奇怪的进程。</p>\n<h4 id=\"toc_7\">检查 6 – 检查进程的网络使用情况</h4>\n<p><code>iftop</code> 的功能类似 <code>top</code>，它会排列显示收发网络数据的进程以及它们的源地址和目的地址。类似 DoS 攻击或垃圾机器人这样的进程很容易显示在列表的最顶端。</p>\n<h4 id=\"toc_8\">检查 7 – 哪些进程在监听网络连接?</h4>\n<p>通常攻击者会安装一个后门程序专门监听网络端口接受指令。该进程等待期间是不会消耗 CPU 和带宽的，因此也就不容易通过 <code>top</code> 之类的命令发现。</p>\n<p><code>lsof</code> 和 <code>netstat</code> 命令都会列出所有的联网进程。我通常会让它们带上下面这些参数：</p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3464cc6ff6f659701288\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nlsof -i\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3464cc6ff6f659701288-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3464cc6ff6f659701288-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3464cc6ff6f659701288-1\"><span class=\"crayon-v\">lsof</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">i</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3464cc6ff6f659701288-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p></p><!-- Crayon Syntax Highlighter v2.7.1.1 -->\r\n\r\n\t\t<div id=\"crayon-5a3464cc6ff72992717960\" class=\"crayon-syntax crayon-theme-github crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-always\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 13px !important; line-height: 15px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 13px !important;height: 19.5px !important; line-height: 19.5px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"切换是否显示行编号\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-plain-button\" title=\"纯文本显示代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"切换自动换行\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"点击展开代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"复制代码\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"在新窗口中显示代码\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 18.2px !important; line-height: 18.2px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 13px !important; line-height: 15px !important;\">\nnetstat -plunt\r\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 13px !important; line-height: 15px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5a3464cc6ff72992717960-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5a3464cc6ff72992717960-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 13px !important; line-height: 15px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5a3464cc6ff72992717960-1\"><span class=\"crayon-v\">netstat</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">plunt</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5a3464cc6ff72992717960-2\"> </div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p>你需要留意那些处于 <code>LISTEN</code> 和 <code>ESTABLISHED</code> 状态的进程，这些进程要么正在等待连接（LISTEN），要么已经连接（ESTABLISHED）。如果遇到不认识的进程，使用 <code>strace</code> 和 <code>lsof</code> 来看看它们在做什么东西。</p>\n<h3 id=\"toc_9\">被入侵之后该怎么办呢?</h3>\n<p>首先，不要紧张，尤其当攻击者正处于登录状态时更不能紧张。<strong>你需要在攻击者警觉到你已经发现他之前夺回机器的控制权。</strong>如果他发现你已经发觉到他了，那么他可能会锁死你不让你登陆服务器，然后开始毁尸灭迹。</p>\n<p>如果你技术不太好那么就直接关机吧。你可以在服务器上运行 <code>shutdown -h now</code> 或者 <code>systemctl poweroff</code> 这两条命令之一。也可以登录主机提供商的控制面板中关闭服务器。关机后，你就可以开始配置防火墙或者咨询一下供应商的意见。</p>\n<p>如果你对自己颇有自信，而你的主机提供商也有提供上游防火墙，那么你只需要以此创建并启用下面两条规则就行了：</p>\n<ol>\n<li>只允许从你的 IP 地址登录 SSH。</li>\n<li>封禁除此之外的任何东西，不仅仅是 SSH，还包括任何端口上的任何协议。</li>\n</ol>\n<p>这样会立即关闭攻击者的 SSH 会话，而只留下你可以访问服务器。</p>\n<p>如果你无法访问上游防火墙，那么你就需要在服务器本身创建并启用这些防火墙策略，然后在防火墙规则起效后使用 <code>kill</code> 命令关闭攻击者的 SSH 会话。（LCTT 译注：本地防火墙规则 有可能不会阻止已经建立的 SSH 会话，所以保险起见，你需要手工杀死该会话。）</p>\n<p>最后还有一种方法，如果支持的话，就是通过诸如串行控制台之类的带外连接登录服务器，然后通过 <code>systemctl stop network.service</code> 停止网络功能。这会关闭所有服务器上的网络连接，这样你就可以慢慢的配置那些防火墙规则了。</p>\n<p>重夺服务器的控制权后，也不要以为就万事大吉了。</p>\n<p>不要试着修复这台服务器，然后接着用。你永远不知道攻击者做过什么，因此你也永远无法保证这台服务器还是安全的。</p>\n<p>最好的方法就是拷贝出所有的数据，然后重装系统。（LCTT 译注：你的程序这时已经不可信了，但是数据一般来说没问题。）</p>\n<p> </p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113205\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113205votetotal\">3</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113205\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 11 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 5 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "url": "http://blog.jobbole.com/113205/", "comment_nums": 5, "praise_nums": 3, "front_image_url": ["http://jbcdn2.b0.upaiyun.com/2014/05/1389f92e6bd3378cb6e4522971b7db35.jpg"]},{"title": "他们是优秀的前端，所以这些后端工作也交给他们…", "url_object_id": "f2c65dccf718330f513e67e843e7c14f", "create_date": "2017/12/07", "tags": "职场,程序员", "fav_nums": 3, "front_image_path": "full/675acba0c3fe762a3da3697c582bdec7fa10530b.jpg", "content": "<div class=\"entry\">\r\n\r\n        \t\t\t<div class=\"textwidget\"></div>\n\t\t\r\n\t\t<div class=\"copyright-area\">本文由 <a href=\"http://blog.jobbole.com\">伯乐在线</a> - <a href=\"http://www.jobbole.com/members/zhj318\">飞哥的咖啡</a> 翻译。未经许可，禁止转载！<br>英文出处：<a target=\"_blank\" href=\"https://hackernoon.com/the-myth-of-the-interchangeable-developer-38d41aff563e\">Scott Shipp</a>。欢迎加入<a target=\"_blank\" href=\"http://group.jobbole.com/category/feedback/trans-team/\">翻译组</a>。</div><p class=\"graf graf--p graf-after--h3\">我多次听经理或招聘人员说，优秀工程师是可以与其他优秀工程师交换的。他们可能会说，“首席工程师为这个项目选择了 F# 语言，如果外面没有太多的 F# 开发者，那么有几年经验的优秀开发者应该也还不错。”</p>\n<p id=\"9c5c\" class=\"graf graf--p graf-after--figure\">我还听说过一些这样的言论，“我知道他们是前端人员，但我们现在需要他们做些后端工作。因为他们本身很优秀，所以这没什么大不了的。”</p>\n<p class=\"graf graf--p graf-after--p\">如果你相信这些蠢话，那我都可以把布鲁克林大桥卖给你了。我还创立了下一个独角兽公司，业务就是把冰卖给爱斯基摩人！我敢肯定，公司很快会有 10 亿美元的估值！机会难得，快来投资吧~</p>\n<p class=\"graf graf--p graf-after--p\"><img class=\"alignnone\" src=\"http://wx4.sinaimg.cn/mw690/7cc829d3gy1fkm7cqqsr0j20m40er0tm.jpg\" width=\"690\" height=\"460\"></p>\n<p class=\"graf graf--p graf-after--p\">好吧，不开玩笑了，说实在的，“优秀的”软件工程师可以交换，这样的想法并不靠谱。我有时会对软件工作感到疑惑，是不是我在简历上写，“我保持良好的记录，不断在新技术上开拓驰骋”，然后我就能去任何想去的公司了？</p>\n<p class=\"graf graf--p graf-after--p\">我不敢相信今天要坐下来和你解释这一点，但是，现在让我们从语言差异开始说起。实际上，我已经将多种语言的代码投入生产，从 Scala 到 C#，从 Java 到 JavaScript。即使我能在几周内学会任何类 C 语言的的语法，（给别人可能需要更多时间，）我仍然清楚地知道，我不会用一种新的语言去开发一个生产代码库。</p>\n<p class=\"graf graf--p graf-after--p\">那么行业或商业背景呢？我已经涉猎在很多领域，包括健康卫生、电子商务、教育和电信。我是否应该认为我有资格在社交媒体工作哪？那么制造业、航空航天、数字加密货币（Cryptocurrency）哪？我的领域究竟能拓展到哪一块？在我被要求从 Web 过渡到移动、桌面或物联网时，也发生了同样的情况。</p>\n<p class=\"graf graf--p graf-after--p\">现在，让我给你讲个小故事。去年，在做后端 Java web 服务工程师的全职工作时，我还参与了另一个团队的工作，他们要在 Ionic Framework 中做一个移动应用程序，并使用 Angular、TypeScript 和一些定制库打组合拳。直到长达八个月的项目临近结束时，我才得以“适应”这种融合了 Ionic/Angular/TypeScript 的工作方式。实际上，“适应”这个词可能有点夸大其词。但仍然困扰我的是，我要在控制器中公开字段，因为需要在视图中显示它们，或者常量应该与其他变量一样命名。</p>\n<p class=\"graf graf--p graf-after--p\">顺便一说，如果你想在 JavaScript 中使用静态类型（static typing），你很快就会发现，这条路走不通。必须准备好“任何”类型！不过，我喜欢使用的 RxJs 订阅。</p>\n<p class=\"graf graf--p graf-after--p\">在项目结束后，我愉快地撤了。我现在再也不会自称为 TypeScript 或移动开发者了。这不是要在口头上表达优越性，而是一个简单的经验问题：八个月的时间不足以证明我在此方面的资质。我敢打赌，任何全职编程的人都会同意我的看法。</p>\n<p class=\"graf graf--p graf-after--p\">一个花了几年时间研究某种语言的开发者，将能够毫不费力地用它思考。她会在脑海中随时准备好所有需要的资源来完成任务，然后继续投入下一个任务。她了解语言环境，可以轻松地将标准库和第三方库结合成一个具有内聚性的新功能，就像一把钥匙对应一把锁一样，以此来轻松地解决问题。然而，当她不知道什么是可用的时候，她会重新造轮子，或者更糟的情况是，她会完全不知所措。</p>\n<p class=\"graf graf--p graf-after--p\">每一种语言都有着其独特的习惯用语、构建和依赖管理工具、框架、库、在线社区、IDE 等一系列东西，这些东西在日常实践中，对开发者生产力的影响比我们想象的要大得多。</p>\n<p class=\"graf graf--p graf-after--p\">但是，所有的语言都一样吗？我是说，C# 和 C++ 的开发者，到底有什么区别？“只是 # 和 ++ 的区别，哈哈，没什么大不了的！”快，把说这话的人扔去喂狮子！</p>\n<p class=\"graf graf--p graf-after--p\">我不是说任何人都不应该更换自己的语言、行业或设备。我只是说，程序员是不一样的。一个以 F# 为主要语言编写应用程序的软件团队，不会从我的 Java 经验中获益，尽管我也花了大量时间写 Scala。我只是说，我们不能找到那些“优秀的开发者”，然后出于奇思妙想，随机地把他们拖到不同的团队，并期望他们能够发挥出应有的效果。我是说，不要把所有“优秀的”开发者当作是可以交换的。</p>\n<p>可交换开发者的神话是不现实的。人与人之间的不同无法消除，并愿每个人都能找到最适合自己的那个角色！</p>\n\r\n        \r\n        \r\n        \n    <div class=\"post-adds\">\n        <span data-post-id=\"113210\" class=\" btn-bluet-bigger href-style vote-post-up   register-user-only \"><i class=\"fa  fa-thumbs-o-up\"></i> <h10 id=\"113210votetotal\">3</h10> 赞</span>\n        <span data-book-type=\"1\" data-site-id=\"2\" data-item-id=\"113210\" data-item-type=\"1\" class=\" btn-bluet-bigger href-style bookmark-btn  register-user-only \"><i class=\"fa fa-bookmark-o  \"></i> 3 收藏</span>\n\n                    <a href=\"#article-comment\"><span class=\"btn-bluet-bigger href-style hide-on-480\"><i class=\"fa fa-comments-o\"></i> 7 评论</span></a>\n        \n        \n        \n        <!-- JiaThis Button BEGIN -->\n        <div class=\"jiathis_style_24x24\" style=\"display: inline-flex; position: relative; margin: 0; clear: both;float: right;\">\n            <a class=\"jiathis_button_tsina\"></a>\n            <a class=\"jiathis_button_weixin\"></a>\n            <a class=\"jiathis_button_qzone\"></a>\n            <a class=\"jiathis_button_fb hide-on-480\"></a>\n            <a href=\"http://www.jiathis.com/share?uid=1745061\" class=\"jiathis jiathis_txt jiathis_separator jtico jtico_jiathis\" target=\"_blank\"></a>\n        </div>\n\n    </div>\n\n\n\n\r\n        <!-- BEGIN #author-bio -->\r\n\r\n<div id=\"author-bio\">\r\n\t\r\n\t<h3 class=\"widget-title\">\r\n\t关于作者：<a target=\"_blank\" href=\"http://www.jobbole.com/members/zhj318\">飞哥的咖啡</a>\r\n\t</h3>\r\n\t<div class=\"alignleft\">\r\n\t\t<a target=\"_blank\" href=\"http://www.jobbole.com/members/zhj318\">\r\n\t\t\t<img src=\"http://jbcdn2.b0.upaiyun.com/2016/09/9667abaa540914200edd449974fb5538.jpg\">\r\n\t\t</a>\r\n\t</div>\r\n\r\n    <div class=\"author-bio-info\">\r\n\r\n        <span class=\"author-bio-info-block\">\r\n            I'm OUT, never IN.        </span>\r\n        <span class=\"author-bio-info-block\">\r\n            <a href=\"http://www.jobbole.com/members/zhj318\" target=\"_blank\"><i class=\"fa fa-user\"></i> 个人主页</a> ·\r\n            <a href=\"http://blog.jobbole.com/author/zhj318/\" target=\"_blank\"><i class=\"fa fa-file-text-o\"></i> 我的文章</a>\r\n\r\n             · <a title=\"声望值\" target=\"_blank\" href=\"http://www.jobbole.com/members/zhj318/reputation/\"><i class=\"fa fa-graduation-cap\"></i> 46</a> · <a title=\"QQ：574375911\" target=\"_blank\" href=\"#\"><i class=\"fa fa-qq\"></i></a>         </span>\r\n    </div>\r\n\t<div class=\"clear\"></div>\r\n</div>\r\n\r\n<!-- END #author-bio -->\r\n\t</div>", "url": "http://blog.jobbole.com/113210/", "comment_nums": 7, "praise_nums": 3, "front_image_url": ["http://wx4.sinaimg.cn/mw690/7cc829d3gy1fkm7cqqsr0j20m40er0tm.jpg"]}]